<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="application-name" content="Cyclos">
<title>Cyclos reference documentation</title>
<style>
:root {
  --bg-color: white;
  --text-color: black;
  --link-color: #006ab1;
  --link-hover-color: #002740;
  --section-border-color: #555555;
  --input-border-color: #808080;
  --toc-bg-color: #f7f7f8;
  --toc-width: 15rem;
  --toc-border-color: #e7e7e9;
  --clipboard-bg-color: #eee9e6;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg-color: black;
    --text-color: white;
    --link-color: #45bef6;
    --link-hover-color: #b3e7ff;
    --section-border-color: #999999;
    --toc-bg-color: #151515;
    --toc-border-color: #3f3f3f;
    --clipboard-bg-color: black;
  }

  pre.rouge .k,
  pre.rouge .kn,
  pre.rouge .kc {
    color: white !important;
  }
  pre.rouge .o,
  pre.rouge .se {
    color: #da70d6 !important;
  }
  pre.rouge .s2 {
    color: #ce9178 !important;
  }
  pre.rouge .nn {
    color: #777777 !important;
  }
  pre.rouge .na,
  pre.rouge .nv {
    color: #d7ba7d !important;
  }
  pre.rouge .kt,
  pre.rouge .nt {
    color: #569cd6 !important;
  }
  pre.rouge .kt {
    color: #569cd6 !important;
  }
  pre.rouge .cp,
  pre.rouge .cm,
  pre.rouge .cs,
  pre.rouge .c1 {
    color: #6a9955 !important;
  }
  pre.rouge .mi {
    color: #b5cea8 !important;
  }
}

*, ::after, ::before {
  box-sizing: border-box;
}
body {
  font-family: Roboto, sans-serif;
  font-size: 1rem;
  margin: 0;
  padding: 1rem;
  color: var(--text-color);
  background-color: var(--bg-color);
}
body.with-dialog {
  overflow: hidden;
}
code, pre, kbd, .clipboard {
  font-family: Roboto Mono;
}
code {
  background-color: var(--toc-bg-color);
}
h5, h6, b, strong {
  font-weight: 500;
}
h1 {
  font-weight: 400;
  font-size: 2.8rem;
  margin-top: 0;
  padding-bottom: 1.5rem;
  margin-bottom: 2rem;
  border-bottom: 1px solid var(--section-border-color);
}
h2 {
  font-weight: 400;
  font-size: 2.3rem;
  border-top: 1px solid var(--section-border-color);
  margin-top: 3rem;
  margin-bottom: 1rem;
  padding-top: 2rem;
}
h2#General {
  padding-top: 0;
  border-top: none;
  margin-top: 2.5rem;
}
h3 {
  font-weight: 400;
  font-size: 1.75rem;
  margin-top: 2rem;
  margin-bottom: 1rem;
}
h4 {
  font-weight: 400;
  font-size: 1.5rem;
  margin-top: 2rem;
  margin-bottom: 0.75rem;
}
h5 {
  font-size: 1.25rem;
  margin-top: 2rem;
  margin-bottom: 0.5rem;
}
h6 {
  font-size: 1.15rem;
  margin-top: 1.5rem;
  margin-bottom: 0.25rem;
}
.sect5:first-of-type h6 {
  margin-top: 1rem;
}

.ulist li p {
  margin: 0.5rem 0;
}
#toctitle img {
  width: 180px;
}
#footer {
  display: none;
}

a, a:visited, a:active, a:hover {
  color: var(--link-color);
  text-decoration: none;
}
a:hover {
  color: var(--link-hover-color);
}

.paragraph {
  line-height: 1.5rem;
}

#toc ul {
  list-style-type: none;
  padding: 0;
}
#toc ul ul {
  padding-left: 1rem;
  margin-top: 0.5rem;
}
#toc li {
  margin-top: 0.5rem;
}

#toctitle {
  display: none;
}

ul {
  padding-left: 1.5rem;
}

.sectlevel3 {
  display: none;
}

#searchTocButton {
  font-family: Roboto, sans-serif;
  font-size: 1rem;
  background-color: var(--bg-color);
  color: var(--link-color);
  display: flex;
  align-items: center;
  border: 1px solid var(--link-color);
  padding: 0.5rem 1rem 0.5rem 0.75rem;
  border-radius: 0.375rem;
  cursor: pointer;
}
#searchTocButton svg {
  width: 1rem;
  height: 1rem;
  margin-right: 0.5rem;
}
#searchTocLarge {
  display: none;
}

#searchTocDialog[open] {
  border: none;
  border-radius: 0.375rem;
  display: flex;
  flex-direction: column;
  padding: 0;
  width: min(60vw, 60rem);
  height: min(80vh, 40rem);;
  overflow: hidden;
}
#searchTocDialog::backdrop {
  background-color: rgba(0, 0, 0, 0.3);
}
#searchTocDialog header {
  flex-shrink: 0;
  background-color: var(--toc-bg-color);
  border-bottom: 1px solid var(--toc-border-color);
  padding: 1rem;
  display: flex;
}
#searchTocDialog header input {
  border: 1px solid var(--input-border-color);
  background-color: var(--bg-color);
  color: var(--text-color);
  padding: 0.5rem;
  font-size: 1rem;
  border-radius: 0.375rem;
  flex-grow: 1;
}
#searchTocDialog header input:focus {
  outline: none;
  border-color: var(--link-color);
}
#searchTocDialog header button {
  flex-shrink: 0;
  width: 2rem;
  margin-left: 1rem;
  padding: 0;
  border: none;
  background: transparent;
  cursor: pointer;
  color: var(--input-border-color);
}
#searchTocDialog header button svg {
  width: 100%;
  height: 100%;
}
#searchTocDialog main {
  flex-grow: 1;
  padding: 1rem;
  scroll-snap-align: start;
  overflow: auto;
  background-color: var(--bg-color);
}
#searchTocDialog main a {
  display: block;
  margin-top: 0.5rem;
}
#searchTocDialog main a:first-of-type {
  margin-top: 0;
}

@media print {
  #searchTocButton,
  .sectlevel2 {
    display: none;
  }
}

@media screen and (min-width: 760px) {
  body {
    padding: 0;
    padding-left: var(--toc-width);
  }
  #toc {
    position: fixed;
    width: var(--toc-width);
    background-color: var(--toc-bg-color);
    left: 0;
    top: 0;
    bottom: 0;
    border-right: 1px solid var(--toc-border-color);
    z-index: 1000;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  #tocheading {
    flex: 0 0;
    background-color: var(--toc-bg-color);
    padding: 1rem;
  }
  #toctitle {
    display: block;
    margin-bottom: 1rem;
    font-size: 1.1rem
  }
  #toc a.selected {
    color: var(--link-hover-color);
  }
  #header, #content {
    padding-left: 1rem;
    padding-right: 1rem;
    max-width: 62rem;
    margin-left: auto;
    margin-right: auto;
  }
  #header {
    padding-top: 1rem;
  }
  #content {
    margin-bottom: 60rem;
  }
  #revnumber {
    display: none;
  }
  #toc .sectlevel1 {
    margin: 0;
    flex-grow: 1;
    overflow: auto;
    padding: 0 1rem 1rem 1rem;
  }
  #toc .sectlevel3 {
    display: block;
  }
}

@media screen and (min-width: 1200px) {
  #searchTocLarge {
    display: unset;
  }
  #searchTocSmall {
    display: none;
  }
}

.listingblock {
  position: relative;
}
.listingblock .content pre {
  padding: 1rem;
  overflow: auto;
  max-height: 30rem;
  background-color: var(--toc-bg-color);
}

.listingblock code[data-lang]::before,
.listingblock .clipboard {
  display: none;
  content: attr(data-lang);
  position: absolute;
  top: 0;
  font-size: 0.75rem;
  line-height: 1;
  text-transform: uppercase;
  color: inherit;
  opacity: 0.5;
  border: 0;
  background: transparent;
  padding: 0.25rem;
  outline: 0;
}
.listingblock code[data-lang]::before {
  right: 4.2rem;
}
.listingblock .clipboard {
  right: 1rem;
}

.listingblock:hover code[data-lang]::before,
.listingblock:hover .clipboard {
  display: block;
}

.listingblock .clipboard:hover,
.listingblock .clipboard:focus,
.listingblock .clipboard:active {
  background-color: var(--clipboard-bg-color);
}

</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Roboto:ital,wght@0,400;0,500;1,400;1,500&display=swap" rel="stylesheet">
<style>
  @media screen and (min-width: 1200px) {
    :root {
      --toc-width: 22rem;
    }
  }
</style>
<script>
  // Only actually do something on desktops
  const isMobile = /Mobi/i.test(window.navigator.userAgent);

  document.styleSheets.item(0).insertRule(`
    @media screen and (min-width: 760px) {
      #toc {
        visibility: hidden;
      }
    }
  `);

  function isScrolledIntoView(el) {
    var rect = el.getBoundingClientRect();
    var elemTop = rect.top;
    var elemBottom = rect.bottom;

    // Partially visible elements return true:
    return elemTop < window.innerHeight && elemBottom >= 0;
  }

  // TOC enhancement
  window.addEventListener('load', () => {
    if (isMobile) {
      return;
    }

    const toc = document.getElementById('toc');

    // Replace the TOC title with an image
    const tocTitle = document.getElementById('toctitle');
    const logoImage = document.getElementById('logoImage');
    tocTitle.innerHTML = '';
    tocTitle.appendChild(logoImage.content.cloneNode(true));

    var preventScroll = false;
    var scrollCounter = 0;

    // Find the max levels
    let maxTocLevels;
    for (let i = 6; i >= 1; i--) {
      if (document.querySelector('.sectlevel' + i)) {
        maxTocLevels = i + 1;
        break;
      }
    }
    let headerClasses = [];
    for (let i = 1; i <= maxTocLevels; i++) {
      headerClasses.push('h' + i);
    }

    // Find common elements
    const headers = [...document.querySelectorAll(headerClasses.join(','))];
    const aliases = new Map();
    const anchors = [...toc.querySelectorAll('a')];

    // Get all valid TOC ids
    const ids = new Set();
    headers.forEach(h => {
      const id = h.id;
      if (id && id !== '') {
        ids.add(id)
        // Also get the aliases
        h.querySelectorAll('a').forEach(a => {
          if (a.id) {
            aliases.set(a.id, id);
          }
        });
      }
    });

    // Shows the anchor in the TOC which points to the given id
    function selectId(id) {
      const ahash = '#' + (aliases.get(id) || id);
      const a = anchors.find(a => a.href.endsWith(ahash));
      selectAnchor(a);
    }

    // Shows the given anchor in the TOC
    function selectAnchor(selectedAnchor) {
      if (!selectedAnchor) {
        return;
      }
      // Deselect all but the selected anchor
      anchors.forEach(a => {
        const selected = a === selectedAnchor;
        const ul = a.parentElement.querySelector('ul');
        a.classList[selected ? 'add' : 'remove']('selected');
        if (ul) {
          ul.style.display = selected ? '' : 'none';
        }
      });
      // Show the lists of parents
      let curr = selectedAnchor.parentElement;
      while (curr && curr !== toc) {
        if (curr.style.display === 'none') {
          curr.style.display = '';
        }
        curr = curr.parentElement;
      }
      selectedAnchor.scrollIntoView(true);

      // Push the state to update the URL
      if (location.href !== selectedAnchor.href) {
        history.pushState({}, '', selectedAnchor.href);
      }
    }

    // On scroll, select the matching item in the TOC
    let scrollTimeout;
    const onScroll = () => {
      clearTimeout(scrollTimeout);
      if (preventScroll) {
        return;
      }
      scrollTimeout = setTimeout(() => {
        const now = new Date().getTime();
        const currentScroll = window.scrollY;
        let id = null;
        for (let i = 0; i < headers.length; i++) {
          const h = headers[i];
          if (h.id && h.id !== '') {
            if (h.offsetTop <= currentScroll && ids.has(h.id)) {
              id = h.id;
            } else {
              break;
            }
          }
        }
        const selectedAnchor = toc.querySelector('a.selected');
        const selectedId = selectedAnchor ? selectedAnchor.href.substring(selectedAnchor.href.indexOf('#') + 1) : null;
        if (selectedId !== id) {
          selectId(id);
        }
      }, 100);
    };
    setTimeout(() => window.addEventListener('scroll', onScroll), 1000);

    // Make anchors expandable
    anchors.forEach(a => {
      const ul = a.parentElement.querySelector('ul');
      if (ul) {
        ul.style.display = 'none';
      }

      // Link anchors hierarchically
      const parentUl = a.parentElement.parentElement;
      a.level = parseInt(parentUl.className.replace('sectlevel', ''), 10);
      a.parentAnchor = parentUl.previousElementSibling;

      a.addEventListener('click', e => {
        clearTimeout(scrollTimeout);

        // Make sure the clicked item is visible
        const id = a.href.substring(a.href.indexOf('#') + 1);

        const selectedAnchor = toc.querySelector('a.selected');
        if (a === selectedAnchor) {
          // Clicking on the same open item. Just toggle the ul, if any
          if (ul) {
            ul.style.display = ul.style.display === 'none' ? '' : 'none';
          }
        } else {
          // Clicking another item: Select it
          if (selectedAnchor) {
            selectedAnchor.classList.remove('selected');
          }
          a.classList.add('selected');
          // If it has a nested level, make sure it is the only one open
          if (ul) {
            toc.querySelectorAll('ul:not(.sectlevel1)').forEach(u => {
              u.style.display = 'none';
            });
            // Show the current UL and all its parents
            for (let u = ul; u && u !== toc; u = u.parentElement) {
              u.style.display = '';
            }
          }
        }

        // Make sure both the link and the target anchor are visible
        preventScroll = true;
        var currentScrollCounter = ++scrollCounter;

        var target = document.getElementById(id);
        if (target) {
          target.scrollIntoView();
        }
        if (!isScrolledIntoView(a)) {
          a.scrollIntoView();
        }

        // Push the state to update the URL
        history.pushState({}, '', '#' + id);

        // Stop the default event processing
        e.stopPropagation();
        e.preventDefault();

        // Allow scroll again
        setTimeout(() => {
          if (currentScrollCounter == scrollCounter) {
            preventScroll = false;
          }
        }, 500);
      });

      // Show the TOC
      toc.style.visibility = 'visible';

      // Initial state: Show the initial hash
      const hash = window.location.hash;
      if (hash?.length > 1) {
        selectId(hash.substring(1));
      }
    });

    // Create the button to search the TOC
    const searchButton = document.getElementById('searchTocButton');
    const tocDialog = document.getElementById('searchTocDialog');
    const tocMain = tocDialog.querySelector('main');
    const closeTocButton = document.getElementById('closeTocButton');
    const tocFilter = document.getElementById('tocFilter');
    searchButton.parentElement.removeChild(searchButton);
    searchButton.style.removeProperty('display');
    searchButton.addEventListener('click', () => {
      document.body.classList.add('with-dialog');
      updateTocDialog();
      tocDialog.showModal();
    });
    const tocHeading = document.createElement('div');
    tocHeading.id = 'tocheading';
    tocTitle.parentElement.removeChild(tocTitle);
    tocHeading.appendChild(tocTitle);
    tocHeading.appendChild(searchButton);
    toc.insertAdjacentElement('afterbegin', tocHeading);

    const closeHandler = () => tocDialog.close();
    closeTocButton.addEventListener('click', closeHandler);

    tocDialog.addEventListener('close', () => {
      tocFilter.value = '';
      document.body.classList.remove('with-dialog');
    });

    function updateTocDialog() {
      const filter = tocFilter.value.trim().toLowerCase();
      const regexp = /^(\d+\.?)+/;
      tocMain.innerHTML = '';
      anchors.forEach(anchor => {
        const level = anchor.level
        if (level <= 3 || filter !== '') {
          const nameParts = [];
          for (let p = anchor; p != null && p.id !== 'toctitle'; p = p.parentAnchor) {
            nameParts.unshift(p.innerHTML.trim());
          }
          if (filter === '' || nameParts.find(p => p.toLowerCase().includes(filter))) {
            const prefix = regexp.exec(nameParts[Math.min(2, nameParts.length - 1)])?.[0] || '';
            const a = document.createElement('a');
            a.href = anchor.href;
            a.innerHTML = prefix + nameParts.map(part => part.replace(regexp, '')).join(' - ');
            a.addEventListener('click', closeHandler);
            tocMain.appendChild(a);
          }
        }
      });
    }

    tocFilter.addEventListener('input', updateTocDialog);

    // Show the TOC now that everything is loaded
    toc.style.visibility = 'visible';
  });

  // Copy button on source listings (even on small screens)
  window.addEventListener('load', () => {
    document.querySelectorAll('.listingblock pre').forEach(pre => {
      const content = pre.textContent;
      const b = document.createElement('button');
      b.className = 'clipboard';
      b.textContent = 'Copy';
      b.addEventListener('click', () => {
        navigator.clipboard.writeText(content);
        b.textContent = 'Copied';
        setTimeout(() => b.textContent = 'Copy', 2000);
      });
      pre.appendChild(b);
    });
  });
</script>
<button id="searchTocButton" style="display:none">
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
  </svg>
  <span id="searchTocSmall">Search headings</span>
  <span id="searchTocLarge">Search table of contents</span>
</button>

<dialog id="searchTocDialog">
  <header>
    <input type="search" id="tocFilter" placeholder="Search table of contents">
    <button id="closeTocButton">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
      </svg>
    </button>
  </header>
  <main></main>
</dialog>

<template id="logoImage">
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABswAAAHgCAYAAAABjkhIAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAwQxJREFUeNrs3X90VOeZ4PlHEiBijJAThHAgdgFjJxA7iN528GQ6UE6HPtOJswj79OkJZ3Zd9OzZ9O6M+ZGz3bt/dBbY9B89M2eXX7sn/ceOKXa3tcmeIRbtJP0DJxSOOzG2Y+QYg2MHKLCIDTixkIyDAFXtfW7dgkLoR1Wpqu5z7/v9nPOeEkJSvfW+90fVfe7zvE3iqKE9ixPeg7Yur7V7bXnw2B58DwBQO31eGwjaq8Gjfi87+8lTWYYHAAAAQBR1buxJSuH60vLzu9dvYUQAAIiuJhdeZBAc6wraarkZJAMAhK8YPNN2WB8JogEAAACwpCQwpm11ydc3nN+9vomRAgAgumJ5Ih/as1iDYfpGZm3wmGCqASBSsl7LeO2APs5+8tQAQwIAAACg3jo39uhN1gkp3Gy9vOTrSREwAwAg2mJzIg+CZN1SCJJ1M7UAECu9Ugie9RI8AwAAADBVnRt7ElIIhiW9dq/crExUNQJmAABEW+RP5EN7FqeEIBkAuMQPns1+8lSaoQAAAAAwkc6NPcW16kszxpL1eC4CZgAARFskT+TBmmSbvJYS1iIDAFdpplnaa7tY8wwAAABAUE4xKbdmjDXsuhEBMwAAom1alDo7tGexvunZKnW6EwgAECn6wXezNu/8kPEet89+8lSGYQEAAACctUO4ZgQAAKoUiYAZgTIAwCT0/JAkcAYAAAAAAACgGqYDZgTKAAAV0vMFgTMAAAAAAAAAFTEZMBvas1hrTJNGDwColp4/ioGzLbOfPNXHkAAAAAAAAAAYj6mA2dCexboejWaUbW7k8zbd2eGNRKs03bWg8I2ZbYU2+ufaF7DFAMAE8gPnbv/mlcFC0/9/3/v/68OS/+Bio7qU9NpR7/yyUwoZZwPMEgAAAAAAAIDRzATMhvYs7vYe9nqtvZ7P09S+UOTOudI0u6PwqMEyAECNjrFj3Vhw83tNiZvf9YNmH7wn+aHgcaC/nl3TGzFS3rlmw+wnT/UyUwAAAAAAAABKhR4wC7LKNFDWXZcnmNkmTXMXS9NdC/1HAIAN/g0LXmuav/TG9/LvnZL8+/3+YzErrYb0fPO0d97RgNkGss0AAAAAAAAAFIUaMKtXVplehG26e2khQDZGaUUAgE3+DQ567L5vlR8w8wNo75yodQlHPfckyTYDAAAAAAAAUBRKwKwua5XpGmTzlxYCZZRZBIDo0wzhhV1+04CZHzh794S/BloNFLPNWNsMAAAAAAAAQOMDZkN7Fie8h6e91lWTPzizTZoXrbylpBcAIF78zOH7OvzMMw2a5U4fqVXJRr1xQ7PN1s1+8lSWkQYAAAAAAADc1NCA2dCexUkpBMumXIKxqX2hNGmgrH0BswgADtEbJFq8lh84J/nTR7zH/qn+Sb2B4+gH6Yc33Jl6gRKNAAAAAAAAgIOaG/VEQ//n7+hd/IdkisEyDZQ1r3jca48RLAMAh+k5QM8Fek7Qc8MUteeHLmiJxhQjCwAAAAAAALinIQGzoT2L98pvB3ZM6Y9o6cWlawiUAQBucSNw5p0j9FwxRXv9cxYAAAAAAAAAp9Q9YBZceExNqZOLVkrLQ19lnTIAwLj8Uo3euULPGVOUImgGAAAAAAAAuKVua5gN7VmspRe1BGNXtX/DL7+49Iu1yBgAADhxVmuVpsRKf42z3Ilnp7K+mQbN9Pz1yOwnTw0wsAAAAAAAAEC81SXDrBbBsub7VvkltgiWAQAqpmV8tUyjdy6ZAj2HHQrOaQAAAAAAAABirOYBs6kGy5ru7JBmLb+4sIvZAQBMiZ5L/HOKd26pEkEzAAAAAAAAwAH1KMlYfbBs/tJCNsC0VmYGAFATGixrWvGY5N56TvLvnqjmT3QF57YVjCaAMHRu7El4D4ngn8mS/7q35PvV0rKzr476d1/x6/O71/cxAwAAAAAAF9Q0YDa0Z/FeqTJY1rx0jR8wAwCg9me7Vv88k79roeROHKzmL3TpOW72k6c2MJgA6qEkKJb02pzgPXXxe/XWPUG/il9q4KwYTLsUPGYJqAEAAAAA4qJmAbMgWJaqvAet0vzgo9LUvoDZAADUlZ/JPLNNcq99T+T6cKW/nvLOdULQDMBUdW7s0WCYtuXBYzIC3S7eFJcc9Vr0wQ+eSSFTTb/uO797fZaZBgAAAABESVMt/sjQnsUp72Fvxb84s02aH/zyVNaWAQCgYvkPLkrute+LXBms5tc3zH7yVJpRBFCuIECW9Nrq4NGFdRGL2WiHg8fM+d3rB9gaAAB1PucekhBvRPHOdU3MAgAA0TXlE/kH6Ye780MXnq74ie/skOYVj7FeGQAgHNeHJXf0u37wrAqPzH7yVIZBBDCWoLxi0mtrxZ0AWTmyXtNjp2aiZSjnCACowzmYgBkAAKjalE7kQ3sW68WAo5VeBCBYBgAwofqgmWZJrJj95KksgwhABVlkuhaYBsm6GJGyj6UZrx2QQgCNYyoAYKrnYwJmAACgalWfyIf2LNYg2aFKLwgQLAMAmFJ90EwzIzTTjBJjgKOCTLJNUgiUJRiRKfNLN3rtwPnd6zMMBwCginMzATMAAFC1aVP43a1CsAwAEPkzYat/bqoiaNYVnAu3MIiAOzo39uhNYxog2yRkktVaV9A2e+OsNyP0SiF41svQAAAAAADqrao7X4b2LNaLBJWtWzazTVoe+irBMgCATdeHZeSl/1fkymClv7lu9pOnuJgLxFznxp6k9/CE11KMRsMVg2f7yDwDAExyvibDDAAAVK3iE3lQivG0VLJuWXD3vmaYAQBglWaYaaaZBs8qoBdyF1GaEYinzo09KSGbzJKsFIJnu1jzDAAwxnmbgBkAAKhaNSUZ90olwTJP84OPEiwDAJjnlw72zlm5o/sr+bX24Ny4jhEE4iEou7hZCoGydkbElEQwN1q2MSOFrLM0wwIAAAAAmKqK7nypphRj89I10jR/KSMNAIiM/LsnJHfiYKW/RmlGIOIIlEVW1mu7vJY+v3s92b4A4Pa5nAwzAABQtbJP5NWUYtRAmQbMAACIGg2YaeCsApRmBCKKQFls6PFXA2c7CZwBgLPndAJmAACgas0V/OxWqSRYpmWt7lvFCAMAonmC9M5hFZYTbg/OlQAiQgNlXtsmhZvCKnqvC5OKx+HTOq9BIBQAAAAAgLKUFTAb2rNYFznfXMkfblr6RZFprYwwACCavHOYfy6rzObgnAnAuM6NPSnv4agQKIuj0sBZiuEAAAAAAJSj3AyzHRX90crvygcAwJwqs6V3MHKAXZ0be7qCck17vZZgRGJNA2d7vfnWwFmS4QAAAAAATGTSgNnQnsX64bLsD5hN7QulaSE31wMA4kHPaXpuq0AyOHcCMCQov6gB7aMS4tomCEXCa4eC+QcAAAAAYEzlZJhVtB5Lc+XlqwAAsH2yrPzcxlpmgCGdG3u6pbBO2WZGw2lnGAIAAAAAwHgmDJhVml3WvGilyMw2RhUAEC/euc0/x5WPLDPAgCCr7GnvS22sU4ZehgAAAAAAMJ7JMszKv0N+ZhulGAEAseWf4yq7KYQsMyBEJVll3YwGPH3nd6/PMgwAAAAAgPGMGzCrKrtsWisjCgCIJ+8cR5YZYF/JWmVklaHULoYAAAAAADCRiTLMyr4zvql9oTTNX8poAgBiTc91es6rAFlmQAN1buzRcgeHhLXKcDvKMQIAAAAAJjRmwGxoz+KEVJBd1lTZHfcAAERWU+VZZglGDai/zo09KSkEy6gRjtF6z+9eP8AwAAAAAAAmMl6G2aZy/4CfXda+gJEEADhBz3kVZpltYtSA+gpKMO4VSjBibAcYAgAAAADAZKaN8/1UuX+A7DIAgGv03Jc/2l/uj+s5dQujBtSerlcmhbXKkowGJkA5RgAAAADApG7LMBvaszgl5d6dO7ON7DIAgHP8c593DixTe3BuBVBDJeuVJRkNTCBNOUYAAAAAQDnGKsm4tuxfJrsMAODqCbSyc+BaRgyonZJgGeuVYTKUYwQAAAAAlOWWkoxDexZrZll3eb/ZKk3zlzKCgIOaZ3ZI86yF3uNcaZre5n89kdyVi5K/Nij5K+/JyOV+yV3uZxAReU1zF/vnQrk+XM6Pd+s5dvaTp8hyAKaoc2NPynvQNctYrwyTGTi/ez3lGAEAAAAAZRm9hll3ub9IsAxwS8vsJdLStliavcemltaKflcDbKLN+91pHSslPzIsuQ/7ZWTwlIwMHGdwEdEzaOHGkXx/X7m/oefYNAMHVC8Ilu1lJFAmgmUAAAAAgLKNDpiVXTKq6W4CZkDcaWCspX2ZTPtYl59JVtO/qwE4r+Xnr5KR3/TJ9V8f9QNpQKT2kbsrCpjpOTbNqAHVIVg2rkzwmPXamZLva0brRAeoRNCK5sjNEpf6GIcMPsoxAgAAAADKdiNgVkk5xqY7O/wGIL6mz3tYWj7aVXE2WaX072vWmT4XgTNETfF8mP/gYjk/TllGoEoEy/zAV9ZrrwZfa6nBTAPGPSGFoJoG0O4NHqMSTMtSjhEAAAAAUInSDLNkub9EdhkQX7oe2YwFa2qaUVbWcaUkcHbt3eco1YjI8LPM3rpY7o/ruZYLuEAFHAyWaVA947XDXutrRGBsPN5zZ6UQqMuMmhMNmHUFx7TlwaO1IBrHWgAAAABARUoDZuWXY5y7mJEDYqYYsJr2sRWh90MDdiNti+XauYNkm8H+vqPnxLeeK/fH9VzLRVygTA4FyzJSKB+YOb97fZ/1znp9LAb1MiVzlZBC4Gx18JgIuZv72IMAAAAAAJWoPMNsZluhAYgNzSabcc+j0jzTTqlVXd+s+b6FcjW7X3JXLjJJsKt4XrwyWM5PJxkwoDwOBMs0eK5Bst4gABVpQTZaOmilAbS10vgMtGwUAo8AAAAAAFv8gNnQnsX6gTZRzi+QXQbEiwbJZiQer/taZdXws828vlGiEdbpuTHfX9a12YSec2c/eSrLqAHji3GwTA8UuyQmQbKJjBFAS0oheNYt9c8+I5MXAAAAAFCxYoZZV7m/0HTXQkYNiAnLwbIbx5ygRONV72uCZjC7nXrnxjIDZsVzbpZRA8YWBFbiFCzTwJgGcHa5nPUUrMWmbYs3x3ocfELqFzzbxZ4EAAAAAKhUIWDWeudqGf6grF8gwwyIhygEy0oRNINlFZ4b9UIx2Q/AGIJAytMxeTkaKNPAzc64Z5NVKggcatsSBEiLwbNalG3sC7LbAAAAAACoSCFgNvxBWRlmTe1klwFxELVgWZEGzYavDUrucj+TCHP0HJkfKGvbXM1oAbfr3NijwRINlrVH/KUQKKtASebZBm8b0KBZMXhWrX2MKgAAAACgGpWVZLxzLiMGRJwGyaYvWBO5YFnRjE88KsMneyR/bZDJhC16jiwvYNbFYAFjOiT1X9uqngiUTZE3bpp92xsET1Ne21TFNkEGLwAAAACgKs1Dexbrh9Cy7uRtmt3BiAERN33+Kj/DLKr8Nc3ueZSJhL1ts/xzZHtw7gUQ6NzYo2uWRTmYnPbaovO7128jWDZ1OoZe08DjIu+fjwTjWw7KMQIAAAAAqqYZZomyf5oMMyDSWmYvkZb2ZZF/HRrw++30ZfKRa6xnBkMqO0fquTfLoAF+sGyzFLKJokjX4doQrMmFOiiWbPS2k+1yM+tsvJv9djFiAAAAAIBqNUsFd/M23UmGGRBVxVKMcfHR+9fIiz8mYAZD+1hl50jKMgLiB8t0X9gRwa5rFtmW87vXryBY1hiaOaYZfN6XmnW2PZiD0SjHCAAAAAComgbMyivHSLAMiLRpH1sR2XXLxrPo9/5Evvc335PhK8NMMEyo4FzZzmjBdcE6VU9HsOsaINNA2U5msfGCco3b5PbAWS/lMAEAAAAAU6EBs+Vl/eS0VkYLiKim6W0yrWNl7F7XPQ+slGstHXJw/0EmGTaUf65czmABouuWJSLW5+1BVlmW6QvXqMBZ2msHGBUAAAAAwFToGmblZZjdtYDRwpRo0KZpRpu0zFoo0jzDX4dqPLkPz/mPI5f7JX91UPLXBhnAqezoH4tv9bff++NN0vONr8rB7x6UNY+tYbIR7nHOO1fmB/rL+VEyzOC0YN2y7gh1WTOX1gXracGQIKtsAyMBAAAAAJiqsgNmQKW0/F/z7CXSMmuB/1hJOcBmDarpBhpkRWnALHe5X0Yun5Pc0EnJj1CCr5J5aGlfFtvXp1lmc+YtlOOvHJe58+fKis+tYNIRBZx74azOjT0J72FrhLqsJRgfodwfAAAAAADxpgGz8lJPZrYxWiiLBmda2hZLy+wlNfubmp3m/10/8LNGRoZOysj7J/xHTKzSYGUUPfToBnn2qW/Kcz94Tjru7pCFixYy8QhH+efKLgYLDtN1y6ISNE6f372e7CUAAAAAABzQXPZPEjDDBDQgM33ewzLz/g0yY8GamgbLxqJ/f8Y9j/rPF+fsqZqMVdvi2L/GB7/w+I2vtTTj8BUyEBESzpXAhDo39myT6ASMtxMsAwAAAADAHc0MAaZq2sdWSOt9G/zyiZoJ1kj6fBqgI3A2zvhoOcY6By8taJ3VJp2LCvM/+P6gHPnRESYfAIyJWCnGDed3r9/GrAEAAAAA4A4CZqh+45m1UFqXrJfp81eFXvKvGDjT/jTP7GByinN0hzulCe9buebG10d/clQuvnORDQAAbNkbkX5qsCzNdAEAAAAA4BYCZqiKBslaE4+bC05pf/wg3ryHmSQdj1kLnHmt93z61jnX9cwAADZ0buxJeQ/JCHSVYBkAAAAAAI4iYIaKaCaXBqS0DKNlWh5SA3phZ76FvoM7lG13zwMrb/l3/+l+vwEAwtW5safde9gRga4SLAMAAAAAwGFlB8ya2hcwWq5vLEH2VlSCMMWSkS6XaNQxcMmcebe+3hNHT7DjoqGa7pzLIAC303XL2o33kWAZAAAAAACOI8MMZWmZvURmRDBjy1/bzGDpyIa8dgez60YHzI6/clwGBwbZgdE401oZA6BE58aeLu9hs/FubiFYBgAAAAAACJhhUi3ty2TGPY9GNgCj/XYxaNbkYJBwzrzbM2FPHj/JTgwA4bFeijF9fvf6nUwTAAAAAAAgYIaJN5BZC2XGgjWRfx2uBs1cMzrDTFGWEQDC0bmxJ+k9JA13MXN+9/oNzBQAAAAAAFAEzDD+xjGzQ2Z84tHYvJ5i0EzLNMIdF9+5SFlGAAjHXsN9y3ptHVMEAAAAAACKCJhhTH5wKcJlGF17XZhY/+l+BgEAGqhzY0/Ke0gY7d6A19ad371+gJkCAAAAAABFBMwwpukL1sQ2E0sz56bPX8UkO+S9d95jEACgsbYa7tuW87vX9zFFAAAAAACgFAEz3KalfZm0zF7Ca0RsaFlGAEBjGM8u6z2/e32aWQIAAAAAAKNNYwhQSksVupJ9pVl0ubf6JT8yzMTHxIXTx8f8PiUZAaChrGaXZb22gekBAExV58aehBRuDik2tbrkR0q/Xw7NfB4Ydc46M+r/BsiQBswfG9q9hy6vFR+ncmzIjHFMGCgeEzgeIORtvbidj3ceVMkK/mRx2y51eIz/66O0PuqNgBluocEyV9b30tc5MnuFNA+8EMvXl7vsXpDoyuUhdmIACPeDU0rsZpdt4MMVAKDC81rxonfSa8uDc1xXHZ6qq8z+6MONC+Zee1VuXjzPMGNAQ48PXcG+uzx4LAYQaiVZxvFA9/9scCzQYwDBBNRrO9fz32qp/IaQcrWPsc0nJ9n2i+fDS8H2TyAZNUHADDfo2l5aqtAlsxaslMPPPCWf/Xw8X7dmz7kSAFXjZZgpLcvYcXcHOzoA1JfV7LKdXEgEAEwmuDCYlMJFweIFQmtKLyp2l/RdH7JSuHjIxXOg9seHZMnxIWmkW8VgRnfxfbjXz2yw/2t2TsY7BmSZPUR8Ox9v25eSPm4tORcWg2mHg6+zBNJQCQJmuMGVUoyjffT+P5CD390rax5bE7vXlr9yUZpmLXRiHi9d6JcrlwfH/f/hK5TeBIA6f7hKic0Li/phaTszBAAY49xVDD6tDR4TEX9JiaBx8RyozfGhu+T40B6h40AqaMVjQK/XDnADGcbYzhOjtvM4GB1MKwbSdPvPBufDPoJoGA8BM/iaprdJsyOBldEe/MLj8vx3dslzP3hOVn0pXkHD3IfnnJnXC6dPsCMDQLieMNovSjGilhcVkkYuJuidsmlmpCFznpLwgyg7OY7VdE5LL4J3O/CSdftNya0XzzNeOyCFABrbFhDv44MeAzZr816f7u8aPNtFsMDp7TwRbN/6+a3LoZdefA9fPB+K3HpDSYatA4qAGXzT5610+vU/9OgGefapb8rcu+fKshXxKc84crlfpnW4MbdnX3+BHRkAwvvQlRSbdyTqB59eZgg1pBfSrJQeTTMdDbE35OfX9Ti2MQ01O1fpxcFuiU6mSD0k5NYAWkYKwbNess/g8PGhGCRLOfA+xt//g+D5Pn0/wb7vzHaeCs6DSUbjhuLn2K2jAmi9BJXdRcAM/hpXzbOXOD0GmmWmAbOD+w9Kx/yO2Kx1lbvc78w6Zm8eOcjODADhsZpdtoWpQY1lrHREL/5zJ2z9x5htLvJzWMwW0UB3ghEZUzJoO7zx0ouDegGd4BlcOT6kvLbJ0eNDIjg2aqCgmHXGOSee2/nmYDtvZ0TKPiduLcnIPMBNmG5pZgigwTIXAioTaZ3VJvevLKxhtv8/7Y/Vele5oZOxn78Lp4/7a5gBAEL5EJYQm3fjprkrELUWlC7LGPpAj/qyUKboMNNQ1bmp3WvbvC9PSyFLMMGolL3N79Bx88bv6SAbAYjde1ev7QiODzs4Pvj0xoJD3rgcZb+P1Xau57/3pRAYJVhWuWJQXc+HeR1PIzdToc4ImEFa2hYzCJ77PvsH/qMGyzTTLC6uD8R/ba+Xvjd5pZyFixaykQNAfVj8UK1Bje1MDerESgBjNVPhxBhnmIbycYGwpvQCul4cfJ8L6IjZ8UEDZZs5PoypK9jvT7PfR3Y7by8JCDOHtf/cu5VhiD8CZpAWx8sxFhUzzNTJEyf9Fgd+WcZrg7Gdt+HLg/IW5RgBIEwWyzHuopQU6ihjpB9JpiL2YzxApmx5uEBYV+1CYAEcH1yTkJuBs26GIzLb+ma5GRBGfZD57wACZq5vALPIuinSsoydi5bd+PdzP3guNqUZr104Ett50+yyK5cnDgiSXQYAdftQ1i32ythodtlOZgf1EqzvMWBkH0wyI3UbWz22hR0kyDATZc3VNuECIdsiwPGhHvRcqOXotFxjF8Nhdjvv0nKaUigxyg0O9cWNTA4gYOa4FgJmt7jngZU3vh58f1D6fhKP4+DIwPFYZplpdtnLz0xejrHtrjY2bgCoD6vZZQNMDeosY6QfSaYi1mPLXcwT0Js2NPtBKL1Yb2Q6IorHhyTHh5qfE48Gazgxnra29W06N2Jj3VUXcD50AAEz1zeAOxYwCCXu+fTDt/z76E+OxifL7J3nYjdf5WSXqQWL2M4BoA4fzhJSWN/EGrLL0AisYxZ/rF9m+Pyj2Q7el0+LvSznOOplCBCh44OWX9RjwyGOD3WR8hplGu2cCzVQxppajZOl7L8bCJg5rmkGmTel5sy7NbCiwbLYZJkNnfTXM4uLSxf6y8ouU5RkBIC6sPhBOU12GRrEygXkJHd6129sQ35+snrGEKzPclTIrmwkMh0RleODvjc9bfQ9apzo+w4t0/g070FC3dbJKms83pc5goCZ45qmEzArNa9kDbOi40ePx+b1XT13UPIj8ciY+/6ePy8ru6zj7g5pa2c7B4A6sFiOcTvTgkYI7i7NGulOkhmpreACYCLkbmSYiVvnJMgqY30WtkVgrOOD3k37NMeHhvIDlGSbNXx738a2HppXGQI3EDBzGMGy8uhaZnEJmuk6ZtfejX5pRs0sO3vshbJ+dumKpWzEAFD7D2oJsXdHY4YSGWj0NmekH5RlrL2kgT6Q1XPznFPMGkkyGg1H+SlYPz7o+1HNtEkxGqEoZpvtYCgasr1rYJgSjLz3R50RMHMY5RjHds8DD9/2vVPHT8Xm9Y0MHPdbVJ09dkSefeqbZf/8kmVL2KgBoPYs3km6i2lBgx0w0o8kU1FzrF9mRHARljvpw8P6ZbB8fEhJIViWYDRCt1nX0wpuqkPtt/X2YL2yFKMRKkoyOoKAGVCGkydO+uuZxYWWZhw4F72g2YXTx+W7f/W1sn9+ydIllGMEgPqwVo5R74Dnoh4aLWOkH12sIVJzyZCf3/n1y0pKMG5mcwwVmY6weozQTJu9jIQpfrafNzdJhqK250Pv4ZCwXlnY+lgr2x0EzIAy9Z/uj9XrOXdkrx+Aiorhy4PS8431Za1bduPd2ud4PwEAdfjQljD4gW0fM4NGCz40Z4x0h/VDaivsY1zG5cEvKbGWZFMMXYYhgLHjA5k2tvnBnSD7DzXY3oVgmRVklzmEgBlQplMnTsXq9Sy4t0Oe+V//NBJBM+3jU19/tKJg2cJFC/0GAKg5ixfm00wLQmIl+4J1zGrEyJ3xhx0ff704mGBrDB1308Pa8aFLCB5ExV7WNauJHWzvZrzKELiDgBlQpovvXIzV62md2SpdDy/1s7Ze+9F+s/3UYJn28dKFyjL8Vn5hJRstANTHWmP9yZzfvT7LtCAkVkqBJpmKWI1lxsWBDzIS9GI4JUZtOMAQwNDxgWBZ9GwOSmeium1exy7FSNj5zMkQuIOAGTDK8DhZTHELmKllK5bJ7LZW+f6eP5Pnv7PLXP80kFdpZpn/un5nGdllAFCfD256ETNprFuUY0RognWmLGRgJIKLiZi6sLP1nFy/LAiWcWHVlgxDACPHh2KwjGB69KQImlV9TkwxEube88MRBMwclr86yCCMdRCcoERh3NYxU2seW+M/Pv/tXVVlctWDBi2/+1df8wN5ldLMuVVfWsWGDAD1kTTYp16mBWyDZvdPjnOVy7g24ATLjH4u3r0+wyjAwPGBYFn0ETSrfJtnvGzhfOgYAmYOy18jYFapwYH4jVnH3R3y8Bce9r8+e+wF2fv1R0PNNtOssm99bZW8eeRgVb+/5vE1ftAMAFAX1tZJ6mV9FRhgZb2ptUzF1BhZv+yAY2OeEi4MWpRhCGDg+ECwLD4ImpW3zbdzTjSJ7DLHEDBzHEGzW509dmTC/x96fyiWr1vX+1qydIn/tZY/1GwzDVo1cm0zHXsN1mlWWaUlGItWfG7FjdcBAKiLpLH+sL4KLCDDLD4slLXMuDLYBMtM4/yKsI8PBMvih6DZ5LYK6/RZ9CpD4BYCZo7LXbnIIJSwUI4wLJqZpdlmpWOhwSsNnGnGWT3GRksvFjPKer7x1QnLYU5GA2WUYgSA+vE+4CYMfoCjHCNCF2Q5Zozsp93MyJSEnUWb9banrCPnlJQQLLMswxAg5PecBMviiaDZ+Nt90nvYzEhwTkT4pjEEbstrwGw2GTlFF7ITB2wuvhPfAKOWMXz83zwuPf9Hjwy+fzPDSwNlmnGm7f6Va+SeTz8s9zywUuYtWlbV8+jf02yyt178x6rLLo6mgT4N+AEA6spasKyPcowwRLMxkgb6oQEfAsnVC3sOMy4McpA5soPNzawB7/xK+SmEdXzQINnTQrAszjRo9qp3nNnJUNwizufFct7fJIJm8ZyYZfN0SwUBszyjFUMjl/tlWgfjUDRZScbhK8Ox3hdaZ86QR9d/Wb7X8/1bgmZFGuAqBrlmzmrzg2YaPFMaSBvLhdPH5cqHg/7YarCs1plqGix7/N885ved4xQA1JW19csoF4WoXQhoBM0w28J0VC4I4oR9gfawI+NM5gjHM2A8enygJF387fDOBxqISDMUN7Kuo7zdZ6WwzterwaPe1DjlmxtL1pZtLxmf4mfSZINeGzeQOKj8gBnXoWMp90E/gxDQ8oCTlwTMx35f6JjfIev/+6/K/qe+O2FGna4zdvbYC34r2NXwvi5ZuljWPLZGWltbOUYBQP0ljfWHLBqYodkY3od6vViQCLkrCS1lxZ2wkT3GZeI8wEHmiJbiinOwLCs3LxxekuCi4Rg/V/zeeBdISwO4q8f4Xj1xQwrCOkbslfgFy4rHgOIxoXiMGH08SIyxfxfPS8uD/4/b2GjQrI+MVt/WCJ7r9LOY3uiTqVfVD+/vZib67BeUb00E+8ryYB+p9Xvxw2ye7iHDDDIyeFJa2ijLWH55wPjvC5qt9fifrJOD331WTp44ZbKPK/55l6z60uc5PgFA41j6kE65KFikH+QtrD2hWWaUOapc2Fm0fQ4EOuN2MVzPQxkJ7qiv8ryUqfD7xTvui3fb63abkNpeIMxwOECjBRk2qRgdFw5XeFzvK2dfDLJ0k8G+XzwWRJVfftN7TStcLrMebPuJCHQ1G7zX3Wflc1iwf2VL95Xg5pzSfWSq7zs4JzqINcwgI0O/JGDm0TW1JqPZV67QNc20POPRn/bJcz/4sal+rXnsi352GQCgYR/kksa6xAcXWKQXxywEzPQCAQGzyoV9nIv1cc07j2yTQjA3yrLBPGkGViasC7wld9z3loxvQm4G0JJS/QXCLBmqCOH4oNvr3gi/hN7guNBb7+NCEKjoK57ng7F7Iji+JiI4dolg7tc5vAtYzy7Tc84ub9uLRHWPYB/sLZ4jg/OjnhfXSnVBZm7SdBABM0hu8KTk5w9LU0urs2Og5RjLyTBr/Yh7Y6SZXAsTC+W5v3tO+k+fC7UvhRKMX/SDZgCAhrKWEUBpDFj8gN6r63FI+Hd7dzMblWH9srqPb1KiV26qqHjhbZflzOaSu+yLFwiLd9gXLxAmyvxTGY4IaPDxwc8yimDXdX/b57V0mEHmkgDaluBYq8GzVMTGsltvqvBeyzYHt3/Lgc6017ZH/SaKoP/poBXHfLWUF2TOupz96DICZpD8yLDkhk5KS/syZ8fgtR/tZ0OYQMfdc+XxP3lMjh89IUd+9KIMDgw2/PlX/eEqWbhoAZMBAOFYbqw/GaYERmXEQMBKLwZE5U5gI7qMbDuxU7JuWdToBWgNkqWjOO5j3GFfbhYK65eh0fZKtDKjslIIIqQN7vd6Hsl4+/t2KdykkIrQuG71+t3rYMn1J4y+l90S17kI3h9r2xKcGzcF58Z2PnOiiDXM4Lt24SdOB8xe+l55n+EWJD7u9L6wbMWn/Hb86BsNCZxpgGzpiqX+c3IcAoBQmcowY/0yGHZAbGR4rZYxFkfHhOMVpkyM72CO2sXwjBQuhmfiNAmjslCKwbOU3H6BMMPhAI0SrN0UlazorBgNlI2xv2tfN0QwcObUembBDSXWtn8NlDlT1js4N24I9hedCw2eJUt+5FWO1G4iwwy+/NVBGRl4XVraP+3ca9fssksX+sv62ba72thY5GbgTEs0njj6hpw8cUqGrwzX5G+3tbfJkqWL/ECZZpYBAEywFDDLMB0wTINUFrJp9EP/FqajbMmQnz+W5RiDi09RuRjuB5PiFigby6jgWUoKFwj1PN9H6Sk08PiQ8B52RKS7GnjaGbX9oyRwtisY66TxLus2sdWh9y8pQ33RbfsRl29KLGaeBcemYqCZmzQdRcAMN1w7/1MnA2bPf2dXWT+n62a1tc9mQymhGWDa1sjv+8Gzc17rz56Ti++8V3YATce04+4OWZAo/C2CZABgS3AnuiWsXwbLH7YHvH0mI+FflErovks2ZlnHuISEnwGVieG4RqUUo14k3BLV0os1OGbp604Hax+1c0RAA+2NwDbnZ59E/Vwa9P8Rbz/fLPaDlJu9fh5w4eYFKawxaWU7Xxf1tcpquL/oOPgZmoyJu8oPmOUphRZ3+auXZOT916XlLneCZhosKze7zA/ksB+Ma2Hi435bKQ/5/9aA2cV335vkdxZwrAEA+xLG+kMAANZpWcakgX4k2V/KHqcwDcT0wmAULobr3eQbyKq6sfYR0BBB9mnSeDc1o2xLzPbzncFNPXp87jLcVe3fopjvA+1G9oGB4DyY5ch02/7CmDismSFAqWvvHJL8yLATr1UDZS8/U/5Nj4s/tYgNpAKakacBsYkaACASrH2gJgAA66ysHfYEU1GW0Ncvi9uABtlKlksxFi8QriNYBjT8+GA9+1SPCeviFiwrKmabeS1tuJuaJb8t5rtC0kg/1lGNALgdATPcQoNl1/r/3onX+v09fy5XLg+W/fNaLhAAAActN/ZBP8uUwLJgG7Vw8aEruDCJiSVDfv44lpm1fDHcv1jsaglGwABdG8jquSkbHB964zwBeqOA1zZIYW02s9tJUDI5rlYb6MNOsouBsREww21GBn/pl2aMM80sO3vshbJ/3l9naz5rawEAnGTpogYf6hAVVrbVbqZifEbWL+uN2ZhuE3ulfEvH+hHupgdCPeZuNto9PS6scOn44L1WPV5vMNzFHTEe/rAreGgm5XYBMKYKAmZ5mkPt2js/ktyVC7Hc6C+cPi7PPvXNin5nydJFbBc0Gq3MBsRO0lBfskwHImKfkX6sZSpMH9+yccqaDTIaNxntXpoSjEDorGafFjNPnTs+BNm2VoNm3UGJX95/1N4uzofA+Mgww5j80oxv/33s1jMbvjwoPd9YX/Hvdf3z5WwUAACE7wxDgCgI7lDPGuhKktmYEOuX1ZZmA1gstZYOyo8BCEkQ+LB4TnI2WFbyniUtdoNmW2O4L1hYHzrNUQkYHxlmtHFb7sp5uXrq27EJmhWDZZWsW6Y0u6yt/U62CRqNJmSYwdGLG5ZkmBVEiIVSe+3efkxZxvGFfYw7EKPzRcJ7SBnsGsEywAaLgQ/ng2VFhoNmSe/8korZcCfC3u5ZExqYWPkBM66BOtlyv70gQ8f3+cGmKCsGy86fPl7x73Y9/Bm2BRqNRrwMsIHSIYgSK8GQ1UzF7YysX5aJ0ZBavBhOsAywcbxNib3sMn1PuYFg2U1B0Gwn55e6CzvD7ABbOzAxSjJiUtPzl+Twf/ofIhs0m0qwbGHi434DwtLU0irNd37iRtN/A0ADJY19kO9jShAV3vaaERtBXjLMbB7f+uJyodZodlmGYBlghsWAxzreV4753mWL2MiQL5WIWZbZnLDPj2zpwMSmMQQox6LELD/o9Nj/9NcyZ97CyPT7wunj8v09f15VsEytfOQhJh8N0/yRedLSdp80faRDmmfOk6YZ47+Pyl+9JLkrFyT3wduSu/y2nw0KADHHHcCIIr3olAq5D3qhqYsLg7cJO/MuTnd4W7sYrtv6OjZxIHxBee+EsW5tCW5qwdg2BHPWZahPep5Jx2R8wx7XLJs4MDEyzFAWzbL62JwR2fv1R+XssSOR6PNbRw5WnVmmlnV9kuwy1F3TjDaZ/vEvyMxP/bfSet8TMq3zc4Wg2Yw5k/zeHP/n9Hf19/T3p3u/q38PAGroXkN94WI/oshKUOQJpuI2yZCfPxOHQTSYXUaZNcAWawH1Xu/4sJNpGV9w/LSWoZtgTdaazW+WUQAmVkHAjIVpXG+r/vBfSH5kWHq+8VV5/ju7zG7UWoLxh099U/b/1dfkSpVlJFtntvqvl3mn1atpYGvGJ/5QZn7qazJt7n8xaYBsMvr70zr/hf/39O8WAmeMM4uYAVP/cMoQAFO6KKEZZhYu3CeZjZsMrF82EKPsBmsXw7eQTQmYOdYmjZ1/LAaCrL5/0ePoFmPd2sTMAGgEMsxQttaZM2TNusJ7nee/vctktpn25ymvXy89s3dKf0dfp75eoNZ0DbLpQWCr5a4H6vIc+nf17+vzAECMHGYIEFEW1gLpCoJEKEiG/PyZOAyit021i6018jRzJM3mDZhhLbt5Hdmn5Qsy8Sydr5JaYpr3IADqjQwzWkVtyacSsuLhBwsnz9PH/Wyz7+/5M7l0oT/UDVmf/7t/9TW/P1Pti74+fZ3MN63WrfkjHTJj8Vf9TLBG0OdpvS/lPy/jT4YZUKUuhgCYMitlGSlldNNatoma2Oy1diN9IXMEMMRgudZe1i2rygaxtY4wWWYA6o4MM1Rs1R9+Tjrmf+zGv1/70X751tdWhRI4u3D6uP+8+vxvHjk45b+nr0tfH1BrLXc9KDMWr5fmj8xr7EHeez59Xl3vDACq0G6oL9wRjEgyVJaRdcxuSob8/JmYjKOlbYp1ywBbUsbeQxJQr+49TNZ7sLQmSyrIbgaAuik/YJbP02g32uOpr0hb++xbNpFi4KznG+v9r4erXD9sMvp39e/r82j5Rf26FvT16Otifmm1bloiccYnvuSXYwyDPu+MxGOFEpDMR/0bgHphTRpEmZWyjM5fZArKOYU5Dn3BBcioj6NmLCaMdCcTBKYB2GEpoL6dgHr1vLHb5j1YOm+lmJUpnb8JOAKTmMYQoBq6vtej/+oPZH/6GRm+cvWW/zt77AW/fX+PyP0r18g9n35Y7nlgpcxbtKzq59NMMl2f7OzrL9Qkk2y818O6Zai1lo8+KDM+8WUTfdF+6N468pvXmBgAABpLS/ClDPRDgxxpx+ciGfLzZ2IyjpYuhm/hEAPYYSygng3W4sLUj7NPG+mLlmVkTqvXFaP3IkBdEDBD1bR8oWZkjRU0K9LgVmmA654HHpY58xZ4baHMvKNtzCCaBseufDjol3e8dOGcH3yrJw2S6esoLTMJ1ELLnPvNBMuKtD99L74kiYXNBIgBTKhzY0+SUQBqQ7NfvH1K724P+65eXbsr7fh0rA75+Q/H4Pyg27GVNfHS3v5FBjJgCwH1eL6PyUj4N52ohGaLc+yvGgEzYBIEzDAlxaDZwd6MXHz315P+fL2DX9X0f013kmAZak7XDptuLFhWtPRffl3+8//yVfn8F5ax7QOIkixDgIjTknGpkPvQrcEOx0tTJcN88piUDkwZ6st2Di2AHcYC6pRrrf3xNmmkL5plFtV16TTQ1xXi8+uNQ2ToARMofw0zydNoY7aO+R+Vx1OPysLE3ZHa+LW/2m/tP/NIq3XTYFlYa5ZNpnVWm3z+v/qfpeev98vxvl8wXzVvAOohDmv+wHkHjPSj29UJMLB+WVwu3FrJHklzbgDMsXSOIaBe2/fiGbGTmRTl9zJh37SUZGsGJtbMEKAWCmUNH5UVDz8Qif5qP7W/lKRDPUyf/3lp/kin6T7quoIPfWWDHOw9LMf73mTSAACos+AudwuZXWsdnoZkyM8fh3KMCQn3zvhSXAwH7NlkpB/ZIMCD2tplpB/twVp5YOyAmiPDjFbTtupfPiyPp74sbe2zTW7w2i/tn/aT+aLVo2lWWcvc343ECeD3/niTzJzVVhI0Y/7IMAMA1JmFDKPuoGSWi1Yz/1PffqzsS2SXAbYE5xYC6jEW3Pxj5dgb1RuALIzfE2zNwPjIMEPNaanD9X+6Th5O/o6pfml/tF9RKx2JaJn+8S9KU8vMSPRVSzP+7lcKZb8LQbO3mEAAAOqLsozuvu5sTAI8Vi6y7RIAHGPHNuAdb9NMR91sZ3ubkjMWxi7IGAcwBjLMaHVprTOny8rkCtmw+Y9lWdd9oW7k+vzaD+2P9ov5odUzu6x5zv2ROgk89OgGP8tMPff3P5WL777HXJJhBgCoE0NlGVe7NvadG3uSIXehNwZjqBfXLGSPUGoNsMlKxk+aqaj7+czCe5l2A+f2qs5hRvqxg00ZGBsZZqirtvY7ZU33qhuBs0atGabPUwyU6fNrP4B6a/noZyKTXXZjX5nVJvetXON/PXzlqnzv28/6jwAgdkrqAHFjoiyjg+OeDPn5D8dgDK1sN/s4jAAcIyZABmodnd+9fkDs3AQSxbKMWSv7K2uZAWMrP2BG0gBtCq1tzp2yZu0q2bDpj/3HJZ+6ty4btP7d0ufR52X8aY1qLXd9JpInAs0yKxoc+ECOZF5hPkkwA1Q7QwDE9kKeiwu+h5lVNxBkFzKGtZHmMALYYuic0sf6hg1h5caFZATHrs9QX/Y6vK4tMK5pDAEaqZj5pU2zWPqz78i5M+/IxXd/439dKV2PrGP+R2XBvXf7Xzcqgw0YrWnGHGn+SGck+z5v0TK/LOOVy4P+v4++8Lp0rXyAzEwAfLAE6uD87vV9nRt7st6XiZC7ondl9zo09MkQnzsTkzG0cEGci+GATVYC6mSgNua9TMbIe5kuLRccpfOCZugZGTulwbJDXlvBVg3cRMAModHglmaElWabDV8Z9oNn6uK7v5arwzdLw81onSEd8z/mf61BstaZrQwizGi+895I9/+eB1bKm0cO3vj3wQPPyeNPfImJBWDFAEOAmNFA1eaQ+6DBjw0uDLaBzIcDMRjDpJGucDEcsMnKMaKXqXDqvUxx20tHbOwyXksZ6YsGHfee371+A5s0UFBBwIw6U6g/DaItTMz3vy4+sk0iCqKaXVakWWalATPN+NSgtQanAcAASoUgbvSif9gXmfyyjDEpFTiZsDMfMjEYw6SRfnAxHDAmKOlmYe1bMlAb64DYCJjpOT4dsbHTdU1ThvqT8vZjIWgGFDQzBABQg4NpxANm93z64ds/bRx5nYkFYEUXQ4A40bKMYmPR97WODHkyxOeOywVcC+XWslwMBzjGTuAAU9HQ9zIZsVEFIhnB4csY7JMGzZ5mTTOgooBZnkaj0WjjNF3DLMpmzpp92/dOvnHGL5PK/FbagNigDCJQX7sM9KE77oNsIPMhE5OhtHBBkuwywCYr65dxjHDzHJeIWpAnuPnD4hrN+r7wkDee3KwIp5FhBgA10DQj2jfhaEnG0YavXJWTb5xlcgF39TEEQF1ZuLDXbmB9r3oL+/VFfs0tQxfODnPYAEyycIwYCLK30VhWsvqSERy7fYb3Zw2apdi84SoyzGg0Go2sonGdO/MOc8u2AACoA0N3F8e9LGOYmQ9xuYBr5UJkhiMHwDGC44MpVsY9ihlRljMi9Y7wvUGJxgSbOVxDhhkAYFxkmAEAUFcWyjKmYr5eRTLE545LebDlBvqga8FRKhgwhgxUtwU3/2QNdGV1RMfO+vsEzdI/6u3nm9na4RICZgCAcWlZxsGBDxgIAADqw8qFkliWZQzuik6E2IW4XMC1cEGcUmsAx4eJZJgKp4/PiYiO3a4I9FFvqtrhvac67bUkmztcQMAMADAhAmYAANRHkDFjIWgW17KMYQcC45JhZuGCONkjgE0JI+dTgupuH58TUcyW97bbjEQn2Kv7uq5tdojAGeKONcxoNBqtBi3323cjfTI4e+zIuP937sy7zDFrmAGho34+YszCou/dMS3LGGaJpkwcSggaKrfGxXCA4+y4x1umgeOzRHMdM7U9Yv1NCoEzxBwZZgBQCyNXIt394cuD4/8nMSAANiQYAsTR+d3rNQvJQmAljmUZkyE+9wGOvTXdTwiYARwjxsPxIdzjc8ZIV7oiPH5RzEjX91iHglKNKfYExMm0sn8yzxVTABhP7oOsNN+ZiGz/z2ePT3QC4BwAuImLD0DjpL0W9oLqa4N+xEKQGRVm1hzlGDkfAS6w8CH4DNMQuqyBbSHKmfJbJLo3Lum87/Xed+2Qwpps6fO712fZJRBlZJgBQA3kPoxvSUYAbopDKTEgQijLWIfXE+JzZ2N0seheA33ICgBzKNkKY8fp1VEdvOA9w/aIbwP6HnKr1zTj7GmvdbNbIKpYw4xGo9Fq0EYunYjsiUDLMZ499gLnANYwA6zrYggQV0G5OQsXm+J0cSPMC2e9MRrHhIE+vMpRAjDJyk0WBMzCd5jtccrvBbfFaFvW95NPB+Uat7EWNaKGDDMAqJGRS29Est9vHjnI5AGIgnaGADG3y0AfNsVhIINMuWSIXdgXo+3Sws0KWQ4PgElJC52gKoIJFuYgDjfXbTAylrWSkFuzzlLsKogCAmYAUCMjvz4ayX6/9eI/TvITZE0BDuOOXaBxLGQldcXkLuBkiM89EGQMxoWFmxWyHB4AjCPDEPCZIS6C9w9bYvryNOtM1zp732t7DZV0BW4zrfwf5YKpGdevSv7yqBsOLr8vMnJ17Jm7cllrrlX2HK2zpGnmrPH/v63zln/6P9s6i7mB07QsY/7qgDTNiE4SxKUL/ZNmmM2dfxfnAMBdlu5wXM50IM50/YrOjT29En5ZRH3+nREfTsox1oCh4GmWIwRgEu/NYOo47Z23kt77qUzE3w+mvdeh72NSMd1W2oPXlvJep243mpWfjtHar4iBaQyBAcOXC0EtNXjef8hfvypSEhTLXzrf8G5NfHn8tQn/t2nWXd7WNaPwj9Lgm36/xfv+tOmFnwFi5to7h2TGvesi09/nvzN59ae2OXcysQCsfLgC4u6AhB8we0KiHzDrDnkO4yJhoRNcRAN4bzaBw0yDjeN058YeBqJ247khyMCKexaWvs/Qko1bvdeb8R73acCQLQBhKz9glie7oFr5wQuFLy5duOXfec0Ku341nq9ZX1vpvyf42aY5QbbarHZp0mCa96jBNj+g1jKdDQiRMvLrVyR/9yORyDK7cPq4vPaj/ZP+XEdnO+cAwF1aFiRp6AMVEGvBXcU7JNyLkFqWsSuqZQWDrKgwjxcZtmQAAPi8MEWPeO2QxD9oVqSfOZPB+2DN1t8VsxLXiBAyzGrED4IFWWH54Q8KWWOaIRbTgFhNx66YPec9jnVJvmnOPD8rzQ+gadnHmbOkqW0eAwez3nv1/5KOhzaa7+ezT/3lpD+z8N5OJhRw2yU+AAMNpxcJUiH3QbPMonqRIszsst7zu9cPxGhbTBroQ4ZDAsAxYgJZpsGMjIFtIjafF/T9ROfGHteCZqq0ZKO+F90Vw/dXMI6AWYX8zCkNhGlAbPB8deuDobIxL2bm/aZ/1NarQTTvOHrHXYVgGoE0GJEbyvqZWw9+4XGzfXz5mb1y9tgLk/7c4k8uZEIBt5n6YKKZI5TmggN2SfgBMw06RXXR+TDXLzvA5gsADcX7QsSWw0GzIn3Ne722wxuHtBSyztjnUXcEzMZz/arkPxzwyyj6GWOaOTaqzCAMzJEG03SOSr+va6bNCoJoc+ZJk2altc5ivNAwbe2z5ODf/O/SuWipzFu0zFz/tBTjs099s6yfXfLJTzChgNusZZgkhAsjiDktPxPcURvmhZGE14ek15dMBIcwzAyzDFswAACo4ftC14NmSrPONmtjrTM0QgUBs3ivX+OXVNSgmAZfNDBG1lh0afafNs1Iezv43o0gWnshiHbHXd7Wz/poqJ+lD9wt+//qT+VP/rfveZtfm6HdY1B6vrG+rJ/Vcoxt7XfE/vgPIFISDAEcsU/CvyiiZRkzURo0DfKF+PR9Mbzr+V4DfchyOABMHm+tvCejTJsdFtY+Xh3HgQ3KEa7w9jvNtko5vp3pNqZrnW0N3i/vpFwjaq3ZyVetwZQLpyV3+qjkXv0HGfnJtyV37Efev18pBFkIlsVzzr25zb19zJ/rkRf3+3Of++URf1vw15sDamjJJxfKlcELfnBKg1Q2doNCsOxKmf1ZunwREwk4zmB2SYJZgSPSBvrQHcFxWxvic++L4XZo4Zh7hsMBwPFhgveqfUyFGZcYgrpv7xskuiWz63EM0qDZ+xpINBTERwxUEDDLR7Zpxlj+nV9I7o0fy8jPnvGbHyjxvkeZRXf524UGTr1tIffq38vIi9/1txF/u9CMwwhv87TwW+vM6bJi5Sfl/OnjJoJmxWCZ9qccWlZymR8wYy4rbwDqaDVDAEcuiOjdXOmQu9HeubEnFbGhS4b43L1suQAAoM7vEXd6D1qikTv/b9L3q6e9962HQq42gJiIZ4bZlcuSf+dNyb3xfCEIoplEp49K/jfnyB7D+HRNNG8b8TMPNQvtJ9/xtyHdlshAQzW6Pnu/tM6c4Qepnvr6o/7aYWHQ5/3W11aVHSxTq/7gd5hAAEUZQ31pZzrgEAsZS2ujMljBncVhlbHMsgg9AABohKAKiN7hzM06t0p6TYNmpyN40xcMKT9gZvlm/mtXC5lCb70oIz/7noy88r2bAbLr15hlVO1GAE1Ld/oZaM/725oGZUmkoU3WWltnyKo/WOFvS5cu9PtBs5ef2dvQbfj57+zyn/dKBRluC++dJ0vuX8gckmAGWNTFEMCxiyHZkLvRHaESN8kQn5sLVgAAoJHvEwe8tk4KJRq5y/9W+t51L4EzVCuyJRn9cnr9xyT383+QkZeeltwvX5T8xdNkkKF+rl8rBNC8bU2Dsn5gNnu0sO4dUQLaOG3ZZxb5AaiiZ5/6pl8asd7ZZmePHZG9X39Unv/2rop+TzPi1vyXK5k7ImZAqcOWOkOZDTjGQpZZVNYyY/0yAADglKBEI9lmY0sIgTNUITolGTVYcTFbCFZogOzn/yi5t1+nVB7CMxyU/vzFP8nIT/8//1G3UYK2GE0DUBqIKjp77AU/6+v7e/6s5oEzDZRpQK7nG1+tqARjkWbEtc2ZxaQBKJU1+MEHcEXaQB+eiMhYhRXY03KMfWyqAAAgDCXZZo8Y/Oxm5fMjgTOUbZrp3mlA4jfnJD94sVBeETDM31aD7bRpVrs0dXjH47Z5/tdwmwagHv2j35P9//ePbvn+az/a77fORcvkwUcel/tWrpE58xZW/Pe13ONbRw7Ka4f2VxUkK1q2fJGfEQcAo1j70LWcKYErdF0s74O93jEcZpZXl9eHLstBIa9/YY4Pd3QDAAAL7xsz3sMi733RZu9xq7D+82gJKQTO9GawLdzwhPHYC5gVg2QXs7HJHmueu1SaWttu/LtlwUrJDw9K7r0TN76nX+v3EA+67eYvB8fd1lnS9NEFfgCN4Jm7tCyjZpod/Nsjt7+pOX3cb1quUYNn8xYt9QNn93z64XH/3tnXX/ADZZpRpo9TteSTC2XNV1YyUQDGYu2DBOuYwTVa7i/ssohPGDwWlFod4nMfZhMFAABWaJnGzo09ae9LDZxtEgJnoyW9dtQbIy1nuV0z9BgSlKogYFbHdVn8INmvYhEk0+CYBsS0Nbct9P9diZFzR/zgmTb/68F+ttKoC0o3aisEzz5O8MxRyz6T8I+lB//2xfHf2ATBs4JdDelXR2e7rPnKZ4X1twCM84FrwPswMWDog1aSWYFj+2Cvtw9mJdxypCkpLCpvVVgBRS2BRIYZAAAw9xnOe9gWBIUInI1Nx6XbG6MNQXYe4AsvwyxGQbJpi9f4rWXRF2/JJKtGMdhWpIGzayf2y8jpZwmexYEfPHvLb8XgWfPd9/lfww3FkocTBc0a2p/li4JgGQBMSDNLklY6432oSfKhBo7RLLOtIT5/u5Y9tBgc0nKREl4wkWAZAAAwa1TgrDt4P5lgZG7QsThEthlKlR8wy9cg82DkWiFI9v6vIr8mmQbGpi9PyfSlj0vT7AV1ex7NUGv9/F+IeE0zzq69mpbrpw6y5cZBEDwb8VpxzbOmjntFWqYzNjG37MGEdMxrl/3/zyEZvnIttH48vOrTsvLzn67N8R1A3GnJsaSh/mhfMkwLHJKWcANmSssyWgwQhXlsOsCmCQAArAsCQfp+Mt25sScVvK9LMjI3FLPN1rG2GZob8SQaIMudfFlGjv7Ae3wp0sEyDZTN+OxGueO/zviP9QyWjaaZZzO/9C2Z9cRhP1CH+NAsy1y2T0ZeOiC5N38i+YtnGJSY0zKIG/7tl2XJ/Qsa/txtc2bJ4/86WQiWAUB5ssb6s5wpgUu8D+66D4YdrNKLCBZL+awN6XkpxwgAAKL4vjLttUe8L7WlGZEbElJY2yzFULit7AyzfKVr2wx/6F/015KL+nUcaIBMs8qmWnZxqjRI1/r7/97vy/CP/9LPPEN8+FmYXpMzfdJ018el6e5/JnIHZYbjaMbM6fLlP/qcnDtzUQ4+85IMXrpc1+dr9Z6v67P3S9dD9/lf51mzDED5rN1ll2RK4CBd3LQ75D7oBYSdVgYkCOCFdTwgWAYAACIrKHGf8d5PbQ/e47HOWcFeb0xWe+OzgaFwU80zzPwg2fHnJHf07yTffzwWwTLN7LrjXz1TyCgLOVh2y+TNXSofWfc3fslGS/1CjVy/5u9PuZ//UHKv/bCQdTZyjXGJoQX3dkjq331J1nzlIT/7q9YKgbL75Kv/zRpZ+fll/r8BoMIPUxows1TPvT1YtwhwaT/MSPjZnpuMDUuYAcTDbJUAACAG7zGzXtvmtbu8f2qQiJKEIinv8+Yho9UVUGcVBMzy4zddi+nMq5J7+W8lf/JlyQ9ejM0AaZBMg1IanLJKM800oGe5j5iiywP+vuUHor1H+XBg4n2SFsm29DP3Surf/aE8/q9Xe18nphzYWnhvhx+ES/3bL8mqNculbc4djHNDGhBb1j44dTMlcNCukJ8/YSxYvTbE5ybDrDHmMASASVkLnfDOSUmmguM1aico17hCKNeo9PhC0MxB06byy7o2mVw8WygfFzOasaXrhWl2WST6O3uBHzQb/uH/KNdO7GfLjqsg68zPNps1R5rm/zNp6riXcYkZzTjTJvK7frnG/rMX5eK7A3J1+Jr0nxn7hgRdE00DbPp7+vWCezrIJANQa4fFVinE1UwJHJT22o6Q+6BZZlZK1IR1TOo9v3v9gAPbW9ZAH8gmBgzSjJTOjT0MBKwdr8n+rt0+npFCucYt3uNmrz0hhTW+XNyuNWj2iCPv/SDVBMxGggv27/wyNmuTjeaXOvzyX/tBqKjRtc00yHfl2T9n6467y5ckf/Jnkj/z85uBs9Y7GJeYuRk8A4DQmVvHTO/244MLXKLbu7fdp6WwzkRYuvXiSdj7ntcHzTIN647fA45scmfY6wAAcPu9p/ewTVvw3ksDZ65V+iBo5pjyA2ZXLkv+3BuFrLLr8V1HqbguWJTXBJv2qcdkpk4ZQTM3aNZZ/wm/adCsqeMekdlzGRcAQK1lDPZJP6ylmRo4Zp+EGzBrN7LvhZllSjlGALAhwRAAjXF+93p9/9PbubEnEbwXdSnrzA+aeW0FW0L8lb2GWa7vHwpl4AiWRYIfNPvif2ALd4zuo7njP5b8Ca9dPMuAAABq+QFJ76azlmVGWUa4uC9mDOyLmwwMRVh3N/dyd3FDJRkCwKyMgT4kmAaO1yWyTEND3otmvbbNa4ukUKY748hL7+rc2LOXLSD+mhmCYCBiFCwrImjmrvzge5I/9bMg0H3WL6UKAEANWPsw1M2UwFG7DFwwSIT15N5z612+YT3/AYe2swy7GgAgQrIMQWOd370+7bVHvC81eLbTa3G/qSjlvQ/dzMzHGwEzjwbJ/DXLYhQsK9KgWevn/4JJdtXwh4XA2dF/8EuqEjgDAEyRtYW024Na+oBrtCRO2Bckwswy6w557NFAQYAUgD0WLoxTbYDjNAwIss62SCFwplln2Ri/3B1s8/FGwMwz80vfkqbZC2L7+qYvT8nbcx+ToSvMtbNGCuucFQJnJ7x/X/W+mafRaHVpQKxlDPZpLdMCBy9K6EXKdMjdSDm437tWjtHKa21nrwdMepUhgLHjdB9TEf571CDrTANn6yS+2eqUZowx5wNmMz67UVoWrIz961z8lb+Qvzv9cTl1kYu5TvMDZ29I7uXvS/7UK34GGgAAlXwAMvihp7tzYw8XU+GisMsyaoZnqtFPGpSCDOuuXpfKMeox38qFR+7iBjCeJEPAcXrUZxXYeR/RG5RrXCHh3+hV823ee0+6jVmOJ6cDZhoo04CZC1pntckX/7v/KD/4eV5+eJygGcRf2yzX949B4OyykBVEo5FhBpTJ2gVjDZZRlhEuXoTISvgB7CdCeE7KMbqHmyIAmzIWOsGNUxynA2SX2X3P2uc1LdOoWWdpic86Z1vDXNMX9eN0wGzmF/+DU6/3ngdWykNf2SAn3snLt1/MyfB1dgAUA2cHJX/qKBlnAIByZAz26QmmBY4KO8ssGcKFgrD2915H71y3cMxnjSIAEyELleO0IrvMuGCds2LgbHtM5ozSjDFUfsCsKV5NM8vivG7ZeH7vjzfJzFlt8t6QyNOvBEGzJhpNJP/eWckdy/glG+X6Ve8beRqNVk0D4v9BR+/ezBrrVpK7++Do/thrYH/c1KgnCrIIKMfoHo7vgM1zUMZIVwiYcZxWZJhF59ih65xtk3gEzvRzaJJZjRcnM8yaWttk+vKUkxOupRl//0++4X99S9AMULrG2a9+IblXn/Uf9d8AAIzBYlmyTUwLHBV2llkjP1hRjrHxDhvoQ4KSa4BZWQN9WM40hCc4PicMdOUMsxEtMQqcbWU248XJgNmMhzb6QTNXPfiFx2XOvIX+137Q7GcEzTCKBs7OBYGz86eENaloNNYwA0Y5bLBPKS6owlHpkJ+/3dv3Ug16rrUhvUZXyzGqrJF+kEECcIzg+GCTlfEnwyyiSgJnKwy8r60GWWYx41zATANl0z71mPMTr6UZiwiaYVwaODt7THI//6Hk33ub8QAAFD/UaKaFtYvHGizrZnbg4P6o+2I65G7UfV2xICAe1j7ucjnGrJF+JNnbAZMs3ERFwIzjsyJgFv33tMU1zjRwlolY91lTO0acC5hpKUaXs8uKNMtM1zIr0qDZ82+SGYFxDH8o+dN9kn/jJyJDv2Y8AADKYnkyymHAVWGXZWzEOoKUYwyHlQuQlFwDbMpa6ATZHc4fnwcczgSPHV0z22uPeF+uE3trZ4+Haicx4l7A7FOPM+sBDZqVOvGrvLx6lqAZxpcf+rXk3viJHzzTIBoAwGm7DPYp0cDScIAZemFBwr8Tt97rCFKOMZxtS1+7hdefZE8HTLISVCfLzO3jM9ll8XwPojcsabbZ9oh0mc+hMeFUwGzaojXSNHsBsx743Uc33Pa9H7+Z97PNgIloecbc689J/ldv+mUbAQBOfoDRD6ZZg10jywyu2hf2RYI631lLOcbwWLgQ2d6ALEYA1b0ftGA1s9F43nFZA5UWsmoOMxuxPcaUrm9mPTBKWcaYcCtgtngNM15izryF0rlo2W3ff/Z4jsHB5HR9s3O/KATO3n/H+0aeRqMJWbpwjsUyZWSZwdULCmkJN4hdtzXGvH2acozhsnIhMslUACZlOD44y8q4k2EW//e5WqZRg2Y7DXezi5t74sGpgFnLoi8y46Pct/L2IKJmmL14iou+KJOub/bLlyX/xk9FPhxkPADALbuM9ossM7gq7CyzepVlDKscY5o1UXxWLkSuZSoAjhHjaGcds1CsZhtEI3nvy7ZIYW0zq+/POA7FgDMBs+a5S6WptY0ZH+X+z46ddadrmQ1fZ3xQPn99sxtlGq8KWUY0MswAJz6wZMXGXcWjkWUGV+0M+QJCV1CeqdYoxxguKxciuQgF2GQlC5WgeuN1G+hDNvhMAnc+g2r2/yNiM2jGcSgGnAmYtSxYyWyPYd4YJRmVBsuef5MLv6hc/tybknv9x5J//10GAwDcsM9ov3bUeT0lwJwgGyrsEoI1zTILyjGGsS8PBBdk2K4KFyKzBrpCBglgE0F1B4VcLrlUhtlw8r2JHncsBs04DsUAATPIPQ88POb3T/wqL0NXGB9UYfi3kv/lzyT/1st+yUbJ52k0dxrg3oeVtNi8u08vsG9mhuCg7SE/f6rGweqw7tQlWHYryjICGO+9YFZsBNVZP8jN4/FhpsLZY4/FoFk7x6HoKz9g1hTt1jJ3GbM9js5FS8f/VHQ2H/m5p4XX8pfOS+7485K/kGVHA4B4Sxvt11Y+sMDBiwf6xisTcjdqGaymHKMNVi5IdjMVgElWbjLgGOHeWGeYCqff92rQbJ2xbnUxM9HmTIZZ0+wFzPY45nQsHPf/3vgVa5lhikauSf7t45I78bzIh5eE9a1orGEGxNIuw33by/SAfbLhnqjFH6EcoykZI/1IUJYRMMlKUH0TU1F/IZ6fR2P9MmjQTN+j7DTUJQJmEedEwKx57lJmegLjrWOmNFh2+gIXgFEDHw5K7sQ/Sf7tE34QDQAQqw8p+kHV6sXlpKE1FoBG7ZO6P2ZD7IIGNVI1+DthlXtKsxXdtk3pHdxWSh49wYwA5mSM9EPPP1ysrj8r5Ri5uQVF28VGaVi1nOmINicCZk2tbcz0FJz4FWOA2tHyjLnXDkv+1/1CJhKNDDMgVkxnmdV4TSUgKhcOwlSLoEZYwe59bD5jMlNyjWM6YMv53esHDB0jyDKro+D4mzLSHdYvQ+kxaLuR7vAeJeKaGQJMtIaZOvc+ZRlRY1qmMfua5N98UeTDIcYDAOLxISUjdtcQ0A8tlGaEa/TCZZgZQcmp3OUfYrmnbJBNhdtZuTBp6WItAHvHCILq9bXZSD8on4zRn0fTYiPLLMlsRJsbGWYzyDCbSOusyceHsoyoh/zQb0aVaSQ7iUaGGRBxlrMy9OLJZqYIDl000GBZ2JmfU7nLP6xyT1x8i8bYkEECcIwYD0H1+nqC7Q2GbWcIMFWsYYaynHufMUD95C+cKZRp9B4BANFl6K6+8WxlXQs4Jh3y86emcJd/WOUYd7HZjHuM1yCsley7Wq2TB6B2x4isoWMEQfU6CI67CSPdOcCMYAy9RvaVBFMRXU4EzPLDg8z0FGlZRqCuRq5L/u03JPfacyJDv2E8ACC6LN/V55dmpEwPXBFcvEyH3I2KMztDLMfYF4wZxmcpk3gr0wFwjBgHQfV4H3cpx4jx3vvqzT0ZC8cgZiO6nAiY5X59gpmeosHfigz9lnFAA1z9reTefEnyXiNwBgCR/JCSFttZZpphtoOZgkPCzph6okG/Uwv72FwmZekCJRfEYQ5ZBaHfpFGKoHptt2093lrZvgmWYSKHGQJMRTNDgAunj5f1c4NXGCs0jr++mQbOssf8IBoAIFKs147XMnHbmCa44Pzu9VoeKxNiFyoKagQZoGGVY+QC3OTbU1bslFxTXBCHNQnHjxEDho6lBNXje7ylfDImkmEIMBUEzCBXLg+V9XOUZUQY8r8+55dp1HKNcv2a9408jWa7AShmmVn/oLKViyhwSNhB7ErWkgktWEY5xrJZysRLcAMEwDFikvd7lOKeImPZZdngZiBgPGwfmBI3SjK+R0nGiQxfZo032Je/cEZyx56T/DsnRUauMSAAYN/2CPRR1zPrYqoQd+d3r89IuKVSu7x9LVnmz64NqY8H2FLKljbWn02UwQNMnXM0w2zASHf02LCZWaleEHC0VM6c7DJMdgwaYBQwFU4EzPLDBIQmPJBkyyvJeI7lpBC2ket+wCx37MclgbM8jWasAQg+qGQkGuUwDhE0gyPMZ5mFWI7RUgmxKBzfrY2Xbjd7mRnAFEtBDYLqU7M1OM5akWZKANRT+QGzpmi3kV8dYbbHUe4aZnHYDmgxabnrkn/3pORe/7H3eMoPpAEATNoQgT7qBQCCZoi9oFRqmHfcdpdxwTLMcozcjVyZfcb6k/S2L7JIYAHvJwrSxt7rEVSvQvD+2NKxNc35GmXKMASoljNrmFGWcXyXLpwr7webGCsYU8w48wNnZJzRyDADrAnWA4pCaUaCZnBF2Hf8b53k/58IqV+UY6z8+K4ZZllj3dpKFgmMvKfgGFF4D5g21KUka9dWxVqgkXKMAOqOgJnjdP2y85VkmAEW+YGzU5J7/XkyzgDAnp1i76LqWAiawZX9MewsszEvJgeBjmQIfcoGwR9UztqFS922nh5vGwMa5F6G4AZrmag7CKqXzxurbWIrYzLjna/7mBmUic90qJozATNKMo7t7DHGBXHa0UsCZ/1vilz9rZDtRCPDDAhXUDZlS0S6WwyaJZk5xHh/TIe8j41X2im0coxsGVXTbclaaSy9QLaDqUGIEgzBjXNORmyVRfOD6szM5IL3wluNdWs7M4MK93egKu5kmA31k2U2hjdf/EcGAfGjgbOLZyX3+j9J/sxxkatXGBMACFGQvRGVi9LFoFmKmUNMhZ0VtGmc74dVjnEfm0TVx/YBsVkeK8V6Zk7Lhvz8SabgFtaCHF3e8YGg+gSCLF1rgcVsEIAFyt2Ggao1u/Rir/1iPzM+yltHDjIIiLX8b94pBM7eekVk6H2Sn2gkmAHh0SyzKC3SvZcLKogjA+vKtI8OSAclssIondNHeacpSxvt1w5ufHDWmbA7QHnnW845GbGVZaY2c3yY0CGxl51DdhkqYeEYzPvLCHMqYDZy+llmvIQGy65cHiz751unMWaIrvwH70vul69I7hdHJP+bXwlRHRoRM6DhF0yyEfywqxdUDnGXImIo7H1xdJmnTSH1g+yy2hzb00a7t5eL4ggJATNb55yx7CCweTtvTPYa3H41uyzN7KACSQPvjwaYhuhyKmCmZRlZy+ym1w7954p+fu5sxgwx8NsPJH/2hORee07y755mnTOaEDADGvrBYafYu8u4nA9cR1nXDDHbF7Mh74uJUYGMsNYvS7M11ITlmyEImrnHwkXKtUzDLeecjMH3f8US3ATNAkFlBYvHyw3MDiJ2DM4yBdHW7NoLvvZzPhOpSxf65c0KyzGSYYZY0XXO3j0tueM/9QNo8gE3fwBAg6yTaJVmVAkpXFTZxvTZpUFNrz1NRmDZwg5yPBHMW1ewjzVaL3f/1kYEMogJmrnFQhmsJOcic+ecsRSDZs7PVXCMtLj2Y4a1y1DhtqzvKcMOhGeZiWhzLmB2/fRByQ+dc37in/9O5Wszz21rYo9BLOV/867kfnlUcr94yf9ag2kAgPoILlBH9U7Rrd6HsKPcjWzug3FK50UKa250S3jZSlHbFzMS7h3/ySBzk3KM8aAZxJYDkKxLiUZq51w05jmn1+hcHQousjv7PkqPkUa7x9plqNQmA31g/bKIa3bxRV99abfTk67ZZa/9aH/Fv7fgLnYYxFyxXGMx68z7NwCg9s7vXq8XTHZGtPsaLNOg2TbuSA6PXtgK5uC0FC7ylAYxKYVVvrCDRrqWWRgXlQeC4xBqd1zXYNku493cTBaqE9tixkhXNjEbt9li/L2dczdEBTcSWA2WpckuQ6WfD8RGWdEzzEa0ORkwu/aL/ZJ774Szk15Vdhnrl8ElWq5Rs85+8VIh6+xiP1lnAFBj3gdgvWgS5bvv9EL/Ucp8NfyDcLde8Pa+PB3MQWKMH0syUmXvh2kJt2yMzlUYwYs0s1+X7Wmb2C9D1C2sS+kCC9mOXXrOYipuOUbo8cFqxlAx08yZY4P3WjVQttnwPkx2GSq1I6T3laNlmIpoa3b1hQ//0186+brPHjtSXXbZRynHCEdp1tm5tyT32o/9rLP8pYveN/M02gQNQAWiuJ5ZqYQUynwd4uJrXS/oaDbZjiCbTINlk12AbOciZUVcvCBFOcb6iULJXT12HyJTONas3JCzg23sNlphIGu0b8Wg2eY4T4Buk0Ep65Tl9yZBgDXu73Gf5ua7mo1lSoyUwvW2XUoyRpyzAbORXx2Raz9PO/e6f/jUN6v6PcoxAoW1zvKnj0nuteclf+6XIh9+QGyIRrwMmNqHCf0gvC4GLyUZXGAhcFa7D70aJNscXNDRQJlevEpU8Ccoy1j+fqgfirIOveQ+LmTUdXvKiM11isZSzBTmuB3D/dxIP/S8xdp5tx4jorCW7Y64lm8Njnf6vspy+Uk9T++M+74QlADVAI/efPe+ZvxxPprSWFopLZphRqKv2eUXf/Xl3ZIfOufM69VSjOdPH6/491qniSyeR4YZcIOWbLzYL7k3X5bciRe8r9/2Dii/FSJFNCJmQFUXTjISjYyEcuiHXAJn1X/Y1TueUzp+wcWcHVO4oEOGWWV2OfRayS6rPz2mRyV7OFFy3E4wdTeOx8V1It+P6EuwtH5MigySMd/7WQ+sx6p8a/AeS99X6Xss64HADY7sCqXvcXVOUsH56HRQWaGLo0VZ23Yy2K6tOMCsRF/T0J7F5V3da4lnwKR57lK544+eif1EaynGnm98tarfXfrxJvn9BwiYAZP6yJ3SdFenNM2ZKzJjJuPhqNwrmbJ+bvaTpziwArd+2NkrtkvDVCMrhXJ3vcEd1bh93vUCgV6UWiu1D3KtIJOoonnQIKULpcPuYn9syDal+/PTEex6WhwpBTbOvKXGOB4/EgQ4ovQ69ELzUWPd2uJC1kxMzzvpYP4GIjrWuj9rsCwRge5uD9bDdGEf0DmZrPynnot2BZ8lshw5bhvDzWIvi3cRcxV9zgfM1PRPPi6tX/j3sX19w5cH5VtfWyVXvMdqrHuomZKMQKVuBM8+RvDMMblXDpf1cwTMgDE/9MQxaKb0AoveSb0vahcd6zTPCbkZJEvW8al2euO9hT2r7HnZJoUSdXGW9raJDcx2w7apctYctEqP2f8/e3cbZMV1Hvp+7WFgkBDD2MLCCjJscCQbCR2G2BZKYpmNDb73RErxosPY4p46zPjDcU7d4mVcZeeDrQJKTpXt+4EZqHP96Wo2pxJio0IaWdaHE2SziXQSITlhFGGwpRxmQyDWEEkZBkvmdfbtp/dqaTPMS7/36u7/r6q1Ac2e3Xv1Wqu719PPWr1Z77N10KKkPgySjRe86NJTt6btu5k49YOUYzdB+w+OUZoC63LMevW1xXBKyrekz+ullJSxTMW4PEf1/7DHYyMPgUmWfO6DZ/peYreB1xhV69gsondPv2aKQKmrvz6ops1foZo/tSFz302CZfsf3+Q7WNZ6C+uXAb787reqJtu//u8Pg2e3zbH/DACYkAQ32pXZ6yr44UyzItMyyQ2uEzzLTfaTHrRxAmRxHd91uk7BHcl82KaynWXGNDnx6tLtvZjCfZf+Y53uszP1dL/OvpK+eKVyN9hYTOlXrSjzAgVyLVCyjsGuNAYhw2aVQb9VFnLu2Z6C3ZVzowSftln7bHTgLIWBMpGGte3C5vX4OPdIMl2j9G9O8Cw3AXj9kMd2g69XexUygQyzBjO/+IPMBc2e/t7X1RtHD/l+/+qlBfXp3yMJAgjNjJl21lmh9XalJICGzBn9x7919XNkmAGT3ggdVtkLmk00OCDBM0lNrWRoMLbYcFO/UiU7YMO0jN6O3U6V3SwznvpNpk6ZODWeX6l8ul/3yaWG/rjo8VfI+WlVCuueiVN13dAnqfr0c2Wu+1J53edcw/WacJ3RMMX1tpReQ3flqS2EvO6W1MNnVYaDZ/o8JnW7U5n9YBfTMWYEAbMxshQ0e37vN9XrPz/o+/0tzUr9ly802a8AIjCtuZ511np7/ZWpGzOBgBkQ2k1/XoJmjeQGSwZdJIA2YPpUYPo4Odkjsq3UfzfpRpY1Y7wf06yuZZabdVEMrFemBy789teVhv56wJCydvrjkrUt069B23Mqg80pCtY6gRcZ8K7kcbpGfawOp/jcU1UJzB4Q8TqwccrddMkRnhcHGvqSSsrLqKjr9eaU3BNKwHI9V33ZQMBsHGkPmsk0jBIsC5JZJh76VEEtW8h4LhCbW2apwm1tZJ+lHAEzINRBgDwGzcaq6s1ZING++Y3jJlg//SraGo7DSv1aSkn55Wo9jJCOe1bXEuSpX+pV1Cq6vz4dZV+tgwvSLxf1tlC/RvbAgvU9Cimtd4MqfVNKDqgbg7HVnPQRaVrPbDLDY45fJcQyctq5ky2ahWtkqe+r8hYojvGcWNFl/JqqP/xQMbhMiurDhz3WpbDvXsVa1dlBwGwcl68p9faSb6tPrU7fAw7OmmVDgycC/R5Zu+y/PNRECwGS7KCd7LNZc+xgGtJh9NiLrn6OgBng6saJoJn7m+Gxjkzws3ITOtGAqmnZYWEhUOKt3RVVPcssS3jql/48aTIYPDbzRPql0+P87EoD++dUDgRa9U4yOLZnpO4c0XWmmtVB2QxPC1xVH84icGGSazdHUX0YLHCu20oZ7ReX5/EaLeFg/tj6OKCPxXDUGZINs1MoXafn6L+nvX6ncupiTIyA2QROna+pf25ZrR7e8v+ollmtqdjnM8eP2muWXXpvJPDvWv+5JjX/IzQQwBgyfaMEzm6bQwDNcATMgEhurAiaIQimZfTe7rKWDdSV93WCDOrPZYq8IqVBG4qpzmVpDb2xeqxj0s35BymWy3Vm9bnw31Owq04gbawjU7xvvIc+Shk/rGSXZQyrU01g8R0F9auBF9ST33jEDpotWLrC6P196ce96qUf9Yb23QmWAYa5fk3VRt5RytqcpxzsDLRZc6zXVqVmzrKDagCQNTJFi3VjKU/sETSDX3LjTsDMm10qOwOWwwTLjOrP16t0r1WUV8WU1rkBq84NZPT64XRG61q3Pl5c82VbVx6DZVp7yvezRPW9QYVgWfa4nnOvUMjftvr+grr07lm1//HH1M+efMKe7tA05wdPqL5vPBJasEymYpTvncfjzcaWtk29d8HqBM6o2qnjqnbiqKq9OaBqZ99U6t/PK3XpPc5wADJDr2sgQTNuRuDHOv00L9y3uar1Us7I1ylzRI2qWwO6Px+mNFJlZYr3vTejxySTwYaGa74Bml1m5T3ru0QVyFZ9pgiyh0WqJtHSrNTDy+tF9OpzfeqHX/+Cev3nB43Ytwvnz6rn937TzoALul5Zo9VLm+zvDSCFJEj27+ftoJkdPHv9f9WDab85Zf37kPX/f2v9UI0t8g1AVAMoem74MqUBH9ZRBJ7tysj36OVQGtefEzRLn2KK970/o3UtswGlhqAZfUT2lMn6TvUDCBhzrcw6ydlEwGwK8z+q1Irfry8zI2uDSZAqycCZEyiLYh9WLy3Y3xdAhkgW2tu/UbWz/6xqb76maq//naqd+qX9d/l3JZmz169RTgBSw7opkaf4dlES8GgtReC5rckAQDnlX6PCQIax9YugWboUU1zXpI5lLXA+rL9XlvsIgmbZU9bX8XnHdKPZMGDV550UQzYRMHPhgU8W1JL5hQ/+7gStev5zuz1Vo/w9am8ePaSe/t7XIwvWyfdr/I4AMkyCaJKJ9ptBPZ3jK/XNzkYbVOr8v9R/5solRbYYGWaAoYMocnOynkEUeFCiCHxJe3B6H4fQ6L6coFmKzNu6P839aE/G6lkupiukj8gUgmX1frSoWMMzC4b1vSgyqnBx72JXo3uFZoIpLxyvqZPnxi+ueYvuVXevWKMW3PegWrB0ReDPkvXSzhw/qt545W/sYNmlCNdPk0CZZJcBwLhmzlJq2jRVmDWn/vdZrTe+4gajA3/n6udmbzlFxwsEv+mUJzT7FE9qwp31Q3s29VMMntuZtLHOFO66ZGB8hCOYmr78sGIQ0XSpXnfIqmc7rZcdGTkWPdax6KaPQEoQLPuwLssU4c9QEtxTwGysVuXBQ58uqJHfKXXu3ZuDZrKOWH0tsXqm/4KlD6p5i5aoOR+7S92x6N56x2j9vWXMAPN56z2X3rtoB8iGqifsbLXzgydDXZdsMgTLAExJ1kaz1CYK3Dv92sxZqjDNOq3MaFFqeov+t1uVmpbRU83Vy0pduVz/sy6b2tVL1BcgRvLksXXjKU8ey4A+a1RhKjItIze33kmWWWcK97vMoUtdXy6DiEVKxFjFlNeznVY925yROnY6h33EIlUPmvGQVMquIZi27gasX5aNOs39RMYRMPOgxSqtDZ8rqBeOqwkzzRxnjr9sbyYjWAYgFE4gzXqdtGdsfGDACa598PdxAmtxBNsag14T/JsdBHP+Pt7PA0iUXuNi/byt+7er+pPjPH2MiUhQlSecvbexqtW+yip9QbNejl6q6pkMiC9XDIibLAsDvV26jqXdQN4qn1zv6cA6fUSK2luas1IjQt1NtzIB4HxgSkafXvxVTQ2cTu9aNSt+v2CvzQYAqaenjLxBgoGt2jV35wamZATCxxSNcGG5XhMF3tpW0XoZTNEuV6zjvIojl8q6Jg897FbpzGrMuqrVrhZloI5J/dqe8q/xEf3AEH0ETGQ/zGbV0QpFcVP9ZdHz9GJq0Rxpogj8kekZJTurJWU5erK/Dy8nWAYgQ2TKSMlya9zIAgNySQIh1iYZCrsoDUxgM0Xgq21VVbqmONzHUUttXRvWA1LdlIZxihn5HnKNkOYHJ4bzGiwb00dwrWcmaVurCJbdTD/Yh3QiWJYzBMwCkCkNv/pHTWru7HTs7/yP1vd38R0EywAAQHbpqTKWqxxOWYQpsdadf2kZnBxmCqhM9OM9uh+vUhrmmLd1fykDdcvOflH1LJg04trmw2u9NB/HLJJ1nVaRyT+hEkWQSgTLcoiAWUCttyj12B812VMcmpptJvslGXGy/prsLwAAQNaNyTZjMAWOIk/4+m5TVZWOLLMyRys7/biqB836KQ1z+tAM9WdpnbaVYMSHx7Ff8YCUKbqt47E+z9mPLiyjCFKni2BZPrkPmBXYJtse+P2C+uofN9lZZyaR/dm8skm1FwscJzY2NrY4NgCmDabsVAy44kZFisC3NGSZ9XKYMtWHS8agZJGQSUL/GXbdkiBLGgdCT1MNbziOVabjTlRV1deH7aEopsQDW+kh1xurmLEgv8gwC5Fkb62+vx6gSjpw5gTKZH9apnNsAABAfunBFBlslafJeQo5vyr65pfgaYC2pMzO4OrX+4js1T1pt4sUGYRJW5mxeiX1KW1BM65jxj+WOxXTuMbNnjqXKRhdI2CWnvuFRazDl2+Fi3sX11z94HQem/dq5HdK/epcTZ20Nvlz1CRgJ4GyT89n6kUASErtqqvTqpq95RQnViAh87bu77RedigyjfKiam27eEo0tPYj7WbQ0N1bT0A0F3WwZL300Ycn059abWxRBuuUDGQftra2FOzuR5j2bsrjuVNf5yG666ouAgqez1uHKQmjDev7BbIlQcAsLqfO19S5d63XoXCDZxIYWzyvYAfK5s6mnAEgaQTMgFTdvG5X9QGVNkojkyr6xrdCUYTediRY0WnYbmVyIB/04aax2lkho/VJgmbSt5mcBSJTlH6EWuj6eO62thKlEV79s7Zenc0Hb/VxpyKIazJ52KqbWQrgIGCWAAmYnXu3pi5ar2ffVdaruyDa3FalWpoL6q6P1v88dzaZZABgGgJmQOpuYGWgdZ0i4yxLyqo+oMMUQdG1G2krpmWZ7WIQL7d9uATOtikCZ3FZldUHEXR92qHrlIkqVtmvogp6OqZyjbeba7xQrq12EVDwXQ93G9yv5JnUZ7IlcRMCZoZ5+6JSl69++PfZtyiCYgCQIgTMgFTfzHYqAmdpJcGxfdZWZqqq2NqLaVlmTFOW7/pI4Cw+mV+zyOBpP3ussu+mCvo6pjvpH3ypKLL1w6qDRV0H13GvkbiqYrp2TIKAGQAAISJgBmTihrbUcEMLs292ZQqVfWSTJdJOisqcLDMJlHZxVEDgLFIVlbOBcwOn/exmfR36B9p7Juqi3GOs1fca1MV47x0IlGFKBMwAAAgRATMgUzezRVXPoNmseBLUpBtdgmTmtBFTssxWMaiHMXWT6XbDMaz73NxOxWZYkIW+Lrxj2qmPKf3DjaS991LPYq2PBM/iqddy79BPUcANAmYAAISIgBnAzSwiuck9Iq+snWFcuyhaL8cSbhMDVr1YztHAJPW0pOoPPtB/u+MEyZ5lcPGGeuQEYSXI0p7QbjD1bPjHtVP3D6Wct/myqgfKuM5K/nzl3G8UKZFApC4707VTr+EJATMAAEJEwAzI/I2sM2Dm3MwifJI5VrG2IwzWpqJN7FT1LJ6kdDG1Dui/Q+l3n5W+l8wSV3VJAmZOELYY08cOW8fmI5R+ZMdUjmPe1peStr6Pc6jR/UxJ9zXtlIgrVcVMFAgBATMAAEJEwAzI1Y1sm76RXatfi5SKLxVVH6yVLLIKT8+nsh3IWmZJZO4wgIwg9VYGxleqfGaeVZw+V9WzNOl3/dclJ3gm1wFRDmrL+XEVJR7LMc3yrAJyvSVZN2Ttp/Oc5dxzkC19Y51+VtdpgmQIBQEzAABCRMAMyPXNrPMkqHMzi/FvamV7TdUHaSsUSSbq/k6VTJaZrKu0kyOAkPpvJ4CWpf57eJx+lwHF6OqR8yCN1KP2kOtSj3Xsuinl2I9pY2C9mNKvwdTW2T1nLVP5C6BVFA/aIWIEzAAACBEBMwANN7NyAys3tM7AWTFHX3/sIG2V4Fim67oM1Px7Ah+9iME/RFSn23W/vUyFH/iIQlVv0ueedvpfBhKNqktFfT3QpvxlonVbx7OHEk30WBbVjQFRU6fJk+stJ5jAtVd+6mbjeauo0j+NIw98IDEEzAAACBEBMwCT3Mw6g2SlDN3MVvSrDMxU9cYgbf7qttTpwzF/rDwpv57SR4z1vKj7banvcxr671IMH+/0r9K3vqY+HEgcZgAx9dcESr86GSIL1fgP2HRzrI2+rlvY0D/ExekXjjRcf1FHMN55y9kaz11FlfzDfM59hNTbC855jXsJJI2AGQAAISJgBiDAzawzYLZMvyZ9I+vcxDoDtIobWUxQh59R9amB4rSKJ+dhaF/u8NOHO32s3fcy+A2ksi9oDIaW9GtjoEJN0E9MdE470nA9RqAcUdXb0jj/XAr4a506+wGu3ZAGBMwAAAgRATMAEd3ENj59HsYNrBh7w8oADPzUzaL1Mhjzx8oUn4sofQAAAABhaqYIAAAAALONE8iqUCowxI4EPnMXxQ4AAAAgbE0UAQAAAADAK51d1hnzx0p2WZnSBwAAABA2AmYAAAAAAD+SyC7bR7EDAAAAiAIBMwAAAACAJ3px+M6YP1YWj++h9AEAAABEgYAZAAAAAMCrJLLLeof2bBqm6AEAAABEgYAZAAAAAMA1nV1WSuCjy5Q+AAAAgKg0UwQAEJ3CjFbVNHeJq58dffukql0ZodAAAIDp+hL4zPLQnk1Vih4AAABAVAiYAUAICrPvUk23L1HT5i5RTXeuUIWWVvvvfoy+c1LVLo+o0d8cVdffPln/+8WzFDIAAEjcvK37d1ovxQQ+ehelDwAAACBKBMwAwAfJHJu2aI2aducKNe33VqjC7Pmh/W4n0Ca/d7r+t9rFc+r6vx5V1yWINniITDQAABC7eVv3F62XbQl8NNllAAAAACLnOmBWK1BYAPJNgmTNxTVq+v2dvrPHfH/27Pmq+VMb7E2Vvm9nnV379UF19Y2nCZ4BAIC47La2tgQ+l+wyAAAAAJErXNy7uObqJ2cQMQOQT3am1z2PquZ7Nhi5f9eqh9TV42U7Aw0GuOLutDp7yylOrACA1Ji3df866+WZBD5assu6OAIAAAAAosaUjAAwAQmSzfjM1lCnW4ykIy+usTeZtvHKP+xRV984yMEDAAChmbd1v2SV9SX08WSXAQAAAIgFATMAGCMtgbKxZH9bSt+3953AGQAACJEEy5KYipG1ywAAAADExkPAjJmjTCbrKRVaWif8/7WLZ9XoxXMUFDAJmXqx5Q+/Hfv6ZGFzAmey1trlv/8LpmqMXY0iAABkxryt+zutl3UJfPSwtXVzBAAAAADEhQyzlJGBfBnUnyYBstnz1bQ7V3h6f+3KiBp956Qaffuk/Xr9nforkGeFGa12gKm5uDpz/cUtj/ylulZ9QV2u/Lnd/gEAANyat3V/u/WyO6GP7x3as2mYowAAAAAgLgTMDCcD+TKIP624Rk37vQfsvwf9fRJkawy0ySD69eoL6lr1kLr+r68wqI58dYJW+5JgWdC2Zfp3nLbpsLryd3+hrr7xNAcdAABMqWHdsiSmYpRAWQ9HAQAAAECcCJgZavo9G+wgWRwZL3ZQzvo82cS1N562B9WZxg1ZltWssqm+r/QrZJsBAAAXJFjWntBn7yK7DAAAAEDcChf3Lna32MqMJkor6oMxo9Vec2j6/ZuNyHapXTynrvzDHjJSkDn2VIVf/qE9rWkeSdv+3d/8N6ZjjcqVUVc/NnvLKRYHBQAYad7W/TIN4/aEPr46tGfTIo4CAAAAgLgRBTOABMdmfGarunXTYet1izFTw0kwQTJSZnX+gx3IA7JAsjdvffQnuQ2WOW1bymC6zioFAABwzNu6Xy78tye4C10cBQAAAABJIMMsYRKIMilINhnJSrn8999V16ovcOCQSi1/+G2Cv2Ncfb1steu/oCDCRIYZACCldLCsL8FdqAzt2bSKIwEAAAAgCaxhlhCZEm5m6fv2a1pIVsrML/9QXf/NUXsNpNGL5ziQSA1pb81kVN1EAoiFllZ1yWrTAAAgvwwIlgmyywAAAAAkxn3AjOfgQyPTL874gy2p3f9pd65Qtzz6E3Xl7/+C9c2QCjNXEiyb9ERglc1M6/XSEYJmAADkkSHBsl1DezZVORoAAAAAksI8i3EWtqwbtOEnqQ6WOWQKyZaV37cDEWmYThL5RbDMHTtoZpUVAADIl3lb9+9UyQfLqtbWw9EAAAAAkCSmZIyJZGXN/PL/m7ngkgyyy7SSlw79N6ZohHEIlnlvz2SaAQCQD/O27m+zXnZbW6cBu9M9tGfTMEcFAAAAQJLIMIvB9Hs2qFse+cvMZmJJwOyWDT9J1XpsyL6WP/w2wTIfpMyk7AAAQHbN27q/3Xo5rMwIlvUP7dnUz1EBAAAAkDQCZhGTYFlLDqY5k2CgBAXfnU7QDGa0u+lLOykIv+Vnld10go0AAGSSnoLxmLW1G7A7klXWxVEBAAAAYAICZhHKS7DMIUGzeRv/Uh0+9yl17t0aFQDJdGq3L8lVu4uKlCFZowAAZMe8rfvXWdug9ccdBu1WF1MxAgAAADBF4eLexe4iGy3E1rzIW7Cs0eX3RtT+xzepj149qT6/pEm1TKc+IKYObUaruvWxw5md/jRutSsj6s3/XlK/d9tFCsNTJzjq6sdmbzlVoLAAIH3mbd2/3XqR9b960hDskUCZ9bLN2kqG7ZpMxbieGgUAAADAFATMIpDnYJnDCZoNnz2hvvQfmtTieYwLI3oz1/xQNRdXUxAhOnP8qPrn//F/qQfupg277wAJmAFAls3bur9xOkNZe+tZVQ/+DBu0j0XrxQmUFQ0sRimrRWSXAQAAADAJAbOQyRRmspYXGS5KXTh/VvV94xF16b0RtaxYUA/dSx1CdGTdrZY//DYFEYGfPfmE+u2xsh38hgsEzAAg0+Zt3T/R/ZMTPKsM7dlUTWC/iqqeRbZW1YNlJltvlVE/tQkAAACASQiYhVmYTAd3E8lO2f/4Y/af57YW1PoVTNGI8DXNnq9u2fAT2l5EJGP0yW88oqZfOkcbdlVgBMwAIKvmbd1fsl4Ou/jRAWurWNsRVQ+gDUewL5LlJtsyVQ+UtaekGGUqy25qEwAAAADTEDALkWSWTbtzBQUxxks/7lUv/ai3Xo2mK3vAXYJnAG0vPZzgN4FvFwiYAUBmzdu6f6f1ssPHW6t6kwCaBM8GnH8fLxtNB8PaGv6ppF8lOFZU6QmOjTVgfd/l1CQAAAAAJmqmCMIh08ExYD++z39lmz3Yfub4y+ryVaWeOTqq/uQzTWr+RxkrRgidWHE1bS8GC5auUPesWKPeOHrIbsPrVxRUy3TaMAAgd5b5fF9Rb6Wx/2Pe1v15KTsJFK6nCgEAAAAwlYe0sRrbBJtMBzfjM1uoTZN4eMsPPvizHTR7eVT96uwo9Yct8Nby4HdoYDH50tcet1/fHqnZQTPq30QbACDDShSBb+uTWNsNAAAAANxinsUQtKz8PmsnTWHOHXepz3912w3/9sI/1dSpIQaX4d/0ex5VhdnzKYgY2/Hn/rTL/vPbI0r97J9ovwCA/BhnmkS41zW0Z1OFYgAAAABgMgJmATUX1zAdnEsyNaMMuDeSAXcZeAe8kiD1jD/8NgWRQDueOav+gMDJszX14gmCZgCA3GinCHwpD+3ZVKYYAAAAAJiOgFlATAfnjQy2N3LWNCNoBq8kWE1mZwJ93qxWdf8XH/3g769Va+pXZwmaAQByYSVF4JkEy7ooBgAAAABpQMAsAKaD804G2sdmmUnQ7IV/GrVfAbdm/MFWCiEhn33kxnGvF0+SKQoAyAUyzLwZIFgGAAAAIE0ImAXAgL0/Y7PMBOshwQuC1cmSoHdjlhlBbwBA1s3bul/WLiNg5t6Ata2iGAAAAACkCQEznxiw92+8LDNxaqhmT+8GTKX5ng0UQtLteNV/uuHvEvR+5U3aLwAgs0oUgWt2sGxoz6ZhigIAAABAmhAw84kB+2A+98j4s7PIgPvF31E+mKTTmn2XmnbnCgoiYQuWrrgp8C0B73PvUjYAgEwiu8wdgmUAAAAAUouAmZ9CY8A+sMbp3BrVp3YjSwUTm7ZwNYVgcDv+2WujFAwAIItWUgRTIlgGAAAAINUImPkwfWknhRBQy6xWdc+KNeP+v3Pv1NSvzhI0w/hmLGXteFPcv+rmgNnI75iaEQCQSSWKYFLloT2blhMsAwAAAJBmBMx8aF64hkIIwd0PfHnC//fiyZqdbQbc0GHNvou1Aw0iUzLOW3TvTf8uUzMytSoAICvmbd3PdIyT6xnas4knmgAAAACkHgEzrwV2+xIG7EMyUYaZkGCZDLoDjZiO0Tyyltl47ZcsMwBAhpQognFJNlnX0J5N3RQFAAAAgCxwHTArFNhka2btstDItIwLlj444f+XgNmVa9Q5tob2VyS70zQTZYqePFvPMstjPQUAZM4yiuAmznplZYoCAAAAQFaQYebRNAbsQzVedoqDLDPc1P4IWKeqDZNlBgDIiBJFcIOyqgfLBigKAAAAAFlCwMwjBuzDteC+Byf9/wODrGUG2p7x7XiCTFHJMhthLTMAQIrN27q/aL0UKQmbTMG4XtYrs7ZhigMAAABA1hAw81JYty+hEEI2WXaKkGDZqSGyVED7M9m8RRMfm1feoP0CAFKtnSKwla1t0dCeTf0UBQAAAICsaqYI3Gu6/V4KIQLzFt2rhgZPTPj/JctsyV0sDET7o/2Z6o7ixMdGAt6XrxZUy3TKCQCQSitz/v1l2sXuoT2bKlQFAAAAAFlHwMyDptvmUwgRmHPH/EkDZm+PKHtat9ZbKKs8K9D+DG7Dd034/5wsUYLeAICUymuGWdXadg3t2VSmCgAAAADIC6Zk9FJYrKEUiTsWTZ059Nog07rlHWuYmWuqqVUHaL8AgPQq5ez7Vq1N1ihbRLAMAAAAQN6QYYZUOPuODLiToQKYauasVnXpvZFx/x9ZogCANJq3dX8pR19Xpl7sJUgGAAAAIM/IMPNSWLcvoRAisOC+B6f8GWfAHflEdpn5psoUPfUWWWYAgHTR63att7b+jH7FYWsrW9ty67suJ1gGAAAAIO/IMPOgMKOVQkjQuXdqqpV1kIBUOnm2ptoX0X4BAOkytGeTBMv6523d32a9rrO2tfo1rSRIVrG2ffq7AQAAAAA0AmZIjXPvKLXkLsohlwhWG2/OHfMn/f9MywgASLOhPZucbCzZZLpGCZqtVPU1ztoN332ZbrFibUcIkgEAAADAxAiYITX+bYR1zPJqGtOhGm/OHVNHs8kSBQBkhZN5Jn/W2WclVQ+crdSvbQntmgT2JEB2RL9WdLAPAAAAADAF9wEzxjiRMMlQoR4C6WVniX6CcgAAZIsOSH0QQBPztu4vWi+ylaxtjqoH0Zx/C8oJiokjDX+vWvtS5YgAAAAAgD9kmCFVZMB9/u2UQ+4QKM1G+32XLFEAQD7owJVslbH/T2ekjZ3Gsai3xmDY2N9ZoWQBAAAAIDoEzJAqI7+rqfkMuAPpbL/vK3X5qlIt0ykLAEB+6Yy0CiUBAAAAAGZpogiQJhffpwyANLOnVgUAAAAAAAAAw5Bh5sH13xxV0+5cQUGE7PzgCdc/K9kpWdB0+xJVmNE6ZX0DsubfRmpq/u1kiQIAAAAAAAAwCwEzJO7S++5TTv4tRdkpEhCTwJgEWZs+ukQp6+9+Aq6j75xUtSsjavSto+q69Wf77789m6s6MnrxHA3FcJffc9c4yRIFAAAAAAAAYCICZh6MvnuSDLMIXDifneCP1I9pC9eoaR9fYQfLwuD8HvndztJPtd+eszPQrp0+pEatVwmoZVneAoRpNDR40tXP/RtTMgIAAAAAAAAwEAEzD2oXGbSPwoXz6c4ekoDW9Pu61LSFq6ecZjEshdvmq+a7N9ibuH76kLp2+gV17c2DVCgAAAAAAAAAADwiYOaBZJghfGeOv5y6fZbAmASrpi/tsoNXSbOz2qxtxoPfVtfefFpdPV7OVFaWTEMJs7nNFD33Tk1aEAUGAAAAAAAAwCgEzDyQKfAQrvODJ1K1vxIom760UzXf1xlbNpnn/bP2TTYJnF35xz2ZCJxlfcrJLMjS1KoAAAAAAAAA8oeAmUeS6RLW2lRwv+5R0kwPlI3buPWUjVkJnNH2zJW2wDcAAAAAAAAAjNVEEXhz/S2yzMJ05pfmT8fYfPej6pavVNT05VtTEyy7cf83qFut/Z/xB+ncf0eWppjMmrSvQwgAAAAAAAAABMw8YlrGcL159JCx+1a47S4180/+SrV84fupDjQ5JOB3y/rn1LQ7V6Ry/1lD0FxDVTLMAAAAAAAAAKQbATOPrp8+xHpKITlz/Ki69J63srzr9nj2zc4qW/+T1AaXJlK4bb4dBJzx4HdSFwQkWG12WwYAAAAAAACANCNg5sP10y9QCCF485W/MW6fJIg0c/UPM5NVNpHp93XagbM0rQlGwMxcrGEGAAAAAAAAIO0ImPlw7fQhCiEEr//8oOf3zI0whiXBIwkiTVu4Jh+NP4Xfl6CZeSRY5jVTFAAAAAAAAABMQ8DMB3taxt+eoyACkGCZn0H21lsL0TQEHTxKU8ZVGJyMOsk4S4PRtwiYmeaNV3iAAAAAAAAAAED6ETDz6erxPgohgNcPH/T1vigyzOz1ytY9l+kpGKcia5q1fOEHxu8n2Z3mefMoxwQAAAAAAABA+hEw8+nam0+r2hWmIfPjzPGj1vay5/dFFSyT9cogZbHB+KDZ6Dsnye40yIXzZ9WQx/XLWqZTbgAAAAAAAADMQ8DMJwmWXftlmYLw4aUf9/p63123hzsdI8Gy8crE/KAZWWbm8JNdNre1QMEBAAAAAAAAMA4BswCuHi+TZeaR3+wyMf/28PZj2sI1BMsmYHrQ7NqbBzlIhvAztSoZZgAAAAAAAABMRMAsALLMvPObXSbmh5Rh1nT7EoJlU5CgmWTgmUimZZQNyTo/eMLzdIziY62UHQAAAAAAAADzEDAL6Mo/7mFNJZdk+jb/2WWFUDJTCjNa1cw/+Sv7FZOToKJk4pnoKoHqxL360z5f75t9K2UHAAAAAAAAwDwEzEJw+W+/RSFMVUbvjagXnnzC9/sXfzyc/SBY5o0Ezd4ZnW/cfl0/fYjpUBNuz37WLxMfYw0zAAAAAAAAAAZyHzArsE20XX/rKBkvU5CpGC+cP+v7/Ys/Xgh8nGY8+B17Oka4Z2fkrf6hevFEzag2V7vKdKhJkuyyS+/5C1jOnZOD8wIAAAAAAACA1CHDLCRXjzE140QkE+XV5/p8v1+CZa0Bp3GbducKNf2+Tg6GD3csulfd9sBW9ddHRtXlqwa1uV+WyTJLgGSX/cJnew5rHUIAAAAAAAAACBsBs5DIwP2lF/6MghhDssqe3/vNQL9jySeC7YNkSbU89AMORgCf/8o2deuCB9XTfzeq3h4xp82RZRa/INllH5tD+QEAAAAAAAAwEwGzEI2+e1JdfvHPKQhNMlGe/t6f+R5cF5JZZk/HGMD05VtV4bb5HJCAVn/tO3awzKSgGVlm8bfpXwTIFp1/O2UIAAAAAAAAwEwEzEJ27c2DrGemvfDkE2po8ESg3/HAPcGCZUzFGB6ZmvHzX91mT8toStBMgmVXjv4FBycmshZhkAB40OA3AAAAAAAAAESFgFkErhz9rrr25tO5LgOZhvH1nx8M9Dsku2zJJ4JnlyE8n3ukS82c1WpU0EyC1JLdiWidHzwReC1CAAAAAAAAADAVAbOIXH7xW+rdfzqYy+/+syefCBwsE4GzyxauUdM+voLKGKKWWa3qS197vF7HddBs5H0D2tvffouDE7Hn9wYr48UfpwwBAAAAAAAAmIuAWYQu/+2fhxI4ShMJlgXJQnGEkV3WsuI7VMII3P/FR9WcO+6q1/GrSj3/6qj9miTJMLt6bA8HJyIyFWPQ6VXJMAMAAAAAAABgMgJmEZKgz7nnv5WboJlMwxhGsEysbg9WNZvvflQVbptPJYzI57+y7YM/y7SMz79aS3yfrhzbw9SMEZCpGF/6UW+g3yHBspbplCUAAAAAAAAAcxEwi5hMK/ji//dNO0Mjqy6/N6Ke/t7XQwsMSmbZ/NuD/Y7muzdQ+SJ0z4o19lpmjnPv1NQrbyQfNJOpGWtXRjhAIbbtoFMx1ts0ZQkAAAAAAADAbATMIiZZFZItJRkaElSSAegskeyT/Y9vUm8cPRRaeT10X7Cp25o+uoS1y6Ku17Na7akZGx39dU2deyfZ/ZIMs3cOf5cDFJIXnnwi8FSMkmnLdIwAAAAAAAAATOc+YFZg87vNn6tU++KCHVR68huPqDPHj2ai8khGmQTLgg6oN3r4c02qZUaw8p5+XxctOwaffeTmcrbXM7uWbHtrOv20+kVIU4PmmZRhGFmj9lqEeev3AQAAAAAAAKQOGWYxeWhpQc2do9SF82fV/scfUz978onUZps5UzDKmmWXQvwOElSU4GJQ0xaupsLFYM4dd6kFSx+8sW5cVeqFY8lOzShZiucOfTc3awdGQcpOssvCOBbLFhNBAgAAAAAAAGC+ZoogPpI99aMjo3ZQ4dXn+uyMs9Vfe1zdvWJNar6DZJ3IemyXQg72zZ9bsIOKgSv07z+qCjNaqWwxuX/Vo+rM8Zdv+LdTb8nUjMHXoQvigU8V1I+ffELNW7RE3bHoXg6UBzLN6s9CCJYJCYJL0AwAAAAAAJhjY0dHu/VSsraFcvve8L+q1nba2vqfOnBggJICkDeFi3sXu0oHKcwiSyAMb19Q6q+PjN7wb5Kl8/mvbLNezV13682jh+yME8mQC5tk3m34o6ZQBtZnfumHatqCNVS0mEi24e7/3H7Tv8u6VZtXJ5vAKplug+/OVpue2E/QzCVnTcIwAuLSnqUO5DFgVnvPXZbl7C2nOLECAAAAAGKzsaOjzXp5RtWDZVOpWNv6pw4cGKbkAOQFGWYxk+DQ6uWFG6atkwyd/dZmYuBMpmb7xU/7Ql2nrJEMptvrloU0qN708RVUshi1zGpV8xbde1P9GHlfqVd+XbMzvZIin33yhRE7AETQbGphBssE2WUAXN6sd1rbSmtri/jjjjT8uaq3YZ6aBQAAQM64DZYp/XPy86soNgB5QYZZQk7+S23CtZ4kAPHZR7rUPSvW2AGJuEkW2euHD9rBsigyyhwymC6ZZRJEDMO0j69QM//jX1G5YiZTdL70o95xj2/SGUYStDtqbTOtdkTQbGJhB8skw/CrK5tyGzAjwwyYmp4C5rCKPlDmRlVvElSrWNsAT9ECAAAgg9fgRetl0Mdbl/OgGYC8IMMsIUs+UR8nHS9oJtk6z+/9prUpO2h29wNfjjx4JoExmXbxzC9fttdWi1rYwTIx7U6yy5Kw4L4Hrf/eHDCTtfpeO5VsltmyxQU7OD3yXj3T7Etfe1zd/8VHOWgNJDAua5aFuS6hrEdIdhmAKciTqm2G7EtRbyVr26EHE2RAYJ+qr91Q5XABAAAgA0o+37fO2giYAcgFAmYJmixo5pDglWwSPJPMM5muUQIUdyxaoubccZfvz5aMkqHBk+p89YQ6c/xoZFMujieKYJlgOsZkTDaF6MCpmh20Sip4Ip8rwZvnX6nZASEJRMu6a5/90y4OnOUXz/XZaxOGaf7cglr8cRKnAExMZ5cVDd/Ndr3tbgielck8AwAAQIoVKQIAmBwBs4RJ0Kz1VhnQH7UzciYzZAe5TqhXn+v74N9k3TMxb9GSSTPQJIPswvlzdrAgzuDYWBIkk2BZFAGUaQTMEiP1UNbiG0vqtGR4yXpWSZHgzeKPK3XqrXpgWgJEQ9UTavXXHk9kylMTSD8g5SDZZWGSdr26nWAZgCm1pWx/neDZjo0dHf3W6y6yzgAAAJAjyygCAHlBwMwA82+vB5EODYyqty94e68TpBgvWGEaCQ5GNVVb00eXUJESJAHbieqgTMuYZMBMrF5eUPteqH0QlJZA0fnBk+rhLT/I3bpm5+0pX78VSeBcpt+U9csAIKMk0Ncp28aOjh5VD5yRcQYAAIA8XAcDQC40UQRmcDKvnGkas0YCZRK0iGpqvsKMVipRguZ8bOLpQUfe/zC7Kyl25tPyG9uWBIye/MYj9rSEeSHfVdZyiyJYJpl8SQdGASBG261tcGNHx3aKAgAAABl3hCIAkBdkmBnEGdRffGd9XbOppmhMAwkErmkPf72ysabdyXSMSZoqS+vUb5Q9LWKS6gGd+rpqjWRqwjdeOaRWf+07mc02k6yyF578bmSZqJJVNjYgCQA5IE/ayhpna63XLqZpBAAAjaxrBCc7Xa4Viurm9aNknVS5fnjWuo4oU2KZPLb7rGPbT4kBQHqQYWYgGdjfvLrJfk0rCf6t+FRBPbYy+mCZjQyzRM2cNXvS/y/rmJkQAJZMx/lzb25XEkiSbLOfPfmEvb5XVsh3eenHvfZ3iypYJm394c81RZY9CgApULK2Yxs7OjopCgAA0ECmM9mtrxWK4/x/WSN1nfwc1xGZPbbPGHZsKzG/DwBSh4CZoexB6AcKasMfF+IJOIVoySeU+urKgr2eUWwVmTXMEuUmMyvpaRkdD39OTbjO1qvP9akffv0LdpAp7X7hfJcfRftdJAiZtj4KACIgTxnLYNduigIAAGjrPPxskeLi2EbtqQMHKqqe+eZFVb8PAHLBw5SMNUorAfNvV+qxlQV18l+UeuXXNXs9KGP3dW49q0z2mTqDsc69XbODqUmrZ0QV1NN/N37W2yXJyvpRr3r95wfV5x7pUvd/8VHVMisdGYySUSb7/epP+9SF82cj/zwJltWPKW0dQKRkSptun+8tqg8HKRbqP8sTv1EtXL5dpuh56sCBLg4bAAAADCTX1X0ur4eHrW09RQYgT1jDLCVkUHrJJwrq1Fv1NZjOvW3Wvkk22URZO4CQumsKyYja8EcTB82EBJxkfTPJNpOg2Wcf6VJz7rjLyLKVff3FT/vsYNmlmKaUlHYva8IBQAyGw36qVa87UbK2lfq1PcRf32n9fkXQDAAAAKaRNdWsa1V5IG3bJNfBcu0tP9PLOr0A8oaAWcos/nh9jTPJNHvtVM0OQiSRdSYBBwngyaC5CWsXMSVj8uYtulcNDZ6Y8P9LYOrtC8qY6fvcBM2EBKBkqkbZFix9UN2/6lF1z4o1iWedSTbZG0cPqdcPH4xsfbKJSLtfvbxApQeQ5oECeVq2X28SQCuq+sLtMnAQRvYZQTMAAACYei1cVf5ncACATCNgllKSzSXToT20tB6EOPkvNXX2nfqfoyJTLkqwToJ2pmWTFWa0UikS5iaAJHXUpPWu3AbNHBKYku35vcoOmi2470G1YOkKV2u4hUEyyd48ekid+eXLdrAsCQTLAGR40GCnbHph9h0q+HoTEjQ7bf3unZQwAAAAAADmI2CWATLo/9Cc+gC2DPqf04Gzs+/UPsjq8UqCY623SGCsYP/5w3XJAP9kHbP2xQXj2o+XoJlDAlZO0GrmrNYPAmcSRJtzx/zA0zdKBtnQ4Ek7OHZ+8IT95zjWJZsMwTIAefDUgQPljR0dknm2XdUDZ0HskClvZOobShYAAAAAALMRMMsYmR6xPm2jUg+oDwe27cCZi6WNCIwhSm+PmLlfTtDs+VdrvqY4vaSnR6wH0Ho/+HeZwlG4CaA5ATIR9xSLbkigTAJmAJAHesrGnTpwJouiB1njrE8HzaqULAAAAAAA5iJglhMSSMtyMGz03ZOsY5aw85OsX+ZIYr09tyRo9tWV9UyzsKY2NTHw5afvkGCZBOEBIG+eOnBAFjtfvrGjQ4JmnT5/jayJJu9fRYkCAAAAAGCuJooAWVC7MkIhJEyyrNyQKUNNJcGhx1aSSeVwMu8IlgHIu6cOHOhSwRZGL23s6NhOSQIAAAAAYC4CZgAwhmRUySYBtLySoKEEyyRoBgCwg2Y91ktXgF8h65m1UZIAAAAAAJiJgBmygQyzRF1+z335n3s7Hd9JAkYyReP8ufk6lhIkfPgBAoYAMJ6nDhwoWy+7fL5dgmW7KUUAAAAAAMxEwAyZIGuYITlDg9ks/9Zb61lWDy3NR/BIgoSbVzMFIwBM5qkDB3ZaL/0+3965saOjSCkCAAAAAGCeZtc/WaCwYC7WMEuWlwwzuy9JWX/S/kmlliwoqBeP19TJM9k7fjLt4heW5i+bDgACkKkZ262t6OO9O1SwqR0BAAAAAEAEmikCZMHouycohAQNVd2X/79dqKk0RuAlw0ymKWxfrNTfHq+lZmrJyUgG3QOfKqglC6jDAODFUwcODG/s6JCg12Efb19nvbdbfkeavrNef61d/7Woxg8WDljbsC6jSp7riFVepUnKyimnqlVOVVoUXLS7sfVo2KlHVh0aMHj/ctcXjOkr5XXs2pVVveW+n5yi/2wsR/rO7J0HuWZAEnWysS6O1z8Lpy4men5NUVly/kcmFS7uXVxz9YO3UVgwuCLPaFW3bjpGQSTk6e99Xb1x9JCrn5Uspg1/nP6UVQmYHf11OgNnBMqiVfutu5+bveUUudvI6w1WSXkLNFWsG65Vhn6XPuul08dbJWDWY/AxkgEEOU4r9YBCyeevqurtiD6OlYzWaRkoWNdQXkWPv6KSdBlZ38HZ77ED1M7AhxED1Lr/KI5TxlW9j5WYj3txnPZhl5nffdHHYrP+ve0u3zag69G+qAf4GvZvnYe6Htv+JdR25FitVRMPwE7VTw409AEDBn/XidrfgK7z1Rjr/HBD39mfRP/UEBCajJfrnbK0kSD7lOA5pKSP3zLlPwN/eExbqCRc1006tpEEb6Y6j+l2naoHvMZcy65rqJNBrmVT0Uc3fO/2sI9pQ3mu1K9tHspP2vKz1uf2KyAlCJghM279T0esenoXBZGAH379C+rC+bOufjYrATPHyPtKvfLrmjr1G6UuXzV7X6Xsl3yCQFnUCJgBrgYhshIwk0GGY8rHAKn1nRYZ+H06VX3Qd11EHyE36HKzvC/twTM9cCDltVm5H+D1Uka9cQzK6O9x2OV32KXX8EuivNv1fra5KL/1Udcv3Vb6pmrn1rbK7UC+/p3bQqhPA7r+lCPou2VK2VLAX1XVdamc4vZfbGj/xZB/vZRPr7WVTRmo9tBPeOojdJ3fEVIZOv1mJaYyORZy3x8WGQxfHlMbWKevGUoRfUwi1wwGH9seqxy6Q2zTz7g8dqF9bkx91bqQzqWT9dFOvRww7PtLn7p7imulYX1tMuChre9Q3oJkk312r65TqQzEIj8ImCEzWj7/A9X8+49SEDGTQJkEzNzKWsDMIcEyCZoNnKqpty+Ys1+STbb4TqWWLS7Yf0b0CJgBU954yc15JgJm+vvIjel2H29dbsKNth5c2K4HF9pi/GgZcEjdoHnM5VXRZVSJ8PvId9nt9uetfSkkVO4ysLfOlD7D2p9B5W6Qf8oAgu4T5RiEPbgn/Ut30PoTYqBsvPrdnaaMs4aBw84YPs6YgUWXAWLXfUTIgbKxZCC7K8oy83EdE7f1UWVy6GO3WUUXJEvsfKi/n5xnnjH42H4kjLrtow4vMnka1JCDOsbVSw/lcNhl25QHMrpcXO/ujuh8N6zLrUcBhmqiCJAV1986SiEk4Mxxyl3IGmeSufVYqaA2rymoh5YW7EBVEubOUar9kzfuC8EyAIhMr8/3bTbgxnqn9TKoBxnaYv74orX1SeDB5dRHKoflJeVyWAZA9GBQFNpS0s5M289iCPWpTQfc3Wb4edWu68/OEPavFFH9PqaDtqa3/TY9Ba+0/84Y67z0NYN6ED/V9V2XY7vO3ulT0QTLxLoYysz0c1Z7BPV/p7X9uz52SXx/53z4jB7IT0XZZWj/iiYWRsN5yumb2xKql4d1JnxaFKco1+0Rn+/sYJwutzYFGIiAGTKDgFkyzvzyZU8//7E52S8TCU5JwOrhBwpqy9qCnVG34tMFO7tOAmthk98rn7d6eT1AJoEyCZLNnUP9BICo6Sdu/TzJXUpwgKGkM2SSCJSNd9MexyBYkPIq6kHepMpL6sox/WQ/MkAPrEmdiiNYtEMHe7zu3+GY9m+31/2L+VjZARgVX6BsLHvqNJP7SJfluF3X+fYYy2wnvU0ox82U6wWxTp8Po6pH3EGnp246fbMJD10412k7U16mbTpLbbeK78GwwZQFG5ETBMyQGbXfnlWj756kIGL25tFDnn6+ZXr+ZqGTgNYDn6pPRflf/6S+yZ8lwCWBNAl2yc9MtUnGmvy8bPJ+CYw5ATkJkEmGG5lkAJAIPwu5t0eYNTTZzbDczMvNcNGwMox6EMxvecnNvAnrmcjARZ/JgQW4rlOdCbTBTrd1p2H/2k3cv5iPlQwaPqPMCRSkLYvBGYCVMtydwMfviKhercxBP+VkA+5WZmb4RtUWGLhPR/3sM6hvHtvnHEvjww26PUkAspTA9e1hgmYwDQEzZMr1t16mEGJ0fvCEuvTeCAXhkWSZSQBMAlwSSJNglwS9ptokY01+XjZ5PxlkAGAGvVaInzUlYrspbZhSbIfBRVk06aa5IXBg0sBHJ1kT6aWzNfoSqlNT1h39/5Pcv+2GHCenvzRtush2laKBRT1oLH1oklNKdkaQnZuadfd8Hjcnw9TkeuYMsofdV1U5U5ndp+hAbqfBu2kHntIUANJ95LEEr3ed9lyklsMUBMyQKVdPlCmEGL1++KDn98xtpdwAAJnkZ1rGWJ5Sbxi07ExBORrxpKkePDA1m2sHgwrpowMwuw2oO+2T7F/SAfXdBrR90/vLVDyN3zDtqAn72RdyeV3IeHdlYlbZRG3hmZB/52nOVsb2KU7f3J6SupmKhxsMut6Noj0DvhEwQ6YwLWO8Xv+594BZFGt4AQBggCM+3hP5jXTKBhgab5oTG2jQ0zCaPvVhiSaXHjoY1WnI7vSlbf9itjuE/lIyjivWVra2XQ1bv/73MPrIPoPXfXQylIoG7VaYA7GmZ5gF3b80nV9KIWemZv3YpvUcmuZr2TaDy7XTsOvddmZRgCmaKQJkzdUTfarl8z+gICImwTI/0zEyjSAAIKMqfm4MY9iv3SF9jgwAy0DNkXG+b1vDZ0jWXCmEz7OfNLVunJc/deDAcFwHUWduhTGwOqC30/p1eExZzdHl5PfYFGly6RAgGFXVdec1/feFur4Ebc8yINVptatyCPtXbegTFup6WQpz/2I+VruV/8ChlIUExPZZ+z7g4rPkOMpUhZt9tmd5vxy79YbVdydY5meQeLih77yg+8l2XT5B+7yiDMRax2Zn0O8o0zBbv2tAmTl4P6CnifZ7/IK23wF9feCc+6S8KuPUEedcuEy3gyBBBcmcLYdxrWD4se2J83rIMGEFyxrPq05/o8a5PmsP8VpW9n25gdcmncp/sGxAl+VrIZ//xTbdnqtcQSJJ7gNmBQoL6XD9Xw6p2pURVZjB3H9R8jMdo2SXtcyg7AAA2SM3dtYNXlV5HNSTgSM3g6s+b4blqevOAL9CBhPKyt0AcP+Yz5YBsLUBP7+o4h8QDrJ+k5RXr5TZFDf6/Q3lJJ8lZbVNpevJabiz1sdxlTbXO1Gba6gzO5T/IIK8t+wzWBbb/sV5oHSftd1nu99llUePx3OGExjaqQcu/ZTXOtnvIAESA/rQYd0n9k52ntEPM3TqvtJvHy0DsWEFHVa5bNuHPbatfQGvRSoJHPOK3u+Km0HuhuPs7GuXbgN+z4Ntum70hPR9TDy2w1FdK5pOn6eCXB9Vddm7CcKMdy27WQVbh1EeAtltfXa3QcXqJyBY1de4/ZOVoy6zbcp/8KxNnw+7uIREksgwQ+ZIsOzaPx9U0++lf43K+cET6szxlz2/j+wyAEDGyQ1k0ceNYRQDDHIzHGS9JJk+zPfAoh7AlSe1d+n98DvYsC6ubBMdYPR7gy8Ddbu8lpf+efluZf1k/w7FdItZ4mWQT9pM91QDemPqjLQtP0Eeybbxur5Uxdq6PO7fdp/9UDHOLDMd5PPzpH2/LpNAARj5ntY+9Ouy6vT4dpmasWJQ5omXOlXWdX7YRRlJvZPgYo8+Vn7OKaEFVvQ+V1zULS+/9nRCAS+/1ztugxCu2kDAPmObCilgxrE1hw6+dPp8u6+HGSa4li3qfsfv9dl263c8a1Ad8PpQQ7fb83FDmZV0mRV97F+n9f7uHGdUwgCsYYZMunqyTCFE6NWf+svcvmsuqaoAgEzzs45ZKaJ9CTLNikyDuDOk6Y2q1iYZYuvVh9MSerU76jUg9O/f4eOt8p3Wy5PDIQyay6D3Kl1WVZpTbki9kaDLeq8Dz/qJdb9PCXoJbEj9XuVj/3oC7N/aGI+Bn8zSHn3MQhnQk99jbVJWXm9kZb+3p6zOSz2S+tTl5yEDfU7xW6+20eVMeQ0w1bGT47ZIXyeEeq4K0GcUk1r3FJFel/m9lq1Y26IgwbJxrmXl+qw7yLVsCg9Dvy7Hso8yk2OwXPlfd6+TVoAkETBDJtV+e9bOMkP4Lpw/a69f5gcZZgCAjKuasBN6wWw/A0dyQ7wqiml/9BOnq3zeOMcxILxbeR8wH9bl1R9BWS1XMU9Jh0Q4dagcoL7Ie3dFuH/LAz6hL/vnZwB8XdSBct1flpT3bKVdUU2v5TNoti2OsgpJv65TlYDl5LfeE1iZvFyHJ7iWkX9zAmXliPdBfr+f9rWOI5gpfq7L7GtZ/YDHcAR1s0dfy/r53e166tG06Ar6UIh+r99r/800ASSJgBky68qr37WnZ0S4fvbkE77fO38u5QcAyLSqj/esDHMH9KCpnyfoy36e9vd44zyg/A80RDYg3LA2jlfro1pTpCHbZKLMvAGaW+rJMVwURh2STI8I6oSTbRrG/pXVmLVhXCrFcBy8ZpaWdXlHRrd9L+XeptLxNH455Kw8OQ4VH28lsDK5xkDksP778rimSNXHtsfHsV3JocuGANdlZd1/Rlk3g1zL7khB8Q+H2d51f+/nmLTregAkgoAZMstey4ypGUN15vhR9cbRQ77eK8GylumUIQAg06oG7INkYnkNLMnNfyyLkTc8bepVlAPCfn7vrjjWopggM8/V+iowmj3gFnKAujuC/asmvH+RDoDr7LKSxz6+O6Y64nWA0fSn8bsiGsjuMq1epZ0eKF+uzz2Lwpqi2c951uPPkzmYHX4CS/1RB8sa2siA8j91qMkBeyfrfSCC8vKTEVyiKSAp7gNmoxQW0ufKQK89PSPCESS7bPGdrF+GHLhOEQB5FvZaHj55zS5z1uAajrGc/N44bzOkzAaizjAZp7xk4LJLl9sqFkJPtSiCZc56IRWD90/6x7LHt0U9AO617XfF1fZ0u/dSXu0GTzXYFVV2ks96VaIbmrr+6XU1hxPcB+nPvFxXtZGRkn4+s8uqyv+6hn7rZ7/yN3W2qQ83RBIsa9CjvGflLaNFICnuA2Y1CgvpdPl/fYtCCMFLP+5VQ4MnfL9/8Z2UIQAAUdJrI3jNLutNItCnA05ePzf0tWd8lll3AuUlUzSW9ZP+TMeYXpEEoxrsC/j+asT71+vx50sR9pdF5W1qvkocWaVj7DKlvALoimEqv14fx59spHTw2uaKFFnqdfp4T3dCwV25HvT6uesMDOxGHSxzZpjwOjUz/TQSw5SMyLzrbx1VV0/0URABnB88oX7xnP8ynDtHqdZbKUcAACK+GfT61Go1zkypceyK4TtOZa3Hn09i0BzZEEc2Z7/J+6cH4zz9/ggHFr1Oi7Ur7gqjH2bwMoC51rA6X45j3Stdr6oe31ZUSIMjHn++jSJLPa/XeRWd7RU7fb7s9fFWk6ZljDxY1uBZjz9fojkgKQTMkAtXX9vD1IwBPL/3W+rSeyO+39/+SaZjBADkhtcbzlAGd/Sgstcby11JFpQeSK16fFvYgwxef98+qjh8cAakqhG3Kb/r28U5YOZ1/4oR7YeXQdmBBAPlXvqckkF1vhzXekIamQvZVOW45ofO/PTa5+9KeLf9TDVo0jqKXXHNXKADm0wpjlQgYIZcqF0ZUZcO/xkF4YOsWxZkKsaW6UzHCADIlaRuBEs+9rPfgPLy+mRuMayMEx8Lrw/HkS2BTOqOcSrNI4bv32te23zYO6D7EC8D60kGyisev5sJAQOpS3FPXXtEIXPI6M4dPzMlVBKuo36up03JMOtOIDvP07WGdU4r0SyQBPcBs1GlJEeEjS2tW+3dk+oK65l58vrPD6pXnws2naUEy2ZOp/6x5WOTcyUAJMTrVFz9Ca33cNN++HhPWDfPXp/wZeAOfpRjDrQOGL5/XttRMYJ98NqHJPZwgY9ApgkBs1UJnF+8ltNKBcA0XvvmXkP22+tUgyYEgiRzuieBz+XhBqRCk+sLixqFhfS79s8H7Q1Tk3XLJLssqBWfZjpG5Ij7c+UAhQVAC2tQ0euN97MmfHkfa/SIZSF9fHsaywypczrmz6tmbP+i4CVYUo16Ks2QrxuLBvTrwwl8ZlUBSK2NHR1tPq7LTJgpwe9Ug0k/3JDUQ3P01UiFJsX8ocgZyTK7fuYQBTGJy++NqP2Pbwq0bplYskCp1lspT8CgC1QA0St5/PnAAXQ9BZentdCSWiB9AhWPP9+e0LGqUL1huhinVvS7f1UDdsNLH2JCeXq5blyW4+rPA2lAjq6fDQuUJ/XwV9pUI64XQCjcB8yuUVjIDgmajb57koIYR1jBMkF2GXLH/bmSgBmAMHkNIFUM23+v07MEvnn2sc7PMBkMQC77zNcM2F8vA7FtOT6uXF8DXMum5Vq2yCEHzNXk9gKwxpSMyJDalRF1+X9uImg2hhMsGxo8Efh3kV2GXPYt7s+Vr1FaAELk9abbtPUDql7foKfuCcLr+8lcADLAx7oxJrT9Cxw5ABnndV1B0+6nKx5/vpTHg/zUgQMVqjrSwH2G2SiFhWwhaHajMINlLdPJLkNOuT9X8gQsgDB5HWQwKvjjcwq5oNMyltJcZgB88xosT9s1W4lDDCAHfXPVsP2vcgiB7Gj2dPMnA4FNFBqyQ4JmIz/dpC4s/YFa+AdrclsOF86fVU9/789CCZaJ9k8WyC5D/nh7sISBVyCDfEzzF1Z/kIUBYCmHdoMPLxkeQDZ47Wd2W3170n1mkcOGDF0rlSgFBO2bTctUkmm7rbrtuS2QcQWYSQJmVbc/XLuuVIGAGTJmRm1EnXrqz9TI8A/U/V98NHff//zgidDWLBMfmyPZZdQr5I+cIz2oUmJAJvmZJjCMQEyqBxm0YR/fOcj38LrYOg86APnUThEA7mzs6CiqeoC3ZG0L9Z/baEeYot5kJfO3qnjAAciE5tlbTlUv7l087OoGn2kZkVES4Pnr//FNdeaXL6vVX3tctcxqzcX3fv3nB9Xze78Z6u9c/QdMxYic8jAdo5x7KTAgk/zcJDNFa53XfjHuNcw4TkA2LKMIgHDoAFlJ1aeGLimCBfDHa0DV1IeYqrQBIBuaGzqb0pQ/fZ0CQ3Y9vKKg/vrwQXV+8KR6eMsP1B2L7s3sd5X1yl548gk7YBYmWbdMMsyAXHJ/jiRLAcguPzfJgfoEH0/lVg0tu9NUHwAxaKMIgMDXHeusbZsicwwAkEFNXm7UawTMkGGy5tYX7i/Y63jJFIW/eK4vk9/zzPGj6slvPBJ6sOyuuUzFiHzzcI48QmkBmeUnc6Ea8DPbY/48AACQMxIos7ad1h8Hra1PESwDgqINAYZyAmauB+9q1yg0ZNeSBfXtks7AksCZrPGVBZJV9jP7Oz2mLpw/G+rvlmCjZOgBeeXx3EiGGZBdRa9vkEXCKbZEMCUjgCyqUAQI28aOju2qHijbocjSBCbi9ZqetgQYqnFKRnfkCfrpFByya81nCuri+zV19m3JxnrZzsb63J92qc9/ZVtq1zaTbDIJlkkgMGwtVn/w8IMF1TKDuoMc85aBTcAMyCA9RZHXJ0UrlFxiPB2rpw4coO8GkAbMZIAwr22K1sszikwYwA2mFwcyws4wm73lVFW5jISTYYY8kABQ41pcrz7Xp3749S+ol37ca2dqpYUEymS/n9/7zUiCZUICjKxbhrzzcG6s6nMugOzxM5hEf5ASetAQAExWeerAgZ0UA0I675Wsl2OKYBnglteRMR7GAgzV3HhxZW2dU75jVG9NFB6yS7KmNjxUUH/985oaeb/+bxJweulHvfbaZp/90y51/6pH1Zw77jJy/yVQJsG9sKdeHEuCZYvvpL4g55zzojsVCgzIrLU+3kMmQHJkkMLLIGBREeAE8tpXmD4lq+zfs08dOFDmcCEMGzs6OlV9nTIA7nkNLjPdN2CoxoDZs8pNwEzpJ+mZfg0ZN0NPNfj0izV1+eqH/+4EzmS7/4uPqnse+LK6e8WaxPdXgmO/+GmfHSy7FEMW3OrPFNSnF1j9AVUFeect8/pZCgzIrJKP91RScDOfVQxSAHCj+6kDByoUA/JiY0eHXCfsDunXVfUmgecL+tzrNavmMEcFABCnZj837LWrShUImCEH5s6pZ5od+oeaevvCzf9fglOySabZPSvWqLsf+LJasHRFbPt3fvCEOnP8qHr98EE1ZP05LhIsW7KA+gE450QPKpQYkD16uj6vgajqUwcOVEP4eK+/w9QFxhd6/Hn6UwAAwr2ekWuEwwGvFfpV/SHBShjXOdY+cWAAALH6IGA2e8up4Yt7F8uJbd2U77qut2kUILLPCZpJptl4QTMh2V2yzplsM2e12kGzBfc9qO5YdG+oATQJkA0NnlRnfvmyHSiLesrF8RAsA8Y5H7q8eZRzLYUGZNI6H++phPHBMhiVkcGkouH710Y1BzKhShEAE+rzeb6Te5xea+uxrku430HUShm5lmUNM8BQzWP+/qzbG347y4yAGXLCWdPs+Zdr6tzbk/+sTIf4xtFD9uaQDDTZnODZvOK9qmVW66S/R4JiQoJkl967qM4cf9mIMpg7h/oANJ4LPWA6RiC7tvl4T2J9wsaOjpKBU4x5HWSoxrx/kkHYT1UHUu90xH0TkEpybaD8PQAk58YuAmUIoJqR7+HpfEGbAczVPM6Jzt3CnjJIOJMCRH44AaMX/6mmBv63t/dKJphsSQe9/JIgmazn1nor9QD4QE2fC73dTALIGD3AVPT4tmHrJjnMPqHqcR9MzJbyVIYhTPN0RHl7QplHhoB8KlIEyAk/D/+UrfNxF0WHIPzMliBr7VnvMyZDS6/95wXZZYDBmhr/oqeKcnfz7n2gEMiEh/5DwQ4eSQAtD9o/qdRjXyRYBtzkmj4XusN0jEB27fDxnrAD6FWvp3eTCjAlgwztVHVfxwowTcXjzxMsRx769qLynl1GsAxh8nqvXDRs/73uT5VDDpiraZx/cz09TO0yBYh8WnynUpv/j4KaPze731ECghIYlAAhgMDnQKZjBDJIZ5eVfLx1X8i74vWme5lhRZlEwGwg4n3MKtZyQ9oN0/aBm3gNlsl1RzfFhhCl/bpspceff41DDpjrpoDZ7C2nyq4vIket7TqFiHxypmhc/ZnsZZstWVCwA4ISGAQwjuv6HOjOsD63AsgeP9ll1QjWD/N6010yrByTGGSoevz5Nv0EftYwJRByxccUXgTMkAdez8O7WH8JCV+PrDRs/71eW1c45IC5mib497LbX1B/wr7AxpbbrR5carJf007WKtvwUJMOAnJs2dgm2jxml5W53ACyZ2NHx3blL/C0y4BBhjbDptbz+mR74EEGn+telDJYlcm2QR55af9tTEWKHPBax1mbGWE77fWazOqbjch61/vhqQ1F8PAcgBBNFDDrdf0bZA0XedKe8VO2HG8tM5Ra/dmC2vx/NqnFv5e+wJmsTyZBsse+1KTmf4zjycY26XZdn/vc6+VyA8gWnWnkN7usHPb++LzpLhlSlhIs8zLgMRziIu9ef89aaj9TMiITvLb9EkWGGCQ5XXLRS/shu8yzhRTBlPxcy64zZN9jf/ALQLTGDZjN3nKq6qUB1y7XKElA1QNPsu6XBM6WLCykYn8lUJaW/QVM4PGcV9HnVAAZoZ8ifUb5CxzsinDXvA4AbzOkSL0GocJ8qr3i8efXmfI0c4i8DnquTKDNdSoCFgjXEY8/v5kiQwwSOb/4mG6YexvvihTB5PTDUF6vSUx5kMnrNTXrmwOGawrlhl6etL9CYQKOxkDUiiUF++8mkeDYhi80ESgDvLqivGaX7aLQgMzZrfxNSxdJdlmDisefL27s6CglWZA6+NTp8W1hDjIc8fGezixVZh/ZeqWY64g8td1Ht4OE+8v2jK5hiOilYZ1Ir3X7NQ6rjSy75PvmdUn3zfpamilNgYyZMGA2e8upivKaZUaiGXADCZQ9sKQeOJPMMwlOtUxPZl/mf6xgB/H+65/W1yibP5fjA3hS85VdVqHggOywbopl4L7T59u7I969fT7esyPhIvX6+TIdY5IZZmJbBqt21WM7WBdTe5MBKIJlCJ3Vj0id9xrI2EHJwQcvQRWmvE2XAY5t6Pw8FJW2a9kBfQ4CYLCmKf6/+yfjRxVZZsAkZG0zJ2Al2V2SeSZBrKhIsE4CdB985kPJBuyA1Luiz3XukV0GZIRkQgUMlvWHHOi5ic4U8noDXkoqy0w/Ebzd49vKIZeZDGR6PS5FPUVgUvVwewSf77XerI3hu0qw7LBikBHR8fqQQSdZZohYe0r2M7a11pI63+b42CbNz7VyYn2zvob2eh3N+uZACkwaMPOcZXap5nUwEcglye6SzDMJYm3ZUA+gSWDLCaJ5CaTNnVPPHpNgmLxffpcEyCSrTX4nQTIgBNf1Oc49ssuAjNA34TJw3+nzV0hQpsvggYa+hNbl8pM5FMUgg5+nmXfHXWZ6UGZQ1acE7Qs50Ol1aspIB6cIlsHk/pJiQ8R9fRKBlarHny/GWBa7Obb54fNBpkT6Zn0d6PVz/X4/ADFrdvEz8oS86xuy2u9qqjCLNZEALySANn9uvd088MG/3tiORt6vv5q2HhqQBx6DZc65E0DKSTaPqk+1EmTgfr0eAIiDBJS8Zm0VVX1AqivGct2tvD+RW45oCpt+/f29HGNnkGR9TOW1U9085c9m5W9KyfH4WWNnRxR1hmAZ4iL9iVXfpP17mWJUsnK3W+/toQThktfzVknFvO6Zbgte3mKv6RfltHIpORcYf2xTqtdjv+z0zTutOrkzxv3sU96Dx70x3hMACGCqKRk9Z5mpa9Z2mYIFwiaBMoJlQAIu63Obe2SXASkn2TvWdkx5D6SM1W3dGMfWH+jBq7KPt3bqoEwcZdupvAf1xK6Iyszv077rdEA1yrKS6R9lwHC89TGKIX5UxWedKUVQNwiWIU5+slZ3Z2iaOETvtMef35zQfla9ngMivk5Iw7nA67FdS3NwdV0m1yS+HuSJq2/W07R7DerJ9SYPWwAp0eTy5zwtUm4/iX+dwgUApNx1X9ll3RQckD56fahOHSiTgZqgU+eUE8pC8BtY2qEzv6Is453K37Q5PREvkO63zCIbONe/V+piKeoKEyBo+ExYU0w11A2CZYiNHpit+HhrX5JBs4b1DI9ZWy3qvhuBeB34b09obVGv7WBbFFMT63aVlnOB1+uSEusgRn5dFnnfHGBN411klwHp4SpgNnvLKTnJe7rhl6kZVY0CBgCkVE2fy7zp0edMACmgM3gkSPaMqq8PJTfBYQQAJFjWlcR3CpBlJmQA9nDYg2B6cFfKeIePt8vgwi6Dy0wGZ0JbB05nNx5W8Q8Y+lnLTfbvcJCg2RRZdEAcuk1o+y7bS7serHXWM2xv6LtZH8lMVR/vSaI/9LqWpZ/1m6a6TuhT6Von0M89H+sgursuk4d4Kib1zfp6RR5k6vRTV5jKF0iXJg8/u0vfsLrj76l8AACM4CNbOvJBXQC+b3JLerOnHpTgjbXJgKMTJJNpVcK6sU4sWNag29N1+41KUi66nNoClnubzhwaVN6nrnHEtQbcrgBl1mltx4I81dwQKDusYsgqG0e/z+/vBM22+6wbxxL6voDN6l88Pxw8pu0PRpnRoAdpt+tzljNYO17fTMDM3PrltW8t6eCR13PIzgBTBfudmrgvhDpe0ue+To7tuOXjXLuuy1nzCTJrS+DrsgmuZf30s1JHuhSAVGl2+4Ozt5wavrh3sTTyZ1z/9ivWNs3aZlDQAIAUuaI3b7rkXEnhAaGTwYW0PIUlUwcmPi2rBJisMvN23X4jGYyVJ9xlyqWy9fqsl7XY9OCXrMMSNBDZE9cacJJlZu23BM38Tm1WVPWnmqXc+t2Umc4Iccqq3YA606v8ZTbIMZbpKbep+ppQ/RNNoRmwbgwoggKIxi5dJ4s+63+fnhZR+st9eiDdF/2ggrSTlfrVbZ0vchiNVVHeHxpx1omUadzKk5xDNo+tu9a/D3g9d+pzgHxOp4/9lP3o8lrv9fSEO1TKAmUhHdt2fWz7JzlXrlU3B8gLeWk0Up/0dZnfjMux12We+mYdoFwbQv3sDnJOAJCMZi8/PHvLqf6Lexf3ezkhyHRWhaaCx08CACAh13xNxdgv50gKD8itYX1DXDZlh2QQxufgVyMZpJGn1SW7Qf5eUfXppcZb6H6hqg9OlEL6CpW4g48yXY71PdcG/A7FMWVWVTdPySXlamLgR7Jstin/QU757hI0kOCZtImxA0SlgPt2QREwQzRtX4IF61U9y8Vv/W/sL536f0SfHyYbLHXaxTJdv4sckcyRKW/9ZAdJXejTGUljs5lKU9Spio/P2+XzmkHqrWTz2EEJff4e9yFCHSST/Vur/GeeZ+HYSpk903Bt5epcKYG0uB4kMqRvlsy6lSFelzn98UTXssv0z4d1rVE26d4AgHt+wlhdurNyfSFZe7+mCrMK9WwzAABMdb1+zvKIaRaAfJMb7y4Tnx6VqSEbBqfCUIqxTNcnVGzyuYMqvCk6iyqaAfCBCOrLcMAsu0ZtIdYXO3NTT4kERNVfSjaDBOn7Qqz/JUoWMmCuMxCDnFfaY9jPasAHbdbpTQI7VXXzwyLtAcpgWMW7rqdb/fqcGWTf6Cemvi47HFIbaIuxvE2Yoh2AT01e36Cnm/LW6Gt6AJIlzQAApvJ/rmIqRiCf7HULrZvh5YZPtSIDDWmaCkb2dVVM65bdRH/uKuV/PbO49Eb0/SWTq2LQ9+wyYZpT5IPOBEjrACdTfuWwz46A9LfVEH5PUX0YNHY2v0Glsqnlp68ZeqnesVyXpamPI1gGpFyTnzfpaae8LYw7qlTtPYJmAAAD1fQ5atTzO3uYihHIpbK1SaBsp+k72jDQUElJuSYWLGsoswFldtCsa6I1wkJiSpC1i6mMkED7lzrXpcwPmo9V5egZrScNx0iff9cbVP/TEHjoSWF/kbZ+OU1Bsx6CZUD6NQV47y7PndV1gmYAAMM4wbLrnt85oM+FAPKjbG2L5EY44oBFqGSgwdpkoKHH4N3cpct12JAyMzFoZg8YRR1E0scgyYCBtK3lBMuQYPsv6/afln6+YnimM3Xqw341DfsqdcmEzN6uNAQe0nRsM9CGpF829WHVYUVWPJAZvgNmevop70+eEDQDAJjCf7DMPgcyFSOQC1VVD46nLlA2lr6JN+nJcSEDc0Zm6+lBw0XKjOy8fl0HKzF+9+Uq/qe5+3V9YPAfJrR/aQM9hu9qv0puzUd4q1PSf8cRWBkOYV/LKrmHRqoqZQ9NWPvar+J5kHI4521IHgCT/q7bsLKoKB70ATIlSIaZBM2qvk74BM0AAEnzHywTXfocCMD7zW4lBTf80r5lkHS9tb8SpNiZ5kDZmPK3Ay8q+UFg50lco4MjDdl5SQ3OSHuRrLL1cWff6Tof19Pcw7q9rTclyxDQ7b9bmTmtbTmpvgGB6pQct6iDZpWQ9lV+z/KY674EnVL50IR+8CfKoNkwD5N8UNY9um6WDbhfkD54VVbuEwDUNQX9BXrtFu8ppxI0+63vgUoAAPwLcg5qUt2sWwYEZtp0JQP6plv2a7kOknXr4FLmNAwCO4GzOAdbZUBBBgsXpezp8R5dXrtiKi+pe6v0IEwl4boiT3OvV9FMTzesPszgTFN7q7J/md6/se2gogPnSQfOnKnyPqIznuPal2HaZaj1qayim/KzP8ygigQBdN3virh8y/o8sDPNAWAdNIvqfNlL27qpbnbpa7O4ryeljXXp+wXGBYAMag7jl8zecqrn4t7Fy6w/dnp642j96f7CrYWQ9gQAgClcs8497/vOci7P/r9P9VCIQOCb3PLGjg65+d5tbe0x3ehXG25yL+jX4SSDESYMNlgv3daxkIDFOmtbq1/DJoNfMqCwL83lrQfxdlrl1aPLaVvI9Vfq5D5VH/CsGvbd5fj1W9+9M6TvXdXftcfD4OiArkttU/zcvhiKpFf3X27rftxM3z/pc/oM3r+J2oH0XxWrHRR1H7A54nPYgN6eVfV1ypIKJPTrdl90c62c4CHq1celzcXP7jOgLi2y6tJ2D2U7VVvpjWp6Yx3kK+tzgNT7UkjXBmW931UX9WrbFMfWiP5CzpdWOcnx3a7LKuixta/VQg7MOH2Lm/6rbHL2lN63LqvM5WGCTn0tW4rgo6oN17KmZvrtc/ndh1WyAdge3T7clHlZAQkohPnLLu5d3Ke8Bs2cHbnF2pUZHBAAQISuKFX7ne/5gMuzt5xiQWcAmbexo6Okb7jlgbii8j4gXNE3ua+p+iDvQIbLqthQVu3K2yCNlNOALqf+ND1V3xAwWKm/d9HD9/U92GR9bpsu4/HqpD0AGNfAni6D9knaRyXJAHEK9m+yY/lBfTG9XYz5Hit1Wyh6/DXDuv46/eaAid9dnxvke44XtKjqOlU14HhM1hcPqGSDjxPtt+zzZg/nEafOyHYk7iwXXc6N5wC31wnOeeBZr/2Pi/6/YmJ/Ye13Yzl5ObZHVMgZgz7a9EAar+FC6peda9kjaSqHtJxbG66fixO1gTw/1IjkFcL+hRf3Lj6m/D5lNcPaoZmFCPYKAJBrklB2qWYHzHwamL3l1HIKEkBeNQxCTogb2xvKq5S3ctIDvuMOurG2B+gzx0XbgJ/6M2BoYCh1+5xQORXVBMEbrqMS75dZJw6ALYqAmXRAh5XfoNk0nW02jYMDAAjBdZ1V5n/NTLloXjV7yylu8gAAAAAAAICMiiSXK3DQTOlMsxYOEAAggMs6s8w/gmUAAAAAAABADkQ2+WEYQTPVbO3grdYuNnGgAAAejCpVe7+m1LVAv4VgGQAAAAAAAJATka8WdnHv4j7rpTPQTjrZZqxtBgCYjCSTBc8qE+XZW051UaAAAAAAAABAPsQSggojaCZZZnbgbAYHDQAwjis6UPb/s3e/t00DYRyAzyTlW6SOUGUBugHpBJQN6FekSHQCxAQgeQE2oGwQNigLRBkhKAgkaBvubBdKaVXaOM4fP4/06pR8sH1nKZHyy3u+WPhIwjIAAAAAaJlGNjusfng8Xugg1fZa868Lb7EFwDaJ3wnpu6HYgnHxsOxYWAYAAAAA7dPoJoezvH8Yh9RttrvwwbpVx1nXTQRopbOqo6yeP1FMQycc9V6OTywsAAAAALRP408Fm+X9vTh8iLVfywFt1QjQLvVtvXjpNNbz3nA8sbgAAAAA0E6Pmj5h9YPkQax3tRzwcqvGL7G+z0M4d1MBtk78bE+f8cVn/bdaw7L0XXQgLAMAAACAdstWefJat2i8qhMn9jhObSesIBIEoBYpFPsZwvzHUv4MMY111BvaghEAAAAAWHFglszyfgrLUmh2uJQTpMBsJ060WwVoAKyvFJCdzYuxxi6y61JIlsKyqQUHAAAAAJJsXS5kad1m13VD2YHWyYqxKACad17W/LzqIDtb+hl1lQEAAAAAN8rW6WKqbrPXsV41euJOuRJFF9qV1395FGzvCHCXi/BvZ9g8/N5Ssegeu/K6QelZZW90lQEAAAAAN8nW8aJmeX8/Dm9jDdwiABYwinXcG45PLQUAAAAAcJtsnS9ulvcHoew4G7hVANzDKJQdZSNLAQAAAADcJduEixScAfCfRkFQBgAAAADcU7ZJFys4A+AWoyAoAwAAAAAeKNvEi57l/b1QBmeHsXbdRoBWmsY6CWVQNrEcAAAAAMBDZZs+gVnefxGHZ6EMzwDYfikk+9gbjt9bCgAAAACgDtm2TGSW91OnWQrNhGcA26cIydLYG46nlgMAAAAAqFO2jZOqwrNBKMOzNO651QAbZRLK55KlkGwkJAMAAAAAlilrwySrZ57tx3pajak8+wxgPaQw7LSqT2n0TDIAAAAAoElZWydehWipLsOzJ9W4W70HQH1SGDat6nP4E5JNhGMAAAAAwKr9EmAAJd3fqq0ls04AAAAASUVORK5CYII=" alt="Cyclos documentation" />
</template>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Cyclos reference documentation</h1>
<div class="details">
<span id="revnumber">version 4.16.3</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Cyclos reference documentation</div>
<ul class="sectlevel1">
<li><a href="#setup">1. Cyclos setup</a>
<ul class="sectlevel2">
<li><a href="#setup-installation">1.1. Installation</a>
<ul class="sectlevel3">
<li><a href="#setup-installation-tomcat">1.1.1. Installation with Tomcat</a>
<ul class="sectlevel4">
<li><a href="#setup-installation-tomcat-requirements">System requirements</a></li>
<li><a href="#setup-installation-tomcat-java">Install Java</a></li>
<li><a href="#setup-installation-tomcat-postgresql">Install the PostgreSQL database</a></li>
<li><a href="#setup-installation-tomcat-database">Create the Cyclos database</a></li>
<li><a href="#setup-installation-tomcat-server">Install Tomcat web server</a></li>
<li><a href="#setup-installation-tomcat-cyclos">Install Cyclos</a></li>
<li><a href="#setup-installation-tomcat-start">Start Cyclos</a></li>
<li><a href="#setup-installation-tomcat-upgrade">Upgrading to a newer version</a></li>
<li><a href="#setup-installation-tomcat-problem-solving">Problem-solving</a></li>
</ul>
</li>
<li><a href="#setup-installation-docker">1.1.2. Installation with Docker</a></li>
<li><a href="#setup-installation-k8s-aws">1.1.3. Installation with Kubernetes (EKS)</a>
<ul class="sectlevel4">
<li><a href="#setup-installation-k8s-aws-requirements">Requirements</a></li>
<li><a href="#setup-installation-k8s-aws-cluster-iam">Create the required IAM roles</a></li>
<li><a href="#setup-installation-k8s-aws-subnets">Create separated VPC subnets</a></li>
<li><a href="#setup-installation-k8s-aws-cli">Configure the AWS CLI</a></li>
<li><a href="#setup-installation-k8s-aws-cluster">Create the cluster</a></li>
<li><a href="#setup-installation-k8s-aws-connect-cluster">Connect to your cluster</a></li>
<li><a href="#setup-installation-k8s-aws-node-group">Create a node group</a></li>
<li><a href="#setup-installation-k8s-aws-database">Deploy the database service</a></li>
<li><a href="#setup-installation-k8s-aws-cyclos-deploy">Deploy the Cyclos service</a></li>
<li><a href="#setup-installation-k8s-aws-publishing">Publishing Cyclos</a>
<ul class="sectlevel5">
<li><a href="#setup-installation-k8s-aws-publishing-certificate">Creating an SSL certificate</a></li>
<li><a href="#setup-installation-k8s-aws-publishing-roles">Setting up the load balancer roles</a></li>
<li><a href="#setup-installation-k8s-aws-publishing-controller">Install the load balancer controller</a></li>
<li><a href="#setup-installation-k8s-aws-publishing-dns">Update the load balancer DNS</a></li>
</ul>
</li>
<li><a href="#setup-installation-k8s-aws-upgrade">Upgrading to a newer version</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#setup-upgrade">1.2. Upgrading to a newer version</a></li>
<li><a href="#setup-adjustments">1.3. Adjustments (optional)</a>
<ul class="sectlevel3">
<li><a href="#setup-adjustments-java">1.3.1. Adjust Tomcat/Java memory</a></li>
<li><a href="#setup-adjustments-oome">1.3.2. Handling out of memory errors</a></li>
<li><a href="#setup-adjustments-ssl">1.3.3. Enable SSL/HTTPS</a></li>
<li><a href="#setup-adjustments-clustering">1.3.4. Clustering</a></li>
<li><a href="#setup-adjustments-apache">1.3.5. Use Apache with mod_jk</a></li>
<li><a href="#setup-adjustments-apache-ssl">1.3.6. Enable SSL on Apache</a></li>
<li><a href="#setup-adjustments-proxy">1.3.7. Setup a proxy / load balancer</a></li>
<li><a href="#setup-adjustments-reserved-paths">1.3.8. Reserved path names</a></li>
<li><a href="#setup-adjustments-google-maps">1.3.9. Enabling Google Maps</a></li>
<li><a href="#setup-adjustments-recaptcha">1.3.10. reCAPTCHA</a></li>
<li><a href="#setup-adjustments-storage">1.3.11. External content storage</a>
<ul class="sectlevel4">
<li><a href="#setup-adjustments-storage-types">Storage types</a></li>
<li><a href="#setup-adjustments-storage-migrator">Storage migrator utility class</a></li>
</ul>
</li>
<li><a href="#setup-adjustments-db-replica">1.3.12. Read data from a hot standby</a></li>
<li><a href="#setup-adjustments-opensearch">1.3.13. Using OpenSearch</a></li>
<li><a href="#setup-adjustments-logging">1.3.14. Logging</a></li>
<li><a href="#setup-adjustments-frontend-self-hosted">1.3.15. Hosting the frontend separately from Cyclos</a></li>
<li><a href="#setup-adjustments-archiving">1.3.16. Data retention period / archiving</a></li>
</ul>
</li>
<li><a href="#setup-maintenance">1.4. Maintenance</a>
<ul class="sectlevel3">
<li><a href="#setup-maintenance-backup">1.4.1. Backup</a></li>
<li><a href="#setup-maintenance-restore">1.4.2. Restore</a></li>
<li><a href="#setup-maintenance-backup-restore-large">1.4.3. Backup / restore large databases</a></li>
<li><a href="#setup-maintenance-reset-admin-password">1.4.4. Reset admin password</a></li>
<li><a href="#setup-maintenance-restore-themes">1.4.5. Restore applied themes</a></li>
<li><a href="#setup-maintenance-send-db">1.4.6. Share database dumps</a></li>
<li><a href="#setup-maintenance-test-environment">1.4.7. Setup a test environment</a></li>
<li><a href="#setup-maintenance-remove-data">1.4.8. Remove network data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#fulltext">2. Full-text searches</a>
<ul class="sectlevel2">
<li><a href="#fulltext-opensearch">2.1. Using OpenSearch</a></li>
<li><a href="#fulltext-language-processing">2.2. Language processing</a></li>
<li><a href="#fulltext-reindexing">2.3. Reindexing</a></li>
</ul>
</li>
<li><a href="#webservices">3. Web services</a>
<ul class="sectlevel2">
<li><a href="#webservices-rest">3.1. REST API</a></li>
<li><a href="#webservices-custom">3.2. Custom web services</a></li>
<li><a href="#webservices-webrpc">3.3. WEB-RPC</a></li>
<li><a href="#webservices-auth">3.4. Authentication in web services</a>
<ul class="sectlevel3">
<li><a href="#webservices-auth-user-pwd">3.4.1. User and password</a></li>
<li><a href="#webservices-auth-session">3.4.2. Login with a session</a></li>
<li><a href="#webservices-auth-access-client">3.4.3. Access clients</a></li>
</ul>
</li>
<li><a href="#webservices-channels">3.5. Channels</a></li>
<li><a href="#webservices-config">3.6. Configuring web services</a></li>
<li><a href="#webservices-external-login">3.7. External login</a></li>
</ul>
</li>
<li><a href="#scripting">4. Scripting</a>
<ul class="sectlevel2">
<li><a href="#scripting-warning">4.1. Crucial considerations</a>
<ul class="sectlevel3">
<li><a href="#scripting-warning-transaction">4.1.1. Database transactions</a>
<ul class="sectlevel4">
<li><a href="#scripting-warning-transaction-exception">Exception handling</a></li>
<li><a href="#scripting-warning-transaction-commit">Manual transaction commit</a></li>
</ul>
</li>
<li><a href="#scripting-warning-inbound-request">4.1.2. Inbound requests</a></li>
<li><a href="#scripting-warning-executor-service">4.1.3. Executor service</a></li>
<li><a href="#scripting-warning-long-running-transactions">4.1.4. Long-running transactions</a></li>
</ul>
</li>
<li><a href="#scripting-bindings">4.2. Variables bound to all scripts</a></li>
<li><a href="#scripting-general">4.3. General tips for scripts</a>
<ul class="sectlevel3">
<li><a href="#scripting-general-grape">4.3.1. Using custom external dependencies using Groovy Grape</a>
<ul class="sectlevel4">
<li><a href="#scripting-general-grape-sftp">Using Grape to connect to a SFTP server</a></li>
</ul>
</li>
<li><a href="#scripting-general-wrap">4.3.2. Reading and updating custom field values</a></li>
<li><a href="#scripting-general-lock">4.3.3. Custom locks</a></li>
<li><a href="#scripting-general-globals">4.3.4. Reusing shared object instances between scripts</a>
<ul class="sectlevel4">
<li><a href="#scripting-general-globals-mysql">Connecting to an external MariaDB / MySQL database</a></li>
<li><a href="#scripting-general-globals-httpclient">Reusing a single HttpClient for all scripts</a></li>
<li><a href="#scripting-general-counter">A simple counter</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type">4.4. Script types</a>
<ul class="sectlevel3">
<li><a href="#scripting-type-library">4.4.1. Library</a></li>
<li><a href="#scripting-type-field-validation">4.4.2. Custom field validation</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-field-validation-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-field-validation-result">Script result</a></li>
<li><a href="#scripting-type-field-validation-examples">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-field-validation-examples-email">E-mail</a></li>
<li><a href="#scripting-type-field-validation-examples-iban">IBAN account number</a></li>
<li><a href="#scripting-type-field-validation-examples-cpf">CPF Validation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-load-field-values">4.4.3. Load custom field values</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-load-field-values-bindings">Additional bound variables</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-load-field-values-bindings-user">User (profile) fields</a></li>
<li><a href="#scripting-type-load-field-values-bindings-contact">Contact fields (personal contact list)</a></li>
<li><a href="#scripting-type-load-field-values-bindings-contact-info">Public contact information fields</a></li>
<li><a href="#scripting-type-load-field-values-bindings-marketplace">Advertisement fields</a></li>
<li><a href="#scripting-type-load-field-values-bindings-record">Record fields</a></li>
<li><a href="#scripting-type-load-field-values-bindings-transaction">Transaction fields</a></li>
<li><a href="#scripting-type-load-field-values-bindings-operation">Custom operation fields</a></li>
<li><a href="#scripting-type-load-field-values-bindings-document">Dynamic document fields</a></li>
<li><a href="#scripting-type-load-field-values-bindings-wizards">Custom wizards fields</a></li>
<li><a href="#scripting-type-load-field-values-bindings-vouchers">Voucher fields</a></li>
</ul>
</li>
<li><a href="#scripting-type-load-field-values-result">Script result</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-load-field-values-result-dynamic">Dynamic selection</a></li>
<li><a href="#scripting-type-load-field-values-result-string">String</a></li>
<li><a href="#scripting-type-load-field-values-result-numeric">Numeric (integer or decimal)</a></li>
<li><a href="#scripting-type-load-field-values-result-date">Date</a></li>
<li><a href="#scripting-type-load-field-values-result-linked-user">Linked user</a></li>
<li><a href="#scripting-type-load-field-values-result-linked-transaction">Linked transaction</a></li>
<li><a href="#scripting-type-load-field-values-result-linked-transfer">Linked transfer</a></li>
<li><a href="#scripting-type-load-field-values-result-linked-record">Linked record</a></li>
<li><a href="#scripting-type-load-field-values-result-linked-marketplace">Linked advertisement</a></li>
</ul>
</li>
<li><a href="#scripting-type-load-field-values-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-load-field-values-example-user-group">Dynamic selection on user profile field: values depending on the user group</a></li>
<li><a href="#scripting-type-load-field-values-example-active-brokers">Linked user: active brokers</a></li>
<li><a href="#scripting-type-load-field-values-example-list-open-loans">Linked transaction on transaction field: list open loans</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-account-number">4.4.4. Account number generation</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-account-number-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-account-number-result">Script result</a></li>
<li><a href="#scripting-type-account-number-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-account-number-example-prefix-by-group">Controlling the prefix according to the currency and user group</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-account-fee">4.4.5. Account fee calculation</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-account-fee-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-account-fee-result">Script result</a></li>
<li><a href="#scripting-type-account-fee-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-account-fee-example-user-rank">Charge a different amount according to the user rank</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-transfer-fee">4.4.6. Transfer fee calculation</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-transfer-fee-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-transfer-fee-result">Script result</a></li>
<li><a href="#scripting-type-transfer-fee-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-transfer-fee-example-profile-field">Charging a fee according to a user profile field</a></li>
<li><a href="#scripting-type-transfer-fee-example-payment-field">Charging a fee according to a payment custom field</a></li>
<li><a href="#scripting-type-transfer-fee-example-distribute">Distributing a fee exactly to different accounts</a></li>
<li><a href="#scripting-type-transfer-fee-example-to-broker-or-system">Pay a transfer fee, either to a broker or system</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-transfer-status">4.4.7. Transfer status handling</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-transfer-status-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-transfer-status-result">Script result</a></li>
<li><a href="#scripting-type-transfer-status-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-transfer-status-example-admin">Restricting a specific status for administrators</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-session">4.4.8. Session handling</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-session-login">Login</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-session-login-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-session-login-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-session-logout">Logout</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-session-logout-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-session-logout-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-session-resolve">Resolve</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-session-resolve-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-session-resolve-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-session-set-properties">Set properties</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-session-set-properties-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-session-set-properties-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-session-search">Search connected users</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-session-search-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-session-search-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-session-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-session-example-storage">Storing sessions on Cyclos script storages</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-password">4.4.9. Password handling</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-password-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-password-result">Script result</a></li>
<li><a href="#scripting-type-password-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-password-example-parameters">Matching passwords to the script parameters</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-extension-point">4.4.10. Extension points</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-extension-point-bindings">Additional bindings</a></li>
<li><a href="#scripting-type-extension-point-type-user">User extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings">Additional bindings</a></li>
<li><a href="#_events">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-operator">Operator extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_2">Additional bindings</a></li>
<li><a href="#_events_2">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-address">Address extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_3">Additional bindings</a></li>
<li><a href="#_events_3">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-phone">Phone extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_4">Additional bindings</a></li>
<li><a href="#_events_4">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-record">Record extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_5">Additional bindings</a></li>
</ul>
</li>
<li><a href="#_events_5">Events</a></li>
<li><a href="#scripting-type-extension-point-type-marketplace">Advertisement extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_6">Additional bindings</a></li>
<li><a href="#_events_6">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-transaction">Transaction extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_7">Additional bindings</a></li>
<li><a href="#_events_7">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-auth">Transaction authorization extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_8">Additional bindings</a></li>
<li><a href="#_events_8">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-transfer">Transfer extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_9">Additional bindings</a></li>
<li><a href="#_events_9">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-voucher">Voucher extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_10">Additional bindings</a></li>
<li><a href="#_events_10">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-agreement">Agreement extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_11">Additional bindings</a></li>
<li><a href="#_events_11">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-type-import">Import extension point</a>
<ul class="sectlevel5">
<li><a href="#_additional_bindings_12">Additional bindings</a></li>
<li><a href="#_events_12">Events</a></li>
</ul>
</li>
<li><a href="#scripting-type-extension-point-examples">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-extension-point-examples-extra-credit">Granting extra credit (on demand) before payments</a></li>
<li><a href="#scripting-type-extension-point-examples-email-payment">Send an e-mail on every payment</a></li>
<li><a href="#scripting-type-extension-point-examples-products-agreements">Assign / unassign individual products when the user accepts / rejects agreements</a></li>
<li><a href="#scripting-type-extension-point-examples-minimum-balance">Enforcing the user remains with a minimum balance for a payment type</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-operations">4.4.11. Custom operations</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-operations-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-operation-result">Script result</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-operation-result-string">Plain text or Rich text</a></li>
<li><a href="#scripting-type-operation-notification">Notification</a></li>
<li><a href="#scripting-type-operation-result-download">File download</a></li>
<li><a href="#scripting-type-operation-result-page">Page results</a></li>
<li><a href="#scripting-type-operation-result-url">URL</a></li>
<li><a href="#scripting-type-operation-result-redirect">External redirect</a></li>
<li><a href="#scripting-type-operation-result-bulk-action">Bulk action</a></li>
</ul>
</li>
<li><a href="#scripting-type-operation-function">Other script functions</a></li>
<li><a href="#scripting-type-operation-actions">Actions</a></li>
<li><a href="#scripting-type-operation-after">Behavior after execution</a></li>
<li><a href="#scripting-type-operation-row-actions">Row actions on page results</a></li>
<li><a href="#scripting-type-operation-receipt">Receipt</a></li>
<li><a href="#scripting-type-operations-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-operations-example-contact">Contact us page</a></li>
<li><a href="#scripting-type-operations-example-string">Returning a string (notification / rich / plain text)</a></li>
<li><a href="#scripting-type-operations-example-redirect">Returning an external redirect</a></li>
<li><a href="#scripting-type-operations-example-file">Returning a file</a></li>
<li><a href="#scripting-type-operations-example-users-traded">View users I&#8217;ve traded with</a></li>
<li><a href="#scripting-type-operations-example-records-empty-value">Search records with an empty field value</a></li>
<li><a href="#scripting-type-operations-example-easy-invoice-link">Get easy invoice link / QR-Code</a></li>
<li><a href="#scripting-type-operations-example-loan-request">Loan request (content page with action)</a></li>
<li><a href="#scripting-type-operations-example-external-records">Searching external records</a></li>
<li><a href="#scripting-type-operations-example-bulk-action-payment">Bulk action to perform a payment from system</a></li>
<li><a href="#scripting-type-operations-example-bulk-action-remove-canceled-tokens">Bulk action to remove canceled tokens</a></li>
<li><a href="#scripting-type-operation-rate-app">Mobile app rating</a></li>
<li><a href="#_sending_mobile_app_notifications">Sending mobile app notifications</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-wizards">4.4.12. Custom wizards</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-wizards-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-wizard-finish">Finish</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-wizard-finish-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-wizard-new">New execution</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-wizard-new-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-wizard-transition">Transition between steps</a></li>
<li><a href="#scripting-type-wizard-redirect">Redirect to external site</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-wizard-redirect-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-wizard-callback">External site callback</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-wizard-callback-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-wizard-tips">Tips</a></li>
<li><a href="#scripting-type-wizard-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-wizard-example-registration-top-up">Registration with a required top-up</a></li>
<li><a href="#scripting-type-wizard-example-next-step">Deciding the next step dynamically</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-web-services">4.4.13. Custom web services</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-web-services-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-web-services-result">Script result</a></li>
<li><a href="#scripting-type-web-services-exceptions">Handling exceptions</a></li>
<li><a href="#scripting-type-web-services-permissions">Permissions</a></li>
<li><a href="#scripting-type-web-services-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-web-services-example-payment">Perform a payment</a></li>
<li><a href="#scripting-type-web-services-example-sso">Single-sign-on (login users without their passwords)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-interceptors">4.4.14. Service interceptors</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-interceptors-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-interceptor-result">Script result</a></li>
<li><a href="#scripting-type-interceptor-recovery">Recovering from errors in crucial services</a></li>
<li><a href="#scripting-type-interceptor-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-interceptor-example-transfers-filters">Modifying the general transfers overview default filters</a></li>
<li><a href="#scripting-type-interceptor-example-default-sms">Marking mobile phones enabled for SMS by default on registrations by administrators or brokers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-recurring-tasks">4.4.15. Custom recurring tasks</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-recurring-tasks-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-recurring-tasks-result">Script result</a></li>
<li><a href="#scripting-type-recurring-tasks-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-recurring-tasks-example-import">Periodically importing a file</a></li>
<li><a href="#scripting-type-recurring-tasks-html">Periodically update a static HTML page</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-background-tasks">4.4.16. Custom background tasks</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-background-tasks-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-background-tasks-result">Script result</a></li>
<li><a href="#scripting-type-background-tasks-schedule">Scheduling background tasks</a></li>
<li><a href="#scripting-type-background-tasks-fork-join">Using the fork-join model</a></li>
<li><a href="#scripting-type-background-tasks-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-background-tasks-example-schedule">Scheduling a bulk of custom background tasks</a></li>
<li><a href="#scripting-type-background-tasks-example-schedule-fork-join">Scheduling a bulk of custom background tasks with fork-join</a></li>
<li><a href="#scripting-type-background-tasks-example-process">Process each record</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-sms-operation">4.4.17. Custom SMS operations</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-sms-operation-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-sms-operation-result">Script result</a></li>
<li><a href="#scripting-type-sms-operation-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-sms-operation-example-taxi">Pay taxi with an SMS message</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-inbound-sms">4.4.18. Inbound SMS handling</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-inbound-sms-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-inbound-sms-resolve">Resolve basic SMS data</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-inbound-sms-resolve-result">Result</a></li>
</ul>
</li>
<li><a href="#scripting-type-inbound-sms-response">Return response to gateway</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-inbound-sms-response-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-inbound-sms-response-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-inbound-sms-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-inbound-sms-example-json">Receiving an SMS in JSON format</a></li>
<li><a href="#scripting-type-inbound-sms-example-custom">Receiving an SMS with a custom format</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-outbound-sms">4.4.19. Outbound SMS handling</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-outbound-sms-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-outbound-sms-result">Script result</a></li>
<li><a href="#scripting-type-outbound-sms-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-outbound-sms-example-json">Sending SMS requests as JSON</a></li>
<li><a href="#scripting-type-outbound-sms-example-xml">Sending SMS requests as XML</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-link">4.4.20. Link generation</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-link-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-link-result">Script result</a></li>
<li><a href="#scripting-type-link-login">Login</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-login-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-root">Root</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-root-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-home">Home</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-home-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-notification">Notification</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-notification-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-registration-validation">Registration validation</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-registration-validation-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-operation-external-redirect">Custom operation redirect</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-operation-external-redirect-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-wizard-external-redirect">Wizard redirect</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-wizard-external-redirect-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-wizard-execution">Wizard execution</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-wizard-execution-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-ticket">Pay ticket</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-ticket-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-easy-invoice">Easy invoice</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-easy-invoice-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-mobile-redirect">Mobile / mobile redirect</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-mobile-redirect-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-reply-message">Reply a message</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-reply-message-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-email-unsubscribe">Email unsubscription</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-email-unsubscribe-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-email-change">Email change</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-email-change-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-voucher-info">Voucher information</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-voucher-info-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-idp-redirect">Identity provider redirect</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-idp-redirect-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-idp-callback">Identity provider callback</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-idp-callback-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-invite">Invite</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-invite-bindings">Additional bound variables</a></li>
</ul>
</li>
<li><a href="#scripting-type-link-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-link-example-location">Link generation for the frontend</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-phone-number">4.4.21. Phone number handling</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-phone-number-parse">Parse</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-phone-number-parse-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-phone-number-parse-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-phone-number-sample">Generate an example number</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-phone-number-sample-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-phone-number-sample-result">Script result</a></li>
</ul>
</li>
<li><a href="#scripting-type-phone-number-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-phone-number-brazil">Custom Brazilian phone number handling</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-ip-geolocation">4.4.22. IP geolocation</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-ip-geolocation-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-ip-geolocation-result">Script result</a></li>
<li><a href="#scripting-type-ip-geolocation-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-ip-geolocation-example-ipinfo">IP geolocation with IPinfo.io</a></li>
<li><a href="#scripting-type-ip-geolocation-example-ipbase">IP geolocation with ipbase</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-export-format">4.4.23. Export formats</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-export-format-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-export-format-result">Script result</a></li>
<li><a href="#scripting-type-export-format-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-export-format-example-mt490">Exporting the account history as Swift MT940 format</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-notifications">4.4.24. Notifications</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-notifications-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-notifications-result">Script result</a></li>
<li><a href="#scripting-type-notifications-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-notifications-example-payment-received">Include the balance for a "Payment received" notification</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-content-helper">4.4.25. Content helper</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-content-helper-bindings">Additional bound variables</a></li>
<li><a href="#scripting-type-content-helper-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-content-helper-example-userRecords">Show user records in a content</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-type-run-directly">4.4.26. Running scripts directly</a>
<ul class="sectlevel4">
<li><a href="#scripting-type-run-directly-result">Result</a></li>
<li><a href="#scripting-type-run-directly-example">Examples</a>
<ul class="sectlevel5">
<li><a href="#scripting-type-run-directly-example-remove-data">Remove all users, transactions and related data</a></li>
<li><a href="#scripting-type-run-directly-export-ads-images">Export advertisements with images</a></li>
<li><a href="#scripting-type-run-directly-example-generate-account-numbers">Generating an account number for all accounts which doesn&#8217;t have a number yet</a></li>
<li><a href="#scripting-type-run-directly-example-custom-pdf">Generating a custom PDF file</a></li>
<li><a href="#scripting-type-run-directly-example-fix-balances">Manual account balance verification</a></li>
<li><a href="#scripting-type-run-directly-example-rebuild-balances">Manually rebuilding closed account balances</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-solution">4.5. Solutions using scripts</a>
<ul class="sectlevel3">
<li><a href="#scripting-solution-paypal">4.5.1. PayPal Integration</a>
<ul class="sectlevel4">
<li><a href="#scripting-solution-paypal-root-url">Check the root URL</a></li>
<li><a href="#scripting-solution-paypal-tx-number">Enable transaction number in currency</a></li>
<li><a href="#scripting-solution-paypal-system-record-type">Create a system record type to store the client id and secret</a></li>
<li><a href="#scripting-solution-paypal-user-record-type">Create a user record type to store each payment information</a></li>
<li><a href="#scripting-solution-paypal-library-script">Create the library script</a></li>
<li><a href="#scripting-solution-paypal-operation-script">Create the custom operation script</a></li>
<li><a href="#scripting-solution-paypal-operation">Create the custom operation</a></li>
<li><a href="#scripting-solution-paypal-system-account">Configure the system account from which payments will be performed to users</a></li>
<li><a href="#scripting-solution-paypal-payment-type">Configure the payment type which will be used on payments</a></li>
<li><a href="#scripting-solution-paypal-admin-permissions">Grant the administrator permissions</a></li>
<li><a href="#scripting-solution-paypal-credentials">Setup the PayPal credentials</a></li>
<li><a href="#scripting-solution-paypal-user-permissions">Grant the user permissions / enable the operation</a></li>
<li><a href="#scripting-solution-paypal-script-params">Configuring the script parameters</a></li>
<li><a href="#scripting-solution-paypal-other">Other considerations</a></li>
</ul>
</li>
<li><a href="#scripting-solution-loan">4.5.2. Loan module</a>
<ul class="sectlevel4">
<li><a href="#scripting-solution-loan-tx-number">Enable transaction number in currency</a></li>
<li><a href="#scripting-solution-loan-status-flow">Create the transfer status flow</a></li>
<li><a href="#scripting-solution-loan-tx-fields">Create the payment custom fields</a></li>
<li><a href="#scripting-solution-loan-system-account">Configure the system account from which payments will be performed to users</a></li>
<li><a href="#scripting-solution-loan-type-grant">Create the payment type which will be used to grant the loan</a></li>
<li><a href="#scripting-solution-loan-user-account">Configure the user account which will receive loans</a></li>
<li><a href="#scripting-solution-loan-type-repay">Create the payment type which will be used to repay the loan</a></li>
<li><a href="#scripting-solution-loan-library">Create the library script</a></li>
<li><a href="#scripting-solution-loan-operation-script">Create the custom operation script</a></li>
<li><a href="#scripting-solution-loan-extension-points">Create two extension point scripts</a></li>
<li><a href="#scripting-solution-loan-operation">Create the custom operation</a></li>
<li><a href="#scripting-solution-loan-extensions">Create the extension points</a></li>
<li><a href="#scripting-solution-loan-admin-permissions">Grant the administrator permissions</a></li>
<li><a href="#scripting-solution-loan-user-permissions">Enable the custom operation for users which will be able to receive loans</a></li>
</ul>
</li>
<li><a href="#scripting-solution-record">4.5.3. Record management</a>
<ul class="sectlevel4">
<li><a href="#scripting-solution-record-type">Create the user record type to work with and give permissions</a></li>
<li><a href="#scripting-solution-record-library-script">Create the library script</a></li>
<li><a href="#scripting-solution-record-email-script">Create a custom operation script to send the record by email</a></li>
<li><a href="#scripting-solution-record-search-script">Create the custom operation script to search records</a></li>
<li><a href="#scripting-solution-record-create-script">Create the custom operation script to create records</a></li>
<li><a href="#scripting-solution-record-view-script">Create the custom operation script to view records</a></li>
<li><a href="#scripting-solution-record-update-script">Create the custom operation script to update records</a></li>
<li><a href="#scripting-solution-record-remove-script">Create the custom operation script to remove records</a></li>
<li><a href="#scripting-solution-record-remove-operation">Create the custom operation to remove records</a></li>
<li><a href="#scripting-solution-record-update-operation">Create the custom operation to update records</a></li>
<li><a href="#scripting-solution-record-email-operation">Create the custom operation to send the record email</a></li>
<li><a href="#scripting-solution-record-view-operation">Create the custom operation to view records details</a></li>
<li><a href="#scripting-solution-record-create-operation">Create the custom operation to create records</a></li>
<li><a href="#scripting-solution-record-search-operation">Create the custom operation to search records</a></li>
<li><a href="#scripting-solution-record-permissions">Enable the custom operation for users</a></li>
</ul>
</li>
<li><a href="#scripting-solution-user-balances">4.5.4. User balances</a>
<ul class="sectlevel4">
<li><a href="#scripting-solution-user-balances-load-accounts-script">Create the script to load user account types</a></li>
<li><a href="#scripting-solution-user-balances-load-groups-script">Create the script to load user groups</a></li>
<li><a href="#scripting-solution-user-balances-search-script">Create the custom operation script to search users balances</a></li>
<li><a href="#scripting-solution-user-balances-search-operation">Create the custom operation to search users balances</a></li>
<li><a href="#scripting-solution-user-balances-permissions">Enable the custom operation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scripting-storage">4.6. Script storage</a></li>
<li><a href="#scripting-custom-alerts">4.7. Custom alerts</a></li>
<li><a href="#scripting-debug">4.8. Debugging scripts</a></li>
</ul>
</li>
<li><a href="#content-management">5. Content management</a>
<ul class="sectlevel2">
<li><a href="#content-security">5.1. Security considerations</a></li>
<li><a href="#content-user-variables">5.2. User variables</a></li>
<li><a href="#content-thymeleaf">5.3. Using Thymeleaf for dynamic content</a>
<ul class="sectlevel3">
<li><a href="#content-thymeleaf-markup">5.3.1. Thymeleaf markup</a></li>
<li><a href="#content-thymeleaf-expression-objects">5.3.2. Thymeleaf expression utility objects</a>
<ul class="sectlevel4">
<li><a href="#content-thymeleaf-expression-objects-format">#format</a></li>
<li><a href="#content-thymeleaf-expression-objects-decimals">#decimals</a></li>
<li><a href="#content-thymeleaf-expression-objects-accounts">#accounts</a></li>
<li><a href="#content-thymeleaf-expression-objects-permissions">#permissions</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Welcome to the Cyclos 4 PRO Documentation for version 4.16.3. For other versions, see <a href="https://www.cyclos.org/documentation" class="bare">https://www.cyclos.org/documentation</a>.</p>
</div>
<div class="paragraph">
<p>There are also some other important documentation resources that are not part of this manual:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There are two (end user) Cyclos 4 manuals (make sure you are not logged into <a href="https://communities.cyclos.org" class="bare">https://communities.cyclos.org</a>):</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://communities.cyclos.org/content/help/admin">Administrator manual</a></p>
</li>
<li>
<p><a href="https://communities.cyclos.org/content/help/user">User manual</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Some functions are described with more details in our wiki:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.cyclos.org/index.php/Imports_quick_steps">Imports</a></p>
</li>
<li>
<p><a href="https://wiki.cyclos.org/index.php/Easy_invoicing_and_webshop_ticketing_quick_steps">Easy invoicing and ticketing</a></p>
</li>
<li>
<p><a href="https://wiki.cyclos.org/index.php/POS_(Point_of_Sale)_%26_Cards_quick_steps">Point of sale and cards</a></p>
</li>
<li>
<p><a href="https://wiki.cyclos.org/index.php/Vouchers:_how_to">Vouchers</a></p>
</li>
<li>
<p><a href="https://wiki.cyclos.org/index.php/System_-_Configurations">Configurations</a></p>
</li>
<li>
<p><a href="https://wiki.cyclos.org/index.php/Users_-_Products">Products (permissions)</a></p>
</li>
<li>
<p>And much more&#8230;&#8203; visit the <a href="https://wiki.cyclos.org">wiki</a> for more details.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cyclos instruction videos:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cyclos.org/documentation/cyclos-4-communities-instruction-videos">Cyclos 4 communities</a></p>
</li>
<li>
<p><a href="https://www.cyclos.org/documentation/cyclos-4-pro-instruction-videos">Cyclos 4 PRO</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Finally, there are many responses, as well as community support, in our
<a href="https://www.cyclos.org/forum">forum</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setup">1. Cyclos setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the installation manual for Cyclos 4 PRO. Cyclos is server side software. End users (customers) will access Cyclos using a web browser or mobile phone.</p>
</div>
<div class="paragraph">
<p>If you have any problems when installing Cyclos using this manual, you can ask for help on our <a href="https://www.cyclos.org/forum">forum</a>.</p>
</div>
<div class="paragraph">
<p>Cyclos can be installed in a <a href="#setup-installation-tomcat">Tomcat server</a> or by using a <a href="#setup-installation-docker">Docker container</a>. If you want to have a quick preview of Cyclos it is easier to use Docker (especially on Linux).</p>
</div>
<div class="sect2">
<h3 id="setup-installation">1.1. Installation</h3>
<div class="sect3">
<h4 id="setup-installation-tomcat">1.1.1. Installation with Tomcat</h4>
<div class="paragraph">
<p>This method will deploy Cyclos as a web application of an existing <a href="https://tomcat.apache.org/forum">Apache Tomcat</a> server.</p>
</div>
<div class="sect4">
<h5 id="setup-installation-tomcat-requirements">System requirements</h5>
<div class="ulist">
<ul>
<li>
<p>Operating system: Linux (x86_64 or arm64), Windows (64) or Mac;</p>
</li>
<li>
<p>At least 2 GB memory available for the JVM;</p>
</li>
<li>
<p>Java Runtime Environment (JRE), Java 11 is required;</p>
</li>
<li>
<p>Web server: Apache Tomcat 9.0. Tomcat 10+ implements Jakarta EE 10, which is not compatible with Cyclos 4.16.3;</p>
</li>
<li>
<p>Database server: PostgreSQL 12 or higher;</p>
</li>
<li>
<p>Cyclos installation package cyclos-4.16.3.zip;</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-tomcat-java">Install Java</h5>
<div class="paragraph">
<p>You can check if you have Java at least with version 11 installed by opening a command prompt and typing this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">java <span class="nt">--version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t have Java, or the version is below 11, proceed with the steps below:</p>
</div>
<div class="paragraph">
<p><strong>Linux (Ubuntu)</strong></p>
</div>
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>apt <span class="nb">install </span>openjdk-<span class="o">{</span>java-version<span class="o">}</span><span class="nt">-jre</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Windows</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Follow the instructions of <a href="https://docs.oracle.com/en/java/javase/17/install/installation-jdk-microsoft-windows-platforms.html">Installation of the JDK on Microsoft Windows Platforms</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-tomcat-postgresql">Install the PostgreSQL database</h5>
<div class="paragraph">
<p><strong>Linux (Ubuntu)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>apt <span class="nb">install </span>postgresql postgis</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, test your installation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo</span> <span class="nt">-u</span> postgres psql</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you see <code>postgres=#</code> you are in the PostgreSQL command line, and you can follow the instructions below.</p>
</div>
<div class="paragraph">
<p><strong>Windows</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download the latest version of <a href="http://www.postgresql.org/download/windows">PostgreSQL</a> and <a href="http://postgis.net/windows_downloads">PostGIS</a>;</p>
</li>
<li>
<p>Install both PostgreSQL and PostGIS by following the installer steps (use the default options);</p>
</li>
<li>
<p>Make sure the bin directory is included in the system variables, so that you can run psql directly from the command line:</p>
<div class="ulist">
<ul>
<li>
<p>Go to: <em>Start &gt; Control Panel &gt; System and Security &gt; System &gt; Advanced system settings &gt; Environment Variables</em>;</p>
</li>
<li>
<p>Then go to the system variable with the name "Path" and add the bin directory of the PostgreSQL installation directory as a value, such as <code>C:\Program Files\PostgreSQL\14\bin</code>. Don&#8217;t forget to separate the values with a semicolon.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Go to the Windows command line and type the command (you will be asked for the password you specified when installing PostgreSQL):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">psql <span class="nt">-U</span> postgres</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you see <code>postgres=#</code> you are in the PostgreSQL command line, and you can follow the instructions below.</p>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-tomcat-database">Create the Cyclos database</h5>
<div class="paragraph">
<p>After configuring the PostgreSQL server, you should run the following commands in <code>psql</code> (same command as listed below to test the PostgreSQL connection):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">create user cyclos with encrypted password <span class="s1">'cyclos-password'</span><span class="p">;</span>
create database cyclos4 encoding <span class="s1">'utf-8'</span> template template0 owner cyclos<span class="p">;</span>
<span class="se">\c</span> cyclos4
create extension cube<span class="p">;</span>
create extension earthdistance<span class="p">;</span>
create extension postgis<span class="p">;</span>
create extension unaccent<span class="p">;</span>
create extension pgcrypto<span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then exit the <code>psql</code> command by typing <code>\q</code> and pressing enter.</p>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-tomcat-server">Install Tomcat web server</h5>
<div class="ulist">
<ul>
<li>
<p>Download Tomcat 9 (cannot be 10+ because of the Jakarta namespace changes) from <a href="https://tomcat.apache.org/" class="bare">https://tomcat.apache.org/</a>;</p>
</li>
<li>
<p>Extract the zipped  file into a folder &lt;tomcat home&gt;;</p>
</li>
<li>
<p>Start tomcat: <code>&lt;tomcat home&gt;/bin/startup.bat</code> (Windows) or <code>&lt;tomcat home&gt;/bin/startup.sh</code> (Linux). You might have to give the execution permissions to the file;</p>
</li>
<li>
<p>Open a browser and go to <a href="http://localhost:8080/" class="bare">http://localhost:8080/</a> to check for installation;</p>
</li>
<li>
<p>The default JVM memory heap size of Tomcat is very low, we recommend increasing it (see <a href="#setup-adjustments-java">adjustments</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-tomcat-cyclos">Install Cyclos</h5>
<div class="paragraph">
<p>Make sure Tomcat is working on port 8080 of the local machine. Also make sure the user running Tomcat has permissions to write in the <code>webapps</code> directory. Then</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit our license server at <a href="https://license.cyclos.org/" class="bare">https://license.cyclos.org/</a>;</p>
</li>
<li>
<p>Register yourself. With the registration, you can run free licenses, which allows running systems with up to 300 users;</p>
</li>
<li>
<p>Download the latest Cyclos version;</p>
</li>
<li>
<p>Unzip the <code>cyclos-<em>version</em>.zip</code> into a temporary directory;</p>
</li>
<li>
<p>Browse to the temporary directory and copy the directory <code>web</code> (including its contents) into the webapps directory (&lt;tomcat_home&gt;/webapps) of the Tomcat installation;</p>
</li>
<li>
<p>Rename this web directory to the name that you will want to use at the URL, in this example we will use <code>instance_name</code>. This name will define how users will access Cyclos. For example, if you run the tomcat server on <code><a href="https://www.domain.com" class="bare">https://www.domain.com</a></code>. the URL would be <code><a href="http://www.domain.com/instance_name" class="bare">http://www.domain.com/instance_name</a></code>. Cyclos has some reserved words that cannot be used for the instance name:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">cyclos.gwt
fonts
js
pay
consent
unsubscribe
voucher
classic
ui
.well-known
robots.txt
sitemap.xml
sitemap-index.xml
sitemap.xstl
activate-access-client
external-redirect-callback
identity
run
content
web-rpc
java-rpc
api
sms
push-notifications
global
redirect
mobile-redirect</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Of course, it is also possible (and recommended) to run Cyclos directly under the domain name. This can be done by renaming the <code>web</code> directory to <code>ROOT</code>. You should first remove the existing <code>ROOT</code> directory;</p>
</li>
<li>
<p>In the folder <code>&lt;tomcat_home&gt;/webapps/&lt;instance_name&gt;/WEB-INF/classes</code>, you&#8217;ll find the file <code>cyclos-release.properties</code>. Copy this file, giving it the name <code>cyclos.properties</code>. The original name is not shipped, so in future installations you can just override the entire folder, and your customizations won&#8217;t be lost;</p>
</li>
<li>
<p>In the <code>cyclos.properties</code> file, you can set the database configuration. Here you have to specify the username and password, by default it is set as <code>cyclos4</code> as database name and <code>cyclos</code> as username and password. For production, it is recommended to change the password:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">cyclos.datasource.provider</span> <span class="p">=</span> <span class="s">hikari</span>
<span class="py">cyclos.datasource.dataSourceClassName</span> <span class="p">=</span> <span class="s">org.postgresql.ds.PGSimpleDataSource</span>
<span class="py">cyclos.datasource.dataSource.portNumber</span> <span class="p">=</span> <span class="s">5432</span>
<span class="py">cyclos.datasource.dataSource.serverName</span> <span class="p">=</span> <span class="s">localhost</span>
<span class="py">cyclos.datasource.dataSource.databaseName</span> <span class="p">=</span> <span class="s">cyclos4</span>
<span class="py">cyclos.datasource.dataSource.user</span> <span class="p">=</span> <span class="s">cyclos</span>
<span class="py">cyclos.datasource.dataSource.password</span> <span class="p">=</span> <span class="s">cyclos</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Notes:</p>
<div class="ulist">
<ul>
<li>
<p>Some systems do not resolve <code>localhost</code> and the default PostgreSQL port directly. In case of database connectivity problems, try replacing it with the IP address of your system;</p>
</li>
<li>
<p>Windows might not see line breaks in the property file, if this is the case we advise you to download a more advanced text editor such as <a href="http://notepad-plus-plus.org/">Notepad++</a>;</p>
</li>
<li>
<p>On Windows, in case of problems, you can change the <code>cyclos.tempDir</code> setting in <code>cyclos.properties</code>. Point it to a <code>temp`</code> directory inside the <code>WEB-INF</code> directory in Cyclos. E.g. <code>cyclos.tempDir = C:\Program Files\Tomcat9\webapps\instance_name\WEB-INF\temp</code>. In some cases, even forward slashes need to be used.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Afterward, specially in Linux systems, make sure that all files inside <code>&lt;tomcat_home&gt;/webapps/&lt;instance_name&gt;</code> can be read / written by the system user that will run the Tomcat service.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-tomcat-start">Start Cyclos</h5>
<div class="ulist">
<ul>
<li>
<p>(Re)start Tomcat:</p>
<div class="ulist">
<ul>
<li>
<p>Stop with <code>&lt;tomcat_home&gt;/bin/stop.bat</code> (Windows) or <code>&lt;tomcat_home&gt;/bin/stop.sh</code> (Linux);</p>
</li>
<li>
<p>Start with <code>&lt;tomcat_home&gt;/bin/startup.bat</code> (Windows) or <code>&lt;tomcat_home&gt;/bin/startup.sh</code> (Linux);</p>
</li>
<li>
<p>Windows: you can use Tomcat monitor (available after tomcat installation).</p>
</li>
</ul>
</div>
</li>
<li>
<p>When Tomcat is started and Cyclos initialized, open a web browser to <a href="http://localhost:8080/instance_name" class="bare">http://localhost:8080/instance_name</a>. Be aware, starting up Cyclos for the first time might take quite some time, because the database needs to be initialized. On a slow computer, this could take a few minutes!;</p>
</li>
<li>
<p>Upon the first start of Cyclos you will be asked to fill in the username and password you used for registration in the <a href="https://license.cyclos.org/">license server</a>. You will also need to provide the information of a global administrator;</p>
</li>
<li>
<p>After submitting the correct information, the initialization process will finish, and you will be automatically logged-in as the created global administrator;</p>
</li>
<li>
<p>You will be presented with the network wizard to create the default network.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-tomcat-upgrade">Upgrading to a newer version</h5>
<div class="paragraph">
<p>Before upgrading, please, carefully follow <a href="#setup-upgrade">these steps</a>.</p>
</div>
<div class="paragraph">
<p>Then, to upgrade:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download the latest <code>cyclos-&lt;version&gt;.zip</code> file from the <a href="https://license.cyclos.org/">license server</a>;</p>
</li>
<li>
<p>Unzip the file to a temporary directory;</p>
</li>
<li>
<p>Stop the Tomcat server;</p>
</li>
<li>
<p>Remove all files in <code>&lt;tomcat_home&gt;/webapps/&lt;instance_name&gt;/WEB-INF/lib</code>;</p>
</li>
<li>
<p>Copy all files and directories from the temporary directory's <code>web</code> folder back to <code>&lt;tomcat_home&gt;/webapps/&lt;instance_name&gt;</code>, overwriting all existing files;</p>
</li>
<li>
<p>Start the Tomcat server.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-tomcat-problem-solving">Problem-solving</h5>
<div class="ulist">
<ul>
<li>
<p>Often, problems can be easily detected by looking at the log files:</p>
<div class="ulist">
<ul>
<li>
<p>The Tomcat&#8217;s <code>&lt;tomcat-home/logs/catalina.out</code> file;</p>
</li>
<li>
<p>Cyclos' own log files, as configured in <code>cyclos.properties</code>. The Cyclos log shows all relevant information about the services and tasks that run in Cyclos.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If the logs can&#8217;t help you to pin down the problem, you can search the <a href="https://www.cyclos.org/forum/viewforum.php?f=13">Cyclos forum (installation issues)</a> if somebody encountered a similar problem;</p>
</li>
<li>
<p>If you can&#8217;t find an answer, post a new question in that same forum topic;</p>
</li>
<li>
<p>In case you locked yourself out of the system, see the section <a href="#setup-maintenance-reset-admin-password">Reset admin password directly on database</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup-installation-docker">1.1.2. Installation with Docker</h4>
<div class="paragraph">
<p>There is a Docker image for Cyclos, and the installation via Docker is very easy, and can be accomplished with a few steps. It can also be used for production with no drawbacks when compared to the Tomcat installation.</p>
</div>
<div class="paragraph">
<p>For details on how to install Cyclos via Docker image, visit the <a href="https://hub.docker.com/r/cyclos/cyclos/">Cyclos repository on Docker hub</a>. It contains detailed information on installation and maintenance.</p>
</div>
<div class="paragraph">
<p>For details on how to install docker, please visit <a href="https://docs.docker.com/engine/install/" class="bare">https://docs.docker.com/engine/install/</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-installation-k8s-aws">1.1.3. Installation with Kubernetes (EKS)</h4>
<div class="paragraph">
<p>This method will deploy Cyclos with <a href="https://kubernetes.io">Kubernetes</a> using <a href="https://aws.amazon.com/eks/">Amazon Elastic Kubernetes Service (EKS)</a>. Kubernetes is the industry standard system for cluster orchestration, but the setup process is provider-dependent. Many of the following concepts and steps can be adjusted for other providers.</p>
</div>
<div class="paragraph">
<p>Please, note that there are many steps to follow. Please, follow each one carefully!</p>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-requirements">Requirements</h5>
<div class="paragraph">
<p>You will need the following CLI tools. Please, refer to their respective websites for installation instructions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.docker.com/">Docker</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/reference/kubectl/">kubectl</a></p>
</li>
<li>
<p><a href="https://aws.amazon.com/cli/">AWS CLI V2</a></p>
</li>
<li>
<p><a href="https://eksctl.io/">CLI for Amazon EKS</a></p>
</li>
<li>
<p><a href="https://helm.sh/">Helm</a> V3+</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-cluster-iam">Create the required IAM roles</h5>
<div class="paragraph">
<p>You need a separated IAM role for the cluster to use (Cluster service role). You&#8217;ll also need one for the node group. For this, go to the <a href="https://console.aws.amazon.com/iam/">Amazon IAM console</a>, and go to 'Roles'.</p>
</div>
<div class="paragraph">
<p>Create the cluster role with the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Trusted entity type: AWS service</p>
</li>
<li>
<p>Use cases for other AWS services: EKS</p>
</li>
<li>
<p>Check EKS - Cluster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Choose 'Next' and 'Next' again. In 'Name, review and create' set the name <code>cyclos-eks</code>, and a description, then click on 'Create role'.</p>
</div>
<div class="paragraph">
<p>Then create a new role for the node group with the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Trusted entity type: AWS service</p>
</li>
<li>
<p>Use case: EC2</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Choose 'Next'. In the 'Add permissions' page, copy and paste each of these permissions, checking the checkbox next to them for each one:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AmazonEKSWorkerNodePolicy</p>
</li>
<li>
<p>AmazonEC2ContainerRegistryReadOnly</p>
</li>
<li>
<p>AmazonEKS_CNI_Policy</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Choose 'Next'. In 'Name, review and create' set the name <code>cyclos-eks-nodes</code>, and a description, then click on 'Create role'.</p>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-subnets">Create separated VPC subnets</h5>
<div class="paragraph">
<p>It is required to have at least 2 subnets in your VPC, in different availability zones, which auto-assign IPv4 addresses. For this, in the <a href="https://console.aws.amazon.com/vpc/">Amazon VPC console</a>, click on 'Subnets', then create a new one. Choose your VPC, set a name, choose an availability zone, type in a valid IPv4 CIDR block (also for IPv6 if desired), then add the following tag (without it the load balancer won&#8217;t work):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Key: <code>kubernetes.io/role/elb</code></p>
</li>
<li>
<p>Value: <code>1</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then select the subnet you just created, click 'Actions' and select 'Edit subnet settings'. Check the 'Enable auto-assign public IPv4 address' and save it.</p>
</div>
<div class="paragraph">
<p>Then repeat all these steps for creating another subnet, just select another availability zone.</p>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-cli">Configure the AWS CLI</h5>
<div class="paragraph">
<p>If you already use the AWS CLI, skip this step.</p>
</div>
<div class="paragraph">
<p>In order to use the AWS CLI, you will need a 'Security credential'. In the Amazon console, in the top bar at the right, in your logged username, select 'Security credentials'. Scroll down to 'Access keys' and create a new one if you don&#8217;t have it yet. 'Choose Command Line Interface (CLI)' and click 'Next'. Then 'Create access key'.</p>
</div>
<div class="paragraph">
<p>It will show you both 'Access key' and 'Secret access key'. You&#8217;ll need both.</p>
</div>
<div class="paragraph">
<p>Now open a terminal console and type in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">aws configure</code></pre>
</div>
</div>
<div class="paragraph">
<p>Paste your 'Access key', then the 'Secret access key', then select the region you use by default and finally, as the output format, we suggest <code>json</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-cluster">Create the cluster</h5>
<div class="paragraph">
<p>Create a cluster in the <a href="https://console.aws.amazon.com/eks/">Amazon EKS console</a>. In 'Clusters', choose 'Add cluster' &gt; 'Create'. Select the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Name: cyclos (if you change it, you&#8217;ll need to adjust many of the other steps as well)</p>
</li>
<li>
<p>Kubernetes version: Choose either the default or the latest one</p>
</li>
<li>
<p>Cluster service role: cyclos-eks (the role previously created)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click 'Next'.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>VPC: Choose your VPC</p>
</li>
<li>
<p>Subnets: Choose the 2 subnets you&#8217;ve created previously</p>
</li>
<li>
<p>Security groups: Choose a security group that opens the ports 80 and 443 for public access. If you don&#8217;t have one, create one.</p>
</li>
<li>
<p>Cluster endpoint access: Public and private</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click 'Next'. You may turn on logging if desired, then click 'Next' again.</p>
</div>
<div class="paragraph">
<p>You will be presented with the add-ons. Leave the defaults and click 'Next'. Leave the defaults and click 'Next' again.</p>
</div>
<div class="paragraph">
<p>Finally, click on 'Create'. It will take a few minutes until the cluster is actually created.</p>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-connect-cluster">Connect to your cluster</h5>
<div class="paragraph">
<p>You&#8217;ll need to run the following command to update the <code>kubectl</code> configuration to point to your cluster. For this, run the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">aws eks update-kubeconfig <span class="nt">--name</span> cyclos</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure the cluster has finished creating. If not, it will fail with the message <code>Cluster status is CREATING</code>.</p>
</div>
<div class="paragraph">
<p>Then, test the connection to your cluster by typing in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl cluster-info</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you try it with an Amazon user which is not the one that created the cluster, an error will be presented. To fix it, grant permission to the current user with the following command, which must be executed by the cluster creator user (adjust the <code>&lt;account-id&gt;</code>, <code>&lt;current-user&gt;</code> and  <code>&lt;cluster-creator-user&gt;</code> variables):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">eksctl create iamidentitymapping <span class="se">\</span>
    <span class="nt">--cluster</span> cyclos <span class="se">\</span>
    <span class="nt">--arn</span> arn:aws:iam::&lt;account-id&gt;:user/&lt;current-user&gt; <span class="se">\</span>
    <span class="nt">--group</span> system:masters <span class="se">\</span>
    <span class="nt">--no-duplicate-arns</span> <span class="se">\</span>
    <span class="nt">--username</span> &lt;cluster-creator-user&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-node-group">Create a node group</h5>
<div class="paragraph">
<p>In your cluster details in <a href="https://console.aws.amazon.com/eks/">Amazon EKS console</a>, choose the 'Compute' tab and click 'Add node group'. Select the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Name: cyclos-nodes</p>
</li>
<li>
<p>Node IAM role: cyclos-eks-nodes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click 'Next'. Choose an AMI type (both x86_64 and ARM_64 architectures are supported). Choose the desired capacity, instance type (we recommend a minimum 4 GB of RAM and 2 CPUs, but depending on the system scale a better hardware is desirable) and disk size (recommended 20 GB). Also choose the desired scaling configuration (choose at least 2 nodes to ensure high availability). Click 'Next'.</p>
</div>
<div class="paragraph">
<p>Then select the 2 subnets you have previously created (which automatically assign public IPv4 addresses). Click on 'Create'. It will take several seconds to create the node group.</p>
</div>
<div class="paragraph">
<p>To check that the nodes were created, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl get nodes</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-database">Deploy the database service</h5>
<div class="paragraph">
<p>This guide assumes that you have a PostgreSQL 12+ database running. For production, we recommend using an 'Amazon RDS' with Engine type 'Aurora (PostgreSQL compatible)' database. In the database details in the <a href="https://console.aws.amazon.com/rds/">Amazon RDS console</a>, you have the 'Endpoint', which is the hostname that resolves to the database server.</p>
</div>
<div class="paragraph">
<p>Create locally a file named <code>postgresql.yaml</code> with the following content, replacing <code>&lt;database-endpoint&gt;</code> with the proper hostname:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">kind</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Service"</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">v1"</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">postgresql"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ExternalName</span>
  <span class="na">externalName</span><span class="pi">:</span> <span class="s">&lt;database-endpoint&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create the service with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl apply <span class="nt">-f</span> postgresql.yaml</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-cyclos-deploy">Deploy the Cyclos service</h5>
<div class="paragraph">
<p>To deploy Cyclos, create locally a file named <code>cyclos.yaml</code> with the following content, replacing the following variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;replicas&gt;</code>: The desired number of Cyclos cluster instances;</p>
</li>
<li>
<p><code>&lt;db-name&gt;</code>: The database name in your PostgreSQL server;</p>
</li>
<li>
<p><code>&lt;db-user&gt;</code>: The database user in your PostgreSQL server;</p>
</li>
<li>
<p><code>&lt;db-password&gt;</code>: The database password in your PostgreSQL server;</p>
</li>
<li>
<p><code>&lt;cyclos-version&gt;</code>: The desired Cyclos version. At the time of writing of this document, the most recent version was 4.16.3.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cyclos</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">&lt;replicas&gt;</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="s">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">cyclos</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="s">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">cyclos</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cyclos</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">cyclos/cyclos:&lt;cyclos-version&gt;</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">cyclos-web-port</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">JAVA_OPTS</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">-Xmx2G"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CLUSTER_K8S_DNS</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">cyclos-dns</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DB_HOST</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">postgresql</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DB_NAME</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;db-name&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DB_USER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;db-user&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DB_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;db-password&gt;</span>

<span class="nn">---</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cyclos-dns</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="s">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">cyclos</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create the service with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl apply <span class="nt">-f</span> cyclos.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>To verify the pods are using the correct image, run the following and verify the 'Image' field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl describe pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please, note that the first startup will take several seconds, specially if the database is being populated for the first time. You can also check the logs of each Cyclos pod with (replacing the <code>&lt;deployment&gt;</code> and <code>&lt;pod&gt;</code> variables with the ones returned by the previous command):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl logs <span class="nt">-f</span> cyclos-&lt;deployment&gt;-&lt;pod&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will block your terminal and update with new logs. Press <code>Control+C</code> to exit the log viewing and return to the terminal prompt.</p>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-publishing">Publishing Cyclos</h5>
<div class="paragraph">
<p>The Cyclos service needs to be publicly accessible, with the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The service needs to be accessible using a friendly URL, such as <code>https://account.my-domain.com</code>;</p>
</li>
<li>
<p>An SSL certificate is required in order to use the secure (HTTPS) protocol;</p>
</li>
<li>
<p>Incoming requests using the non-secure (HTTP) protocol will be redirected, switching to HTTPS;</p>
</li>
<li>
<p>Incoming requests need to be load-balanced into any of the Cyclos deployment replicas (pods).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To do so, an Amazon 'Application Load Balancer' (ALB) is required. The default, 'Classic load balancer', doesn&#8217;t support redirecting requests. Setting it up require several steps. Please, follow each of them carefully. Also, this documentation assumes your domain is managed by Amazon.</p>
</div>
<div class="sect5">
<h6 id="setup-installation-k8s-aws-publishing-certificate">Creating an SSL certificate</h6>
<div class="paragraph">
<p>In the <a href="https://console.aws.amazon.com/acm/">Amazon Certificate Manager console</a>, click in the 'Request' button. Choose 'Request a public certificate', and click 'Next'. Then you need to type in the target domain name. You can leave the rest of the options in their default values. Then press 'Request'.</p>
</div>
<div class="paragraph">
<p>The certificate is now in the pending validation status. To fix this, you need to go to the certificate details and click on the 'Create records in Route 53' button. It will validate the certificate. Take note of the certificate 'ARN'.</p>
</div>
</div>
<div class="sect5">
<h6 id="setup-installation-k8s-aws-publishing-roles">Setting up the load balancer roles</h6>
<div class="paragraph">
<p>First, you will need to associate the 'OpenID Connect provider' role for the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">eksctl utils associate-iam-oidc-provider <span class="nt">--cluster</span> cyclos <span class="nt">--approve</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then register an IAM policy. You need to download the latest release of the <code>iam_policy.json</code> file to a local folder. To get which is the latest version, visit the <a href="https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases">releases page</a>, taking note of the latest release (should be something like <code>v2.4.6</code>). Then download the file, replacing the <code>&lt;version&gt;</code> variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-O</span> https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/&lt;version&gt;/docs/install/iam_policy.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now create the IAM policy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">aws iam create-policy <span class="se">\</span>
  <span class="nt">--policy-name</span> AWSLoadBalancerControllerIAMPolicy <span class="se">\</span>
  <span class="nt">--policy-document</span> file://iam_policy.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you need to create an IAM role for the load balance controller. Replace the <code>&lt;account-id&gt;</code> variable with your AWS account id:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">eksctl create iamserviceaccount <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>cyclos <span class="se">\</span>
  <span class="nt">--namespace</span><span class="o">=</span>kube-system <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>aws-load-balancer-controller <span class="se">\</span>
  <span class="nt">--role-name</span> AmazonEKSLoadBalancerControllerRole <span class="se">\</span>
  <span class="nt">--attach-policy-arn</span><span class="o">=</span>arn:aws:iam::&lt;account-id&gt;:policy/AWSLoadBalancerControllerIAMPolicy <span class="se">\</span>
  <span class="nt">--approve</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="setup-installation-k8s-aws-publishing-controller">Install the load balancer controller</h6>
<div class="paragraph">
<p>Now you need to install the load balancer controller in your cluster, using Helm. First add the EKS repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">helm repo add eks https://aws.github.io/eks-charts</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now update the local repositories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">helm repo update</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, install the AWS load balancer controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">helm <span class="nb">install </span>aws-load-balancer-controller eks/aws-load-balancer-controller <span class="se">\</span>
  <span class="nt">-n</span> kube-system <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">clusterName</span><span class="o">=</span>cyclos <span class="se">\</span>
  <span class="nt">--set</span> serviceAccount.create<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> serviceAccount.name<span class="o">=</span>aws-load-balancer-controller</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you need to create the Kubernetes' Ingress controller. It will be responsible for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Receiving incoming HTTP requests;</p>
</li>
<li>
<p>Ensure the HTTPS protocol is used (will redirect from plain HTTP to HTTPS);</p>
</li>
<li>
<p>Validate the SSL certificate;</p>
</li>
<li>
<p>Forward requests to one of the Cyclos pods (load-balancing them).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To create this service, create a local file named <code>ingress-controller.yaml</code> with the following content (remember to update the <code>&lt;certificate-arn&gt;</code> variable with the ARN of the SSL certificate you&#8217;ve <a href="#setup-installation-k8s-aws-publishing-certificate">created before</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-srv</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="c1"># Ingress Core Settings</span>
    <span class="s">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s">alb</span>
    <span class="s">alb.ingress.kubernetes.io/scheme</span><span class="pi">:</span> <span class="s">internet-facing</span>
    <span class="c1">## SSL Settings</span>
    <span class="s">alb.ingress.kubernetes.io/listen-ports</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[{"HTTP":</span><span class="nv"> </span><span class="s">80},</span><span class="nv"> </span><span class="s">{"HTTPS":443}]'</span>
    <span class="s">alb.ingress.kubernetes.io/certificate-arn</span><span class="pi">:</span> <span class="s">&lt;certificate-arn&gt;</span>
    <span class="c1"># SSL Redirect Setting</span>
    <span class="s">alb.ingress.kubernetes.io/actions.ssl-redirect</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{"Type":</span><span class="nv"> </span><span class="s">"redirect",</span><span class="nv"> </span><span class="s">"RedirectConfig":</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">"Protocol":</span><span class="nv"> </span><span class="s">"HTTPS",</span><span class="nv"> </span><span class="s">"Port":</span><span class="nv"> </span><span class="s">"443",</span><span class="nv"> </span><span class="s">"StatusCode":</span><span class="nv"> </span><span class="s">"HTTP_301"}}'</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
        <span class="na">paths</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
            <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
            <span class="na">backend</span><span class="pi">:</span>
              <span class="na">service</span><span class="pi">:</span>
                <span class="na">name</span><span class="pi">:</span> <span class="s">ssl-redirect</span>
                <span class="na">port</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">use-annotation</span>
          <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
            <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
            <span class="na">backend</span><span class="pi">:</span>
              <span class="na">service</span><span class="pi">:</span>
                <span class="na">name</span><span class="pi">:</span> <span class="s">cyclos-server</span>
                <span class="na">port</span><span class="pi">:</span>
                  <span class="na">number</span><span class="pi">:</span> <span class="m">80</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cyclos-server</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="s">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">cyclos</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now actually create the service in Kubernetes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl apply <span class="nt">-f</span> ingress-controller.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there was an error, delete the IAM service account with <code>eksctl delete iamserviceaccount --cluster=cyclos --namespace=kube-system --name=aws-load-balancer-controller</code>, uninstall the service with <code>helm uninstall aws-load-balancer-controller -n kube-system</code> and retry the previous steps.</p>
</div>
<div class="paragraph">
<p>To verify that the controller is running, execute the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl get deployment <span class="nt">-n</span> kube-system aws-load-balancer-controller</code></pre>
</div>
</div>
<div id="setup-installation-k8s-aws-publishing-load-balancer-id" class="paragraph">
<p>Also, check the created load balancer identifier by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl get ingress</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will need this load balancer identifier for the next step.</p>
</div>
</div>
<div class="sect5">
<h6 id="setup-installation-k8s-aws-publishing-dns">Update the load balancer DNS</h6>
<div class="paragraph">
<p>In the <a href="https://console.aws.amazon.com/route53/">Amazon Route 53 console</a>, select 'Hosted zones'. Select your zone. Click on 'Create record'. In the record name, type in the subdomain. The 'Record type' must be 'A'. Then check the 'Alias' toggle. Then set 'Route traffic to' as 'Alias to Application and Classic Load Balancer'. Select your region below. Then select the load balancer that was created as noted in the <a href="#setup-installation-k8s-aws-publishing-load-balancer-id">previous step</a> (it may be prefixed with <code>dualstack.</code>). Click on 'Create records' and you&#8217;re done.</p>
</div>
<div class="paragraph">
<p>Finally, open a web browser pointing to your domain, and you should have access to your instance.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="setup-installation-k8s-aws-upgrade">Upgrading to a newer version</h5>
<div class="paragraph">
<p>Before upgrading, please, carefully follow <a href="#setup-upgrade">these steps</a>.</p>
</div>
<div class="paragraph">
<p>Important! Cyclos doesn&#8217;t support rolling updates because it needs to upgrade the database schema.</p>
</div>
<div class="paragraph">
<p>So, first you need to stop all cluster instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl scale <span class="nt">--replicas</span><span class="o">=</span>0 deployments/cyclos</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you need to update the Cyclos deployment to use the new image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl <span class="nb">set </span>image deployments/cyclos <span class="nv">cyclos</span><span class="o">=</span>cyclos/cyclos:&lt;new-version&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, scale the deployment back to the desired number of replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl scale <span class="nt">--replicas</span><span class="o">=</span>&lt;replicas&gt; deployments/cyclos</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setup-upgrade">1.2. Upgrading to a newer version</h3>
<div class="paragraph">
<p><strong>IMPORTANT!</strong> Before upgrading, always:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Carefully review the release notes in the <a href="https://license.cyclos.org/">license server</a>, specially with milestone upgrades, such as from 4.10 to 4.11. Sometimes there are new system requirements (newer Java / PostgreSQL versions, for example), or manual actions that could make the upgrade fail if not applied first (such as creating a new extension in PostgreSQL);</p>
</li>
<li>
<p>Make a backup (dump) of the database. New Cyclos versions generally contain new functionality that requires the database to be modified. With milestone upgrades these changes can be major, and, in case of failure, you should always have a backup to be able to restore;</p>
</li>
<li>
<p>First upgrade a test environment. This is very important. Specially for milestone releases, never upgrade the production instance without testing it first! See <a href="#setup-maintenance-test-environment">Setup a test environment</a> for more details;</p>
</li>
<li>
<p>Specially with milestone upgrades, test all your scripts and API calls;</p>
</li>
<li>
<p>Milestone versions can include new settings in <code>cyclos-release.properties</code>. It might be interesting to study the new file to see if a new setting can be useful for your installation;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If everything went well in the test environment, then upgrade the live environment.</p>
</div>
<div class="paragraph">
<p>Note for upgrades from versions prior to 4.15: In Cyclos 4.15 a new PostgreSQL extension is required: <code>pgcrypto</code>. It requires being created as superuser. If the database user configured in <code>cyclos.properties</code> is not a superuser,
please connect to the Cyclos database and run the following commands as a superuser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="n">extension</span> <span class="n">pgcrypto</span><span class="p">;</span>
<span class="k">drop</span> <span class="k">index</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">ix_background_task_executions</span><span class="p">;</span>
<span class="k">create</span> <span class="k">unique</span> <span class="k">index</span> <span class="n">ix_background_task_executions</span> <span class="k">on</span> <span class="n">background_task_executions</span> <span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">digest</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">'sha512'</span><span class="p">));</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setup-adjustments">1.3. Adjustments (optional)</h3>
<div class="paragraph">
<p>There are many additional steps for configuring Cyclos, specially for production, as well as tuning it for large systems.</p>
</div>
<div class="sect3">
<h4 id="setup-adjustments-java">1.3.1. Adjust Tomcat/Java memory</h4>
<div class="paragraph">
<p>The default memory heap size of Tomcat is very low. You can augment this in the following way:</p>
</div>
<div class="paragraph">
<p><strong>Windows</strong></p>
</div>
<div class="paragraph">
<p>In the bin directory of Tomcat create (if it doesn't exist) a file called <code>setenv.bat</code>, edit this file and add the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">set </span><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="nt">-Xmx2g</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Linux</strong></p>
</div>
<div class="paragraph">
<p>In the bin directory of Tomcat create (if it doesn't exist) a file called <code>setenv.sh</code>, edit this file and add the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">"-Xmx2g"</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-oome">1.3.2. Handling out of memory errors</h4>
<div class="paragraph">
<p>When an <code>OutOfMemoryError</code> (<code>OOME</code>) is unhandled, it is generally advisable to kill the JVM. Although any operation can, theoretically, generate `OOME&#8217;s, one particular one is prone to it: generating PDFs. Cyclos uses the excellent <a href="https://github.com/danfickle/openhtmltopdf">openhtmltopdf</a> library, which transforms HTML documents to PDFs. However, as most HTML handling applications (such as browsers), the RAM requirement is high, depending on the size of the HTML document being processed.</p>
</div>
<div class="paragraph">
<p>When generating PDFs, Cyclos attempts to catch `OOME&#8217;s. However, if some other Tomcat thread gets out of memory in the same time, the entire server will become unresponsive, and there will be no additional choice than restarting the server.</p>
</div>
<div class="paragraph">
<p>The recommended approach is to use pass a JVM property (in a similar fashion to <a href="#setup-adjustments-java">memory adjustments</a>) to kill the JVM process in such cases. It is then the responsibility of an external service monitoring tool to restart the Tomcat server. The parameter to pass is <code>-XX:OnOutOfMemoryError="kill -9 %p"</code>.</p>
</div>
<div class="paragraph">
<p>In most systems, Cyclos is either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Executed via <a href="https://hub.docker.com/r/cyclos/cyclos/">Docker</a>. Starting with Cyclos 4.16.2, this parameter is included in the default in the Docker image. For previous versions, just set the environment variable <code>JAVA_OPTS="-XX:OnOutOfMemoryError=\"kill -9 %p\""</code>. Just remember to pass the <code>--init --restart=unless-stopped</code> arguments when starting the container. Without the <code>--init</code>, the java process will have pid 1, which is not killable in Linux;</p>
</li>
<li>
<p>Executed in a Linux server using <a href="https://systemd.io/">Systemd</a>. In this case, you should set <code>Restart=on-failure</code> and pass the <code>JAVA_OPTS</code> environment variable. As Systemd replaces <code>%p</code> by its service name, you should escape it with <code>%%p</code>. Here&#8217;s an example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="systemd">[Unit]
Description=Apache Tomcat for Cyclos
After=syslog.target network.target

[Service]
User=tomcat
Group=tomcat
Type=forking
Environment=CATALINA_PID=/opt/tomcat/cyclos.pid
Environment=CATALINA_HOME=/opt/tomcat
Environment=CATALINA_BASE=/opt/cyclos
Environment=JAVA_OPTS="-Djava.awt.headless=true -XX:OnOutOfMemoryError=\"kill -9 %%p\""
ExecStart=/opt/tomcat/bin/startup.sh
ExecStop=/opt/tomcat/bin/shutdown.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
<div class="paragraph">
<p>In both cases, if the Tomcat server has an unhandled <code>OOME</code>, it will be restarted instead of becoming unresponsive.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-ssl">1.3.3. Enable SSL/HTTPS</h4>
<div class="paragraph">
<p>Enabling SSL is crucial on live systems, as it protects sensitive information, like passwords, to be sent plain over the Internet, making it readable by eavesdroppers.</p>
</div>
<div class="paragraph">
<p>Generally it is advised to use a proxy server, like Apache or Nginx, that handles HTTPS and then redirect the request to Tomcat. See <a href="#setup-adjustments-apache-ssl">Enable SSL on Apache</a> for more details.</p>
</div>
<div class="paragraph">
<p>Otherwise, if the Tomcat server is directly accessible from the Internet, to enable SSL / HTTPS you first have to enable (uncomment) the <code>https</code> connector in the file <code>&lt;tomcat_home&gt;/conf/server.xml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"443"</span> <span class="na">maxHttpHeaderSize=</span><span class="s">"8192"</span>
    <span class="na">maxThreads=</span><span class="s">"150"</span> <span class="na">minSpareThreads=</span><span class="s">"25"</span> <span class="na">maxSpareThreads=</span><span class="s">"75"</span>
    <span class="na">enableLookups=</span><span class="s">"false"</span> <span class="na">disableUploadTimeout=</span><span class="s">"true"</span>
    <span class="na">acceptCount=</span><span class="s">"100"</span> <span class="na">scheme=</span><span class="s">"https"</span> <span class="na">secure=</span><span class="s">"true"</span>
    <span class="na">clientAuth=</span><span class="s">"false"</span> <span class="na">sslProtocol=</span><span class="s">"TLS"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Generate a key with the <code>keytool</code> utility that comes bundled with Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">keytool <span class="nt">-genkey</span> <span class="nt">-alias</span> tomcat <span class="nt">-keyalg</span> RSA <span class="nt">-keystore</span> /path/to/my/keystore</code></pre>
</div>
</div>
<div class="paragraph">
<p>After executing this command, you will first be prompted for the keystore password. Passwords are <strong>case-sensitive</strong>. You will also need to specify this password in the <code>server.xml</code> configuration file, as described later.</p>
</div>
<div class="paragraph">
<p>Next, you will be prompted for general information about this certificate, such as company, contact name, and so on. This information will be displayed to users who attempt to access a secure page in your application, so make sure that the information provided here matches what they will expect.</p>
</div>
<div class="paragraph">
<p>Finally, you will be prompted for the key password, which is the password specifically for this certificate (as opposed to any other Certificates stored in the same keystore file). You <strong>MUST</strong> use the same password here as was used for the keystore password itself, or Tomcat will have problems loading it. Currently, the keytool prompt will tell you that pressing the ENTER key does this for you automatically.</p>
</div>
<div class="paragraph">
<p>If everything was successful, you now have a keystore file with a certificate that can be used by your server.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-clustering">1.3.4. Clustering</h4>
<div class="paragraph">
<p>Clustering is useful both for scaling (serving more requests) and for high availability (if a server crashes, the service continues to run).</p>
</div>
<div class="paragraph">
<p>There's no need to configure a Tomcat-level cluster, because it is only used to replicate HTTP sessions. Cyclos, however, doesn't use Tomcat sessions, but handles them internally. This way, there is no special Tomcat configuration to support a Cyclos cluster.</p>
</div>
<div class="paragraph">
<p>The Cyclos application, however, needs some small configurations to enable clustering. Cyclos uses <a href="http://hazelcast.org/">Hazelcast</a> to synchronize shared state (such as caches) between cluster hosts. To enable clustering, find in <code>cyclos.properties</code> the line containing <code>cyclos.clusterHandler</code>, and set it to <code>hazelcast</code>.</p>
</div>
<div class="paragraph">
<p>Hazelcast is able to find the cluster nodes with many different join strategies: multicast (for local network), TCP/IP (when the list of nodes is known beforehand), Kubernetes (using a DNS service), Amazon Web Services (by matching nodes via tags) and Google Cloud Platform (by matching nodes via labels). Starting with Cyclos 4.16, it is possible to both enable clustering and configuring the join strategy by setting one of these environment variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CLUSTER_MULTICAST</code>: Enables clustering with multicast join. The value should be in the format <code>group:port</code>, for example, <code>224.2.2.3:54327</code>;</p>
</li>
<li>
<p><code>CLUSTER_TCPIP</code>: Enables clustering with TCP/IP join. The value should be a list of comma-separated members, either <code>host</code> or <code>host:port</code>. For example: <code>10.0.0.1,10.0.0.2:5108</code>;</p>
</li>
<li>
<p><code>CLUSTER_K8S_DNS</code>: Enables joining in Kubernetes using a DNS service. The value should be the DNS service name, for example, <code>cyclos-dns</code>;</p>
</li>
<li>
<p><code>CLUSTER_AWS_TAG</code>: Enables Amazon Web Services (AWS) join using a tag key and value for finding nodes that should join the cluster. The value should be in the format <code>tagKey=tagValue</code>. Make sure to apply the given tag to the EC2 nodes metadata;</p>
</li>
<li>
<p><code>CLUSTER_GCP_LABEL</code>: Enables Google Cloud Platform (GCP) join using a label key and value for finding nodes that should join the cluster. The value should be in the format <code>labelKey=labelValue</code>. Make sure to apply the given label to the node&#8217;s metadata.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Another way to configure the join strategy, as well as fine-tuning other parameters, is by configuring the <code>WEB-INF/classes/hazelcast.xml</code> file. Check the Hazelcast documentation for more details. When one of the previously mentioned environment variables are found, any <code>&lt;join&gt;</code> tags in <code>hazelcast.xml</code> are ignored, and the environment variable is used instead.</p>
</div>
<div class="paragraph">
<p>To set up high-availability at database (PostgreSQL) level, it is recommended to either use a managed PostgreSQL service from a cloud provider or deploy a PostgreSQL cluster with <a href="https://cloudnative-pg.io/">CloudNativePG</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-apache">1.3.5. Use Apache with mod_jk</h4>
<div class="paragraph">
<p>You can use Apache as a front-end / load balancer for Tomcat.
This is very useful when you have several domains configured on the server.
There are several documentations and examples available on the Internet. In our example, we will use the module <code>mod_jk</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>apt <span class="nb">install </span>apache2 libapache2-mod-jk</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration is done in the <code>/etc/libapache2-mod-jk/workers.properties</code> file. By default, this is configured to use the AJP port <code>8009</code>, this is the default AJP port for Tomcat, if you are using a different port you need to configure it here.</p>
</div>
<div class="paragraph">
<p>On Tomcat, we need to enable the AJP connector.
Edit the file <code>&lt;tomcat_home&gt;/conf/server.xml</code> and uncomment the  AJP connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"8009"</span> <span class="na">protocol=</span><span class="s">"AJP/1.3"</span> <span class="na">redirectPort=</span><span class="s">"8443"</span> <span class="na">secretRequired=</span><span class="s">"false"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now on Apache we need to configure the virtualhost (which on Ubuntu can be found here in <code>/etc/apache2/sites-enabled/</code>) to use the AJP connector.
On the virtualhost of your domain, add the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="apache"><span class="p">&lt;</span><span class="nl">IfModule</span><span class="sr"> mod_jk.c</span><span class="p">&gt;
</span>    JkMount /* ajp13_worker
    JkMount / ajp13_worker
<span class="p">&lt;/</span><span class="nl">IfModule</span><span class="p">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example uses the cyclos as ROOT application on Tomcat.
If you want to use something like <a href="http://www.yourdomain.com/instance_name" class="bare">http://www.yourdomain.com/instance_name</a> we need to deploy cyclos on the <code>webapps/instance_name`</code> directory and configure apache like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="apache"><span class="p">&lt;</span><span class="nl">IfModule</span><span class="sr"> mod_jk.c</span><span class="p">&gt;
</span>    JkMount /instance_name/* ajp13_worker
    JkMount /instance_name ajp13_worker
<span class="p">&lt;/</span><span class="nl">IfModule</span><span class="p">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now restart both Apache and Tomcat and check if it works.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-apache-ssl">1.3.6. Enable SSL on Apache</h4>
<div class="paragraph">
<p>Enabling SSL is crucial for live systems, as it protects sensitive information, like passwords, to be sent plain over the Internet, making it readable by eavesdroppers.</p>
</div>
<div class="paragraph">
<p>We recommend using <a href="https://letsencrypt.org/">Let&#8217;s Encrypt</a> to set up a certificate. It is free and has only a few steps for setup.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-proxy">1.3.7. Setup a proxy / load balancer</h4>
<div class="paragraph">
<p>The easiest configuration for a load balancer is Apache connecting to Tomcat using the AJP protocol. In this case, the original request is forwarded to Tomcat as is, keeping the original client IP address and URL.</p>
</div>
<div class="paragraph">
<p>However, in most other cases, the load balancer works as a proxy, sending a new HTTP to Tomcat and forwarding the response to the client. Examples of such proxies include Apache with <code>mod_proxy</code>, Nginx, haproxy and all cloud provider load balancers.</p>
</div>
<div class="paragraph">
<p>In either way, generally the proxy will have the server certificate and will terminate the SSL connection with the client. Then an internal (non-HTTPS) request is performed from the proxy to Tomcat.</p>
</div>
<div class="paragraph">
<p>That means the client IP address received by Cyclos, as well as the request URL, are different from the original request performed by the client. As Cyclos uses the client IP for logging and blocking in case of abuse, this would lead Cyclos to block the proxy, preventing any further request.</p>
</div>
<div class="paragraph">
<p>However, the proxy will add some extra request headers, with information about the original request. Cyclos then needs to be configured to read both the IP address and which was the connection protocol used by the original request (HTTP or HTTPS) from those headers, instead of directly from the incoming HTTP request. For this, the following settings in <code>cyclos.properties</code> are needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cyclos.header.remoteAddress</code>: Specifies the name of the header which contains the original client&#8217;s IP address.  The name of this header is usually <em>X-Forwarded-For</em>. The value associated to this header will be a comma-separated list of IPs;</p>
</li>
<li>
<p><code>cyclos.header.remoteAddress.index</code>: Specifies the position in the list to read the client&#8217;s IP from. The default value is 0. To avoid a malicious user perpetrating an IP spoofing attack, we strongly recommend using a negative value indicating an offset from the end of the list. Thus, -1 means the last IP, -2 the previous one, and so on;</p>
</li>
<li>
<p><code>cyclos.header.protocol</code>: Specifies the protocol name (http or https) used on the original request. The name of this header is usually <em>X-Forwarded-Proto</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following cases are handled by Cyclos to match a specific network / configuration from the request URL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A request to Tomcat using the root URL specified in a parent configuration (normally the network default). For example, if the network default configuration&#8217;s root URL is <em><a href="http://cyclos-net.com" class="bare">http://cyclos-net.com</a></em>, any requests to <em><a href="http://cyclos-net.com/*" class="bare">http://cyclos-net.com/*</a></em> will match that configuration;</p>
</li>
<li>
<p>A request to Tomcat using the root URL specified in a parent configuration plus a specific path of an inherited configuration. Following the previous example, if the child configuration has a custom path of <em>config</em>, any requests to <em><a href="http://cyclos-net.com/config/*" class="bare">http://cyclos-net.com/config/*</a></em> will match that configuration;</p>
</li>
<li>
<p>If no custom URL is matched, requests having the first subpath (after the web application context path) equals the network internal name. For example, if Cyclos is deployed in a Tomcat under the context path <em>cyclos</em>, and it has a network called <em>main</em>, any requests to <em><a href="http://localhost:8080/instance_name/main/*" class="bare">http://localhost:8080/instance_name/main/*</a></em> will match this network;</p>
</li>
<li>
<p>Same as previous, but with a specific configuration path. Following the previous example, if that network has a configuration with path <em>config</em>,  requests to <em><a href="http://localhost:8080/instance_name/main/config/*" class="bare">http://localhost:8080/instance_name/main/config/*</a></em> will match this configuration;</p>
</li>
<li>
<p>Also, the name <em>global</em> is reserved as a network internal name. For example, requests to <em><a href="http://localhost:8080/instance_name/global/*" class="bare">http://localhost:8080/instance_name/global/*</a></em> will be considered in global mode;</p>
</li>
<li>
<p>Still, if no custom URL is matched, if no network internal name is given and there is a default network, the network internal name can be omitted. For example, requests to <em><a href="http://localhost:8080/instance_name/*" class="bare">http://localhost:8080/instance_name/*</a></em> will be considered in the default network.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When Tomcat is behind a proxy, it will never receive requests using the original public URL. Hence, only matching by network (and optionally, configuration paths) will be used.</p>
</div>
<div class="paragraph">
<p>Still, networks should correctly set the root url in their configurations because they are used to generating full URLs at the server side, for example, when sending links in e-mails or resolving image URLs in rich texts.</p>
</div>
<div class="paragraph">
<p>Following are common cases that could be configured for a proxy, all assuming Cyclos is deployed to a Tomcat accessible by the proxy via <em><a href="http://tomcat:8080/instance_name" class="bare">http://tomcat:8080/instance_name</a></em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The proxy handles the (sub)domain of a specific network. For example, it handles requests to <em><a href="https://main.my-cyclos.com" class="bare">https://main.my-cyclos.com</a></em> and forwards them to <em><a href="http://tomcat:8080/instance_name/main" class="bare">http://tomcat:8080/instance_name/main</a></em>. The network in Cyclos must have the internal name <em>main</em> in this case;</p>
</li>
<li>
<p>The proxy handles a specific (sub)domain for the global mode. For example, it handles requests to <em><a href="https://global.my-cyclos.com" class="bare">https://global.my-cyclos.com</a></em> and forwards them to <em><a href="http://tomcat:8080/instance_name/global" class="bare">http://tomcat:8080/instance_name/global</a></em>;</p>
</li>
<li>
<p>The proxy handles a multi-network entry point on a (sub)domain of a specific network. For example, it handles requests to <em><a href="https://www.my-cyclos.com" class="bare">https://www.my-cyclos.com</a></em> and forwards them to <em><a href="http://tomcat:8080/instance_name" class="bare">http://tomcat:8080/instance_name</a></em>. So, requests to <em><a href="https://www.my-cyclos.com/main" class="bare">https://www.my-cyclos.com/main</a></em> will match the <em>main</em> network, while requests to <em><a href="https://www.my-cyclos.com/alt" class="bare">https://www.my-cyclos.com/alt</a></em> will match the <em>alt</em> network.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-reserved-paths">1.3.8. Reserved path names</h4>
<div class="paragraph">
<p>There are reserved paths in Cyclos that cannot be used as paths in proxies.
For example, a proxy could handle requests to <em><a href="https://www.my-project.com/app" class="bare">https://www.my-project.com/app</a></em> and redirect them to <em><a href="http://tomcat:8080/instance_name" class="bare">http://tomcat:8080/instance_name</a></em>.
In this case, the <em>/app</em> path part is public, used by clients, but never visible on Tomcat.</p>
</div>
<div class="paragraph">
<p>To handle such cases, the list of reserved paths is used to generate the correct URIs for scripts and stylesheets, and having any of the reserved paths in the proxy would prevent the URI generation from working correctly.</p>
</div>
<div class="paragraph">
<p>The list of reserved paths is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">cyclos.gwt
fonts
js
pay
consent
unsubscribe
voucher
classic
ui
.well-known
robots.txt
sitemap.xml
sitemap-index.xml
sitemap.xstl
activate-access-client
external-redirect-callback
identity
run
content
web-rpc
java-rpc
api
sms
push-notifications
global
redirect
mobile-redirect</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-google-maps">1.3.9. Enabling Google Maps</h4>
<div class="paragraph">
<p>Cyclos supports displaying maps using <a href="https://maps.google.com">Google Maps</a>. This has to be enabled in the Cyclos configuration. Cyclos also uses geocoding to map the user-informed address fields to a position (latitude/longitude).</p>
</div>
<div class="paragraph">
<p>Google Maps requires an API key. For details on the free daily quota for map views and geocode requests, see <a href="https://developers.google.com/maps/documentation/javascript/usage-and-billing">this page</a>.</p>
</div>
<div class="paragraph">
<p>There are actually 2 API keys that can be set in the Cyclos configuration: The server-side API key and the browser API-key.</p>
</div>
<div class="paragraph">
<p>Each one needs to be generated in the <a href="https://console.developers.google.com/apis">API Manager</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Enabling the APIs</em>: on the "Library" menu, search for the following APIs and enable them: "Maps JavaScript API", "Maps Static API" and "Geocoding API";</p>
</li>
<li>
<p><em>Creating the API keys</em>: on the "Credentials" menu, choose "Create credentials", then choose "API key". Choose "Server key" and specify a name for it. Save and then create a new one, this time as "Browser key".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once the API keys are ready, they can be copied / pasted into the Cyclos configuration, on the corresponding "Google maps server API" and "Google maps browser API" fields.</p>
</div>
<div class="paragraph">
<p>The <a href="https://console.developers.google.com/apis">API Manager</a> allows monitoring of requests performed by each API.</p>
</div>
<div class="paragraph">
<p>On the main Cyclos web application, addresses are geolocated on the client-side, before saving it. In such cases, the browser API key is used. However, sometimes addresses can be saved without being geolocated, either by third-party software or by importing new users into Cyclos.
In such cases, a background task will attempt to geolocate them (might take up to 24 hours for this) using the server API key.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-recaptcha">1.3.10. reCAPTCHA</h4>
<div class="paragraph">
<p>Starting with Cyclos 4.15, it has been added the support for reCAPTCHA v2, which displays the "I am not a robot" checkbox.
As of 2021, it offers a free usage for up to 1 million requests per month.
As CAPTCHAS are used in Cyclos only on registration and on 'forgot password' requests, it should be enough for most systems.</p>
</div>
<div class="paragraph">
<p>To enable it, first you need to <a href="https://www.google.com/recaptcha/admin/create">register a new site in reCAPTCHA</a>. Select the v2 on reCAPTCHA type.
Then add your domain, accept the terms of service and submit.
It will display 2 keys: the site key and the secret key.</p>
</div>
<div class="paragraph">
<p>Then, in Cyclos configuration form, under the CAPTCHA section, select reCAPTCHA v2 as provider and paste both keys to the corresponding fields.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT!</strong> To make the reCAPTCHA works for the mobile app, please ensure the web server doesn't send the following HTTP response headers for the path <code>/mobile-recaptcha</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>X-Frame-Options</code>;</p>
</li>
<li>
<p><code>X-XSS-Protection</code>;</p>
</li>
<li>
<p><code>Content-Security-Policy</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-storage">1.3.11. External content storage</h4>
<div class="paragraph">
<p>Cyclos handles stored files, such as images, documents and binary custom field values. By default, they are stored in the database. However, for large systems, having files in the database will complicate backups, which will be very large. Also, having files in the database can be suboptimal in terms of performance. However, Cyclos also provides other storage types.</p>
</div>
<div class="sect4">
<h5 id="setup-adjustments-storage-types">Storage types</h5>
<div class="paragraph">
<p>Cyclos comes with four implementations out of the box:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Database: the content is stored in conjunction with all data in the database. This is the default implementation;</p>
</li>
<li>
<p>File system: the content is stored outside the database in specific paths;</p>
</li>
<li>
<p>Amazon S3: Amazon Simple Storage Service, the content is stored outside the database in specific buckets. As DigitalOcean&#8217;s storage is compatible with S3, it can also be used;</p>
</li>
<li>
<p>Google Cloud storage: the content is stored outside the database in a specific bucket.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Besides the built-in implementations, you can create your own custom implementation. To do that, you can create a Java class implementing <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/storage/StoredFileContentManager.html">org.cyclos.impl.storage.StoredFileContentManager</a></p>
</div>
<div class="paragraph">
<p>Some storage types support specifying custom directories. They can be set to provide different permissions for physical access of those files. All file storages, except for database, support storage directories.</p>
</div>
<div class="paragraph">
<p>All file storage settings are configured in <code>cyclos.properties</code>. First, set the <code>cyclos.storedFileContentManager</code> property to specify which storage should be used. Then set additional properties according to the type. Each storage type is described below.</p>
</div>
<div id="setup-adjustments-storage-file" class="paragraph">
<p><strong>File system storage</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cyclos.storedFileContentManager</code>: Set to <code>file</code>;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.rootDir</code>: The root directory where the files will be stored;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.directories</code>: comma separated list of folder (storage directory) names that will be created as children of the rootDir and where individual documents and image/file custom field values can be stored;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.maxSubDirs</code>: the maximum number of directories to be created below the root directory or a specific storage directory where the content will be stored.</p>
</li>
</ul>
</div>
<div id="setup-adjustments-storage-s3" class="paragraph">
<p><strong>Amazon S3 storage</strong></p>
</div>
<div class="paragraph">
<p>This can also be used for DigitalOcean Spaces.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cyclos.storedFileContentManager</code>: Set to <code>s3</code>;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.bucketName</code>: the name of the default bucket that will be created (if it doesn't exist) and where the content will be stored;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.regionName</code>: the name of the default region where the buckets will be created;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.directories</code>: comma separated list of bucket (storage directory) names where individual documents and image/file custom field values can be stored;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.accessKeyId</code>: the AWS access key;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.secretAccessKey</code>: the AWS secret access key;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.serviceEndpoint</code>: Not needed for Amazon, but used when using a S3-compatible system, such as DigitalOcean Spaces;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.signinRegion</code>: Not needed for Amazon, but used when using a S3-compatible system, such as DigitalOcean Spaces.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you need to create a bucket in a different region than the default one, then you need to define a property of the form: <code>cyclos.storedFileContentManager.regionName.&lt;bucket_name&gt;=specific_region_name</code></p>
</div>
<div id="setup-adjustments-storage-gcs" class="paragraph">
<p><strong>Google Cloud storage</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cyclos.storedFileContentManager</code>: Set to <code>gcs</code>;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.bucketName</code>: the name of the default bucket that will be created (if it doesn't exist) and where the content will be stored;</p>
</li>
<li>
<p><code>cyclos.storedFileContentManager.credentialsFile</code>: path to JSON key file downloaded when creating the service account.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="setup-adjustments-storage-migrator">Storage migrator utility class</h5>
<div class="paragraph">
<p>When you perceive the need to move the stored files out of the database to an external storage, you can use a utility, which is shipped together with Cyclos, to perform the migration.</p>
</div>
<div class="paragraph">
<p>First do a backup of your database, in case it needs to be restored.</p>
</div>
<div class="paragraph">
<p>The recommended strategy for running the migration tool in production is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First test this in a test environment with a copy of the live database. See <a href="#setup-maintenance-test-environment">Setup a test environment</a> for more details on this;</p>
</li>
<li>
<p>Plan this at night or at a moment that the system is not heavily used;</p>
</li>
<li>
<p>Run the migration while Cyclos is running. It will migrate all existing images in batches, using several parallel threads (one per available CPU core);</p>
</li>
<li>
<p>When the migration finishes, stop Cyclos;</p>
</li>
<li>
<p>Run the migration again to make sure any newly uploaded file is also migrated;</p>
</li>
<li>
<p>Update your <code>cyclos.properties</code>, setting <code>cyclos.storedFileContentManager</code> file with the new value;</p>
</li>
<li>
<p>Restart Cyclos.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note: After step 3, errors will show up while accessing already migrated files, because those are no longer stored where Cyclos looks for them (i.e., the database). However, the system will be online for all other operations.</p>
</div>
<div class="paragraph">
<p>To run the utility, you first need to update the <code>cyclos.properties</code> file, leaving <code>cyclos.storedFileContentManager</code> with your current value (probably <code>db</code>), but already preparing all the other properties for the new storage. For example, when migrating to <code>gcs</code>, set both <code>cyclos.storedFileContentManager.bucketName</code> and <code>cyclos.storedFileContentManager.credentialsFile</code>. Or when migrating to <code>s3</code>, set <code>cyclos.storedFileContentManager.bucketName</code>, <code>cyclos.storedFileContentManager.regionName</code>, <code>cyclos.storedFileContentManager.accessKeyId</code> and <code>cyclos.storedFileContentManager.secretAccessKey</code>.</p>
</div>
<div class="paragraph">
<p>Then, in a console in the server running Cyclos, go to the Cyclos installation directory and run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">java <span class="nt">-cp</span> <span class="s2">"WEB-INF/classes:../../lib/*:WEB-INF/lib/*"</span> <span class="se">\</span>
    org.cyclos.impl.storage.utils.StoredFileContentMigrator</code></pre>
</div>
</div>
<div class="paragraph">
<p>If Tomcat&#8217;s <code>lib</code> directory is located elsewhere, replace the <code>:../../lib/*:</code> part with <code>:/path/to/tomcat/lib/*:</code>. If that&#8217;s the case, you should see an error like <code>java.lang.ClassNotFoundException: javax.servlet.ServletContext</code>.</p>
</div>
<div class="paragraph">
<p>You will be presented with the usage help. Then, to finally migrate to the new storage, repeat the previous command, appending the value of the new storage (<code>file</code>, <code>s3</code> or <code>gcs</code>) as an argument to the command.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-db-replica">1.3.12. Read data from a hot standby</h4>
<div class="paragraph">
<p>When a PostgreSQL hot standby server is used, the master server can be offloaded by directing read-only queries to the hot standby server.
This can be obtained by specifying additional datasource properties, with the <code>cyclos.datasource.readOnly</code> prefix. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">cyclos.datasource.provider</span> <span class="p">=</span> <span class="s">hikari</span>
<span class="py">cyclos.datasource.dataSourceClassName</span> <span class="p">=</span> <span class="s">org.postgresql.ds.PGSimpleDataSource</span>
<span class="py">cyclos.datasource.dataSource.portNumber</span> <span class="p">=</span> <span class="s">5432</span>
<span class="py">cyclos.datasource.dataSource.serverName</span> <span class="p">=</span> <span class="s">database-master</span>
<span class="py">cyclos.datasource.readOnly.dataSource.serverName</span> <span class="p">=</span> <span class="s">database-replica # This is the overridden property</span>
<span class="py">cyclos.datasource.dataSource.databaseName</span> <span class="p">=</span> <span class="s">cyclos4</span>
<span class="py">cyclos.datasource.dataSource.user</span> <span class="p">=</span> <span class="s">cyclos</span>
<span class="py">cyclos.datasource.dataSource.password</span> <span class="p">=</span> <span class="s">cyclos</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All properties specified for the regular datasource can also be specified for the read-only datasource. The default value of all read-only datasource properties are those set for the regular datasource. You can then override only the ones that are different.
So, in this example, the same Hikari <code>dataSource.databaseName</code>, <code>dataSource.user</code>, and so on, will be used for both data sources.</p>
</div>
<div class="paragraph">
<p>An important point for consistent queries between the master and the replica servers is the <code>synchronous_commit</code> setting in the master server. It should be set to either <code>on</code> (the default) or <code>remote_apply</code>. Take care that the setting is only used when <code>synchronous_standby_names</code> is also set. The remote_apply setting will wait until the data is visible for queries in the replica before the commit ends. This will introduce an additional delay in read-write transactions, but ensures data consistency. Without it, it might happen that after saving some data, the next request to read the same data will fail. This is a trade-off between consistency and performance. However, the odds for this are low, because there are the delays between the first request&#8217;s response being read by the client and the second request being sent and processed by the server. It is very like that such times are higher than the replica server time to apply the changes. This policy should be defined by the system administrator.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-opensearch">1.3.13. Using OpenSearch</h4>
<div class="paragraph">
<p>For large systems, the time required for searching users, advertisements or transactions can be unacceptable when searching the database. Such queries can be complex, using full-text keywords or geo-distance filters.</p>
</div>
<div class="paragraph">
<p>For such systems, it is advised to use <a href="https://opensearch.org/">OpenSearch</a> as search provider. For details on how to configure Cyclos with OpenSearch, refer to <a href="#fulltext-opensearch">this section</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-logging">1.3.14. Logging</h4>
<div class="paragraph">
<p>By default, Cyclos logs access to services, as well as background tasks, to files. But besides logging to files, it is also possible to log to an external PostgreSQL database. Logging to an external database has some benefits, especially being easier to find data when needed.</p>
</div>
<div class="paragraph">
<p>Logs are, by default, asynchronous, so the requests are not delayed until the log is written. This is controlled by the <code>cyclos.log.threads</code> property, which sets the number of threads used to concurrently write logs. However, if the server crashes, some log entries may be lost. If the number of threads is set to zero, logs will be synchronous, delaying each response. This guarantees that all logs are written before returning the response, but can have a high impact on the system throughput.</p>
</div>
<div class="paragraph">
<p>To choose the log provider, the <code>cyclos.log</code> setting should be changed in <code>cyclos.properties</code>. There are also additional settings for specific log providers:</p>
</div>
<div class="paragraph">
<p><strong>Logging to files</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cyclos.log</code>: Set to <code>file</code>;</p>
</li>
<li>
<p><code>cyclos.log.dir</code>: The directory where to write logs. Supports the following variables:</p>
<div class="ulist">
<ul>
<li>
<p><code>%t</code>: The system temporary directory;</p>
</li>
<li>
<p><code>%w</code>: The web application directory;</p>
</li>
<li>
<p><code>%n</code>: The network internal name (or <code>global</code>).</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>cyclos.log.maxFiles</code>: The log files are rotating. This setting indicates the maximum number of files per network.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Logging to an external database</strong></p>
</div>
<div class="paragraph">
<p>It is important that the PostgreSQL database used for storing logs isn&#8217;t the same as the main Cyclos database. The database itself must be created before starting Cyclos.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cyclos.log</code>: Set it to <code>db</code>;</p>
</li>
<li>
<p><code>cyclos.log.datasource.<strong></code>: All properties inside this prefix are used to create a datasource, and are the same options available to the regular <code>cyclos.database.</strong></code> settings.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If using a database log, make sure to set the maximum number of connections equal to the number of threads set in the <code>cyclos.log.threads</code> setting. When using synchronous logging, the maximum connections to the log database will also limit the number of concurrent requests, so, extra care is needed.</p>
</div>
<div class="paragraph">
<p>A final note on the log database: there are currently 2 tables: <code>service_logs</code> and <code>task_logs</code>. The service_logs store a row each time a client calls any Cyclos service, while the task_logs stores a row for each background task execution. To make insertion of rows as fast as possible, the tables have no indexes, and will store parameters and results as the PostgreSQL&#8217;s JSON type, which has minimal impact on inserts (comparing to JSONB).</p>
</div>
<div class="paragraph">
<p>However, for searching data, the JSONB type (binary JSON) is more efficient, and supports indexing. When searching the table with too many logs, instead of searching directly on service_logs, it is recommended to create a new table, and query it instead. This new table should have the same columns as service_logs, but with JSONB columns instead. Also, add indexes according to your query.</p>
</div>
<div class="paragraph">
<p>A final note on log tables is that they tend to quickly grow in size, so you may need to periodically (according to the database data volume) move old data to another database in order to not impact the logging performance.
Also, don&#8217;t forget to vacuum the table after deleting old records.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-frontend-self-hosted">1.3.15. Hosting the frontend separately from Cyclos</h4>
<div class="paragraph">
<p>For instructions on how to host the frontend separately from Cyclos please see <a href="https://github.com/cyclosproject/cyclos4-ui#hosting-the-frontend-separately-from-cyclos" target="\"_blank\"">the project instructions page at GitHub</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-adjustments-archiving">1.3.16. Data retention period / archiving</h4>
<div class="paragraph">
<p>Very large systems may produce a huge amount of transactions per day. For such systems, having the full data over many years in the production database may be challenging, as it increases the database space, makes it harder to backup the database, increases the OpenSearch index size, etc.</p>
</div>
<div class="paragraph">
<p>Starting with Cyclos 4.16, such systems can define a data retention period - for example, 2 years - and configure Cyclos to only consider transfers, transactions and balances within this period. Then, an external application (provided by STRO upon request) connects to the Cyclos database, backups data in an external database, and then physically deletes such data in the Cyclos production database.</p>
</div>
<div class="paragraph">
<p>For understanding which data is archived up, it is important to understand the structure of transfers vs transactions in Cyclos. A quick review: a transfer is an actual balance transfer between 2 accounts, while a transaction is an intent of transferring balances between accounts. There are 2 kinds of transactions: payments, which generate one or more transfers once processed, and others which generate a payment (that will generate transfers). Payments are of 3 kinds: direct, which generate a single transfer once processed; scheduled, which splits the total amount in one or more installments (and each installment generates a transfer when processed); and recurring, which repeats the same amount on every processed occurrence (generating a transfer per occurrence). Other kinds of transactions are the ones which generate a payment when processed: payment requests, tickets and external payments.</p>
</div>
<div class="paragraph">
<p>These are the data effectively copied to the archive:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transfers, together with information from the corresponding transaction, such as channel, description and custom values;</p>
</li>
<li>
<p>Account balances. Balances are actually calculated in the side of the archive application and stored for each account per month it had transfers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Carefully consider that the following data will be permanently lost after archiving:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transfer status (status flows). Those statuses typically represent a current follow-up of the transfer and don&#8217;t make sense from a historical point of view. They are not archived. The log of status changes is also not archived;</p>
</li>
<li>
<p>Information of payment requests, external payments and tickets;</p>
</li>
<li>
<p>Scheduled / recurring payment installment / occurrence information;</p>
</li>
<li>
<p>Amount reservations details (although those are not currently visible in Cyclos, only stored in the database);</p>
</li>
<li>
<p>Binary (file / image) transaction custom field values. When archiving, the corresponding files (for example, stored in Amazon S3 or Google Cloud Storage) are physically removed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Note</strong>: When physically removing transfers after archiving, it is then possible to permanently remove transfer types or transaction custom fields which were only referenced from archived transfers. However, this is not recommended, because the same data will be used to show the details of the archived transfer in Cyclos.</p>
</div>
<div class="paragraph">
<p>In order to enable archiving, you have to set the following in <code>cyclos.properties</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cyclos.archiving.months</code>: The number of months to keep live transactions in Cyclos. Required for archiving;</p>
</li>
<li>
<p><code>cyclos.archiving.url</code>: The URL used to contact the archiving application. Required for archiving;</p>
</li>
<li>
<p><code>cyclos.archiving.user</code>: The HTTP username used on connections to the archiving application;</p>
</li>
<li>
<p><code>cyclos.archiving.password</code>: The HTTP password used on connections to the archiving application;</p>
</li>
<li>
<p><code>cyclos.archiving.trustAllCerts</code>: If the connection uses HTTP, this setting allows using self-signed certificates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, Cyclos has a permission which can be enabled in administrator permissions / products (only visible when archiving is enabled in <code>cyclos.properties</code>) for administrators to query archived data. This functionality is available from the account history page itself, with a button to query for archived data, and fetches data from the external application via API.</p>
</div>
<div class="paragraph">
<p>This archiving functionality should not be confused with specific archiving settings in <code>cyclos.properties</code>, which are: <code>cyclos.purgeMessagesOnTrash.days</code>, <code>cyclos.archiveImports.days</code>, <code>cyclos.archiveAccountFees.days</code> and <code>cyclos.archiveBulkActions.days</code>. Those settings control the plain removal of data periodically from the Cyclos database.</p>
</div>
<div class="paragraph">
<p>Archiving is performed in a monthly basis. A recurring task will check daily whether the current month&#8217;s archiving was performed. If not (for example, the server was down on the first day), it will calculate the new archiving date and update the archived balances on all accounts. After all accounts archived balance are calculated, Cyclos will notify the archiving application to start the external archive.</p>
</div>
<div class="paragraph">
<p>When enabled, information about the current archiving status can be seen from the system monitor page.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Database archiving is usually only needed for very large databases. Before implementing database archiving other measures can be taken. For example, storing images, files and documents outside the Cyclos database will considerably diminish the database size, and this is a common first step before implementing database archiving. See <a href="#setup-adjustments-storage">this section</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setup-maintenance">1.4. Maintenance</h3>
<div class="sect3">
<h4 id="setup-maintenance-backup">1.4.1. Backup</h4>
<div class="paragraph">
<p>All data in Cyclos is stored in the PostgreSQL database. Making a backup of the database can be done using the <code>pg_dump</code> command. In terms of files, you only need to backup the <code>cyclos.properties</code> and, if customized, the <code>hazelcast.xml</code> configuration files.</p>
</div>
<div class="paragraph">
<p>The database can be backed up manually as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">pg_dump <span class="nt">--username</span><span class="o">=</span>cyclos <span class="nt">--password</span> <span class="nt">-hlocalhost</span> cyclos4 <span class="o">&gt;</span> cyclos4.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: in this example the name of the database is <code>cyclos4</code>, the username <code>cyclos</code> and the command will prompt for the password of the cyclos user.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-maintenance-restore">1.4.2. Restore</h4>
<div class="paragraph">
<p>To restore a database dump to another database, first create the new database (in this example, <code>cyclos4</code>) and grant permission to the user to manage it (in this example, the user is <code>cyclos</code>). Supposing the file containing the dump is <code>cyclos4.sql</code> in the current directory, the following command will import the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">psql <span class="nt">--username</span><span class="o">=</span>cyclos <span class="nt">--password</span> <span class="nt">-hlocalhost</span> cyclos4 &lt; cyclos4.sql</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup-maintenance-backup-restore-large">1.4.3. Backup / restore large databases</h4>
<div class="paragraph">
<p>When the database is very large (especially if it has a lot of images) it is possible to use a custom format for the dump file, which makes the dump file smaller. To use it, backup with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">pg_dump <span class="nt">--username</span><span class="o">=</span>cyclos <span class="nt">--password</span> <span class="nt">-Fc</span> <span class="nt">-hlocalhost</span> cyclos4 <span class="o">&gt;</span> cyclos4.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>To restore the dump, another command needs to be used as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">pg_restore <span class="nt">--username</span><span class="o">=</span>cyclos <span class="nt">--password</span> <span class="nt">-Fc</span> <span class="nt">-hlocalhost</span> <span class="nt">-d</span> cyclos4 cyclos4.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: for larger databases, it is highly advised to store binary files outside the database, specially in a managed storage service such as Amazon S3 or Google Cloud Storage. For more details, see <a href="#setup-adjustments-storage">External content storage</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-maintenance-reset-admin-password">1.4.4. Reset admin password</h4>
<div class="paragraph">
<p>If you lost the password of your global administrator, it is still possible to update the value on the database directly. To reset the password to 1234, run the following sql in the PostgreSQL query tool (psql). Replace the <code>'admin'</code> username by the username of your global administrator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">update</span> <span class="n">passwords</span>
  <span class="k">set</span> <span class="n">value</span><span class="o">=</span><span class="s1">'$2a$10$yM.uw9jC7C1DrRGUhqUc3eSR6FCJH0.HdDt3CJs8YL56iATHcXH7.'</span>
<span class="k">where</span> <span class="n">user_id</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="n">id</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">username</span><span class="o">=</span><span class="s1">'admin'</span><span class="p">)</span>
  <span class="k">and</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">'ACTIVE'</span>
  <span class="k">and</span> <span class="n">password_type_id</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">id</span> <span class="k">from</span> <span class="n">password_types</span> <span class="k">where</span> <span class="n">input_method</span> <span class="o">=</span> <span class="s1">'TEXT_BOX'</span> <span class="k">and</span> <span class="n">password_mode</span> <span class="o">=</span> <span class="s1">'MANUAL'</span><span class="p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup-maintenance-restore-themes">1.4.5. Restore applied themes</h4>
<div class="paragraph">
<p>If you are locked out of the system because an applied theme is failing compilation because of some error, you can run the following SQL to apply a built-in theme to both guests and logged users. After running it, only the global default URL will have an applied theme - all others will just inherit them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">with</span> <span class="n">default_theme</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">select</span> <span class="k">min</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">as</span> <span class="n">id</span>
    <span class="k">from</span> <span class="n">themes</span>
    <span class="k">where</span> <span class="k">type</span> <span class="o">=</span> <span class="s1">'MAIN_WEB'</span>
    <span class="k">and</span> <span class="n">file_name</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span><span class="p">)</span>
<span class="k">update</span> <span class="n">configurations</span> <span class="k">set</span>
<span class="n">guests_theme_id</span> <span class="o">=</span> <span class="k">case</span> <span class="k">when</span> <span class="n">parent_id</span> <span class="k">is</span> <span class="k">null</span> <span class="k">then</span> <span class="n">default_theme</span><span class="p">.</span><span class="n">id</span> <span class="k">else</span> <span class="k">null</span> <span class="k">end</span><span class="p">,</span>
<span class="n">users_theme_id</span> <span class="o">=</span> <span class="k">case</span> <span class="k">when</span> <span class="n">parent_id</span> <span class="k">is</span> <span class="k">null</span> <span class="k">then</span> <span class="n">default_theme</span><span class="p">.</span><span class="n">id</span> <span class="k">else</span> <span class="k">null</span> <span class="k">end</span>
<span class="k">from</span> <span class="n">default_theme</span><span class="p">;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup-maintenance-send-db">1.4.6. Share database dumps</h4>
<div class="paragraph">
<p>If Cyclos development team or a third party asks you to share the database with them, specially for bug isolation and support, it is vital for security that sensitive configurations, passwords and personal data are removed from the database.</p>
</div>
<div class="paragraph">
<p>The passwords in Cyclos are hashed with one of the strongest algorithms available (Bcrypt), but still passwords can be theoretically recovered using brute force (although very unlikely). If the database falls into the wrong hands, some users might get compromised. Therefore, it is always recommended to follow this procedure before sharing the database with other parties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make a dump of the database (see <a href="#setup-maintenance-backup">Backup</a>);</p>
</li>
<li>
<p>Restore the database in another (temporary) database, so the data can be changed without risking changing live data (see <a href="#setup-maintenance-restore">Restore</a>);</p>
</li>
<li>
<p>Run the following series of SQL commands, preferably storing all these in a script file, so it can be replayed whenever needed:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Reset all passwords to '1234':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">update</span> <span class="n">passwords</span>
<span class="k">set</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">'$2a$04$rDPKseEiJhYdjx9RogW2tuzNX4TKG1wcE79ooEXiA5.mJF.ooZY/2'</span>
<span class="k">where</span> <span class="n">status</span> <span class="o">&lt;&gt;</span> <span class="s1">'OLD'</span>
<span class="k">and</span> <span class="n">password_type_id</span> <span class="k">in</span> <span class="p">(</span>
    <span class="k">select</span> <span class="n">id</span>
    <span class="k">from</span> <span class="n">password_types</span>
    <span class="k">where</span> <span class="n">input_method</span> <span class="o">=</span> <span class="s1">'TEXT_BOX'</span>
    <span class="k">and</span> <span class="n">password_mode</span> <span class="o">=</span> <span class="s1">'MANUAL'</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remove sensitive user information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">delete</span> <span class="k">from</span> <span class="n">sessions</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">phones</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">addresses</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">user_fcm_tokens</span><span class="p">;</span>
<span class="k">update</span> <span class="n">users</span>
  <span class="k">set</span> <span class="n">email</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s1">'@localdomain'</span><span class="p">)</span>
  <span class="k">where</span> <span class="n">email</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have a custom field with private information, such as ID card, you can also remove the values with (adjust the <code>&lt;internal_name&gt;</code> value):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">delete</span> <span class="k">from</span> <span class="n">user_custom_field_values</span>
  <span class="k">where</span> <span class="n">field_id</span> <span class="o">=</span> <span class="p">(</span>
    <span class="k">select</span> <span class="n">id</span>
    <span class="k">from</span> <span class="n">user_custom_fields</span>
    <span class="k">where</span> <span class="n">internal_name</span> <span class="o">=</span> <span class="s1">'&lt;internal_name&gt;'</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remove sensitive configurations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">update</span> <span class="n">configurations</span> <span class="k">set</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">smtp_from_address</span> <span class="o">=</span> <span class="s1">'noreply@localhomain'</span><span class="p">,</span>
    <span class="n">smtp_host</span> <span class="o">=</span> <span class="s1">'localhost'</span><span class="p">,</span>
    <span class="n">smtp_port</span> <span class="o">=</span> <span class="s1">'25'</span><span class="p">,</span>
    <span class="n">smtp_security</span> <span class="o">=</span> <span class="s1">'NONE'</span><span class="p">,</span>
    <span class="n">smtp_user</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">smtp_password</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">sms_enabled</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
    <span class="n">sms_gateway_url</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">sms_username</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">sms_password</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">sms_headers</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">firebase_private_key</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">map_server_api_key</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">map_browser_api_key</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">captcha_recaptcha_key</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may also have API keys, passwords, etc. stored in custom script parameters. If this is the case, make sure to also change that.</p>
</div>
<div class="paragraph">
<p>Finally, create a dump of the temporary database. This dump and then be sent to the third party.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-maintenance-test-environment">1.4.7. Setup a test environment</h4>
<div class="paragraph">
<p>For running a production system, it&#8217;s of vital importance to run not only a live instance but also, a test instance. Besides running a test instance, many systems will benefit from also having a development instance. When updating Cyclos, creating new scripts, or doing any change with impact to the system, we recommend to always try it out on the test instance first. If all goes well on the test system, the change can be made on the live system too.</p>
</div>
<div class="paragraph">
<p>We recommend creating a script that copies the database from a live instance backup and, before the test instance is started, imports that dump and removes all vital information from the database. It&#8217;s very important that customers won&#8217;t receive emails, SMS messages or mobile app push notifications from a test instance.</p>
</div>
<div class="paragraph">
<p>We recommend first removing all user-related private information and production-specific API keys. For this, please refer to the <a href="#setup-maintenance-send-db">Share database dumps</a> section.</p>
</div>
<div class="paragraph">
<p>Also, the following database commands are recommended, and can be adjusted to better fit your needs. Adjust the variables presented between <code>&lt;</code> and <code>&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">update</span> <span class="n">configurations</span> <span class="k">set</span>
    <span class="n">root_url</span> <span class="o">=</span> <span class="s1">'&lt;https://test.instance.url&gt;'</span><span class="p">,</span>
    <span class="n">email_unique</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span>
    <span class="n">application_name</span> <span class="o">=</span> <span class="k">case</span>
        <span class="k">when</span> <span class="n">application_name</span> <span class="k">is</span> <span class="k">null</span> <span class="k">then</span> <span class="k">null</span>
        <span class="k">else</span> <span class="s1">'Test - '</span> <span class="o">||</span> <span class="n">application_name</span> <span class="k">end</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_authorizable_payments</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_payments</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_fwd_message_categories</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_user_alerts</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_system_alerts</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_user_groups</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_fwd_message_categories</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">notification_type_settings</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_external_payments_expired</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_external_payments_failed</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_voucher_configurations_buying</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">admin_notif_settings_voucher_configurations</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">user_account_notification_settings</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">notification_settings</span><span class="p">;</span>
<span class="k">update</span> <span class="n">static_contents</span> <span class="k">set</span> <span class="n">content</span><span class="o">=</span><span class="s1">'&lt;div style="color: red; font-size: 28px; margin-bottom: 20px; font-weight: bold;"&gt;Test instance&lt;/div&gt;'</span> <span class="o">||</span> <span class="n">content</span> <span class="k">where</span> <span class="n">subclass</span><span class="o">=</span><span class="s1">'HEADER'</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we recommend using a test SMTP server, in this way a client could never accidentally get an email message. An easy and free solution for this is <a href="https://mailtrap.io">Mailtrap</a>, but there are also self-hosted solutions available, such as <a href="https://github.com/mailhog/MailHog">Mailhog</a>. Here&#8217;s an example for Mailtrap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">update</span> <span class="n">configurations</span> <span class="k">set</span>
    <span class="n">smtp_from_address</span> <span class="o">=</span> <span class="s1">'noreply@localhomain'</span><span class="p">,</span>
    <span class="n">smtp_host</span> <span class="o">=</span> <span class="s1">'smtp.mailtrap.io'</span><span class="p">,</span>
    <span class="n">smtp_port</span> <span class="o">=</span> <span class="s1">'465'</span><span class="p">,</span>
    <span class="n">smtp_security</span> <span class="o">=</span> <span class="s1">'NONE'</span><span class="p">,</span>
    <span class="n">smtp_user</span> <span class="o">=</span> <span class="s1">'&lt;your-mailtrap-user&gt;'</span><span class="p">,</span>
    <span class="n">smtp_password</span> <span class="o">=</span> <span class="s1">'&lt;your-mailtrap-password&gt;'</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After all these adjustments, you can start the test instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-maintenance-remove-data">1.4.8. Remove network data</h4>
<div class="paragraph">
<p>A common practice for a first-time configuration of Cyclos, specially with a complex structure for accounts, configurations, products and groups, is to configure all the system, and create some test users and payments. However, after finishing configuration, it might be desirable to remove all users and transfers (payments) from that network, leaving only administrators and configurations. Alternatively, it might be desirable to completely delete an entire network.</p>
</div>
<div class="paragraph">
<p>An interactive utility is included in Cyclos, which can be used for both cases.
Please, be advised to perform a full database dump before running the utility, and have Cyclos stopped before running it.</p>
</div>
<div class="paragraph">
<p>To run the utility, go to <code>&lt;tomcat_home&gt;/webapps/&lt;instance_name&gt;</code> directory and execute the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">java <span class="nt">-cp</span> <span class="s2">"WEB-INF/classes:../../lib/*:WEB-INF/lib/*"</span> <span class="se">\</span>
    org.cyclos.db.DeleteNetworkData</code></pre>
</div>
</div>
<div class="paragraph">
<p>If Tomcat&#8217;s <code>lib</code> directory is located elsewhere, replace the <code>:../../lib/*:</code> part with <code>:/path/to/tomcat/lib/*:</code>. If that&#8217;s the case, you should see an error like <code>java.lang.ClassNotFoundException: javax.servlet.ServletContext</code>.</p>
</div>
<div class="paragraph">
<p>Then follow the instructions presented on the console. When a lot of data is removed, it is recommended to run a full vacuum in the database. This operation might take a while. To run it, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>vacuumdb <span class="nt">--full</span> <span class="nv">$DATABASE_NAME</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fulltext">2. Full-text searches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter covers how <a href="http://en.wikipedia.org/wiki/Full_text_search">full-text searches</a> work in Cyclos, and how to fine-tune them.</p>
</div>
<div class="paragraph">
<p>Full-text searches allow retrieving documents using its words, returning documents that match a given textual query (often related as <code>keywords</code> in Cyclos). The full-text engine processes words both when indexing (calculating the words on documents) and querying (transforming an input text in a way it matches indexed documents). Some examples of such processing include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Removing <em>stop words</em> - words which are too common in a given language, and likely be contained in multiple documents. In English, 'a', 'the' and 'is' could be example of stop words;</p>
</li>
<li>
<p>Changing words to a common form, or <em>stemming</em>. For example, in English, 'sailing', 'sailed', 'sailor' could all be stored as 'sail'.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Currently, the following entities are searched with full-text queries when using keywords:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Users</strong>: The profile fields which are set in the user products (or group&#8217;s permissions in case of administrators) marked to include in user keywords will be searched. Also supports geo-distance searches;</p>
</li>
<li>
<p><strong>Advertisements</strong>: The advertisement title, description and custom fields, plus the user (owner) profile fields which are set in the user products marked to include in advertisements keywords will be searched.  Also supports geo-distance searches;</p>
</li>
<li>
<p><strong>Records</strong>: The record custom fields, plus the user profile fields which are set in the user products (or group&#8217;s permissions in case of administrators) marked to include in record keywords will be searched;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Cyclos uses the native <a href="http://www.postgresql.org/docs/current/static/textsearch-intro.html">PostgreSQL&#8217;s full-text indexing</a> capabilities. Also, for geospatial distance filters, Cyclos uses <a href="https://postgis.net/">PostGIS</a>. However, for large systems, such queries can present an unacceptable slow performance. In such cases, the system should use an external <a href="#fulltext-opensearch">OpenSearch</a> server.</p>
</div>
<div class="paragraph">
<p>As the PostgreSQL native query syntax is too much formal for end users, a query preprocessor is included in Cyclos, such that the following variants are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>a b</code>: The value must have words that either start with a <em>or</em> b;</p>
</li>
<li>
<p><code>a +b</code>: The value must have words that start with both a <em>and</em> b;</p>
</li>
<li>
<p><code>a -b</code>: The value must have words that start with a <em>and no words that start with</em> b;</p>
</li>
<li>
<p><code>"a b"</code>: The value must have exactly a followed by b, in this exact order;</p>
</li>
<li>
<p>Also, parenthesis can be used to group expressions, such as <code>( (a b) +(c -d) )</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The fulltext dictionary used by Cyclos in PostgreSQL is a simple one, only performing the unaccent and ignoring case operations (so, for example, <code>acao</code> matches <code>Ao</code>). For more advanced operations, such as analyzing the text according to the configured language, OpenSearch should be used.</p>
</div>
<div class="sect2">
<h3 id="fulltext-opensearch">2.1. Using OpenSearch</h3>
<div class="paragraph">
<p>For large systems, the time required for searching users, advertisements or transactions can be unacceptable when searching the database. Such queries can be complex, using full-text keywords or geo-distance filters.</p>
</div>
<div class="paragraph">
<p>For such systems, it is advised to use <a href="https://opensearch.org/">OpenSearch</a> as search provider. OpenSearch is a fork of the well-known <a href="https://www.elastic.co/elasticsearch/">Elasticsearch</a> system. OpenSearch was created because Elasticsearch 7.11 onwards is no longer open source software (OSS), and cannot be used by cloud providers, such as Amazon. Because many Cyclos systems are hosted on Amazon and use it&#8217;s managed <a href="https://aws.amazon.com/opensearch-service">Amazon OpenSearch Service</a>, it makes more sense for Cyclos to support OpenSearch than Elasticsearch. OpenSearch 1.1 and Elasticsearch 7.10 are virtually the same, but it is expected that both systems divert more and more with newer releases.</p>
</div>
<div class="paragraph">
<p>The OpenSearch server / cluster needs to be deployed in a server accessible to Cyclos via its REST API. Then, in <code>cyclos.properties</code>, add the following settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cyclos.searchHandler = opensearch</code>: This enables the OpenSearch integration. Make sure to comment out or remove the line <code>cyclos.searchHandler = db</code>;.</p>
</li>
<li>
<p><code>cyclos.searchHandler.host</code>: One or more (comma-separated) hosts (protocol://hostname:port) of the OpenSearch server;</p>
</li>
<li>
<p><code>cyclos.searchHandler.pathPrefix</code>: Path within the host on which the OpenSearch server responds to;</p>
</li>
<li>
<p><code>cyclos.searchHandler.user</code>: Optional user for HTTP basic auth;</p>
</li>
<li>
<p><code>cyclos.searchHandler.password</code>: Optional password for HTTP basic auth;</p>
</li>
<li>
<p><code>cyclos.searchHandler.shards</code>: How many shards the indexes should be split in;</p>
</li>
<li>
<p><code>cyclos.searchHandler.replicas</code>: How many replicas per shard;</p>
</li>
<li>
<p><code>cyclos.searchHandler.trustAllCertificates</code>: By default, OpenSearch is configured with a self-signed certificate to handle HTTPS connection. If this setting isn&#8217;t set to <code>true</code>, Java will reject such a connection, because the certificate issuer cannot be validated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once set-up, when restarted, Cyclos will attempt to find the following OpenSearch indexes, and, if not found, will create them and index all entities in the database: <code>users</code>, <code>ads</code>, <code>records</code>, <code>transactions</code>, <code>transfers</code> and <code>installments</code>. Indexing will be executed on the background, and it can take several minutes to index all data, depending on the database size.</p>
</div>
<div class="paragraph">
<p>Textual searches (referred to as keywords in Cyclos) are passed to OpenSearch using <a href="https://opensearch.org/docs/latest/opensearch/query-dsl/full-text/#simple-query-string">Simple Query String</a> syntax, which is like the one employed by Cyclos when searching on the database, but more powerful.</p>
</div>
</div>
<div class="sect2">
<h3 id="fulltext-language-processing">2.2. Language processing</h3>
<div class="paragraph">
<p>The actual language processing (such as removing stop words and stemming text) is performed only on the following fields: advertisement title and description, and custom fields whose setting "Value match" is set to "Language". Note that the "Value match" field will only show up in custom fields when OpenSearch is used. When handling searches in the database, only the checkbox "Use exact matching on search filters" will show up.</p>
</div>
<div class="paragraph">
<p>Language-analyzed fields are stored multiple times in the index: one using OpenSearch Standard Analyzer (to prevent mismatches when searches are performed by users which use other languages), and another one for each language the owner of the data can have. So, for example, an advertisement owned by a user whose configuration allows English, Portuguese and French will have the field stored in all such analyzers, plus the standard.</p>
</div>
<div class="paragraph">
<p>When searching for the data, Cyclos uses all languages the logged user has, plus the standard analyzer. So, following the same previous example, if a logged user had only the French language, it would search in both the standard analyzer field, plus the French one. And if another user could see that advertisement, but have only the Spanish language, they would search in both Spanish (in which the no data exist) and in standard, and would ultimately find the advertisement using the standard analyzer.</p>
</div>
</div>
<div class="sect2">
<h3 id="fulltext-reindexing">2.3. Reindexing</h3>
<div class="paragraph">
<p>Being a separated data store, the data on PostgreSQL database and on OpenSearch might become de-synchronized. The database is always considered correct, and is the trusted store. The data on OpenSearch is updated automatically, as soon as the corresponding entity is modified on the database. But it might happen that an update request fails, or that the OpenSearch server is offline for some time.</p>
</div>
<div class="paragraph">
<p><strong>Important</strong>: If you have modified a profile field (its value or the internal name) then you must reindex users, advertisements and records.</p>
</div>
<div class="paragraph">
<p>To handle these cases, Cyclos offers methods that can be executed by scripts, directly through the menu System &gt; Tools &gt; Run script.
Here are some examples:</p>
</div>
<div class="paragraph">
<p>Reindex ALL data on ALL indexes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">searchHandler</span><span class="o">.</span><span class="na">reindex</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Reindex ALL data on a specific index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">userSearchHandler</span><span class="o">.</span><span class="na">reindex</span><span class="o">()</span>
<span class="n">adSearchHandler</span><span class="o">.</span><span class="na">reindex</span><span class="o">()</span>
<span class="n">recordSearchHandler</span><span class="o">.</span><span class="na">reindex</span><span class="o">()</span>
<span class="n">transactionSearchHandler</span><span class="o">.</span><span class="na">reindex</span><span class="o">()</span>
<span class="n">transferSearchHandler</span><span class="o">.</span><span class="na">reindex</span><span class="o">()</span>
<span class="n">installmentSearchHandler</span><span class="o">.</span><span class="na">reindex</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Other examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// Reindex a single user</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>
<span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">conversionHandler</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">User</span><span class="o">,</span> <span class="s1">'loginName'</span><span class="o">)</span>
<span class="n">userSearchHandler</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">user</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// Reindex a single advertisement by external (masked) id (would be similar to records)</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.marketplace.BasicAd</span>
<span class="kt">def</span> <span class="n">ad</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">BasicAd</span><span class="o">,</span> <span class="n">unmaskId</span><span class="o">(</span><span class="mi">123456789L</span><span class="o">))</span>
<span class="n">adSearchHandler</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">ad</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="webservices">3. Web services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here you will find information on how to call Cyclos web services from 3rd party applications. Web services must not be invoked by Cyclos scripts, refer to <a href="#scripting-warning-inbound-request">this section</a> for more information.</p>
</div>
<div class="paragraph">
<p>Cyclos 4 provides distinct web service interfaces: the <a href="#webservices-rest">REST API</a>, <a href="#webservices-custom">custom web services</a> and <a href="#webservices-webrpc">WEB-RPC</a>. In all cases the security layer is exactly the same (hence, both grant exactly the same permissions), and users are authenticated in the same way, as <a href="#webservices-auth">described below</a>.</p>
</div>
<div class="sect2">
<h3 id="webservices-rest">3.1. REST API</h3>
<div class="paragraph">
<p>This API is implemented with REST concepts in mind, such as using proper HTTP verbs (GET, PUT, POST, DELETE), using JSON data for input and output. It should be relatively easy for developers to leverage existing knowledge when using it. It is documented using <a href="https://openapis.org/">OpenAPI</a>, which enjoys rich documentation and tooling support. For example, there are OpenAPI generators that can generate clients for distinct languages / frameworks.</p>
</div>
<div class="paragraph">
<p>A detailed reference documentation is available online on each Cyclos installation, at <code>&lt;cyclos-root-url&gt;[/network]/api</code>. You can also refer to the <a href="https://demo.cyclos.org/api">Cyclos Demo API</a>. It is possible to disable the API reference documentation page by setting <code>cyclos.rest.reference = false</code> in <code>cyclos.properties</code>.</p>
</div>
<div class="paragraph">
<p>The REST API contains a subset of the Cyclos functionality. Most notably, system management and content management are not part of the API. Most user-facing operations, however, are available via the REST interface. New functionality will be added on demand, in a cautious manner, as each path, parameter and data model needs to be planned to fit the target architecture.</p>
</div>
<div class="paragraph">
<p>The REST interface is the preferred API for 3rd party clients to connect to Cyclos, as it should be relatively stable between Cyclos releases. Cyclos follows the following policy: any breaking changes / removals in the API will be kept as deprecated for 2 versions, then removed in the next one. For example, an operation can be deprecated in Cyclos 4.16 and 4.17, to be finally removed in 4.18.</p>
</div>
</div>
<div class="sect2">
<h3 id="webservices-custom">3.2. Custom web services</h3>
<div class="paragraph">
<p>It is also possible to create custom web services, which run a script on every invocation. Custom web services can be configured to be executed as a guest, with a fixed HTTP user / password or as a Cyclos user (using the same <a href="#webservices-auth">authentication</a> as other web services).</p>
</div>
<div class="paragraph">
<p>After creating a <a href="#scripting-type-web-services">custom web service script</a>, you have to create a custom web service entity in 'System &gt; Tools &gt; Custom web services'. There you will find the 'Url mappings' field, which contains the path which the script should be available. The endpoint for the custom web service will be <code>&lt;cyclos-root&gt;/run/&lt;mapping&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Also, take into account that custom web services executed as a logged user must also be granted to users through a product in 'System &gt; User configuration &gt; Products (permissions)'.</p>
</div>
</div>
<div class="sect2">
<h3 id="webservices-webrpc">3.3. WEB-RPC</h3>
<div class="paragraph">
<p>WEB-RPC provides direct access to the internal service interfaces in Cyclos, via web services. It is not recommended for 3rd party applications to use WEB-RPC directly, but the REST API instead.</p>
</div>
<div class="paragraph">
<p>Starting with Cyclos 4.16, we will no longer publish a PHP library for services, nor detailed information on WEB-RPC in general. For historic purposes, the documentation is kept at <a href="https://cyclos.org/documents/legacy-web-rpc.html" class="bare">https://cyclos.org/documents/legacy-web-rpc.html</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="webservices-auth">3.4. Authentication in web services</h3>
<div class="paragraph">
<p>Regardless of the web service interface (REST, WEB-RPC or custom), users are authenticated either as user / password (stateless), logging-in with a session (stateful) or using access clients (stateless). The way authentication data is passed from client to server depends on whether the clients are using a web service or a client API (Java or PHP).</p>
</div>
<div class="sect3">
<h4 id="webservices-auth-user-pwd">3.4.1. User and password</h4>
<div class="paragraph">
<p>In this mode, a principal (user identification method), which can be the login name, e-mail, mobile phone, custom field, account number or token value (card number), depending on the channel configuration, is sent on each request together with the password (live systems must always be over HTTPS, so should be secure). The drawbacks are that the username and password need to be stored in the client application, and changing the password on the web (if the same password type is used) will make the application stop working.</p>
</div>
</div>
<div class="sect3">
<h4 id="webservices-auth-session">3.4.2. Login with a session</h4>
<div class="paragraph">
<p>In this mode, first a request authenticated with user and password is made with <code>POST /api/auth/session</code>. It returns a session token, as well as other information of the logged user. Subsequent requests should pass this session token instead in the subsequent requests, via the <code>Session-Token</code> HTTP header. To end a session (logout), a request authenticated with the session token must be performed with <code>DELETE /api/auth/session</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="webservices-auth-access-client">3.4.3. Access clients</h4>
<div class="paragraph">
<p>Access clients can be configured to prevent the login name and password to be passed on every request by clients, decoupling them from the actual password, which can then be changed without affecting the client access. It also improves security, as each client application has its own authorization token, which can be individually blocked or revoked.</p>
</div>
<div class="paragraph">
<p>To configure access clients, first a new identification method of this type must be created by administrators in 'System &gt; System configuration &gt; User identification methods'. Then, in a member product of users which can use this kind of access, permissions over that type should be granted. Finally, the user (or an admin) should create a new access client in Cyclos main access, and get the activation code for it.</p>
</div>
<div class="paragraph">
<p>The activation code is a short (4 digits) code which uniquely identifies an access client pending activation for a given user. To use the access client, on the client application side (probably a server-side application or an interactive application), a request must be performed: <code>POST /api/clients/activate</code>, passing the username / password in a BASIC authentication and sending the activation code as the <code>code</code> query parameter.</p>
</div>
<div class="paragraph">
<p>The result will be a token which should be passed in subsequent requests using the HTTP header <code>Access-Client-Token</code>. The activation process should be done only once, and the token will be valid until the access client in Cyclos is blocked or disabled.</p>
</div>
<div class="paragraph">
<p>Here is an example which can be called by the command-line program curl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl https://&lt;cyclos-root&gt;[/network]/api/clients/activate?code<span class="o">=</span>&lt;4-digit code&gt; <span class="se">\</span>
    <span class="nt">-u</span> <span class="s2">"&lt;username&gt;:&lt;password&gt;"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated token will be printed on the console, and should be stored on the client application to be used on requests.</p>
</div>
<div class="paragraph">
<p>Additionally, clients can improve security if they can have some unique identifier which can be relied on, and don&#8217;t need to be stored. For example, Android devices always provide a unique device identifier. In that case, this identification string can be passed at the moment of activation, and will be stored on the server as a prefix to the generated token. The server will return only the generated token part, and this prefix should be passed on requests together with the generated token. The prefix is passed in the activation request as a query parameter <code>prefix</code>. So, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl https://&lt;cyclos-root&gt;[/network]/api/clients/activate?code<span class="o">=</span>&lt;4-digit code&gt;&amp;prefix<span class="o">=</span>XYZW <span class="se">\</span>
    <span class="nt">-u</span> <span class="s2">"&lt;username&gt;:&lt;password&gt;"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Imagining the server returns the fictional token <code>ABCDEFG</code> (the actual token is 64 characters long), the actual token that then should be passed to requests is <code>XYZWABCDFG</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webservices-channels">3.5. Channels</h3>
<div class="paragraph">
<p>Channels can be seen as a set of configurations for access in Cyclos.
There are some built-in channels, and additional ones can be created.
The built-in channels that can use used on web services are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Main web</em>: The main web application. The internal name is <code>main</code>;</p>
</li>
<li>
<p><em>Mobile</em>: The Cyclos (or another 3rd party) mobile application. The internal name is <code>mobile</code>;</p>
</li>
<li>
<p><em>Web services</em>: Is the default channel for clients using any web service client. The internal name is <code>webServices</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, the channel used on any web service (regardless of the interface or user authentication mode) is <em>Web services</em>. It is possible to specify another channel, for example, with third party web applications (handled as Main web) or third party mobile applications.</p>
</div>
<div class="paragraph">
<p>In such cases, the channel internal name must be passed on each request using the HTTP header <code>Channel</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="webservices-config">3.6. Configuring web services</h3>
<div class="paragraph">
<p>For clients to invoke web services in Cyclos, the following configuration needs to be done on the server (as global or network administrator):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On 'System &gt; System configuration &gt; Configurations' menu, select the configuration used by users to go to the configuration details page;</p>
</li>
<li>
<p>On the 'Channels' tab, click on the 'Web services' channel row, to go to the channel configuration details page;</p>
</li>
<li>
<p>Make sure the channel is enabled. It can be allowed or disallowed by default. Click the edit icon on the right if the channel is not defined for this configuration. Then mark the channel as enabled, choose the way users will be able to access this channel (by default or manually) and the password type used to access the web services channel.   You can also set a confirmation password, so sensitive operations, like performing a payment, will require that additional password;</p>
</li>
<li>
<p>For specific users, in the user profile page (as administrator), under the 'User management' box, click the 'Channels access' link;</p>
</li>
<li>
<p>On that page, make sure the 'Web services' channel is enabled for that user. Also, only active users may access any channel - on the profile page, on the same 'User management' box, there should be a link with actions like 'Enable / Block / Disable / Remove'. On that page, make sure the user status is 'Active';</p>
</li>
<li>
<p>A side note: If performing payments via Web services, make sure the desired 'Transfer type' is enabled for the 'Web services' channel. To check that, go to 'System &gt; Account configuration &gt; Account types' menu item. Then click the row of the desired account type, select the 'Transfer types' tab and click on the desired payment type (generated types cannot be used for direct payment). There, make sure the 'Channels' field has the 'Web services' channel.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="webservices-external-login">3.7. External login</h3>
<div class="paragraph">
<p>With the right configuration, it is possible to add a Cyclos login form to an external website, such as the company main website.</p>
</div>
<div class="paragraph">
<p>The user types in their Cyclos username and password in that form and, after a successful login, is redirected to Cyclos, where the session will be already valid, and the user can perform the operations as usual.</p>
</div>
<div class="paragraph">
<p>After the user clicks logout, or the session expires, the user is redirected back to the external website.</p>
</div>
<div class="paragraph">
<p><strong>The following aspects should be considered:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is needed to have an administrator whose group is granted the permission 'Login users via web services'. This is needed because the website will relay user logins to Cyclos, authenticated as that administrator;</p>
</li>
<li>
<p>The website needs to have that administrator&#8217;s username and password configured in order to make the web services call. Even better, you can configure an access client which will allow using a separated key instead of the username / password;</p>
</li>
<li>
<p>It is a good practice to create a separate configuration for that administrator. That configuration should have an IP address whitelist for the 'Web services' channel. Doing that, no other server, even if the administrator username / password is known by someone else, will be able to perform such operations;</p>
</li>
<li>
<p>The Cyclos configuration for users needs the following settings:</p>
<div class="ulist">
<ul>
<li>
<p>'Redirect login to URL': This is the URL of the external website which contains the login form. This is used to redirect the user when his session expires and a new login is needed, or when the user navigates directly to some URL in Cyclos (as guest). In that case, the external website receives a parameter named <code>returnTo</code> that must be sent back to Cyclos without any modification after a successful login;</p>
</li>
<li>
<p>'URL to redirect after logout': This is the URL where the user will be redirected after clicking <code>Logout</code> in Cyclos. It might be the same URL as the one for redirect login, but not necessarily.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Finally, the web service code needs to be created, and deployed to the website. Here is an example, which receives the username and password parameters, calls the web service to create a session for the user (passing his remote address), redirecting the user to Cyclos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Cyclos plugin for WordPress</strong></p>
</div>
<div class="paragraph">
<p>Cyclos provides a plugin for the well-known WordPress CMS system. It also serves as an example of the external login. For details, refer to <a href="https://wordpress.org/plugins/cyclos/" class="bare">https://wordpress.org/plugins/cyclos/</a>.</p>
</div>
<div class="paragraph">
<p><strong>Important notes</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>In case there is a wrong configuration for the <code>Redirect login to URL</code> setting, it won&#8217;t be possible anymore to login to Cyclos. In that case, if the configuration problem is within a network, it is possible to use a global administrator to login in global mode (using the <code>&lt;cyclos-root&gt;/global</code> URL), then switch to the network and fix the configuration. If the configuration error is in global mode, you can use a special URL to prevent redirect: <code>&lt;server-root&gt;/global/login!noRedirect=true</code>. However, this flag only works in global mode, to prevent end-users from using it to bypass the redirect;</p>
</li>
<li>
<p>Users should never have username / password requested in a plain HTTP connection. Always use a secure (HTTPS) connection. Also, just having an iframe with the form on a secure page, where the iframe itself is displayed in a non-encrypted page would still encrypt the traffic in the iframe, but browsers won&#8217;t show the page as secure (padlock icon). Users won&#8217;t see that page as secure, and could refuse to provide credentials in such a situation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Creating an alternate frontend to Cyclos</strong></p>
</div>
<div class="paragraph">
<p>It is possible to not only place a login form in an external website, but to create an entire frontend for users to interact with Cyclos. At first glimpse, this can be great, but consider the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is a very big effort to create a frontend, as there are several Cyclos services involved, and it might not be clear without a deep analysis on the <a href="https://demo.cyclos.org/api">API</a> which service / operation / parameters should be used on each case;</p>
</li>
<li>
<p>You will always have a limited subset of the functionality Cyclos offers. While you may initially think that only the very basic features are needed, there will inevitably be the need for more features, and the custom frontend will need to grow. By using Cyclos standard web interface, all this comes automatically.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instead, a better approach could be to extend the <a href="https://github.com/cyclosproject/cyclos4-ui">new frontend (cyclos4-ui)</a>, which provides a modern interface and can be easily customized.</p>
</div>
<div class="paragraph">
<p>Nevertheless, some (large) organizations might find it better to provide their users a single, integrated interface. Also, some organizations develop all their services with mobile applications only.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scripting">4. Scripting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cyclos scripting module provides an integration layer that allows connecting Cyclos to third party software, as well executing custom operations and scheduled tasks within Cyclos itself. The scripting module offers an easy way to customize and extend Cyclos. Scripts can access the full Cyclos services layer, which makes it a powerful feature. For security reasons only global administrators can manage scripts, as scripts can access any service, the database or even the physical server where Cyclos is running. Network administrators can then assign scripts to elements such as extension points (e.g. payment, user profile, advertisement), custom validations (for input fields), custom calculations (account fees, transaction fees), custom operations, scheduled tasks and many others.</p>
</div>
<div class="paragraph">
<p>Global admins can write scripts directly within Cyclos. Each script <code>type</code> has its own functions which have to be implemented. A network admin can choose from the available scripts and bind them to the actual entity (such as custom operations, extension points, etc.). The script can also use parameters, which are configured outside the script code. This avoids the need for modifying a script every time a new or different parameter is required.</p>
</div>
<div class="paragraph">
<p>The scripting language currently supported is <a href="http://www.groovy-lang.org/">Groovy</a>. It is a powerful language that is very similar to Java, with a close to zero learning curve for Java developers. It is possible to write scripts that will be available in a shared script library, so that other scripts within the same context can make use of it. All scripts are compiled to Java byte-code, which minimizes the runtime performance impact.</p>
</div>
<div class="paragraph">
<p>Debugging scripts can sometimes be tricky, because the exact context is only available at runtime, and errors can be hidden. A good approach is to set <code>cyclos.dumpAllErrors = true</code> in <code>cyclos.properties</code>. This way, whenever an error is triggered, it is dumped to the application server (i.e., Tomcat) console. Also, see the section <a href="#scripting-debug">Debugging scripts</a> for how to setup an IDE to develop scripts more comfortably.</p>
</div>
<div class="sect2">
<h3 id="scripting-warning">4.1. Crucial considerations</h3>
<div class="paragraph">
<p>Before writing any script code, please carefully consider the following points.</p>
</div>
<div class="sect3">
<h4 id="scripting-warning-transaction">4.1.1. Database transactions</h4>
<div class="paragraph">
<p>Scripts are executed in a database transaction. If there are any exceptions, the transaction is rolled-back. Otherwise, if all operations succeed, the transaction is committed. Scripts must never modify the current transaction to avoid database inconsistencies. <strong>This is a very hard situation to fix, requiring manual intervention in the database, and the Cyclos team cannot be held responsible in such cases.</strong></p>
</div>
<div class="paragraph">
<p>Below are situations which can cause database inconsistencies.</p>
</div>
<div class="sect4">
<h5 id="scripting-warning-transaction-exception">Exception handling</h5>
<div class="paragraph">
<p>If the script catches an exception without throwing another one, the current transaction will not be rolled-back, but committed instead. If there were other previous database operations which partially modified data, the final state of the database will be inconsistent. Here are some examples for this anti-pattern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When performing a payment, a Payment entity is created. Then, if the payment doesn&#8217;t need authorization, also a Transfer entity is created, which effectively moves funds between the accounts. However, before creating the transfer, the available balance is checked. If the account doesn&#8217;t have enough balance, an exception is thrown. If silencing that exception, the database will have the Payment entity without the corresponding Transfer, which is an inconsistent state for Cyclos. <strong>This is a very hard situation to fix, requiring manual intervention in the database, and the Cyclos team cannot be held responsible in such cases.</strong></p>
</li>
<li>
<p>PostgreSQL marks the current transaction to be rolled-back when there are any errors in database queries (for example, an integrity constraint validation). If that error is silenced, Cyclos may assume it is all OK, and even a success response can be returned to the client (for example, a transaction with a transaction number). However, that transaction was never persisted, because of the rollback. <strong>This situation can damage the system by, for example, notifying merchants that a payment is done, the physical product is sent, but the merchant never gets the payment</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Always catch the most specific exception type you need. And always, either rethrow another specific exception or, if you really need to silence an exception, you must mark the current transaction as rollback-only by calling <code>transactionStatus.setRollbackOnly()</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-warning-transaction-commit">Manual transaction commit</h5>
<div class="paragraph">
<p>Never manually commit the current transaction. For example, after committing the transaction, all locks are released, causing concurrency issues. Also, if the transaction fails, all previously commited data will be persisted but any database changes after that point will be rolled-back.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-warning-inbound-request">4.1.2. Inbound requests</h4>
<div class="paragraph">
<p>Do not make any HTTP requests from scripts to Cyclos' own REST operations or custom web services. Though the REST services are well documented and easy to use, doing so will require opening a separated and parallel database transaction to handle the request, while leaving open the current transaction which is running the script. This can easily exhaust the database connection pool and even lead to situations where no more requests can be handled. Instead, scripts should only use the internal services and handlers.</p>
</div>
</div>
<div class="sect3">
<h4 id="scripting-warning-executor-service">4.1.3. Executor service</h4>
<div class="paragraph">
<p>Do not create your own <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ExecutorService.html">ExecutorService</a> or <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ScheduledExecutorService.html">ScheduledExecutorService</a> unless you have a very good reason for it. Instead, used the shared scheduled executor which is available through the <code>invokerHandler</code> bounded variable, using its <code>executorService</code> property. It scales and shuts down threads as needed. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">invokerHandler</span><span class="o">.</span><span class="na">executorService</span><span class="o">.</span><span class="na">submit</span> <span class="o">{</span>
    <span class="c1">// This runs in another thread...</span>
    <span class="n">println</span> <span class="s1">'Task finished!'</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Keep in mind that Groovy will resolve closures as <code>Runnable</code> by default, not as <code>Callable</code>. This means that the result of the <code>Future.get()</code> call will always be null, as the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ExecutorService.html#submit(java.lang.Runnable)">submit(Runnable)</a> version is called in runtime, which always returns null. To actually use the result, you need to explicitly cast your closure to <code>Callable</code>, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.util.concurrent.Callable</span>

<span class="kt">def</span> <span class="n">future</span> <span class="o">=</span> <span class="n">invokerHandler</span><span class="o">.</span><span class="na">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">({</span>
    <span class="c1">// This runs in another thread...</span>
    <span class="k">return</span> <span class="s1">'My result'</span>
<span class="o">}</span> <span class="k">as</span> <span class="n">Callable</span><span class="o">)</span> <span class="c1">// Note the parenthesis, as we're casting the argument, not the result</span>

<span class="c1">// This will block until the other thread finishes and print 'My result'</span>
<span class="n">println</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if you really need to create an ExecutorService, make sure to shut it down before the script ends. Failing to do so will cause the threads in the pool to be left open (depending on the executor type), which increases the number of system threads in each script execution. This will eventually crash the JVM due to an excessively large number of threads. So, enclose your code with a try / finally block and call <code>ExecutorService.shutdown()</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="scripting-warning-long-running-transactions">4.1.4. Long-running transactions</h4>
<div class="paragraph">
<p>It is not a good idea to have a large job running in the same transaction. This is particularly dangerous for payments because each payment requires locking accounts*, and locks are only released on commit or rollback, causing the locks to be held for much time.</p>
</div>
<div class="paragraph">
<p>Instead, it is much better to break the job into smaller pieces. For example, you could move payments out of the main transaction, by using :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.utils.TransactionLevel</span>

<span class="n">invokerHandler</span><span class="o">.</span><span class="na">submitAsInParallelTransaction</span><span class="o">(</span><span class="n">sessionData</span><span class="o">,</span> <span class="n">TransactionLevel</span><span class="o">.</span><span class="na">READ_WRITE</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Code to make payment...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With this approach, locks will be released early, as the only thing that the separated transaction does is the payment, which would release the lock early.</p>
</div>
<div class="paragraph">
<p>Also, if you need to do some processing iterating a large amount of data (e.g. users, records, etc.) take a look at the <a href="#scripting-type-background-tasks">custom background tasks</a>, it is a much better option than manually processing each entity in the same transaction.</p>
</div>
<div class="paragraph">
<p><em>* How the account locks are performed can be changed through the payment type being used, please check the information for the "Lock origin account" and "Lock destination account" properties on the transfer type details page.</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scripting-bindings">4.2. Variables bound to all scripts</h3>
<div class="paragraph">
<p>When running, scripts have a set of bindings, that is, available top-level variables. At runtime, the bindings will vary according to the script type and context. On all cases, however, the following variables are bound:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>scriptParameters</code>: In the script details page, or in every page where a script is chosen to be used (for example, in the extension point or custom operation details page) there will be a textarea where parameters may be added to the script. They allow scripts to be reused in different contexts, just with different parameters. The text is parsed as <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Properties.html">Java Properties</a>, and the format is <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Properties.html#load(java.io.Reader)">described here</a>. The library parameters are included first (if any), then the own script parameters (if any), then the specific page parameters. This allows overriding parameters at more specific levels;</p>
</li>
<li>
<p><code>globals</code>: A shared <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> (thread-safe) that can be used to store shared objects available to all scripts. When running in a cluster, each node will have its <code>globals</code> map instance. See <a href="#scripting-general-globals">this section</a> for more details;</p>
</li>
<li>
<p><code>scriptHelper</code>: An instance of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/ScriptHelper.html">org.cyclos.impl.system.ScriptHelper</a>. Besides having the instance available, all its methods are automatically exported as closures on the default binding, making it possible to call its methods without using the <code>scriptHelper.</code> prefix. The <code>ScriptHelper</code> class contains some useful methods, such as:</p>
<div class="ulist">
<ul>
<li>
<p><code>wrap(object[, customFields])</code>: wraps the given object in a <code>Map&lt;String,Object&gt;</code>, allowing reading / writing regular properties (getters / setters) and custom field values alike (via field internal names). Also, when setting values, they are automatically converted to the expected type when possible. See <a href="#scripting-general-wrap">this section for more details</a>.</p>
</li>
<li>
<p><code>bean(class)</code>: returns a Spring bean bean by type. The class reference needs to be passed. Available beans are all services, handlers and so on;</p>
</li>
<li>
<p><code>addOnCommit(callback)</code> and <code>addOnRollback(callback)</code>: Add callbacks to be executed after the main database transaction ends, either successfully or with failure. Can only be used in read-write transactions (<code>transactionLevel.readOnly</code> is false). Be aware that those callbacks will be invoked outside any transaction scope within Cyclos, so things like 'sessionData.loggedUser' won&#8217;t work (because it requires retrieving the User object from the database). However, it is more efficient, as no new database access needs to be done. This is mostly useful to notify an external application that some data has been persisted in Cyclos (after we&#8217;re sure that the data is persistent). Keep in mind that there is a (very) small chance that the main transaction is committed / rolled back but then the server crashes, and the callback wasn&#8217;t yet called. So, when synchronizing with external systems, it is always wise to do some form of timeout / recovery mechanism;</p>
</li>
<li>
<p><code>addOnCommitTransactional(callback)</code> and <code>addOnRollbackTransactional(callback)</code>: Same as the non-transactional counterparts, but the callback is executed in a new read-write transaction;</p>
</li>
<li>
<p><code>addOnAfterEnd(callback)</code>: Adds a callback to be executed after the current transaction ends. The callback receives a boolean flag. When in a read-only transaction, the flag will be null. When in a read-write, indicates whether the original transaction was committed (true) or rolled-back (false). The callback itself is executed outside a transaction;</p>
</li>
<li>
<p><code>addOnAfterEndTransactional(callback)</code>: Same as the non-transaction counterpart, but the callback is executed in a new read-write transaction;</p>
</li>
<li>
<p><code>addOnBeforeEnd(callback)</code>: Adds a callback to be executed right before the current transaction ends. The callback is executed in the same current transaction;</p>
</li>
<li>
<p><code>maskId(id)</code> and <code>unmaskId(id)</code>: In Cyclos the internal database ids are not visible to the clients, because of security reasons. The ids used in the web application or used in our web services are therefore always masked / obfuscated. These methods apply or remove the mask to the id.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>sessionData</code>: Contains information about the currently authenticated user (if any), as a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/access/ScriptSessionData.html">org.cyclos.impl.access.ScriptSessionData</a>;</p>
</li>
<li>
<p><code>entityManager</code>: The <a href="https://javaee.github.io/javaee-spec/javadocs/javax/persistence/EntityManager.html">JPA entity manager</a> bound to the current transaction;</p>
</li>
<li>
<p><code>transactionLevel</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/TransactionLevel.html">org.cyclos.model.utils.TransactionLevel</a>. When <code>transactionLevel.readOnly</code> is true, scripts should not modify the database in any way, or the current transaction will fail;</p>
</li>
<li>
<p><code>transactionStatus</code>: The current transaction status, as <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/TransactionStatus.html">org.springframework.transaction.TransactionStatus</a>. If ever doing a script that silences an exception, the <code>setRollbackOnly()</code> method <strong>must</strong> be called to rollback the current transaction, avoiding an inconsistent database state. See <a href="#scripting-warning-transaction-exception">this warning</a> for more information;</p>
</li>
<li>
<p><code>formatter</code>: A <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/formatting/FormatterImpl.html">org.cyclos.impl.utils.formatting.FormatterImpl</a> instance configured with the current user settings;</p>
</li>
<li>
<p><code>objectMapper</code>: A <a href="https://fasterxml.github.io/jackson-databind/javadoc/2.6/com/fasterxml/jackson/databind/ObjectMapper.html">com.fasterxml.jackson.databind.ObjectMapper</a> which can be used to encode / decode objects to JSON strings;</p>
</li>
<li>
<p><code>jdbc</code> or <code>jdbcTemplate</code>: <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/core/JdbcTemplate.html">org.springframework.jdbc.core.JdbcTemplate</a> which can be used to perform native SQL queries using positional parameters;</p>
</li>
<li>
<p><code>namedJdbc</code> or <code>namedParameterJdbcTemplate</code>: <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/namedparam/NamedParameterJdbcTemplate.html">org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate</a> which can be used to perform native SQL queries using named parameters;</p>
</li>
<li>
<p><code>rest</code> or <code>restTemplate</code>: <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html">org.springframework.web.client.RestTemplate</a> which can be used to perform REST HTTP requests;</p>
</li>
<li>
<p><em>Service implementations</em>: All <code>*ServiceLocal</code> instances are bound via simple names, starting with lowercase characters, without the 'Local' suffix. For example, <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/users/UserServiceLocal.html">org.cyclos.impl.users.UserServiceLocal</a> is bound as <code>userService</code>;</p>
</li>
<li>
<p><em>Security layer</em>: All <code>*ServiceSecurity</code> instances are bound via simple names, starting with lowercase characters. Specially useful for custom web services, which have no security layer. For example, <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/security/users/UserServiceSecurity.html">org.cyclos.security.users.UserServiceSecurity</a> is bound as <code>userServiceSecurity</code>;</p>
</li>
<li>
<p><em>Internal handlers</em>: All <code>*Handler</code> instances are bound via simple names, starting with lowercase characters. For example, <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/access/ConfigurationHandler.html">org.cyclos.impl.access.ConfigurationHandler</a> is bound as <code>configurationHandler</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="scripting-general">4.3. General tips for scripts</h3>
<div class="sect3">
<h4 id="scripting-general-grape">4.3.1. Using custom external dependencies using Groovy Grape</h4>
<div class="paragraph">
<p>Groovy provides the <a href="http://docs.groovy-lang.org/latest/html/documentation/grape.html">Grape</a> functionality to fetch Java dependencies in a Maven repository. All you need is to find the dependency in <a href="https://mvnrepository.com/" class="bare">https://mvnrepository.com/</a>, click on the version and copy the content of the Grape tab.</p>
</div>
<div class="sect4">
<h5 id="scripting-general-grape-sftp">Using Grape to connect to a SFTP server</h5>
<div class="paragraph">
<p>Here is an example of a library script which uses the <a href="https://github.com/mwiede/jsch">a fork</a> of the <a href="https://sourceforge.net/projects/jsch/">JSch library</a> to download a file from a remote SFTP server to the local filesystem. The original JSch project was discontinued, and no longer works with modern encryption algorithms, hence, the fork.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="nd">@Grab</span><span class="o">(</span><span class="n">group</span><span class="o">=</span><span class="s1">'com.github.mwiede'</span><span class="o">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">'jsch'</span><span class="o">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">'0.2.8'</span><span class="o">)</span>

<span class="kn">import</span> <span class="nn">com.jcraft.jsch.ChannelSftp</span>
<span class="kn">import</span> <span class="nn">com.jcraft.jsch.JSch</span>
<span class="kn">import</span> <span class="nn">com.jcraft.jsch.SftpException</span>

<span class="kd">class</span> <span class="nc">SftpHelper</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="n">CODE_TO_MSG</span> <span class="o">=</span> <span class="o">[</span>
        <span class="o">(</span><span class="n">ChannelSftp</span><span class="o">.</span><span class="na">SSH_FX_OK</span><span class="o">):</span> <span class="s1">'OK'</span><span class="o">,</span>
        <span class="o">(</span><span class="n">ChannelSftp</span><span class="o">.</span><span class="na">SSH_FX_EOF</span><span class="o">):</span> <span class="s1">'EOF'</span><span class="o">,</span>
        <span class="o">(</span><span class="n">ChannelSftp</span><span class="o">.</span><span class="na">SSH_FX_NO_SUCH_FILE</span><span class="o">):</span> <span class="s1">'NO_SUCH_FILE'</span><span class="o">,</span>
        <span class="o">(</span><span class="n">ChannelSftp</span><span class="o">.</span><span class="na">SSH_FX_PERMISSION_DENIED</span><span class="o">):</span> <span class="s1">'PERMISSION_DENIED'</span><span class="o">,</span>
        <span class="o">(</span><span class="n">ChannelSftp</span><span class="o">.</span><span class="na">SSH_FX_FAILURE</span><span class="o">):</span> <span class="s1">'FAILURE'</span><span class="o">,</span>
        <span class="o">(</span><span class="n">ChannelSftp</span><span class="o">.</span><span class="na">SSH_FX_BAD_MESSAGE</span><span class="o">):</span> <span class="s1">'BAD_MESSAGE'</span><span class="o">,</span>
        <span class="o">(</span><span class="n">ChannelSftp</span><span class="o">.</span><span class="na">SSH_FX_NO_CONNECTION</span><span class="o">):</span> <span class="s1">'NO_CONNECTION'</span><span class="o">,</span>
        <span class="o">(</span><span class="n">ChannelSftp</span><span class="o">.</span><span class="na">SSH_FX_CONNECTION_LOST</span><span class="o">):</span> <span class="s1">'CONNECTION_LOST'</span><span class="o">,</span>
        <span class="o">(</span><span class="n">ChannelSftp</span><span class="o">.</span><span class="na">SSH_FX_OP_UNSUPPORTED</span><span class="o">):</span> <span class="s1">'UNSUPPORTED'</span>
    <span class="o">]</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">host</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">user</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">path</span>

    <span class="kd">public</span> <span class="nf">SftpHelper</span><span class="o">(</span><span class="n">Binding</span> <span class="n">binding</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Properties</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">scriptParameters</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">[</span><span class="s1">'sftp.host'</span><span class="o">]</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">[</span><span class="s1">'sftp.port'</span><span class="o">]</span> <span class="k">as</span> <span class="kt">int</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">[</span><span class="s1">'sftp.user'</span><span class="o">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">[</span><span class="s1">'sftp.password'</span><span class="o">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">[</span><span class="s1">'sftp.path'</span><span class="o">]</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">download</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">File</span> <span class="n">outFile</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">jsch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSch</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">session</span> <span class="o">=</span> <span class="n">jsch</span><span class="o">.</span><span class="na">getSession</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span>
        <span class="n">session</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
        <span class="kt">def</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
        <span class="n">config</span><span class="o">[</span><span class="s2">"StrictHostKeyChecking"</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"no"</span><span class="o">;</span>
        <span class="n">session</span><span class="o">.</span><span class="na">setConfig</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>

        <span class="n">ChannelSftp</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">outFile</span><span class="o">)</span>
            <span class="n">session</span><span class="o">.</span><span class="na">connect</span><span class="o">()</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">openChannel</span><span class="o">(</span><span class="s2">"sftp"</span><span class="o">)</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">connect</span><span class="o">()</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">cd</span><span class="o">(</span><span class="n">path</span><span class="o">)</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="n">out</span><span class="o">)</span>
            <span class="k">return</span> <span class="s2">"OK"</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SftpException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">CODE_TO_MSG</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="na">id</span><span class="o">]</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">session</span><span class="o">.</span><span class="na">disconnect</span><span class="o">()</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="cm">/* Ignore */</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">disconnect</span><span class="o">()</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="cm">/* Ignore */</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="cm">/* Ignore */</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It uses the following parameters (adjust according to your server):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">sftp.host</span> <span class="p">=</span> <span class="s">localhost</span>
<span class="py">sftp.port</span> <span class="p">=</span> <span class="s">22</span>
<span class="py">sftp.user</span> <span class="p">=</span> <span class="s">username</span>
<span class="py">sftp.password</span> <span class="p">=</span> <span class="s">password</span>
<span class="py">sftp.path</span> <span class="p">=</span> <span class="s">/remote/server/root</span>

<span class="py">file.name</span> <span class="p">=</span> <span class="s">remote-file.txt</span>
<span class="py">file.local</span> <span class="p">=</span> <span class="s">/tmp/file.txt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is a usage of the library script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">sftp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SftpHelper</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptParameters</span>
<span class="n">sftp</span><span class="o">.</span><span class="na">download</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">[</span><span class="s1">'file.name'</span><span class="o">],</span>
        <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">[</span><span class="s1">'file.local'</span><span class="o">]))</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-general-wrap">4.3.2. Reading and updating custom field values</h4>
<div class="paragraph">
<p>Working directly with custom field values can be a hard task. For this reason, Cyclos provides the <code>scriptHelper.wrap(object[, customValues])</code> method. It will return a <code>Map&lt;String, Object&gt;</code> which can be used to set and get custom field values. When setting a value, the input will be converted the value to the expected type, whereas when reading a value, the 'native' data type is returned. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>

<span class="c1">// In this case we're using the internal name of the possible value</span>
<span class="n">bean</span><span class="o">.</span><span class="na">gender</span> <span class="o">=</span> <span class="s1">'male'</span>

<span class="c1">// Here, gender is of type org.cyclos.entities.system.CustomFieldPossibleValue</span>
<span class="kt">def</span> <span class="n">gender</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">gender</span>

<span class="c1">// Here, date will be a java.util.Date</span>
<span class="kt">def</span> <span class="n">date</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">customDate</span>

<span class="c1">// Here, relatedUser will be an instance of org.cyclos.entities.users.User</span>
<span class="kt">def</span> <span class="n">relatedUser</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">relatedUser</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that when you call <code>wrap(object)</code> without the second parameter, Cyclos will try to determine which are all the available custom fields. You can also pass in the second argument, which is a collection of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomField.html">org.cyclos.entities.system.CustomField</a>s to specify exactly which are the fields to use.</p>
</div>
<div class="paragraph">
<p>Also, note that you don&#8217;t need to wrap every object (we&#8217;ve seen many clients doing this). You only should wrap objects when reading / writing custom values.</p>
</div>
</div>
<div class="sect3">
<h4 id="scripting-general-lock">4.3.3. Custom locks</h4>
<div class="paragraph">
<p>Sometimes it might be interesting to have system-wide locks, specially in a cluster. Cyclos implements locks  using <a href="https://www.postgresql.org/docs/current/explicit-locking.html#ADVISORY-LOCKS">PostgreSQL&#8217;s advisory locks</a>. All locks are held until the transaction ends (either committed or rolled back).</p>
</div>
<div class="paragraph">
<p>Cyclos provides the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/locks/LockHandler.html">org.cyclos.impl.locks.LockHandler</a> component to acquire locks. Starting with version 4.16, custom locks are supported. These locks are meant to be used by scripts.</p>
</div>
<div class="paragraph">
<p>For an example in a custom lock usage, refer to <a href="#scripting-general-counter">this example</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="scripting-general-globals">4.3.4. Reusing shared object instances between scripts</h4>
<div class="paragraph">
<p>Sometimes it is desirable to have a shared object between all script executions in the same JVM. To accomplish this, a variable bound to all scripts named <code>globals</code> is available. It is a <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ConcurrentMap.html">ConcurrentMap&lt;String, Object&gt;</a>. Please, notice that <code>ConcurrentMap</code> doesn&#8217;t allow <code>null</code> s neither for keys nor values.</p>
</div>
<div class="paragraph">
<p>This map can be used on 2 situations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For storing objects that should be cached and reused, such as external connection pools or service clients. In this case, scripts should use the <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ConcurrentMap.html#computeIfAbsent(K,java.util.function.Function)">Map.computeIfAbsent()</a> method to get an existing or produce a new instance if none exists. When the Cyclos server is shutdown, all values in this map will be destroyed if they either follow a Spring destruction semantics (having a method annotated with <a href="https://docs.oracle.com/javaee/7/api/javax/annotation/PreDestroy.html">@PreDestroy</a> or implementing <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/DisposableBean.html">DisposableBean</a>) or by implementing <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/AutoCloseable.html">AutoCloseable</a>;</p>
</li>
<li>
<p>For storing simple variables that are shared between the scripts. In this case, the recommended method to read and update the value is <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ConcurrentMap.html#compute(K,java.util.function.BiFunction)">Map.compute()</a>, to avoid concurrency issues. If many values will be added to the map, those should be removed to avoid memory leaks. The size of the map is shown in the system monitor page under 'Scripting global storage size'.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider these points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There will probably be concurrent access to the values in the <code>globals</code> map, so only use instances that are thread-safe;</p>
</li>
<li>
<p>In a cluster, the <code>globals</code> map is local to each node. However, you can obtain the values in all nodes by calling <code>clusterHandler.getGlobal('key')</code>. For this to work, the values must be serializable. The resulting map is keyed by the host id of each node;</p>
</li>
<li>
<p>It is always advisable to use either <code>Map.computeIfAbsent()</code> or <code>Map.compute()</code> methods instead of directly accessing the map values. This will avoid headaches!</p>
</li>
<li>
<p>In development, if you need to recreate the value in the map, you can run the following in System &gt; Tools &gt; Run script: <code>globals.remove('name')</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here are some examples:</p>
</div>
<div class="sect4">
<h5 id="scripting-general-globals-mysql">Connecting to an external MariaDB / MySQL database</h5>
<div class="paragraph">
<p>This examples provides a connection pool to an external MariaDB / MySQL database, which could be further accessed from other scripts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="nd">@Grab</span><span class="o">(</span><span class="n">group</span><span class="o">=</span><span class="s1">'org.mariadb.jdbc'</span><span class="o">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">'mariadb-java-client'</span><span class="o">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">'3.0.8'</span><span class="o">)</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span>

<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.DataSourceTransactionManager</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.PlatformTransactionManager</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.support.TransactionTemplate</span>

<span class="kn">import</span> <span class="nn">org.mariadb.jdbc.MariaDbPoolDataSource</span>

<span class="kd">class</span> <span class="nc">MariaDbConnection</span> <span class="o">{</span>
    <span class="n">DataSource</span> <span class="n">dataSource</span>
    <span class="n">PlatformTransactionManager</span> <span class="n">transactionManager</span>
    <span class="n">TransactionTemplate</span> <span class="n">transaction</span>
    <span class="n">JdbcTemplate</span> <span class="n">jdbc</span>

    <span class="nf">MariaDbConnection</span><span class="o">(</span><span class="n">Binding</span> <span class="n">binding</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">globals</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">globals</span>
        <span class="n">Properties</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">scriptParameters</span>

        <span class="n">dataSource</span> <span class="o">=</span> <span class="n">globals</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="s1">'mariaDb.pool'</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">MariaDbPoolDataSource</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">jdbcUrl</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">transactionManager</span> <span class="o">=</span> <span class="n">globals</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="s1">'mariaDb.txManager'</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="n">globals</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="s1">'mariaDb.txTemplate'</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">TransactionTemplate</span><span class="o">(</span><span class="n">transactionManager</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">jdbc</span> <span class="o">=</span> <span class="n">globals</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="s1">'mariaDb.jdbc'</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example uses script parameters. Note that the JDBC URL has many parameters. Refer to <a href="https://mariadb.com/kb/en/pool-datasource-implementation/" class="bare">https://mariadb.com/kb/en/pool-datasource-implementation/</a> for more details:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">jdbcUrl</span> <span class="p">=</span> <span class="s">jdbc:mariadb://localhost:3306/dbname?user=dbuser&amp;password=dbpwd&amp;maxPoolSize=10</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is an example of the usage from another script that uses the library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">db</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MariaDbConnection</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span>

<span class="c1">// Run a transaction</span>
<span class="n">db</span><span class="o">.</span><span class="na">transaction</span><span class="o">.</span><span class="na">execute</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">jdbc</span><span class="o">.</span><span class="na">queryForList</span><span class="o">(</span><span class="s2">"select a, b from my_table"</span><span class="o">)</span>
    <span class="n">rows</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span> <span class="n">println</span><span class="o">(</span><span class="s2">"A: ${it.a}, B: ${it.b}"</span><span class="o">)</span> <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-general-globals-httpclient">Reusing a single HttpClient for all scripts</h5>
<div class="paragraph">
<p>This examples allows reusing a single instance of <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpClient.html">HttpClient</a>. This class creates some threads (which are stopped when the garbage collector runs), but can still impose some performance penalty if instantiated too many times. As the instance is thread-safe and can be reused, it is a good practice to do so. For simplicity, the example uses the map directly, but, just like in the previous example, it is advised to have the common code in a library script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.net.http.HttpClient</span>

<span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">globals</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="s1">'httpClient'</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">HttpClient</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
            <span class="c1">// Reuse Cyclos' shared executor</span>
            <span class="o">.</span><span class="na">executor</span><span class="o">(</span><span class="n">invokerHandler</span><span class="o">.</span><span class="na">executorService</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">()</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-general-counter">A simple counter</h5>
<div class="paragraph">
<p>This example simply increments a value on every call. In a cluster, this counter will be per-node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">globals</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s1">'counter'</span><span class="o">)</span> <span class="o">{</span> <span class="n">k</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">value</span> <span class="o">-&gt;</span>
    <span class="o">(</span><span class="n">value</span> <span class="o">?:</span> <span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the following example is slightly modified to provide a cluster-wide view of the counter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// First lock, to avoid 2 cluster members to read / increment</span>
<span class="n">lockHandler</span><span class="o">.</span><span class="na">lock</span><span class="o">(</span><span class="s1">'counter'</span><span class="o">)</span>

<span class="c1">// Now return the maximum local counter value on each node</span>
<span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">globals</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s1">'counter'</span><span class="o">)</span> <span class="o">{</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span> <span class="o">-&gt;</span>
    <span class="kt">def</span> <span class="n">current</span> <span class="o">=</span> <span class="n">clusterHandler</span><span class="o">.</span><span class="na">getGlobal</span><span class="o">(</span><span class="n">k</span><span class="o">).</span><span class="na">values</span><span class="o">().</span><span class="na">max</span><span class="o">()</span> <span class="o">?:</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">current</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scripting-type">4.4. Script types</h3>
<div class="sect3">
<h4 id="scripting-type-library">4.4.1. Library</h4>
<div class="paragraph">
<p>Libraries are scripts which are included by other scripts, in order to reuse code, and are never used directly by other functionality in Cyclos.</p>
</div>
<div class="paragraph">
<p>Each script (including other libraries) can have any number of libraries as dependencies. However, circular dependencies between libraries (for example, A depends on B, which depends on C, which depends on A) are forbidden (validated when saving a library).</p>
</div>
<div class="paragraph">
<p>The order in which the code on libraries is included in the final code respects the dependencies, but doesn&#8217;t guarantee ordering between libraries in the same level. For example, if there are both C and B libraries which depend on A, it is guaranteed that A is included before B and C, but either B or C could be included right after A. So, in the example, your code shouldn&#8217;t rely on that B comes before C. In this case, the library C should depend on B to force the A, B, C order.</p>
</div>
<div class="paragraph">
<p>Contrary to other script types, libraries don&#8217;t have bound variables per se: the bindings will be the same as the script including the library.</p>
</div>
<div class="paragraph">
<p>Also, as libraries are just prepended in other scripts, no direct examples are provided here. The example <a href="#scripting-solution">scripting solutions</a>, however, all use libraries.</p>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-field-validation">4.4.2. Custom field validation</h4>
<div class="paragraph">
<p>These scripts are used to perform custom validation logic to custom field values. The field can be of any type (users, advertisements, user records, transactions and so on).</p>
</div>
<div class="sect4">
<h5 id="scripting-type-field-validation-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>object</code>: The DTO which holds the custom field values. It may be an instance of:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/UserDTO.html">org.cyclos.model.users.users.UserDTO</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/contacts/ContactDTO.html">org.cyclos.model.users.contacts.ContactDTO</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/contactinfos/ContactInfoDTO.html">org.cyclos.model.users.contactinfos.ContactInfoDTO</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/marketplace/advertisements/BasicAdDTO.html">org.cyclos.model.marketplace.advertisements.BasicAdDTO</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/records/UserRecordDTO.html">org.cyclos.model.users.records.UserRecordDTO</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/PerformTransactionDTO.html">org.cyclos.model.banking.transactions.PerformTransactionDTO</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/contentmanagement/documents/ProcessDynamicDocumentDTO.html">org.cyclos.model.contentmanagement.documents.ProcessDynamicDocumentDTO</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/operations/RunCustomOperationDTO.html">org.cyclos.model.system.operations.RunCustomOperationDTO</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>field</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomField.html">org.cyclos.entities.system.CustomField</a> being validated;</p>
</li>
<li>
<p><a id="scripting-type-field-validation-bindings-value"></a> <code>value</code>: The raw custom field value. Depends on the custom field type. It may be either:</p>
<div class="ulist">
<ul>
<li>
<p>String (for single line text, multi line text, rich text or url types);</p>
</li>
<li>
<p>Boolean (for boolean type);</p>
</li>
<li>
<p>Integer (for integer type);</p>
</li>
<li>
<p>BigDecimal (for decimal type);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomFieldPossibleValue.html">org.cyclos.entities.system.CustomFieldPossibleValue</a> (for single selection type);</p>
</li>
<li>
<p>A collection of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomFieldPossibleValue.html">org.cyclos.entities.system.CustomFieldPossibleValue</a>s (for multi selection type);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/fields/DynamicFieldValueVO.html">org.cyclos.model.system.fields.DynamicFieldValueVO</a> (for dynamic selection type);</p>
</li>
<li>
<p>A collection of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/fields/DynamicFieldValueVO.html">org.cyclos.model.system.fields.DynamicFieldValueVO</a>s (for multiple dynamic selection type);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> (for linked entity of type user);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transaction.html">org.cyclos.entities.banking.Transaction</a> (for linked entity of type transaction);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a> (for linked entity of type transfer);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Record.html">org.cyclos.entities.users.Record</a> (for linked entity of type record);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/marketplace/BasicAd.html">org.cyclos.entities.marketplace.BasicAd</a> (for linked entity of type advertisement);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/utils/RawFile.html">org.cyclos.entities.utils.RawFile</a> (for file type);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/Image.html">org.cyclos.entities.system.Image</a> (for image type).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that in case of user custom field validation, the <code>object</code> may not be a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/UserDTO.html">org.cyclos.model.users.users.UserDTO</a>. For instance, when paying an external user, <code>object</code> is a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/PerformExternalPaymentDTO.html">org.cyclos.model.banking.transactions.PerformExternalPaymentDTO</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-field-validation-result">Script result</h5>
<div class="paragraph">
<p>The script should return one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A boolean: indicates that the value is either valid / invalid. When invalid, the general <code>&lt;Field name&gt; is invalid</code> error will be displayed;</p>
</li>
<li>
<p>A string: means the field is invalid, and the string is the error message. To concatenate the field name, use the {0} placeholder, like: <code>{0} has an unexpected value</code>;</p>
</li>
<li>
<p>Any other result will be considered valid.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-field-validation-examples">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-field-validation-examples-email">E-mail</h6>
<div class="paragraph">
<p>To have a custom field which is validated as an e-mail, use the following script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.apache.commons.validator.routines.EmailValidator</span>

<span class="k">return</span> <span class="n">EmailValidator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">isValid</span><span class="o">(</span><span class="n">value</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-field-validation-examples-iban">IBAN account number</h6>
<div class="paragraph">
<p>To validate an IBAN account number as a custom field, the following script can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.apache.commons.validator.routines.checkdigit.IBANCheckDigit</span>

<span class="k">return</span> <span class="n">IBANCheckDigit</span><span class="o">.</span><span class="na">IBAN_CHECK_DIGIT</span><span class="o">.</span><span class="na">isValid</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">"\\s"</span><span class="o">,</span> <span class="s2">""</span><span class="o">))</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-field-validation-examples-cpf">CPF Validation</h6>
<div class="paragraph">
<p>In Brazil, people are identified by a number called CPF (Cadastro de Pessoas Fsicas). It has 2 verifying digits, which have a known formula to calculate.
Here&#8217;s the example for validating it in Cyclos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">parseInt</span>

<span class="kt">def</span> <span class="kt">boolean</span> <span class="nf">validateCPF</span><span class="o">(</span><span class="n">String</span> <span class="n">cpf</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Strip non-numeric chars</span>
    <span class="n">cpf</span> <span class="o">=</span> <span class="n">cpf</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">"[^0-9]"</span><span class="o">,</span> <span class="s2">""</span><span class="o">)</span>

    <span class="c1">// Obvious checks: needs to be 11 digits, and not all be the same digit</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cpf</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">11</span> <span class="o">||</span> <span class="n">cpf</span><span class="o">.</span><span class="na">toSet</span><span class="o">().</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">// Check for verifier digit 1</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="n">add</span> <span class="o">+=</span> <span class="n">parseInt</span><span class="o">(</span><span class="n">cpf</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">*</span> <span class="o">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">i</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">rev</span> <span class="o">=</span> <span class="mi">11</span> <span class="o">-</span> <span class="o">(</span><span class="n">add</span> <span class="o">%</span> <span class="mi">11</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">rev</span> <span class="o">==</span> <span class="mi">11</span><span class="o">)</span> <span class="n">rev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rev</span> <span class="o">!=</span> <span class="n">parseInt</span><span class="o">(</span><span class="n">cpf</span><span class="o">[</span><span class="mi">9</span><span class="o">]))</span> <span class="k">return</span> <span class="kc">false</span>

    <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">// Check for verifier digit 2</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="n">add</span> <span class="o">+=</span> <span class="n">parseInt</span><span class="o">(</span><span class="n">cpf</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">*</span> <span class="o">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="o">)</span>
    <span class="n">rev</span> <span class="o">=</span> <span class="mi">11</span> <span class="o">-</span> <span class="o">(</span><span class="n">add</span> <span class="o">%</span> <span class="mi">11</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">rev</span> <span class="o">==</span> <span class="mi">11</span><span class="o">)</span> <span class="n">rev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rev</span> <span class="o">!=</span> <span class="n">parseInt</span><span class="o">(</span><span class="n">cpf</span><span class="o">[</span><span class="mi">10</span><span class="o">]))</span> <span class="k">return</span> <span class="kc">false</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="o">}</span>

<span class="k">return</span> <span class="nf">validateCPF</span><span class="o">(</span><span class="n">value</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-load-field-values">4.4.3. Load custom field values</h4>
<div class="paragraph">
<p>These scripts are used to load a list of allowed values for a custom field.
Custom fields of type dynamic selection are required to have such a script.
Several other field types can have an optional load values script: string, integer, decimal, date, url, enumerated or linked entity. Enumerated fields naturally have a list of static possible values. The script, however, can be used to show a subset of those options to specific users. Multi-line text, rich text, boolean, image and file types cannot have a load custom field values script.</p>
</div>
<div class="paragraph">
<p>If a custom field of type string, integer, decimal, date, url or linked entity has a load values script, Cyclos will use a single selection or radio button group widget instead of the regular widget for the custom field. Also, when a load custom field values script is used, the server-side validation will ensure that saved values are valid according to the allowed values list.</p>
</div>
<div class="paragraph">
<p>The script has a separated code block which loads values for custom fields being used as a search filter. The field types supporting load values when filtering are: dynamic selection, linked entity and enumerated. In that case, the bound variables will be different from the ones for the code block that runs over fields used to create or edit some entity (user, advertisement, record, etc.).</p>
</div>
<div class="sect4">
<h5 id="scripting-type-load-field-values-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>In all cases, the script will have the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>field</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomField.html">org.cyclos.entities.system.CustomField</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, depending on the custom field nature, there are the following additional bindings, both for the script that runs when creating or modifying an entity and for the script that runs over custom fields used as search filters:</p>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-user">User (profile) fields</h6>
<div class="paragraph">
<p>When the field is used for registering a user or editing a user profile:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/BasicUser.html">org.cyclos.entities.users.BasicUser</a>. When registering a user, it will always have the <code>group</code> property with a valid <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Group.html">org.cyclos.entities.users.Group</a>. When the field is used in the context of an operator, this will represent the operator owner;</p>
</li>
<li>
<p><code>operator</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Operator.html">org.cyclos.entities.users.Operator</a>. Only used when the field is in the context of an operator. When registering an operator, it will always have the <code>user</code> property with the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> set.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the field is used as search filter or in the built-in bulk action, <code>Change custom field value</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>searchContext</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/users/ProfileFieldSearchContext.html">org.cyclos.impl.users.ProfileFieldSearchContext</a> in which the custom field is being used for search. Note that only the values reflecting filters are used. This enumeration also contains cases for the field in keywords, but it will never be the case when calling this script. In the bulk action mentioned above, this parameter is null.</p>
</li>
<li>
<p><code>overBrokeredUsers</code>: This flag indicates, in case a broker is logged in, if the search is being done only over users he/she manages (<code>true</code>) or if this is a general search, as member (<code>false</code>).</p>
</li>
<li>
<p>Also, as user custom profile fields can be used to search advertisements or records, the same variables bound for those custom fields when used as search filter will also be available for the user profile fields. See below for the extra variables bound for advertisement and record fields when used as search filters.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-contact">Contact fields (personal contact list)</h6>
<div class="paragraph">
<p>When the field is used for creating or modifying a contact:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>contact</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Contact.html">org.cyclos.entities.users.Contact</a>. Even on inserts, is guaranteed to have the <code>owner</code> property set with the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the field is used for search the contact list:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>owner</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> instance of the contact owner.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-contact-info">Public contact information fields</h6>
<div class="paragraph">
<p>When the field is used for creating or modifying a public contact information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>contactInfo</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/ContactInfo.html">org.cyclos.entities.users.ContactInfo</a>. Even on inserts, is guaranteed to have the <code>user</code> property set with the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is no public contact information search, so the secondary script code doesn&#8217;t apply.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-marketplace">Advertisement fields</h6>
<div class="paragraph">
<p>When the field is used for creating or modifying an advertisement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ad</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/marketplace/BasicAd.html">org.cyclos.entities.marketplace.BasicAd</a>. Even on inserts, is guaranteed to have the <code>owner</code> property set with the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the field is used for searching advertisements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>user</code>: If searching advertisements of a specific user, contains the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> instance;</p>
</li>
<li>
<p><code>adType</code>: The type of advertisements being searched. It is null when all types are being searched. Otherwise, contains the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/marketplace/advertisements/AdType.html">org.cyclos.model.marketplace.advertisements.AdType</a> instance;</p>
</li>
<li>
<p><code>overBrokeredUsers`</code>: This flag indicates, in case a broker is logged in, if the search is being done only over managed users (<code>true</code>) or if this is a general advertisements search (<code>false</code>).</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-record">Record fields</h6>
<div class="paragraph">
<p>When using the field for creating or modifying a record:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>record</code> The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Record.html">org.cyclos.entities.users.Record</a>. Even on inserts, is guaranteed to have the <code>type</code> property set with the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/RecordType.html">org.cyclos.entities.users.RecordType</a> instance. Also, for user records, is guaranteed to have the <code>user</code> property set with the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the field is used for searching records:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>recordType</code>: In most cases, the record type is known, and this contains the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/RecordType.html">org.cyclos.entities.users.RecordType</a>. However, it is also possible to search for records using shared record fields, over multiple record types at the same time. In that case, this variable will be null.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-transaction">Transaction fields</h6>
<div class="paragraph">
<p>When the field is used to perform a payment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>paymentType</code>: The transaction type, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/PaymentTransferType.html">org.cyclos.entities.banking.PaymentTransferType</a> instance;</p>
</li>
<li>
<p><code>fromOwner</code> The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/accounts/InternalAccountOwner.html">org.cyclos.model.banking.accounts.InternalAccountOwner</a> performing the payment;</p>
</li>
<li>
<p><code>fromOwnerResult</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/LocateAccountOwnerResult.html">org.cyclos.impl.banking.LocateAccountOwnerResult</a> which contains additional information for the from owner;</p>
</li>
<li>
<p><code>toOwner</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/accounts/AccountOwner.html">org.cyclos.model.banking.accounts.AccountOwner</a> receiving the payment;</p>
</li>
<li>
<p><code>toOwnerResult</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/LocateAccountOwnerResult.html">org.cyclos.impl.banking.LocateAccountOwnerResult</a> which contains additional information for the to owner.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the field is used to search an account history:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>account</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Account.html">org.cyclos.entities.banking.Account</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-operation">Custom operation fields</h6>
<div class="paragraph">
<p>When the field is used to run a custom operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>customOperation</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomOperation.html">org.cyclos.entities.system.CustomOperation</a>;</p>
</li>
<li>
<p><code>formParameters</code>: A <code>Map&lt;String, Object&gt;</code>, keyed by the form field internal name. The value depends on the custom field type (see <a href="#scripting-type-field-validation-bindings-value">the value binding on custom field validation script</a> for details on types). The parameters of the operation being executed;</p>
</li>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a>. Only present if the custom operation scope is user;</p>
</li>
<li>
<p><code>contact</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Contact.html">org.cyclos.entities.users.Contact</a>. Only present if the custom operation scope is contact;</p>
</li>
<li>
<p><code>contactInfo</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/ContactInfo.html">org.cyclos.entities.users.ContactInfo</a>. Only present if the custom operation scope is public contact information;</p>
</li>
<li>
<p><code>ad</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/marketplace/BasicAd.html">org.cyclos.entities.marketplace.BasicAd</a>. Only present if the custom operation scope is advertisement;</p>
</li>
<li>
<p><code>record</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Record.html">org.cyclos.entities.users.Record</a>. Only present if the custom operation scope is record;</p>
</li>
<li>
<p><code>transfer</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a>. Only present if the custom operation scope is transfer;</p>
</li>
<li>
<p><code>menuItem</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/contentmanagement/MenuItem.html">org.cyclos.entities.contentmanagement.MenuItem</a>. Only present if the custom operation scope is custom menu.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Custom operation fields are never used on search, so the secondary script code doesn&#8217;t apply.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-document">Dynamic document fields</h6>
<div class="paragraph">
<p>When the document is being printed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>document</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/contentmanagement/DynamicDocument.html">org.cyclos.entities.contentmanagement.DynamicDocument</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dynamic document fields are never used on search, so the secondary script code doesn&#8217;t apply.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-wizards">Custom wizards fields</h6>
<div class="paragraph">
<p>When the field is being shown in a form fields step:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>wizard</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWizard.html">org.cyclos.entities.system.CustomWizard</a> being executed;</p>
</li>
<li>
<p><code>step</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/FormFieldsWizardStep.html">org.cyclos.entities.system.FormFieldsWizardStep</a>;</p>
</li>
<li>
<p><code>execution</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWizardExecution.html">org.cyclos.entities.system.CustomWizardExecution</a> which contains all data for a given wizard execution, and is shared between steps;</p>
</li>
<li>
<p><code>storage</code>: A <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/CustomWizardExecutionStorage.html">org.cyclos.impl.system.CustomWizardExecutionStorage</a> which is shared between all steps. Scripts can use it to pass data between steps, and to the final execution script function;</p>
</li>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a>. The meaning depends on the wizard type. For registration wizards, it is the newly registered user. For user wizards it is the user over which it is being executed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Custom wizards fields are never used on search, so the secondary script code doesn&#8217;t apply.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-bindings-vouchers">Voucher fields</h6>
<div class="paragraph">
<p>When the field is being shown in a voucher creation or activation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>voucher</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Voucher.html">org.cyclos.entities.banking.Voucher</a> being activated in a top-up (present only for voucher activation);</p>
</li>
<li>
<p><code>voucherType</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/VoucherType.html">org.cyclos.entities.banking.VoucherType</a> of the voucher being bought, sent or generated (present only for voucher creation);</p>
</li>
<li>
<p><code>voucherCreationType</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/vouchers/VoucherCreationType.html">org.cyclos.model.banking.vouchers.VoucherCreationType</a>  (present only for voucher creation).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Voucher fields are never used on search, so the secondary script code doesn&#8217;t apply.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-load-field-values-result">Script result</h5>
<div class="paragraph">
<p>The expected result type should match the custom field type.
Must be either one, a collection or an array of:</p>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-result-dynamic">Dynamic selection</h6>
<div class="ulist">
<ul>
<li>
<p>String: In this case, each allowed possible value will have both value and label equals.</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/fields/DynamicFieldValueVO.html">org.cyclos.model.system.fields.DynamicFieldValueVO</a> (or compatible object / Map): The dynamic field value, containing the properties <code>value</code> (the internal value) and a <code>label</code> (the display value). The value must be not blank, or an error will be raised. If the label is blank, it will show the same text as the value. Also, the first dynamic value with <code>defaultValue</code> set to true will show up by default in the form.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-result-string">String</h6>
<div class="paragraph">
<p>Any returned object will be converted to string via <code>toString()</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-result-numeric">Numeric (integer or decimal)</h6>
<div class="paragraph">
<p>The result may be either numbers or strings</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-result-date">Date</h6>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Date.html">java.util.Date</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/utils/DateTime.html">org.cyclos.utils.DateTime</a>;</p>
</li>
<li>
<p><strong>Number</strong>: A number of <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Date.html#Date-long-">milliseconds since the epoch date</a>;</p>
</li>
<li>
<p><strong>String</strong>: a date representation in the <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-8601</a> format (yyyy-mm-dd[Thh:mm[:ss[+/-offset/timezone-id]]]).</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-result-linked-user">Linked user</h6>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/UserVO.html">org.cyclos.model.users.users.UserVO</a>;</p>
</li>
<li>
<p><strong>String</strong>: the principal to locate users (login name, account number, e-mail, etc, according to the configuration);</p>
</li>
<li>
<p><strong>Number</strong>: user identifier (same as in the database, not the masked id sent to clients).</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-result-linked-transaction">Linked transaction</h6>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transaction.html">org.cyclos.entities.banking.Transaction</a>;</p>
</li>
<li>
<p>*<a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/TransactionVO.html">org.cyclos.model.banking.transactions.TransactionVO</a>;</p>
</li>
<li>
<p><strong>String</strong>: the transaction number;</p>
</li>
<li>
<p><strong>Number</strong>: transaction identifier (same as in the database, not the masked id sent to clients).</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-result-linked-transfer">Linked transfer</h6>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transfers/TransferVO.html">org.cyclos.model.banking.transfers.TransferVO</a>;</p>
</li>
<li>
<p><strong>String</strong>: The transaction number;</p>
</li>
<li>
<p><strong>Number</strong>: The transfer identifier (same as in the database, not the masked id sent to clients).</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-result-linked-record">Linked record</h6>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Record.html">org.cyclos.entities.users.Record</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/records/RecordVO.html">org.cyclos.model.users.records.RecordVO</a>;</p>
</li>
<li>
<p><strong>Number</strong>: The record identifier (same as in the database, not the masked id sent to clients).</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-result-linked-marketplace">Linked advertisement</h6>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/marketplace/BasicAd.html">org.cyclos.entities.marketplace.BasicAd</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/marketplace/advertisements/BasicAdVO.html">org.cyclos.model.marketplace.advertisements.BasicAdVO</a>;</p>
</li>
<li>
<p><strong>*Number</strong>: The advertisement identifier (same as in the database, not the masked id sent to clients).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-load-field-values-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-load-field-values-example-user-group">Dynamic selection on user profile field: values depending on the user group</h6>
<div class="paragraph">
<p>This example applies to a custom user profile field, and returns distinct values according to the user group.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.system.fields.DynamicFieldValueVO</span>

<span class="kt">def</span> <span class="n">values</span> <span class="o">=</span> <span class="o">[]</span>
<span class="c1">// Common values</span>
<span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"common1"</span><span class="o">,</span> <span class="s2">"Common value 1"</span><span class="o">)</span>
<span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"common2"</span><span class="o">,</span> <span class="s2">"Common value 2"</span><span class="o">)</span>
<span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"common3"</span><span class="o">,</span> <span class="s2">"Common value 3"</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">internalName</span> <span class="o">==</span> <span class="s2">"business"</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Values only available for businesses</span>
    <span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"business1"</span><span class="o">,</span> <span class="s2">"Business value 1"</span><span class="o">)</span>
    <span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"business2"</span><span class="o">,</span> <span class="s2">"Business value 2"</span><span class="o">)</span>
    <span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"business3"</span><span class="o">,</span> <span class="s2">"Business value 3"</span><span class="o">)</span>
<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">internalName</span> <span class="o">==</span> <span class="s2">"consumer"</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Values only available for consumers</span>
    <span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"consumer1"</span><span class="o">,</span> <span class="s2">"Consumer value 1"</span><span class="o">)</span>
    <span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"consumer2"</span><span class="o">,</span> <span class="s2">"Consumer value 2"</span><span class="o">)</span>
    <span class="n">values</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"consumer3"</span><span class="o">,</span> <span class="s2">"Consumer value 3"</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">return</span> <span class="n">values</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is the script returning all available values, to be used for search filters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.system.fields.DynamicFieldValueVO</span>

<span class="k">return</span> <span class="o">[</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"common1"</span><span class="o">,</span> <span class="s2">"Common value 1"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"common2"</span><span class="o">,</span> <span class="s2">"Common value 2"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"common3"</span><span class="o">,</span> <span class="s2">"Common value 3"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"business1"</span><span class="o">,</span> <span class="s2">"Business value 1"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"business2"</span><span class="o">,</span> <span class="s2">"Business value 2"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"business3"</span><span class="o">,</span> <span class="s2">"Business value 3"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"consumer1"</span><span class="o">,</span> <span class="s2">"Consumer value 1"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"consumer2"</span><span class="o">,</span> <span class="s2">"Consumer value 2"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="s2">"consumer3"</span><span class="o">,</span> <span class="s2">"Consumer value 3"</span><span class="o">)</span>
<span class="o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-example-active-brokers">Linked user: active brokers</h6>
<div class="paragraph">
<p>This example applies to a custom field of type linked entity - user.
It returns all active brokers in the system, so the user can select one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.access.Role</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserStatus</span>

<span class="kt">def</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserQuery</span><span class="o">()</span>
<span class="n">q</span><span class="o">.</span><span class="na">setUnlimited</span><span class="o">()</span>
<span class="n">q</span><span class="o">.</span><span class="na">ignoreProfileFieldsInList</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">q</span><span class="o">.</span><span class="na">roles</span> <span class="o">=</span> <span class="o">[</span><span class="n">Role</span><span class="o">.</span><span class="na">BROKER</span><span class="o">]</span>
<span class="n">q</span><span class="o">.</span><span class="na">userStatus</span> <span class="o">=</span> <span class="o">[</span>
    <span class="n">UserStatus</span><span class="o">.</span><span class="na">ACTIVE</span><span class="o">,</span>
    <span class="n">UserStatus</span><span class="o">.</span><span class="na">BLOCKED</span>
<span class="o">]</span>
<span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">q</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-load-field-values-example-list-open-loans">Linked transaction on transaction field: list open loans</h6>
<div class="paragraph">
<p>This example lists all transactions of a specific payment type (loan grant) to the user performing the payment, filtering by a specific transfer status (open). It could be used on a payment from user to system to repay the loan, which would also need additional processing from an extension point script to mark the loan as repaid (script not included in this example).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.AccountType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.AccountHistoryQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.AccountVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transferstatus.TransferStatusVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transfertypes.TransferTypeVO</span>

<span class="c1">// Find the account</span>
<span class="kt">def</span> <span class="n">accountType</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">AccountType</span><span class="o">,</span> <span class="s1">'user'</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">fromOwner</span><span class="o">,</span> <span class="n">accountType</span><span class="o">)</span>

<span class="c1">// The account history has transfers. We need the transactions.</span>
<span class="kt">def</span> <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccountHistoryQuery</span><span class="o">()</span>
<span class="n">q</span><span class="o">.</span><span class="na">setUnlimited</span><span class="o">()</span>
<span class="n">q</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccountVO</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
<span class="n">q</span><span class="o">.</span><span class="na">transferTypes</span> <span class="o">=</span> <span class="o">[</span>
    <span class="k">new</span> <span class="nf">TransferTypeVO</span><span class="o">(</span><span class="nl">internalName:</span> <span class="s1">'debit.loan'</span><span class="o">)</span>
<span class="o">]</span>
<span class="n">q</span><span class="o">.</span><span class="na">statuses</span> <span class="o">=</span> <span class="o">[</span>
    <span class="k">new</span> <span class="nf">TransferStatusVO</span><span class="o">(</span><span class="nl">internalName:</span> <span class="s1">'loan.open'</span><span class="o">)</span>
<span class="o">]</span>
<span class="kt">def</span> <span class="n">transfers</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">searchAccountHistory</span><span class="o">(</span><span class="n">q</span><span class="o">).</span><span class="na">pageItems</span>

<span class="c1">// Return the transaction ids</span>
<span class="k">return</span> <span class="n">transfers</span><span class="o">.</span><span class="na">collect</span> <span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">transactionId</span><span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-account-number">4.4.4. Account number generation</h4>
<div class="paragraph">
<p>This kind of script is responsible for generating account numbers, in case more control than the default (random generation) is needed.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-account-number-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/AccountType.html">org.cyclos.entities.banking.AccountType</a>;</p>
</li>
<li>
<p><code>owner</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/accounts/InternalAccountOwner.html">org.cyclos.model.banking.accounts.InternalAccountOwner</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-account-number-result">Script result</h5>
<div class="paragraph">
<p>The script should return a string, which should match the account number mask set in the configuration (if any). If the string returns null or an empty string, no number is assigned to the account.</p>
</div>
<div class="paragraph">
<p>The script doesn&#8217;t need to check if the account number already exists. This is done internally. If the number is already used, the script is called again (up to 10 times, then, an error is raised).</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-account-number-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-account-number-example-prefix-by-group">Controlling the prefix according to the currency and user group</h6>
<div class="paragraph">
<p>In this example, the mask <code>##-#######</code> is expected for the account number. The prefix is composed of 2 digits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first one is 0 if the currency is unit, or 1 otherwise.</p>
</li>
<li>
<p>The second one is 0 for system, 1 for business, 2 for consumers of 9 otherwise.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The rest are 7 random digits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="c1">// Either unit or euro</span>
<span class="n">String</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">currency</span><span class="o">.</span><span class="na">internalName</span> <span class="o">==</span> <span class="s1">'internal_units'</span> <span class="o">?</span> <span class="s1">'0'</span> <span class="o">:</span> <span class="s1">'1'</span>

<span class="k">if</span> <span class="o">(</span><span class="n">owner</span> <span class="k">instanceof</span> <span class="n">User</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">owner</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">internalName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="s1">'business'</span><span class="o">:</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="s1">'1'</span>
            <span class="k">break</span>
        <span class="k">case</span> <span class="s1">'consumers'</span><span class="o">:</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="s1">'2'</span>
            <span class="k">break</span>
        <span class="nl">default:</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="s1">'9'</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">prefix</span> <span class="o">+=</span> <span class="s1">'0'</span>
<span class="o">}</span>

<span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">"-"</span> <span class="o">+</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">randomNumeric</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-account-fee">4.4.5. Account fee calculation</h4>
<div class="paragraph">
<p>These scripts are used to calculate the amount of an account fee over a specific user. An account fee is charged periodically or manually over many accounts, according to the <code>Charged account fees</code> setting in member products.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-account-fee-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fee</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/AccountFee.html">org.cyclos.entities.banking.AccountFee</a> being charged;</p>
</li>
<li>
<p><code>account</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/UserAccount.html">org.cyclos.entities.banking.UserAccount</a> being charged;</p>
</li>
<li>
<p><code>executionDate</code>: The expected fee charge date (of type <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Date.html">java.util.Date</a>). When scheduled, charges usually happen a bit after the exact expected date. For manual account fees, this will be the time the fee has started.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-account-fee-result">Script result</h5>
<div class="paragraph">
<p>The script should return a number, which will be rounded to the currency&#8217;s decimal digits. If null or zero is returned, the fee is not charged, and the user is skipped.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-account-fee-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-account-fee-example-user-rank">Charge a different amount according to the user rank</h6>
<div class="paragraph">
<p>This example allows choosing a distinct account fee amount based on a profile field of the paying user. It is assumed a custom field of type single selection with the internal name rank. It should have 3 possible values, with internal names 'bronze', <code>silver</code> and <code>gold</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// Depending on a user custom field, we'll pick the fee amount</span>
<span class="kt">def</span> <span class="n">amounts</span> <span class="o">=</span> <span class="o">[</span><span class="nl">bronze:</span> <span class="mi">10</span><span class="o">,</span> <span class="nl">silver:</span> <span class="mi">7</span><span class="o">,</span> <span class="nl">gold:</span> <span class="mi">5</span><span class="o">]</span>
<span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">owner</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">rank</span><span class="o">?.</span><span class="na">internalName</span> <span class="o">?:</span> <span class="s2">"bronze"</span>
<span class="k">return</span> <span class="n">amounts</span> <span class="o">[</span><span class="n">rank</span><span class="o">]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-transfer-fee">4.4.6. Transfer fee calculation</h4>
<div class="paragraph">
<p>These scripts are used to either calculate the amount or the full characteristics of a transfer fee (a fee triggered by another transfer).</p>
</div>
<div class="paragraph">
<p>Starting with Cyclos 4.16, the transfer fee details page has a field called 'Configuration mode', which can be set to either 'Form' or 'Script'.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Form</strong>: In this mode, all transfer fee characteristics are statically defined in the form. The only characteristic that can be defined by the script is the actual fee amount, when the 'Charge mode' field is set to 'Custom script'.</p>
</li>
<li>
<p><strong>Script</strong>: In this mode, the script defines who pays, who receives, the generated payment type and the amount of the fee.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="scripting-type-transfer-fee-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>previewParameters</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/PerformTransactionDTO.html">org.cyclos.model.banking.transactions.PerformTransactionDTO</a> for the payment being performed. It is only available on the payment preview. On actual processing, it is always null. However, this object is useful when the fee amount depends on a some data about the future transaction being performed, such as custom fields;</p>
</li>
<li>
<p><code>fee</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/TransferFee.html">org.cyclos.entities.banking.TransferFee</a> being charged;</p>
</li>
<li>
<p><code>transfer</code>: The original <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a> which triggered the fee.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-transfer-fee-result">Script result</h5>
<div class="paragraph">
<p>The script result is interpreted according to the transfer fee&#8217;s configuration mode:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Form</strong>: The script should return a number, which will be rounded to the currency&#8217;s decimal digits. If null or zero is returned, the fee is not charged.</p>
</li>
<li>
<p><strong>Script</strong>: The script should return an instance of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/TransferFeeRecipe.html">org.cyclos.impl.banking.TransferFeeRecipe</a>, or compatible object or Map. The script should set the following fields:</p>
<div class="ulist">
<ul>
<li>
<p><code>amount</code>: The amount to be charged, as a number. When null or not positive, the fee is not charged;</p>
</li>
<li>
<p><code>from</code>: The account owner that pays the fee. Can be one of:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/accounts/SystemAccountOwner.html">org.cyclos.model.banking.accounts.SystemAccountOwner.instance()</a> for system accounts;</p>
</li>
<li>
<p>The string <code>system</code> for system accounts;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> for a user (using an entity);</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/UserVO.html">org.cyclos.model.users.users.UserVO</a> for a user (using a model VO);</p>
</li>
<li>
<p>A string representing a user identification method (username, account number, etc.).</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>to</code>: The account owner that receives the fee. Same accepted values as <code>from</code>;</p>
</li>
<li>
<p><code>type</code>: The generated transfer type. It must have been created as a generated transfer type, not payment transfer type. When represented as string, is the composite internal name, in the form <code>accountTypeInternalName.transferTypeInternalName</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-transfer-fee-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-transfer-fee-example-profile-field">Charging a fee according to a user profile field</h6>
<div class="paragraph">
<p>This example allows choosing a distinct fee amount based on a profile field of the paying user. The fee must have been configured using the form. It is assumed a custom field of type single selection with the internal name <code>rank</code>. It should have 3 possible values, with internal names <code>bronze</code>, <code>silver</code> and <code>gold</code>. The script then chooses a different percentage according to the user rank.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="k">if</span> <span class="o">(</span><span class="n">transfer</span><span class="o">.</span><span class="na">fromSystem</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Only charge users</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="o">}</span>

<span class="c1">// Depending on a user custom field, we'll pick the fee amount</span>
<span class="kt">def</span> <span class="n">percentages</span> <span class="o">=</span> <span class="o">[</span><span class="nl">bronze:</span> <span class="mf">0.07</span><span class="o">,</span> <span class="nl">silver:</span> <span class="mf">0.05</span><span class="o">,</span> <span class="nl">gold:</span> <span class="mf">0.02</span><span class="o">]</span>
<span class="kt">def</span> <span class="n">from</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">transfer</span><span class="o">.</span><span class="na">fromOwner</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="na">rank</span><span class="o">?.</span><span class="na">internalName</span> <span class="o">?:</span> <span class="s2">"bronze"</span>
<span class="kt">def</span> <span class="n">percentage</span> <span class="o">=</span> <span class="n">percentages</span><span class="o">[</span><span class="n">rank</span><span class="o">]</span>
<span class="k">return</span> <span class="n">transfer</span><span class="o">.</span><span class="na">amount</span> <span class="o">*</span> <span class="n">percentage</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-transfer-fee-example-payment-field">Charging a fee according to a payment custom field</h6>
<div class="paragraph">
<p>This example is similar to the above, but based on a transaction custom field in the payment itself. The main difference is the source for custom field values now depends on whether we&#8217;re calculating the fee during a payment preview (used to show the user the paid fees before the transfer is actually processed) or for the actual transfer processing. That is because the <code>transfer.transaction</code> is not available during preview. The fee must have been configured using the form.</p>
</div>
<div class="paragraph">
<p>However, to allow retrieving the custom fields during preview, there is an extra bound variable, called <code>previewParameters</code> (not available during transfer processing). Similar to the previous example, but this one assumes the single selection field has internal name <code>category</code>, and the possible values have internal names <code>loan</code>, <code>repayment</code> and <code>buying</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">percentages</span> <span class="o">=</span> <span class="o">[</span><span class="nl">loan:</span> <span class="mf">0.05</span><span class="o">,</span> <span class="nl">repayment:</span> <span class="mf">0.01</span><span class="o">,</span> <span class="nl">buying:</span> <span class="mf">0.02</span><span class="o">]</span>
<span class="kt">def</span> <span class="n">source</span> <span class="o">=</span> <span class="n">previewParameters</span> <span class="o">?:</span> <span class="n">transfer</span><span class="o">.</span><span class="na">transaction</span>
<span class="kt">def</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">source</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">category</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">category</span><span class="o">?.</span><span class="na">internalName</span> <span class="o">?:</span> <span class="s2">"buying"</span>
<span class="kt">def</span> <span class="n">percentage</span> <span class="o">=</span> <span class="n">percentages</span><span class="o">[</span><span class="n">category</span><span class="o">]</span>
<span class="k">return</span> <span class="n">transfer</span><span class="o">.</span><span class="na">amount</span> <span class="o">*</span> <span class="n">percentage</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-transfer-fee-example-distribute">Distributing a fee exactly to different accounts</h6>
<div class="paragraph">
<p>Some systems charge a fee from users (be it a transfer fee or account fee) which is itself distributed amongst different accounts. For example, a 5% transaction fee is charged from users, and that fee amount is distributed like 12% to account A, 27% to account B and 61% to account C. So, the transaction fee transfer type itself has other 3 fees.</p>
</div>
<div class="paragraph">
<p>The problem in making them all percentage is that each fee charge rounds the charged amount (generally to 2 decimal places, according to the currency), and that may cause the total distributed amount to be different from the total fee amount.</p>
</div>
<div class="paragraph">
<p>A solution for this problem is to make one of the fees calculated by script, so it sums up what each other fee has charged, and charges the remaining. Generally, the fee with the largest charge percentage would then use this script, while all other fees will be configured as percentages.</p>
</div>
<div class="paragraph">
<p>The fee must have been configured using the form.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.Transfer</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transferfees.TransferFeeChargeMode</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.BigDecimalHelper</span>

<span class="n">Transfer</span> <span class="n">transfer</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">transfer</span>
<span class="n">BigDecimal</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">.</span><span class="na">amount</span>

<span class="c1">// Sum what the other fees will charge</span>
<span class="kt">int</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">.</span><span class="na">currency</span><span class="o">.</span><span class="na">precision</span>
<span class="n">BigDecimal</span> <span class="n">others</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">def</span> <span class="n">fee</span> <span class="k">in</span> <span class="n">transfer</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">transferFees</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fee</span><span class="o">.</span><span class="na">chargeMode</span> <span class="o">==</span> <span class="n">TransferFeeChargeMode</span><span class="o">.</span><span class="na">PERCENTAGE</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">others</span> <span class="o">+=</span> <span class="n">BigDecimalHelper</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">amount</span> <span class="o">*</span> <span class="n">fee</span><span class="o">.</span><span class="na">amount</span><span class="o">,</span> <span class="n">scale</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Charge the rest</span>
<span class="k">return</span> <span class="n">BigDecimalHelper</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">amount</span> <span class="o">-</span> <span class="n">others</span><span class="o">,</span> <span class="n">scale</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-transfer-fee-example-to-broker-or-system">Pay a transfer fee, either to a broker or system</h6>
<div class="paragraph">
<p>In this example, the user will pay a 1% transfer fee either to his main broker, if the user has a broker, or otherwise will pay to a system account.</p>
</div>
<div class="paragraph">
<p>This cannot be achieved when the fee is configured by form. Instead, it must be configured using script, because in the example, both the receiver and the generated type are dynamic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.Transfer</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>

<span class="n">Transfer</span> <span class="n">transfer</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">transfer</span>
<span class="n">BigDecimal</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">.</span><span class="na">amount</span>

<span class="kt">def</span> <span class="n">fromUser</span> <span class="o">=</span> <span class="n">transfer</span><span class="o">.</span><span class="na">fromOwner</span> <span class="k">as</span> <span class="n">User</span>
<span class="k">return</span> <span class="o">[</span>
    <span class="nl">amount:</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.01</span><span class="o">,</span>
    <span class="nl">from:</span> <span class="n">fromUser</span><span class="o">,</span>
    <span class="nl">to:</span> <span class="n">fromUser</span><span class="o">.</span><span class="na">mainBroker</span> <span class="o">?:</span> <span class="s1">'system'</span><span class="o">,</span>
    <span class="nl">type:</span> <span class="n">fromUser</span><span class="o">.</span><span class="na">mainBroker</span> <span class="o">?</span> <span class="s1">'units.feeToBroker'</span> <span class="o">:</span> <span class="s1">'units.feeToSystem'</span>
<span class="o">]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-transfer-status">4.4.7. Transfer status handling</h4>
<div class="paragraph">
<p>These scripts are used to determine to which status(es) a transfer may be set after the current status. By default, if no script is used, the possible next statuses (as configured in the transfer status details page) will be available.</p>
</div>
<div class="paragraph">
<p>Using a script, however, allows using finer-grained controls.
For example, a specific status could be allowed only by specific administrators, or only under special conditions (for example, checking the account balance or any other condition).</p>
</div>
<div class="sect4">
<h5 id="scripting-type-transfer-status-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>transfer</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a>;</p>
</li>
<li>
<p><code>flow</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/TransferStatusFlow.html">org.cyclos.entities.banking.TransferStatusFlow</a> of the affected status;</p>
</li>
<li>
<p><code>status</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/TransferStatus.html">org.cyclos.entities.banking.TransferStatus</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-transfer-status-result">Script result</h5>
<div class="paragraph">
<p>The script must return one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single / collection / array / iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/TransferStatus.html">org.cyclos.entities.banking.TransferStatus</a>: The possible next statuses;</p>
</li>
<li>
<p>A single / collection / array / iterator of strings: The internal names of the possible next statuses;</p>
</li>
<li>
<p>A single / collection / array / iterator of numbers: The internal id (same as the database id, not the masked id returned to clients) of the possible next statuses;</p>
</li>
<li>
<p>Null: Assumes the default behavior - the possible next configured in the status are used.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-transfer-status-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-transfer-status-example-admin">Restricting a specific status for administrators</h6>
<div class="paragraph">
<p>In this example, any user can change a transfer status in a given flow.
However, only administrators can set a transfer to the status with internal name <code>finished</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// Only administrators can set the status to finished</span>
<span class="k">return</span> <span class="n">status</span><span class="o">.</span><span class="na">possibleNext</span><span class="o">.</span><span class="na">findAll</span> <span class="o">{</span> <span class="n">st</span> <span class="o">-&gt;</span>
    <span class="n">sessionData</span><span class="o">.</span><span class="na">admin</span> <span class="o">||</span> <span class="n">st</span><span class="o">.</span><span class="na">internalName</span> <span class="o">!=</span> <span class="s2">"finished"</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-session">4.4.8. Session handling</h4>
<div class="paragraph">
<p>These scripts can be used to manage user sessions (logins) externally.
It can only be set in the network default configuration, as the custom session handling script. There are distinct code blocks in this script type, each implementing a different aspect.</p>
</div>
<div class="paragraph">
<p>On any of these functions, returning null or having an empty code block will result in the default session management taking place. This way, it is possible to implement a custom handling only on special cases. For example, a custom session mechanism might be used only for privileged administrators, whose session tokens comply with a specific format.</p>
</div>
<div class="paragraph">
<p>For reference, Cyclos sessions use 32-character alphanumeric strings, with no punctuation. So, for example, if session tokens generated for those administrators have a different format, say, a <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a>, the script can differentiate which sessions tokens correspond to normal sessions (and return null on the Logout and Resolve functions for those token format) and handle only those specific sessions. Also, in such a case, the login method could check the user group being logged in, and either perform the login on the underlying system (returning the generated session token) or return null for regular users.</p>
</div>
<div class="paragraph">
<p><strong>Caution:</strong> Errors on any of these functions, specially the first three, may cause users not being able to login or access the system. A good security measure while developing such scripts is to handle a specific (for example, if the login name is 'admin') with the default session resolution, and withdraw this case after the rest of the script is ready. If such a situation occurs, a possible workaround is to login in global mode, then disable and lock the custom session handling in the configuration from which the network configuration inherits. Then edit the script and unlock it again in global mode.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-session-login">Login</h5>
<div class="paragraph">
<p>This script function is called when a session is being created.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-session-login-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>The login function has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/BasicUser.html">org.cyclos.entities.users.BasicUser</a> attempting to login;</p>
</li>
<li>
<p><code>principal</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/UserPrincipal.html">org.cyclos.entities.users.UserPrincipal</a> the user used to authenticate. A principal may be the login name, email, mobile phone number, etc.;</p>
</li>
<li>
<p><code>sessionProperties</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/SessionProperties.html">org.cyclos.entities.access.SessionProperties</a> for the session being created;</p>
</li>
<li>
<p><code>trusted</code>: A boolean value indicating whether the session will be a trusted one, i.e, the user is performing a login from a trusted device. Trusted sessions may be configured to skip the confirmation password;</p>
</li>
<li>
<p><code>channel</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/Channel.html">org.cyclos.entities.access.Channel</a> in which the user is logging-in;</p>
</li>
<li>
<p><code>remoteAddress</code>: The remote IP address (string) the client is used to authenticate;</p>
</li>
<li>
<p><code>sessionTimeout</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/utils/TimeInterval.html">org.cyclos.entities.utils.TimeInterval</a> indicating the time the session should be valid.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-session-login-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p><strong>String</strong>: A session token. All other session properties will be handled as default;</p>
</li>
<li>
<p><strong>Null</strong>: When returning null, the default session handling will be used for this user.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-session-logout">Logout</h5>
<div class="paragraph">
<p>This script function is called when a session is terminated.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-session-logout-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>The logout function has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sessionToken</code>: The session token for the session being invalidated;</p>
</li>
<li>
<p><code>remoteAddress</code>: The remote IP address (string) over which the session is being invalidated.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-session-logout-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p><strong>True</strong>: If the script returns true, Cyclos considers the logout handled by the script;</p>
</li>
<li>
<p><strong>False</strong> or <strong>Null</strong>: In this case, the default session handling will be used for invalidating this session.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-session-resolve">Resolve</h5>
<div class="paragraph">
<p>This script function is called on every request, to resolve which user belongs to a session token.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-session-resolve-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>The resolve function has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sessionToken</code>: The input session token;</p>
</li>
<li>
<p><code>remoteAddress</code>: The remote IP address (string) over which the session is being resolved.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-session-resolve-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/Session.html">org.cyclos.entities.access.Session</a> or compatible Map / object: The script can return a session with at least the property <code>user</code>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/BasicUser.html">org.cyclos.entities.users.BasicUser</a>: The script can return the logged-in user;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/users/LocateUserResult.html">org.cyclos.impl.users.LocateUserResult</a>: Result of using the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/users/UserLocatorHandler.html">org.cyclos.impl.users.UserLocatorHandler</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-session-set-properties">Set properties</h5>
<div class="paragraph">
<p>This script function is called when specific session properties are modified. Most likely, this will be called when login confirmation is enabled with a trusted device. In that case, the previously untrusted session will be considered trusted.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-session-set-properties-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>The set properties function has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sessionToken</code>: The input session token;</p>
</li>
<li>
<p><code>sessionProperties</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/SessionProperties.html">org.cyclos.entities.access.SessionProperties</a> with the session properties to be stored.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-session-set-properties-result">Script result</h6>
<div class="paragraph">
<p>The set properties function result is ignored.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-session-search">Search connected users</h5>
<div class="paragraph">
<p>This script is called when an administrator searches for connected users, as well as on the administrator home page, as the number of connected users is shown.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-session-search-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>The search connected users function has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>query</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/ConnectedUserQuery.html">org.cyclos.model.users.users.ConnectedUserQuery</a> with search parameters.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-session-search-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p>A <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/utils/Page.html">org.cyclos.utils.Page</a> of either <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/Session.html">org.cyclos.entities.access.Session</a> or compatible Map / objects, with the results for the requested page;</p>
</li>
<li>
<p><strong>Null</strong>: The default session search is performed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-session-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-session-example-storage">Storing sessions on Cyclos script storages</h6>
<div class="paragraph">
<p>This example stores user sessions in the <a href="#scripting-storage">scripting storage</a>. It is not a realistic example, as Cyclos itself is used to store sessions, but it does demonstrate the usage of a session handling script. Here are the sources for each of the 5 code boxes:</p>
</div>
<div class="paragraph">
<p>Function to perform the login:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.apache.commons.lang3.RandomStringUtils</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.access.Channel</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.access.SessionProperties</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserPrincipal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.utils.TimeInterval</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptStorageHandler</span>

<span class="n">ScriptStorageHandler</span> <span class="n">scriptStorageHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptStorageHandler</span>
<span class="n">UserPrincipal</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">principal</span>
<span class="n">TimeInterval</span> <span class="n">sessionTimeout</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionTimeout</span><span class="o">;</span>
<span class="n">String</span> <span class="n">remoteAddress</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">remoteAddress</span>
<span class="n">SessionProperties</span> <span class="n">sessionProperties</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionProperties</span>
<span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">channel</span>

<span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">RandomStringUtils</span><span class="o">.</span><span class="na">randomAlphanumeric</span><span class="o">(</span><span class="mi">64</span><span class="o">)</span>
<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">sessionTimeout</span><span class="o">.</span><span class="na">milliseconds</span> <span class="o">/</span> <span class="mi">1000</span>
<span class="kt">def</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">scriptStorageHandler</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s2">"session_${token}"</span><span class="o">,</span> <span class="n">timeout</span><span class="o">)</span>
<span class="n">storage</span><span class="o">.</span><span class="na">principal</span> <span class="o">=</span> <span class="n">principal</span>
<span class="n">storage</span><span class="o">.</span><span class="na">remoteAddress</span> <span class="o">=</span> <span class="n">remoteAddress</span>
<span class="n">storage</span><span class="o">.</span><span class="na">timeout</span> <span class="o">=</span> <span class="n">sessionTimeout</span>
<span class="n">storage</span><span class="o">.</span><span class="na">sessionProperties</span> <span class="o">=</span> <span class="n">sessionProperties</span>
<span class="n">storage</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">channel</span>

<span class="k">return</span> <span class="n">token</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Function to perform the logout:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptStorageHandler</span>

<span class="n">ScriptStorageHandler</span> <span class="n">scriptStorageHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptStorageHandler</span>
<span class="n">String</span> <span class="n">sessionToken</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionToken</span>

<span class="k">return</span> <span class="n">scriptStorageHandler</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s2">"session_${sessionToken}"</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Function to resolve a session given a token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.access.Session</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptStorageHandler</span>

<span class="n">ScriptStorageHandler</span> <span class="n">scriptStorageHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptStorageHandler</span>
<span class="n">String</span> <span class="n">sessionToken</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionToken</span>

<span class="kt">def</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">scriptStorageHandler</span><span class="o">.</span><span class="na">getIfValid</span><span class="o">(</span><span class="s2">"session_${sessionToken}"</span><span class="o">)</span>
<span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="kc">null</span>
<span class="k">if</span> <span class="o">(</span><span class="n">storage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">session</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Session</span><span class="o">()</span>
    <span class="n">session</span><span class="o">.</span><span class="na">initFrom</span><span class="o">(</span><span class="n">storage</span><span class="o">.</span><span class="na">principal</span><span class="o">)</span>
    <span class="n">session</span><span class="o">.</span><span class="na">sessionToken</span> <span class="o">=</span> <span class="n">sessionToken</span>
    <span class="n">session</span><span class="o">.</span><span class="na">properties</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="na">sessionProperties</span>
    <span class="n">session</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="na">channel</span>
    <span class="n">session</span><span class="o">.</span><span class="na">remoteAddress</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="na">remoteAddress</span>
    <span class="n">session</span><span class="o">.</span><span class="na">sessionTimeout</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="na">timeout</span>
<span class="o">}</span>
<span class="k">return</span> <span class="n">session</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Function to set the session properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.apache.commons.lang3.RandomStringUtils</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.access.SessionProperties</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.utils.TimeInterval</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptStorageHandler</span>

<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.BasicUser</span>
<span class="n">ScriptStorageHandler</span> <span class="n">scriptStorageHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptStorageHandler</span>
<span class="n">String</span> <span class="n">sessionToken</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionToken</span>
<span class="n">SessionProperties</span> <span class="n">sessionProperties</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionProperties</span>

<span class="kt">def</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">scriptStorageHandler</span><span class="o">.</span><span class="na">getIfValid</span><span class="o">(</span><span class="s2">"session_${sessionToken}"</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">storage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">storage</span><span class="o">.</span><span class="na">sessionProperties</span> <span class="o">=</span> <span class="n">sessionProperties</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Function to search for connected users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.system.QScriptStorage</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.system.ScriptStorage</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserPrincipal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.persistence.EntityManagerHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.ConnectedUserQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.server.utils.JacksonParameterStorage</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.PageImpl</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span>

<span class="n">ConnectedUserQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">query</span>
<span class="n">EntityManagerHandler</span> <span class="n">entityManagerHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">entityManagerHandler</span>
<span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">objectMapper</span>
<span class="n">QScriptStorage</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">QScriptStorage</span><span class="o">.</span><span class="na">scriptStorage</span>

<span class="c1">// First we get the persisted script storages which start with 'session_'</span>
<span class="n">PageImpl</span> <span class="n">page</span> <span class="o">=</span> <span class="n">entityManagerHandler</span>
        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">ss</span><span class="o">)</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">ss</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="s2">"session\\_${StringHelper.repeat('_', 64)}"</span><span class="o">,</span> <span class="s1">'\\'</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)),</span>
        <span class="n">ss</span><span class="o">.</span><span class="na">expirationDate</span><span class="o">.</span><span class="na">after</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">()))</span>
        <span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">ss</span><span class="o">.</span><span class="na">creationDate</span><span class="o">.</span><span class="na">asc</span><span class="o">())</span>
        <span class="o">.</span><span class="na">page</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">ss</span><span class="o">)</span>

<span class="c1">// Each one is parsed as JSON and converted to the expected format</span>
<span class="n">page</span><span class="o">.</span><span class="na">pageItems</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">pageItems</span><span class="o">.</span><span class="na">collect</span> <span class="o">{</span> <span class="n">ScriptStorage</span> <span class="n">it</span> <span class="o">-&gt;</span>
    <span class="kt">def</span> <span class="n">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JacksonParameterStorage</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">,</span> <span class="n">it</span><span class="o">.</span><span class="na">content</span><span class="o">)</span>
    <span class="n">UserPrincipal</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="na">principal</span>
    <span class="k">return</span> <span class="o">[</span>
        <span class="nl">sessionToken:</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">removeStart</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="s2">"session_"</span><span class="o">),</span>
        <span class="nl">user:</span> <span class="n">principal</span><span class="o">.</span><span class="na">basicUser</span><span class="o">,</span>
        <span class="nl">creationDate:</span> <span class="n">it</span><span class="o">.</span><span class="na">creationDate</span><span class="o">,</span>
        <span class="nl">channel:</span> <span class="n">storage</span><span class="o">.</span><span class="na">channel</span><span class="o">,</span>
        <span class="nl">remoteAddress:</span> <span class="n">storage</span><span class="o">.</span><span class="na">remoteAddress</span>
    <span class="o">]</span>
<span class="o">}</span>
<span class="k">return</span> <span class="n">page</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-password">4.4.9. Password handling</h4>
<div class="paragraph">
<p>These scripts are used to check passwords. In order to use them, the password type&#8217;s password mode needs to be <code>Script</code>.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-password-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/BasicUser.html">org.cyclos.entities.users.BasicUser</a> whose password is being checked;</p>
</li>
<li>
<p><code>passwordType</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/PasswordType.html">org.cyclos.entities.access.PasswordType</a> of the current password;</p>
</li>
<li>
<p><code>password</code>: The password value being checked, as String.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-password-result">Script result</h5>
<div class="paragraph">
<p>The script should return a boolean, indicating whether the password is ok or not.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-password-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-password-example-parameters">Matching passwords to the script parameters</h6>
<div class="paragraph">
<p>This is a very simple example, which checks for passwords according to the script parameters. The parameters can be set either in the script itself or in the password type. This example is very insecure, and shouldn&#8217;t be used in production. Normally, scripts to check passwords would connect to third party applications, but this is just a very basic example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// Just read the password value from the script parameters</span>
<span class="k">return</span> <span class="n">scriptParameters</span><span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="na">username</span><span class="o">]</span> <span class="o">==</span> <span class="n">password</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-extension-point">4.4.10. Extension points</h4>
<div class="paragraph">
<p>These scripts are used on extension points (user, user record, transfer, &#8230;&#8203;), and are attached to specific events (create, update, remove, charge back, &#8230;&#8203;). The extension point scripts have 2 functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>The data has already been validated, but not saved yet</strong>. In this function, we know that the data entered by users is valid, but the main event has not been saved yet;</p>
</li>
<li>
<p><strong>The data has been saved, but not committed to database yet</strong>. In this function, the main event has been saved. For example, when registering a user, the user will be saved (and has an assigned <code>id</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here are some example scenarios for performing custom logic, or integrating Cyclos with external systems using extension points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Custom credit limit. When a user is performing a payment, an extension point of type transaction could be used, in the function invoked after validation, to check the current balance. If the balance is not enough for the payment and the user has credit limit, a payment from a system account could be done automatically to the user, completing the amount for the payment;</p>
</li>
<li>
<p>A <a href="http://en.wikipedia.org/wiki/X/Open_XA">XA transaction</a> could be done with an external system by creating data in the external database in the function which runs after validating, then preparing the commit in the function after the data is saved, and finally registering both a commit and a rollback listener (see the <code>scriptHelper</code> in <a href="#scripting-bindings">default bindings</a>) to either commit or rollback the prepared transaction;</p>
</li>
<li>
<p>A simple notification of performed payments could be implemented by registering a commit listener (see the <code>scriptHelper</code> in <a href="#scripting-bindings">default bindings</a>) to implement the notification;</p>
</li>
<li>
<p>The profile information of a user needs to be mirrored in an external system. In this case, a user extension point, with the create / update events, can be used to send this information. Additional information on addresses and phones can use the same mechanism (they are different extension points);</p>
</li>
<li>
<p>There could be payment custom fields which are not filled-in by users when performing payments, but by extension points of type transaction. Payment custom fields may be configured to not show up in the form, only automatically via extension points;</p>
</li>
<li>
<p>An extension point on a new Cyclos advertisement could publish the advertisement as well in a third party system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are just some examples. There are many possible uses for the extension points.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-bindings">Additional bindings</h5>
<div class="paragraph">
<p>All extension points have the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>extensionPoint</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/ExtensionPoint.html">org.cyclos.entities.system.ExtensionPoint</a> instance being executed;</p>
</li>
<li>
<p><code>event</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/extensionpoints/ExtensionPointEvent.html">org.cyclos.model.system.extensionpoints.ExtensionPointEvent</a> being executed;</p>
</li>
<li>
<p><code>context</code>: A <code>Map&lt;String, Object&gt;`</code> which can be used to store shared attributes between different extension points or extension point functions. Any value added to this map will be visible in the next function or extension point.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following types of extension points exist:</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-user">User extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on users, including administrators, brokers and regular users.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> being affected.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Create</strong>: a user is being registered. <strong>IMPORTANT</strong>: When e-mail validation is enabled, the user will be pending until confirming the e-mail. If you have e-mail confirmation enabled, this event might not be what you need, but <code>activate</code> instead;</p>
</li>
<li>
<p><strong>Activate</strong>: a user is being activated for the first time. If enabling email validation, after the user confirms the email address, this event will be triggered. When email validation is not enabled, users will be initially active if the group&#8217;s <code>Initial status for users</code> field is active. Otherwise, only when the user is manually activated, this event will be triggered;</p>
</li>
<li>
<p><strong>Update</strong>: The user profile fields are being updated. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>currentCopy</code>: A detached copy of the user being edited, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Change group</strong>: The user&#8217;s group is being changed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>oldGroup</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Group.html">org.cyclos.entities.users.Group</a>;</p>
</li>
<li>
<p><code>newGroup</code>: The new <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Group.html">org.cyclos.entities.users.Group</a>;</p>
</li>
<li>
<p><code>comments</code>: The comments, as provided by the administrator when changing the group, as string.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Change status</strong>: The user status is being changed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>oldStatus</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/UserStatus.html">org.cyclos.model.users.users.UserStatus</a>;</p>
</li>
<li>
<p><code>newStatus</code>: The new <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/UserStatus.html">org.cyclos.model.users.users.UserStatus</a>;</p>
</li>
<li>
<p><code>comments</code>: The comments, as provided by the administrator when changing the status, as string.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-operator">Operator extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on operators.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_2">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>operator</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Operator.html">org.cyclos.entities.users.Operator</a> being affected.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_2">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Create</strong>: An operator is being registered;</p>
</li>
<li>
<p><strong>Update</strong>: The operator profile fields are being updated. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>currentCopy</code>: A detached copy of the operator being edited, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Operator.html">org.cyclos.entities.users.Operator</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Change group</strong>: The operator&#8217;s group is being changed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>oldGroup</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/OperatorGroup.html">org.cyclos.entities.users.OperatorGroup</a>;</p>
</li>
<li>
<p><code>newGroup</code>: The new <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/OperatorGroup.html">org.cyclos.entities.users.OperatorGroup</a>;</p>
</li>
<li>
<p><code>comments</code>: The comments, as provided by the owner or administrator when changing the group, as string.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Change status</strong>: The user status is being changed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>oldStatus</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/UserStatus.html">org.cyclos.model.users.users.UserStatus</a>;</p>
</li>
<li>
<p><code>newStatus</code>: The new <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/UserStatus.html">org.cyclos.model.users.users.UserStatus</a>;</p>
</li>
<li>
<p><code>comments</code>: The comments, as provided by the owner administrator when changing the status, as string.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-address">Address extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on user addresses.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_3">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>address</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/UserAddress.html">org.cyclos.entities.users.UserAddress</a> being affected.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_3">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Create</strong>: An address is being created;</p>
</li>
<li>
<p><strong>Update</strong>: An address is being updated. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>currentCopy</code>: A detached copy of the address being edited, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/UserAddress.html">org.cyclos.entities.users.UserAddress</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Delete</strong>: An address is being deleted.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-phone">Phone extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on user phones.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_4">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>phone</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Phone.html">org.cyclos.entities.users.Phone</a> being affected.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_4">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Create</strong>: A phone is being created;</p>
</li>
<li>
<p><strong>Update</strong>: A phone is being updated. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>currentCopy</code>: A detached copy of the phone being edited, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Phone.html">org.cyclos.entities.users.Phone</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Delete</strong>: A phone is being deleted.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-record">Record extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on records.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_5">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>record</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Record.html">org.cyclos.entities.users.Record</a> being affected.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_events_5">Events</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Create</strong>: A record is being created;</p>
</li>
<li>
<p><strong>Update</strong>: A record is being updated. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>currentCopy</code>: A detached copy of the phone being edited, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Record.html">org.cyclos.entities.users.Record</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Delete</strong>: A record is being deleted.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-marketplace">Advertisement extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on advertisements.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_6">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>ad</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/marketplace/BasicAd.html">org.cyclos.entities.marketplace.BasicAd</a> being affected.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_6">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Create</strong>: An advertisement is being created;</p>
</li>
<li>
<p><strong>Update</strong>: An advertisement is being updated. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>currentCopy</code>: A detached copy of the advertisement being edited, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/marketplace/BasicAd.html">org.cyclos.entities.marketplace.BasicAd</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Delete</strong>: An advertisement is being deleted.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-transaction">Transaction extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on transactions.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_7">Additional bindings</h6>
<div class="paragraph">
<p>The following additional bindings are available for both the <strong>Preview</strong>, <strong>Confirm</strong>, <strong>Send payment request</strong> and <strong>Create ticket</strong> events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>performTransaction</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/PerformTransactionDTO.html">org.cyclos.model.banking.transactions.PerformTransactionDTO</a>;</p>
</li>
<li>
<p><code>paymentType</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/PaymentTransferType.html">org.cyclos.entities.banking.PaymentTransferType</a>;</p>
</li>
<li>
<p><code>fromAccount</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Account.html">org.cyclos.entities.banking.Account</a> which will have funds withdrawn;</p>
</li>
<li>
<p><code>fromOwner</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/accounts/InternalAccountOwner.html">org.cyclos.model.banking.accounts.InternalAccountOwner</a> performing the payment;</p>
</li>
<li>
<p><code>fromOwnerResult</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/LocateAccountOwnerResult.html">org.cyclos.impl.banking.LocateAccountOwnerResult</a> which provides additional information for the owner performing the payment;</p>
</li>
<li>
<p><code>toAccount</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Account.html">org.cyclos.entities.banking.Account</a> which will have funds credited;</p>
</li>
<li>
<p><code>toOwner</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/accounts/AccountOwner.html">org.cyclos.model.banking.accounts.AccountOwner</a> receiving the payment;</p>
</li>
<li>
<p><code>toOwnerResult</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/LocateAccountOwnerResult.html">org.cyclos.impl.banking.LocateAccountOwnerResult</a> which provides additional information for the owner receiving the payment;</p>
</li>
<li>
<p><code>authorizationType</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/TransactionAuthorizationType.html">org.cyclos.model.banking.transactions.TransactionAuthorizationType</a> indicating if the performed payment will be pending authorization. When null, no authorization will be needed. For the <code>confirm</code> event will only be available in the script which runs after save;</p>
</li>
<li>
<p><code>authorizationLevel</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/AuthorizationLevel.html">org.cyclos.entities.banking.AuthorizationLevel</a> indicating if the performed payment will be pending authorization if <code>authorizationType</code> is <code>LEVEL</code>. For the <code>confirm</code> event, will only be available in the script which runs after save, not in the one that runs after data is validated.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_7">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Preview</strong>: The user is previewing the transaction. Note that, as there is nothing really being saved, both scripts will run at the same time, i.e., there&#8217;s no phase 'after validate' and 'after save'. <strong>WARNING</strong>: This event runs in a readonly transaction, and if the script writes anything to the database, it will fail. The error displayed on the application is a general one, like "There was an error while accessing the database". Make sure to never store anything in the database in a script that runs in this event. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>preview</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/TransactionPreviewVO.html">org.cyclos.model.banking.transactions.TransactionPreviewVO</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Confirm</strong>: The transaction has been confirmed, that is, was performed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>transaction</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transaction.html">org.cyclos.entities.banking.Transaction</a>, only available for the script which runs after save.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Change status</strong>: The transaction status is being changed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>transaction</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transaction.html">org.cyclos.entities.banking.Transaction</a>;</p>
</li>
<li>
<p><code>oldStatus</code>: The current status, as one of the previously mentioned classes, according to the transaction kind (<a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/ScheduledPaymentStatus.html">org.cyclos.model.banking.transactions.ScheduledPaymentStatus</a>, <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/RecurringPaymentStatus.html">org.cyclos.model.banking.transactions.RecurringPaymentStatus</a>, <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/PaymentRequestStatus.html">org.cyclos.model.banking.transactions.PaymentRequestStatus</a>, <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/TicketStatus.html">org.cyclos.model.banking.transactions.TicketStatus</a> or <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/ExternalPaymentStatus.html">org.cyclos.model.banking.transactions.ExternalPaymentStatus</a>);</p>
</li>
<li>
<p><code>newStatus</code>: The new status, as one of the previously mentioned classes, according to the transaction kind (same type as <code>oldStatus</code>).</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Change installment status</strong>: A scheduled payment installment or recurring payment occurrence status has changed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>installment</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Installment.html">org.cyclos.entities.banking.Installment</a>;</p>
</li>
<li>
<p><code>oldStatus</code>: The current status, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/InstallmentStatus.html">org.cyclos.model.banking.transactions.InstallmentStatus</a>;</p>
</li>
<li>
<p><code>newStatus</code>: The new status, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/transactions/InstallmentStatus.html">org.cyclos.model.banking.transactions.InstallmentStatus</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Send payment request</strong>: A payment request is being sent;</p>
</li>
<li>
<p><strong>Create ticket</strong>: A ticket is being created.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-auth">Transaction authorization extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on a transactions.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_8">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>transaction</code>: The affected payment, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/BasePayment.html">org.cyclos.entities.banking.BasePayment</a>;</p>
</li>
<li>
<p><code>currentLevel</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/AuthorizationLevel.html">org.cyclos.entities.banking.AuthorizationLevel</a>;</p>
</li>
<li>
<p><code>comment</code>: The comment entered by the user performing the action, as string.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_8">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Authorize</strong>: The transaction is being authorized. <strong>Be careful</strong>: there might be more authorization levels which need to be authorized before the transaction is finally processed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>nextLevel</code>: The next <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/AuthorizationLevel.html">org.cyclos.entities.banking.AuthorizationLevel</a>, if there are more levels to authorize. When null, the transaction will be processed.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Deny</strong>: The transaction is being denied by the authorizer;</p>
</li>
<li>
<p><strong>Cancel</strong>: The transaction is being canceled by the performer;</p>
</li>
<li>
<p><strong>Expire</strong>: The transaction is being expired by the system through a polling task. If the transfer type requires authorization, it is possible to define an expiration period to avoid leaving the payment indefinitely in a pending state.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-transfer">Transfer extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on a transfer.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_9">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>transfer</code>: The affected transfer, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_9">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Create</strong>: The transfer is being created;</p>
</li>
<li>
<p><strong>Chargeback</strong>: The transfer is being charged-back. Invoked once for the main transfer, not being invoked for each fee transfer, if any. In the case that the script needs access to the fee transfers, the <code>children</code> collection from <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a> will contain all fee chargebacks. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>chargeback`</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/ChargebackTransfer.html">org.cyclos.entities.banking.ChargebackTransfer</a> which was inserted. Only available in the script which runs after the data is saved.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Change status</strong>: The transfer is being set to a new status. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>flow</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/TransferStatusFlow.html">org.cyclos.entities.banking.TransferStatusFlow</a> of the status being changed;</p>
</li>
<li>
<p><code>oldStatus</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/TransferStatus.html">org.cyclos.entities.banking.TransferStatus</a>;</p>
</li>
<li>
<p><code>newStatus</code>: The new <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/TransferStatus.html">org.cyclos.entities.banking.TransferStatus</a>;</p>
</li>
<li>
<p><code>comments</code>: The comments, as provided by the administrator when changing the status, as string.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-voucher">Voucher extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on vouchers.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_10">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>voucher</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Voucher.html">org.cyclos.entities.banking.Voucher</a> being affected.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_10">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Generate</strong>: A voucher is being generated;</p>
</li>
<li>
<p><strong>Buy</strong>: A voucher is being bought or sent by a user. To differentiate, use the flag <code>voucher.pack.sent</code>;</p>
</li>
<li>
<p><code>unblock</code>: A blocked voucher is being unblocked;</p>
</li>
<li>
<p><code>redeem</code>: A voucher is being redeemed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>user</code> or <code>redeemer</code>: The voucher redeemer (generally a shop or cash point) as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a>;</p>
</li>
<li>
<p><code>amount</code>: The amount being redeemed. May be less than the voucher amount if the type allows partial redeems.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Cancel</strong>: A generated voucher is being canceled. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>previousStatus</code>: The previous voucher status as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/vouchers/VoucherStatus.html">org.cyclos.model.banking.vouchers.VoucherStatus</a>;</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Expire</strong>: A voucher has expired. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>previousStatus</code>: The previous voucher status as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/vouchers/VoucherStatus.html">org.cyclos.model.banking.vouchers.VoucherStatus</a>. Useful to differentiate whether the activation period has expired or the voucher itself has expired.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-agreement">Agreement extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on user agreements.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_11">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>agreement</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/Agreement.html">org.cyclos.entities.access.Agreement</a> being accepted or rejected;</p>
</li>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a> accepting or rejecting an agreement.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_11">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Accept</strong>: An agreement is being accepted;</p>
</li>
<li>
<p><strong>Reject</strong>: An optional agreement which was previously accepted is no longer accepted.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-type-import">Import extension point</h5>
<div class="paragraph">
<p>Extension points which monitor events on imports.</p>
</div>
<div class="sect5">
<h6 id="_additional_bindings_12">Additional bindings</h6>
<div class="ulist">
<ul>
<li>
<p><code>importedFile</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/ImportedFile.html">org.cyclos.entities.system.ImportedFile</a> being affected.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_events_12">Events</h6>
<div class="ulist">
<ul>
<li>
<p><strong>File status changed</strong>: The status of the imported file has changed. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>oldStatus</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/imports/ImportedFileStatus.html">org.cyclos.model.system.imports.ImportedFileStatus</a>;</p>
</li>
<li>
<p><code>newStatus</code>: The new <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/imports/ImportedFileStatus.html">org.cyclos.model.system.imports.ImportedFileStatus</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Line read</strong>: An imported line was read from the CSV file. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>line</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/ImportedLine.html">org.cyclos.entities.system.ImportedLine</a> being read.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Line processed</strong>: A line is being processed. On the validated phase, the line isn&#8217;t yet processed. On the saved phase, the line was processed, either with success or error. Additional bindings:</p>
<div class="ulist">
<ul>
<li>
<p><code>line</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/ImportedLine.html">org.cyclos.entities.system.ImportedLine</a> being processed;</p>
</li>
<li>
<p><code>entity</code>: Only on the saved phase when success (null when error). The entity which was created. The actual type depends on the import type. Can be a user, an advertisement, a transfer, a transaction, a record, a voucher, etc.;</p>
</li>
<li>
<p><code>error</code>: Only on the saved phase when error (null when success). The Java error which was thrown when processing the line.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-extension-point-examples">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-extension-point-examples-extra-credit">Granting extra credit (on demand) before payments</h6>
<div class="paragraph">
<p>This example allows, with a custom profile field, to define an extra credit limit the user can use on demand. When performing a payment, if the available balance is not enough, a payment is performed from a system account to the user, up to the limit specified in that profile field. Once the payment is done, the profile field is subtracted</p>
</div>
<div class="paragraph">
<p>This example expects the system account to have the internal name <code>debitUnits</code>, and it should have a payment transfer type to the user account. That payment transfer type should have the internal name <code>extraCredit</code>. Finally, the custom profile field needs to have the internal name <code>availableCredit</code>, and needs to be of type decimal, and enabled for the user.</p>
</div>
<div class="paragraph">
<p>Then create an extension point of type Transaction, enabled and for the confirm event. This example only works for payments without fees.
Use this in the "Script code executed when the data is saved" code block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.Account</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.PaymentTransferType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.SystemAccountType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.SystemAccountOwner</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PerformPaymentDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transfertypes.TransferTypeVO</span>

<span class="c1">// Only process direct payments. Scheduled payments are skipped</span>
<span class="k">if</span> <span class="o">(!(</span><span class="n">performTransaction</span> <span class="k">instanceof</span> <span class="n">PerformPaymentDTO</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">return</span>
<span class="o">}</span>

<span class="c1">// Get the available credit as a profile field</span>
<span class="kt">def</span> <span class="n">payer</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">fromOwner</span><span class="o">)</span>
<span class="n">BigDecimal</span> <span class="n">availableCredit</span> <span class="o">=</span> <span class="n">payer</span><span class="o">.</span><span class="na">availableCredit</span><span class="o">?.</span><span class="na">abs</span><span class="o">()</span>
<span class="k">if</span> <span class="o">(</span><span class="n">availableCredit</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">availableCredit</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Nothing to do - no available credit</span>
    <span class="k">return</span>
<span class="o">}</span>

<span class="c1">// Get the account and balance</span>
<span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">fromOwner</span><span class="o">,</span> <span class="n">paymentType</span><span class="o">.</span><span class="na">from</span><span class="o">)</span>
<span class="n">BigDecimal</span> <span class="n">availableBalance</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">getAvailableBalance</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
<span class="n">BigDecimal</span> <span class="n">needs</span> <span class="o">=</span> <span class="n">performTransaction</span><span class="o">.</span><span class="na">amount</span> <span class="o">-</span> <span class="n">availableBalance</span>
<span class="k">if</span> <span class="o">(</span><span class="n">needs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">needs</span> <span class="o">&lt;=</span> <span class="n">availableCredit</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Needs some extra credit, and has it available - make a payment from system</span>
    <span class="c1">// Find the system account and payment type</span>
    <span class="n">SystemAccountType</span> <span class="n">systemAccountType</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span>
            <span class="n">SystemAccountType</span><span class="o">,</span> <span class="s2">"debitUnits"</span><span class="o">)</span>
    <span class="n">PaymentTransferType</span> <span class="n">paymentType</span> <span class="o">=</span>  <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span>
            <span class="n">PaymentTransferType</span><span class="o">,</span> <span class="s2">"extraCredit"</span><span class="o">,</span> <span class="n">systemAccountType</span><span class="o">)</span>
    <span class="n">PerformPaymentDTO</span> <span class="n">credit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PerformPaymentDTO</span><span class="o">()</span>
    <span class="n">credit</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">SystemAccountOwner</span><span class="o">.</span><span class="na">instance</span><span class="o">()</span>
    <span class="n">credit</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="n">fromOwner</span>
    <span class="n">credit</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransferTypeVO</span><span class="o">(</span><span class="n">paymentType</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
    <span class="n">credit</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">needs</span>
    <span class="n">paymentService</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">credit</span><span class="o">)</span>
    <span class="c1">// Now there should be enough credit to perform the payment</span>

    <span class="c1">// Update the user available credit</span>
    <span class="n">payer</span><span class="o">.</span><span class="na">availableCredit</span> <span class="o">-=</span> <span class="n">needs</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-extension-point-examples-email-payment">Send an e-mail on every payment</h6>
<div class="paragraph">
<p>This example allows, for the selected payment types in the extension point details, to send an e-mail to a specific address. Use this in the "Script code executed when the data is saved" code block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">javax.mail.internet.InternetAddress</span>

<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>
<span class="kn">import</span> <span class="nn">org.cyclos.server.utils.MessageProcessingHelper</span>
<span class="kn">import</span> <span class="nn">org.springframework.mail.javamail.MimeMessageHelper</span>

<span class="c1">// Get the e-mail subject and body</span>
<span class="kt">def</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">transaction</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">vars</span> <span class="o">=</span> <span class="o">[</span>
    <span class="nl">payer:</span> <span class="n">tx</span><span class="o">.</span><span class="na">fromOwner</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
    <span class="nl">amount:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">tx</span><span class="o">.</span><span class="na">currencyAmount</span><span class="o">),</span>
    <span class="nl">date:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">formatAsDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">()),</span>
    <span class="nl">time:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">formatAsTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span>
<span class="o">]</span>
<span class="kt">def</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">MessageProcessingHelper</span><span class="o">.</span><span class="na">processVariables</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">subject</span><span class="o">,</span> <span class="n">vars</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">subject</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">subject</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="s2">"Missing the 'subject' script parameter"</span><span class="o">)</span>
<span class="o">}</span>
<span class="kt">def</span> <span class="n">body</span> <span class="o">=</span> <span class="n">MessageProcessingHelper</span><span class="o">.</span><span class="na">processVariables</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">message</span><span class="o">,</span> <span class="n">vars</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">body</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="s2">"Missing the 'message' script parameter"</span><span class="o">)</span>
<span class="o">}</span>
<span class="kt">def</span> <span class="n">toEmail</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="na">email</span>
<span class="kt">def</span> <span class="n">fromEmail</span> <span class="o">=</span> <span class="n">sessionData</span><span class="o">.</span><span class="na">configuration</span><span class="o">.</span><span class="na">smtpConfiguration</span><span class="o">.</span><span class="na">fromAddress</span>
<span class="kt">def</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">mailHandler</span><span class="o">.</span><span class="na">mailSender</span>

<span class="c1">// Send the message after commit, so we guarantee the transaction is persisted</span>
<span class="c1">// when the e-mail is sent</span>
<span class="n">scriptHelper</span><span class="o">.</span><span class="na">addOnCommit</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">message</span> <span class="o">=</span> <span class="n">sender</span><span class="o">.</span><span class="na">createMimeMessage</span><span class="o">()</span>
    <span class="kt">def</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessageHelper</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
    <span class="n">helper</span><span class="o">.</span><span class="na">to</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">toEmail</span><span class="o">)</span>
    <span class="n">helper</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">fromEmail</span><span class="o">)</span>
    <span class="n">helper</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="n">subject</span>
    <span class="n">helper</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">body</span>
    <span class="c1">// Send the message</span>
    <span class="n">sender</span><span class="o">.</span><span class="na">send</span> <span class="n">message</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-extension-point-examples-products-agreements">Assign / unassign individual products when the user accepts / rejects agreements</h6>
<div class="paragraph">
<p>Starting with Cyclos 4.13, there are optional agreements. This example assigns / unassigns individual products to the user that accepts / rejects agreements.</p>
</div>
<div class="paragraph">
<p>The script parameters must be in the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">agreementInternalName1</span><span class="p">=</span><span class="s">productInternalName1</span>
<span class="py">agreementInternalName2</span><span class="p">=</span><span class="s">productInternalName2</span>
<span class="err">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure the "Run with all permissions" checkbox is selected. Then, use this script in the "Script code executed when the data is saved" code block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.access.Agreement</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.users.ProductsUserServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.system.extensionpoints.AgreementExtensionPointEvent</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.products.ProductVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserVO</span>

<span class="c1">// Get the variables from context</span>
<span class="n">AgreementExtensionPointEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">event</span>
<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">user</span>
<span class="n">Agreement</span> <span class="n">agreement</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">agreement</span>
<span class="n">ProductsUserServiceLocal</span> <span class="n">productsUserService</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">productsUserService</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptParameters</span>

<span class="c1">// Lookup the product by agreement internal name</span>
<span class="kt">def</span> <span class="n">productVO</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProductVO</span><span class="o">(</span><span class="nl">internalName:</span> <span class="n">scriptParameters</span><span class="o">[</span><span class="n">agreement</span><span class="o">.</span><span class="na">internalName</span><span class="o">])</span>
<span class="kt">def</span> <span class="n">userVO</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserVO</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">assigned</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">products</span><span class="o">.</span><span class="na">find</span> <span class="o">{</span> <span class="n">it</span><span class="o">.</span><span class="na">internalName</span> <span class="o">==</span> <span class="n">productVO</span><span class="o">.</span><span class="na">internalName</span> <span class="o">}</span> <span class="o">!=</span> <span class="kc">null</span>

<span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">AgreementExtensionPointEvent</span><span class="o">.</span><span class="na">ACCEPT</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Assign the individual product</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">assigned</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">productsUserService</span><span class="o">.</span><span class="na">assign</span><span class="o">(</span><span class="n">productVO</span><span class="o">,</span> <span class="n">userVO</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">// Unasign the individual product</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">assigned</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">productsUserService</span><span class="o">.</span><span class="na">unassign</span><span class="o">(</span><span class="n">productVO</span><span class="o">,</span> <span class="n">userVO</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the extension point itself, select all agreements whose internal names are included in the script parameters, the user groups and both events.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-extension-point-examples-minimum-balance">Enforcing the user remains with a minimum balance for a payment type</h6>
<div class="paragraph">
<p>This example forces the user to remain with a minimum balance for the payment types configured in the extension point. The extension point should be of type transaction, and the event should be confirmed. Paste the following on "Script code executed when the data is validated" code block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.Account</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.utils.CurrencyAmount</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.AccountServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.formatting.FormatterImpl</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PerformTransactionDTO</span>

<span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">fromAccount</span>
<span class="n">PerformTransactionDTO</span> <span class="n">performTransaction</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">performTransaction</span>
<span class="n">AccountServiceLocal</span> <span class="n">accountService</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">accountService</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptParameters</span>
<span class="n">FormatterImpl</span> <span class="n">formatter</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">formatter</span>

<span class="kt">def</span> <span class="n">minBalance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">minBalance</span><span class="o">)</span>

<span class="kt">def</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">getBalance</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">newBalance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">performTransaction</span><span class="o">.</span><span class="na">amount</span>
<span class="k">if</span> <span class="o">(</span><span class="n">newBalance</span> <span class="o">&lt;</span> <span class="n">minBalance</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="s2">"""This operation cannot be processed,
        as your new account balance would be
        ${formatter.format(new CurrencyAmount(account.currency, newBalance))},
        below the minimum allowed balance of
        ${formatter.format(new CurrencyAmount(account.currency, minBalance))}"""</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-operations">4.4.11. Custom operations</h4>
<div class="paragraph">
<p>These scripts are invoked when a user runs a custom operation. A custom operation is configured to return different data types, and the script must behave accordingly (see <a href="https://wiki.cyclos.org/index.php/System_-_Operations">System  Operations</a> for more details).</p>
</div>
<div class="paragraph">
<p>Custom operations can have different scopes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>System</strong>: Those are executed by administrators (with granted permissions), directly from the main menu;</p>
</li>
<li>
<p><strong>User</strong>: Custom operations which are related to a user, and can either be executed by the own user (with granted permissions), from the main menu or run by administrator or brokers (also, with granted permissions) when viewing the user profile. In both cases, the custom operation needs to be enabled to users via member products. For example, there might be operations which apply only to businesses, not consumers, and even administrators with permission to run them shouldn&#8217;t be able to run them over consumers. It is enforced that administrators / brokers will only be able to run custom operations over users they manage;</p>
</li>
<li>
<p><strong>Menu</strong>: These custom operations are executed by a custom menu entry. This is the only possible custom operation scope that can be run by guests. A classical example of this is a "Contact us" page;</p>
</li>
<li>
<p><strong>Internal</strong>: An internal custom operation is executed either as an action (see below) or when the user clicks a row returned by another custom operation, which returns a table with results;</p>
</li>
<li>
<p><strong>Advertisement</strong>: Custom operations which are executed over an advertisement;</p>
</li>
<li>
<p><strong>Record</strong>: Custom operations which are executed over a record;</p>
</li>
<li>
<p><strong>Transfer</strong>: Custom operations which are executed over a transfer (balance transfer between accounts);</p>
</li>
<li>
<p><strong>Contact</strong>: Custom operations which are executed over a contact in a user&#8217;s contact list;</p>
</li>
<li>
<p><strong>Public contact information</strong>: Custom operations which are executed over a public contact information in a user&#8217;s profile;</p>
</li>
<li>
<p><strong>Bulk action</strong>: Custom operations executed on bulk actions, over each user individually.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="scripting-type-operations-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>customOperation</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomOperation.html">org.cyclos.entities.system.CustomOperation</a> being executed;</p>
</li>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a>. Only present if the custom operation&#8217;s scope is either user or bulk action;</p>
</li>
<li>
<p><code>bulkAction</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/CustomOperationBulkAction.html">org.cyclos.entities.users.CustomOperationBulkAction</a>. Only present if the custom operation&#8217;s scope is bulk action;</p>
</li>
<li>
<p><code>ad</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/marketplace/BasicAd.html">org.cyclos.entities.marketplace.BasicAd</a>. Only present if the custom operation&#8217;s scope is advertisement;</p>
</li>
<li>
<p><code>record</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Record.html">org.cyclos.entities.users.Record</a>. Only present if the custom operation&#8217;s scope is record;</p>
</li>
<li>
<p><code>transfer</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a>. Only present if the custom operation&#8217;s scope is transfer;</p>
</li>
<li>
<p><code>contact</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Contact.html">org.cyclos.entities.users.Contact</a>. Only present if the custom operation&#8217;s scope is contact;</p>
</li>
<li>
<p><code>contactInfo</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/ContactInfo.html">org.cyclos.entities.users.ContactInfo</a>. Only present if the custom operation&#8217;s scope is public contact information;</p>
</li>
<li>
<p><code>menuItem</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/contentmanagement/MenuItem.html">org.cyclos.entities.contentmanagement.MenuItem</a>. Only present if the custom operation&#8217;s scope is menu;</p>
</li>
<li>
<p><code>inputFile</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/FileInfo.html">org.cyclos.model.utils.FileInfo</a>. Only present if the custom operation is configured to accept a file upload, and if a file was selected upon the operation execution;</p>
</li>
<li>
<p><code>formParameters</code>: A <code>Map&lt;String, Object&gt;</code>, keyed by the form field internal name. The value depends on the custom field type (see <a href="#scripting-type-field-validation-bindings-value">the value binding on custom field validation script</a> for details on types);</p>
</li>
<li>
<p><code>scannedQrCode</code>: The string value scanned from the QR-code when submitting the operation. Only for custom operations which have 'Submit with a QR-code scan' set to true;</p>
</li>
<li>
<p><code>exportFormat</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/ExportFormat.html">org.cyclos.entities.system.ExportFormat</a> indicating if an operation which returns a result page will return just the data (when null) or will be exported to a file;</p>
</li>
<li>
<p><code>currentPage</code>: An integer indicating the current page, when getting paged results. Starts with zero. Only available if the result type is result page;</p>
</li>
<li>
<p><code>pageSize</code>: An integer indicating the requested page size when getting paged results. Only available if the result type is result page;</p>
</li>
<li>
<p><code>skipTotalCount</code>: A boolean indicating whether the total count should be skipped for this search. Only available if the result type is result page;</p>
</li>
<li>
<p><code>returnUrl</code>: Only if the custom operation return type is external redirect. Contains the url (as string) which Cyclos expects the external site to redirect the user after the operation completes;</p>
</li>
<li>
<p><code>storage</code> or <code>parameterStorage</code>: Only if the custom operation return type is external redirect. Contains an <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/server/utils/ObjectParameterStorage.html">org.cyclos.server.utils.ObjectParameterStorage</a> which is shared in both the first script and the callback handling script. This object is enhanced with propertyMissing methods, to support "syntactic sugar" on Groovy scripts, like <code>storage.name = value</code>. When this form is used, it is assumed that the input / output are plain strings;</p>
</li>
<li>
<p><code>execution</code> or <code>externalRedirectExecution</code>: execution / externalRedirectExecution: Only if the custom operation return type is external redirect. Contains the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/ExternalRedirectExecution.html">org.cyclos.entities.system.ExternalRedirectExecution</a> which stores the context for this execution;</p>
</li>
<li>
<p><code>request</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/RequestInfo.html">org.cyclos.model.utils.RequestInfo</a>. Only if the custom operation return type is external redirect. Contains the information about the current request, so the script function which handles the callback can identify the context to complete the process.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-operation-result">Script result</h5>
<div class="paragraph">
<p>The required return value depends on the custom operation result type. In all cases, the result type for the <code>CustomOperationService.run()</code> method is a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/operations/RunCustomOperationResult.html">org.cyclos.model.system.operations.RunCustomOperationResult</a>. But, depending on the custom operation result type, the value returned by the script is handled differently, as shown below:</p>
</div>
<div class="sect5">
<h6 id="scripting-type-operation-result-string">Plain text or Rich text</h6>
<div class="paragraph">
<p>In these cases, the result has a title and a content. The script must return one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>String</strong>: Is the result content. The header will be the custom operation name;</p>
</li>
<li>
<p>An object or Map containing the following properties:</p>
<div class="ulist">
<ul>
<li>
<p><strong>content</strong>: The required result content;</p>
</li>
<li>
<p><strong>title</strong>: The result title. When not specified, will use the operation name;</p>
</li>
<li>
<p><strong>receipt</strong>: A receipt to be printed by the Cyclos mobile app in a Bluetooth printer. See below for more information on receipts.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operation-notification">Notification</h6>
<div class="paragraph">
<p>In all cases, notifications are assumed to be HTML formatted. The script must return one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>String</strong>: A plain string, which is considered as an information notification. If it is prefixed with either <code>[INFO]</code>, <code>[WARN]</code> or <code>[ERROR]</code>, such prefixes are removed from the notification and the notification level is set;</p>
</li>
<li>
<p>An object or Map with the following properties:</p>
<div class="ulist">
<ul>
<li>
<p><code>notification</code>: The notification text;</p>
</li>
<li>
<p><code>notificationLevel</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/NotificationLevel.html">org.cyclos.model.utils.NotificationLevel</a> to be considered. If not specified, assume information.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operation-result-download">File download</h6>
<div class="paragraph">
<p>The script must return an instance of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/FileInfo.html">org.cyclos.model.utils.FileInfo</a>, or an object or Map with the same properties. The properties are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>content</code>: Required. The file content. It may be an InputStream, a File or a String (containing the file content itself);</p>
</li>
<li>
<p><code>contentType</code>: Required. The MIME type, such as <code>text/plain</code>, <code>text/html</code>, <code>image/jpeg</code>, <code>application/pdf</code>, etc.;</p>
</li>
<li>
<p><code>name</code>: Optional file name, which will be used by browsers to suggest the file name to save;</p>
</li>
<li>
<p><code>length</code>: Optional file length, which browsers use to monitor the progress of file downloads.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operation-result-page">Page results</h6>
<div class="paragraph">
<p>The script must return an object (or map) with the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>columns</code>: Either this or headers must be returned. Contains each column definition. Each column is a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/operations/PageResultColumn.html">org.cyclos.model.system.operations.PageResultColumn</a> or equivalent object. Each column can define a result property to display (otherwise it is assumed that each result is an array, accessed by index). Additionally, defines the <code>type</code>, <code>header</code>, <code>width</code>, <code>align</code>, <code>valign</code>. The type is a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/operations/PageResultColumnType.html">org.cyclos.model.system.operations.PageResultColumnType</a> or equivalent string, such as: <code>string</code>, <code>boolean</code>, <code>number</code>, <code>date</code> or <code>currencyAmount</code>. Returning as currency amount is a special case, where exports can use this information to correctly format the amount. Also, when the type is <code>boolean</code>, <code>number</code> or <code>date</code>, results are sent with a suitable representation in a standard form, rather than a formatted string;</p>
</li>
<li>
<p><code>rows</code>: A list of objects, each containing properties. Each column matches the corresponding object property to display each cell. An object can have additional properties, which can be used to pass parameters to the url when clicking a row;</p>
</li>
<li>
<p>Alternatively, and for backwards compatibility, instead of returning <code>columns</code> and <code>rows</code>, it is possible to return <code>headers</code> as a <code>List&lt;String&gt;</code> and <code>results</code> as a <code>List&lt;List&lt;String&gt;&gt;</code>, so the result table is assembled with those tabular data;</p>
</li>
<li>
<p><code>totalCount</code>: Optional, used to page results. If a total count is returned, a result page navigator is shown to the user, and records can be returned page-by-page. The script should probably use the <code>currentPage</code> and <code>pageSize</code> variables to
calculate the correct page to be returned;</p>
</li>
<li>
<p><code>hasNextPage</code>: Indicates that there are more rows to be returned than this page. Ignored if <code>totalCount</code> is returned.  Another way to enable pagination is to not return this flag explicitly, but to limit <code>rows</code> to <code>pageSize + 1</code>. When more results are returned than the page size, the list is truncated, but Cyclos has the information that there&#8217;s more data.
Take into account that if both <code>totalCount</code> and <code>hasNextPage</code> are not returned and the <code>rows</code> list has exactly the same
size as <code>pageSize</code>, then the pagination will be disabled because Cyclos will infer there is no more data.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operation-result-url">URL</h6>
<div class="paragraph">
<p>The script must return one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>String</strong>: The URL, and the user is redirected to that URL in the same browser window;</p>
</li>
<li>
<p>An object or Map with the following properties:</p>
<div class="ulist">
<ul>
<li>
<p><code>url</code>: The destination URL;</p>
</li>
<li>
<p><code>newWindow</code>: A boolean value indicating whether the application will open a new browser window with the destination URL. Most browsers block popups by default, and opening in a new window is probably considered a popup by browsers. Hence, when opening a new window, on the first execution, users might be prompted whether the popup is allowed. Then they might need to run the operation again once the popup is allowed.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operation-result-redirect">External redirect</h6>
<div class="paragraph">
<p>This return type has 2 different scripts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first script should prepare the data in some external system, and then return the URL to which the user should be redirected. An example using this kind of script is the <a href="#scripting-solution-paypal">PayPal Integration</a>, in which the first script creates a payment in PayPal, to be confirmed later on by the user. Two noteworthy variables bound to the script context which are necessary for this script are:</p>
<div class="ulist">
<ul>
<li>
<p><code>returnUrl</code>: This is the URL that should be passed to the external service to redirect the user back to Cyclos to complete the operation;</p>
</li>
<li>
<p><code>storage</code>: A <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/utils/ParameterStorage.html">storage</a> which can be used to persist data that should be read when the execution resumes in the second script, after the user is redirected.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The second script is triggered after the external site redirects the user back to Cyclos. This script must return an HTML content which is shown to the user. After being redirected back to Cyclos, the previous web application state, such as breadcrumb, current page, etc., will be lost. Just the returned HTML content will be shown.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operation-result-bulk-action">Bulk action</h6>
<div class="paragraph">
<p>The script is executed for each user affected by the bulk action, and must return one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Null</strong>: The user was skipped;</p>
</li>
<li>
<p><strong>Boolean</strong>: <code>true</code> represents the user was processed, <code>false</code> means the user was skipped;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/bulkactions/BulkActionUserStatus.html">org.cyclos.model.users.bulkactions.BulkActionUserStatus</a>: The status of the user</p>
</li>
<li>
<p><strong>String</strong>: If is the name of a <code>BulkActionUserStatus</code> enum item, is considered it. Otherwise, represents a message to be stored in the user log for this bulk action, and the user is assumed as processed;</p>
</li>
<li>
<p><strong>Throwable</strong>: An error. Normally, errors are expressed by throwing exceptions, but it is also possible to return one;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/users/BulkActionUserResult.html">org.cyclos.impl.users.BulkActionUserResult</a>: A fully populated result.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-operation-function">Other script functions</h5>
<div class="paragraph">
<p>Custom operations also support other script functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a id="scripting-type-operation-function-pre-run"></a> <strong>Code executed before the form is show, to fill the initial field values</strong>: This script will be executed before showing the form, so it can determine the default form fields dynamically. It should return a <code>Map&lt;String, Object&gt;</code>, containing, per custom field internal name, the initial value that should be presented for the user.
Additionally, as part of the returned result object, you can specify the following properties:</p>
<div class="ulist">
<ul>
<li>
<p><code>autoRunAction</code>: Either, the id or internal name of the <a href="#scripting-type-operation-actions">action</a> that should be executed automatically, instead of showing the form;</p>
</li>
<li>
<p><code>reRun</code>: boolean indicating that the operation must be re-run when going back to it before displaying it. This will avoid showing outdated data when going back not from an operation action but using another mechanism (e.g the mobile app&#8217;s back button).</p>
</li>
</ul>
</div>
</li>
<li>
<p><a id="scripting-type-operation-function-availability"></a> <strong>Code executed to determine whether the custom operation will be available</strong>: This script can decide to disable the custom operation from being shown as an option to be executed. For example, for record scope, some custom operation could only make sense if the record has a particular custom field value. If this script returns <code>false</code>, the operation will not be shown as an option. Any other value will enable the operation. This script will also run for custom operations used as actions (<a href="#scripting-type-operation-actions">see below</a>) of other custom operations. In this case, the <code>formParameters</code> bound variable will contain only the parameters that would be sent to the action, if it is executed, according to the mapped values in the action configuration. Also, for actions, an additional available variable for the script is <code>containerCustomOperation</code>, which is the main custom operation which is currently being executed, and that will contain the action;</p>
</li>
<li>
<p><a id="scripting-type-operation-function-callback"></a> <strong>Script code executed when the external site redirects the user back to Cyclos</strong>: This script is executed only if the operation result type is <strong>External redirect</strong>. It runs after the external service redirects the user back to Cyclos. The script will have access to the same <code>storage</code> object that was available to the main script block, so using that object, it is possible to pass data between both executions. The callback also runs with the same <code>sessionData</code> as the original script, they will have the same logged user, permissions, etc. Additionally, it is possible to read the original request parameters using the <code>request</code> variable.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-operation-actions">Actions</h5>
<div class="paragraph">
<p>Custom operations can have additional actions. Each action points to another custom operation with scope <strong>Internal</strong>. The original custom operation can be configured for which actions are available, which parameters are passed with that action and the visibility (when are shown to the user). Each parameter of the action operation may be mapped to a parameter of the original custom operation, or left for the original operation script to resolve the parameters that will be set to the action operation.</p>
</div>
<div class="paragraph">
<p>Actions can be configured on custom operations of result type 'Plain text', 'Rich text' or 'Result page'. The label defined for the custom operation pointed by an action will be used as the button label associated with that action, as the full name could be too large for buttons.</p>
</div>
<div class="paragraph">
<p>Also, actions can be configured to be displayed before executing the operation (for example, for result pages that can show a button to add a new row), after the execution or in both cases.</p>
</div>
<div class="paragraph">
<p>To control the actions, the object returned by the container custom operation can set a property named <code>actions</code> as part of the returned result. It should be a map keyed by the action operation internal name, and whose values contain the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parameters</code>: Contains another map, keyed by parameter (form field of the action operation) internal name, with the value that should be used as that parameter. If there is a static mapping between an action parameter and an owner operation input field, and the script returns a parameter value, the script takes precedence;</p>
</li>
<li>
<p><code>enabled</code>: Whether the action must be enabled or not. Default to true.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Actions shown before the execution of the original custom operation are customized by <a href="#scripting-type-operation-function-pre-run">script executed before the form is shown</a>, and those shown after are customized by the main script function.</p>
</div>
<div class="paragraph">
<p>Here is an example of a script for a custom operation of result type <strong>Rich text</strong> with two actions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="k">return</span> <span class="o">[</span>
    <span class="nl">content:</span> <span class="s2">"This is the content displayed after the operation is executed"</span><span class="o">,</span>
    <span class="nl">actions:</span> <span class="o">[</span>
        <span class="nl">action1:</span> <span class="o">[</span>
            <span class="c1">// action1 is the internal name of the custom operation</span>
            <span class="c1">// (with scope 'Internal') pointed by an action.</span>
            <span class="nl">parameters:</span> <span class="o">[</span>
                <span class="nl">input1:</span> <span class="s2">"Value for input 1"</span><span class="o">,</span>
                <span class="nl">input2:</span> <span class="s2">"1234"</span> <span class="c1">// Here input1 and input2 are internal names</span>
                <span class="c1">// of form fields in the action1 custom operation</span>
            <span class="o">]</span>
            <span class="c1">// action1 is enabled by default</span>
        <span class="o">],</span>
        <span class="nl">action2:</span> <span class="o">[</span>
            <span class="nl">enabled:</span> <span class="kc">false</span> <span class="c1">// action2 is disabled for this execution</span>
        <span class="o">]</span>
    <span class="o">]</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of a script executed before show the form for a custom operation of result type <strong>Rich text</strong> with two actions (with visibility set to before or both):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="k">return</span> <span class="o">[</span>
    <span class="c1">// Here field1 is a form field in the custom operation</span>
    <span class="nl">field1:</span> <span class="s2">"Default value"</span><span class="o">,</span>
    <span class="nl">actions:</span> <span class="o">[</span>
        <span class="nl">action1:</span> <span class="o">[</span>
            <span class="c1">// action1 is the internal name of the custom operation</span>
            <span class="c1">// (with scope 'Internal') pointed by an action.</span>
            <span class="nl">parameters:</span> <span class="o">[</span>
                <span class="nl">input1:</span> <span class="s2">"Value for input 1"</span><span class="o">,</span>
                <span class="nl">input2:</span> <span class="s2">"1234"</span> <span class="c1">// Here input1 and input2 are internal names</span>
                <span class="c1">// of form fields in the action1 custom operation</span>
            <span class="o">]</span>
            <span class="c1">// action1 is enabled by default</span>
        <span class="o">],</span>
        <span class="nl">action2:</span> <span class="o">[</span>
            <span class="nl">enabled:</span> <span class="kc">false</span> <span class="c1">// action2 is disabled before the execution</span>
        <span class="o">]</span>
    <span class="o">]</span>
<span class="o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-operation-after">Behavior after execution</h5>
<div class="paragraph">
<p>Additionally, as part of the returned result object, you can specify what to do after a successful operation execution. Although you can specify this information for all result types, the Cyclos web application will process it only for <strong>Notification</strong>, <strong>URL</strong> (with 'newWindow' in true) and <strong>External redirect</strong> result types (except for <code>autoRunAction</code>). The following properties can be specified in the result:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>backTo</code>: Either the internal name, id or entity for the custom operation to which the user should be redirected after executing this operation. If such operation is in the current history (breadcrumb), the user will be redirected to it. Otherwise, the current page will not be changed;</p>
</li>
<li>
<p><code>backToRoot</code>: A boolean value indicating if the application must go back to the page that originated the custom operation executions. If we already are in a 'root page' then the Cyclos web application will stay in the current page.  For example, an operation with scope <strong>User</strong> containing an action (action 1) and this in turn containing another action (action 1.1) could generate the following history: <em>View user profile &#8594; Run user custom operation &#8594; Run Custom operation action1 &#8594; Run Custom operation action1.1</em>. In this case, the flag <code>backToRoot</code> set to <code>true</code> means go back to the 'View user profile' page;</p>
</li>
<li>
<p><code>reRun</code>: A boolean value indicating if the page we went back to or the  current one (if <code>backTo</code> was not specified or <code>backToRoot</code> is <code>false</code>) must be executed again before displaying it;</p>
</li>
<li>
<p><code>autoRunAction</code>: Either the id or internal name of the action that should be executed automatically. If it is specified, the Cyclos web application doesn&#8217;t show the result and runs the action automatically, as it will if the user manually executes it by the corresponding action button.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-operation-row-actions">Row actions on page results</h5>
<div class="paragraph">
<p>Custom operations that return a page of results are very versatile.
For example, they can be printed as PDF or exported to CSV / XLSX, or page results (if the script returns the total count).</p>
</div>
<div class="paragraph">
<p>Also, on the custom operation, it is possible to define an action to be executed when a row is clicked by the user.
The possible actions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Navigate to an external URL</strong>: When clicking a row, the user is redirected to an external URL;</p>
</li>
<li>
<p><strong>Navigate to a location in Cyclos</strong>: A list of common locations in Cyclos are presented;</p>
</li>
<li>
<p><strong>Run an internal custom operation</strong>: Allows running a custom operation which has the scope = 'Internal'. This new operation will probably present some content to the user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In all cases an action is set to a row, parameters can be passed to the next page. This is very important, as it will provide context on which data was selected. For an internal custom operation to receive a parameter, first on the result page custom operation the field 'URL parameters' must be set, having a comma-separated value of object properties to be passed to the internal custom operation. This will pass all such properties from the clicked row to the internal custom operation.</p>
</div>
<div class="paragraph">
<p>Then, the internal custom operation needs to have form fields defined with the matching internal name. Here is an <a href="#scripting-type-operations-example-external-records">example on this</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-operation-receipt">Receipt</h5>
<div class="paragraph">
<p>Custom operations which return a content can also return a receipt to be printed in the Cyclos mobile application using a Bluetooth printer. The content of the receipt is simple, because the printing has limited style and layout possibilities.</p>
</div>
<div class="paragraph">
<p>The classic frontend for administrators has a button to preview the receipt on the browser. It is not a "pixel-perfect" version of the physical printing, but can aid developers of the script to have an acceptable version before testing it physically on paper in the mobile application.</p>
</div>
<div class="paragraph">
<p>To enable receipt printing, the <code>receipt</code> property should be present in the result. It should contain the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>timestamp</code>: When returned (normally with the value <code>new Date()</code>) the timestamp will be printed on the very beginning of the receipt;</p>
</li>
<li>
<p><code>header</code>: Either a string or an object with the text displayed above the title, and below the timestamp. By default, the header is normal style and left aligned;</p>
</li>
<li>
<p><code>title</code>: Either a string or an object with the title text displayed below the header and above the main items. By default, the title is bold, double height and center aligned;</p>
</li>
<li>
<p><code>items</code>: A list of either strings or objects to be used as the main section. Each of these items either be a regular text or a label / value pair. See examples below;</p>
</li>
<li>
<p><code>footer</code>: Either a string or an object with the text displayed at the end of the receipt. By default, the footer has lines before and after, is bold style and is center aligned;</p>
</li>
<li>
<p><code>labelSuffix</code>: A string indicating a suffix for all labels in items. The default value is <code>:&#160;</code>. It is possible to disable the suffix by returning a single space;</p>
</li>
<li>
<p><code>autoPrint</code>: When set to true, the mobile app will start printing automatically.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are the properties that can be used to configure each section or item:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>label</code>: Only for items. If set, the item enters into 'field' mode, with a left-aligned label and a right-aligned value, which is the text attribute. They are printed in the same line if both fit. Otherwise, the value is printed left-aligned in the next line;</p>
</li>
<li>
<p><code>labelStyle</code>: Only for items with labels. If set, determine the font style of the label. Defaults to <code>bold</code>;</p>
</li>
<li>
<p><code>text</code>: The section text;</p>
</li>
<li>
<p><code>style</code>: Either <code>normal</code>, <code>bold</code> or <code>underline</code>;</p>
</li>
<li>
<p>align: Either <code>left</code>, <code>center</code> or <code>right</code>. Ignored for items with a label;</p>
</li>
<li>
<p><code>width</code>: Font width. Either <code>normal</code> or <code>double</code>. Ignored for items with a label;</p>
</li>
<li>
<p><code>height</code>: Font height. Either <code>normal</code> or <code>double</code>. Ignored for items with a label;</p>
</li>
<li>
<p><code>lineBefore</code>: Boolean indicating whether a line should be printed before the text;</p>
</li>
<li>
<p><code>lineAfter</code>: Boolean indicating whether a line should be printed after the text;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example of a script for a custom operation of result type 'Rich text' with a simple receipt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="k">return</span> <span class="o">[</span>
    <span class="nl">content:</span> <span class="s2">"This is the content displayed after the operation is executed"</span><span class="o">,</span>
    <span class="nl">receipt:</span> <span class="o">[</span>
        <span class="nl">timestamp:</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(),</span>
        <span class="nl">header:</span> <span class="s2">"This is the header content"</span><span class="o">,</span>
        <span class="nl">title:</span> <span class="s2">"Transaction receipt"</span><span class="o">,</span>
        <span class="nl">items:</span> <span class="o">[</span>
            <span class="s2">"Thanks for this transaction!"</span><span class="o">,</span>
            <span class="s2">""</span><span class="o">,</span>
            <span class="c1">// Blank line</span>
            <span class="o">[</span>
                <span class="nl">label:</span> <span class="s2">"Field 1"</span><span class="o">,</span>
                <span class="nl">text:</span> <span class="s2">"Value 1"</span>
            <span class="o">],</span>
            <span class="o">[</span>
                <span class="nl">label:</span> <span class="s2">"Field 2"</span><span class="o">,</span>
                <span class="nl">text:</span> <span class="s2">"Value 2"</span>
            <span class="o">]</span>
        <span class="o">],</span>
        <span class="nl">footer:</span> <span class="s2">"Hope to see you soon again!"</span>
    <span class="o">]</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is another example, changing the defaults:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="k">return</span> <span class="o">[</span>
    <span class="nl">content:</span> <span class="s2">"This is the content displayed after the operation is executed"</span><span class="o">,</span>
    <span class="nl">receipt:</span> <span class="o">[</span>
        <span class="nl">timestamp:</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(),</span>
        <span class="nl">header:</span> <span class="o">[</span>
            <span class="nl">align:</span> <span class="s1">'center'</span><span class="o">,</span>
            <span class="nl">text:</span> <span class="s1">'Centered header'</span>
        <span class="o">],</span>
        <span class="nl">title:</span> <span class="o">[</span>
            <span class="nl">align:</span> <span class="s1">'left'</span><span class="o">,</span>
            <span class="nl">text:</span> <span class="s1">'Left title'</span>
        <span class="o">],</span>
        <span class="nl">items:</span> <span class="o">[</span>
            <span class="o">[</span>
                <span class="nl">text:</span> <span class="s2">"On left"</span>
            <span class="o">],</span>
            <span class="o">[</span>
                <span class="nl">text:</span> <span class="s2">"On right"</span><span class="o">,</span>
                <span class="nl">align:</span> <span class="s2">"right"</span>
            <span class="o">]</span>
        <span class="o">],</span>
        <span class="nl">footer:</span> <span class="o">[</span>
            <span class="nl">lineAfter:</span> <span class="kc">false</span><span class="o">,</span>
            <span class="nl">align:</span> <span class="s1">'left'</span><span class="o">,</span>
            <span class="nl">text:</span> <span class="s1">'Left footer without bottom line'</span>
        <span class="o">],</span>
    <span class="o">]</span>
<span class="o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-operations-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-operations-example-contact">Contact us page</h6>
<div class="paragraph">
<p>This example allows creating a "contact us" page, which sends an e-mail to a specified address. To use it, you will need the following content in the script parameters box:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">to</span><span class="p">=</span><span class="s">admin@project.org</span>
<span class="py">from</span><span class="p">=</span><span class="s">noreply@project.org</span>
<span class="py">subject</span><span class="p">=</span><span class="s">Contact form</span>
<span class="py">message</span><span class="p">=</span><span class="s">The message was sent.</span><span class="se">\n</span><span class="s">Thank you for your contact.</span>

<span class="py">mailHeader</span><span class="p">=</span><span class="s">A user has sent a contact form with the following data:</span>
<span class="py">mailFrom</span><span class="p">=</span><span class="s">From:</span>
<span class="py">mailEmail</span><span class="p">=</span><span class="s">E-Mail:</span>
<span class="py">mailSubject</span><span class="p">=</span><span class="s">Subject:</span>
<span class="py">mailMessage</span><span class="p">=</span><span class="s">Message:</span>

<span class="py">invalidEmail</span><span class="p">=</span><span class="s">Invalid e-mail address</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, use the following script code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">javax.mail.internet.InternetAddress</span>

<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.validation.validations.EmailValidation</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>
<span class="kn">import</span> <span class="nn">org.springframework.mail.javamail.MimeMessageHelper</span>

<span class="kt">def</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">mailHandler</span><span class="o">.</span><span class="na">mailSender</span>
<span class="kt">def</span> <span class="n">message</span> <span class="o">=</span> <span class="n">sender</span><span class="o">.</span><span class="na">createMimeMessage</span><span class="o">()</span>
<span class="kt">def</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessageHelper</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>

<span class="k">if</span> <span class="o">(!</span><span class="n">EmailValidation</span><span class="o">.</span><span class="na">isValid</span><span class="o">(</span><span class="n">formParameters</span><span class="o">.</span><span class="na">email</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">invalidEmail</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">helper</span><span class="o">.</span><span class="na">to</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">to</span><span class="o">)</span>
<span class="n">helper</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">from</span><span class="o">)</span>
<span class="n">helper</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">subject</span>
<span class="n">helper</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="s2">"""
${scriptParameters.mailHeader}
${scriptParameters.mailFrom} ${formParameters.from}
${scriptParameters.mailEmail} ${formParameters.email}
${scriptParameters.mailSubject} ${formParameters.subject}
${scriptParameters.mailMessage} ${formParameters.message}
"""</span>
<span class="n">sender</span><span class="o">.</span><span class="na">send</span> <span class="n">message</span>

<span class="k">return</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">message</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom operation needs form parameters with the following internal names: <code>from</code>, <code>email</code>, <code>subject</code> and <code>message</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-string">Returning a string (notification / rich / plain text)</h6>
<div class="paragraph">
<p>Examples of a custom operation which returns a text (a notification in that case) can be found in the <a href="#scripting-solution-loan">loan solution example</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-redirect">Returning an external redirect</h6>
<div class="paragraph">
<p>An example of an external redirect is the <a href="#scripting-solution-paypal">PayPal integration example</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-file">Returning a file</h6>
<div class="paragraph">
<p>This is an example where the user selects a document to download. It is assumed that the custom operation has a form field of type single selection with the internal name file. Then, each possible value should have the internal name corresponding to a PDF file in a given folder. Once the user chooses the file, it is downloaded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>

<span class="c1">// Assume there is a pdf file for each possible value of the field</span>
<span class="n">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">file</span><span class="o">.</span><span class="na">internalName</span>
<span class="n">String</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">dir</span> <span class="o">?:</span> <span class="s2">"/usr/share/documents"</span>
<span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="s2">"${fileName}.pdf"</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="s2">"File not found"</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">return</span> <span class="o">[</span>
    <span class="nl">content:</span> <span class="n">file</span><span class="o">,</span>
    <span class="nl">contentType:</span> <span class="s2">"application/pdf"</span><span class="o">,</span>
    <span class="nl">name:</span> <span class="n">file</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
    <span class="nl">length:</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span>
    <span class="nl">lastModified:</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">()</span>
<span class="o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-users-traded">View users I&#8217;ve traded with</h6>
<div class="paragraph">
<p>In this example, a user can see the other users he has traded with (either performed or received payments). The custom operation needs to have 'User' scope and 'Result page' as result type. Also, it needs to have the URL action as 'Cyclos location', and the location needs to be <code>user_profile</code>. Finally, set as 'URL parameters' the value <code>id</code>. For more details, see the next section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.AccountServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.ColumnMapRowMapper</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate</span>

<span class="n">AccountServiceLocal</span> <span class="n">accountService</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">accountService</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">accountIds</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">listVisible</span><span class="o">(</span><span class="n">user</span><span class="o">).</span><span class="na">collect</span> <span class="o">{</span><span class="n">acc</span> <span class="o">-&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">id</span><span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">accountIds</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="s2">"No accounts"</span><span class="o">)</span>
<span class="o">}</span>

<span class="n">NamedParameterJdbcTemplate</span> <span class="n">jdbc</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">namedParameterJdbcTemplate</span>

<span class="c1">// First count the number of users / currencies that traded with the current user</span>
<span class="n">Integer</span> <span class="n">totalCount</span> <span class="o">=</span> <span class="kc">null</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">skipTotalCount</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">totalCount</span> <span class="o">=</span> <span class="n">jdbc</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="s2">"""
        select count(*)
        from (
            select distinct user_id, currency_id
            from (
                select user_id, currency_id
                from (
                    select u.id as user_id, at.currency_id, max(t.date) as last_date, max(t.amount) as max_amount, count(*) as count
                    from transfers t inner join accounts a on t.to_id = a.id
                    inner join users u on a.user_id = u.id
                    inner join account_types at on a.account_type_id = at.id
                    where t.from_id in (:accountIds)
                    group by u.id, at.currency_id
                    union
                    select u.id as user_id, at.currency_id, max(t.date) as last_date, max(t.amount) as max_amount, count(*) as count
                    from transfers t inner join accounts a on t.from_id = a.id
                    inner join users u on a.user_id = u.id
                    inner join account_types at on a.account_type_id = at.id
                    where t.to_id in (:accountIds)
                    group by u.id, at.currency_id
                ) t1
                group by user_id, currency_id
            ) t2
        ) t3
    """</span><span class="o">,</span> <span class="o">[</span><span class="nl">accountIds:</span> <span class="n">accountIds</span><span class="o">],</span> <span class="n">Integer</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// Then get the data</span>
<span class="kt">int</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">pageSize</span>
<span class="kt">int</span> <span class="n">currentPage</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">currentPage</span>
<span class="kt">def</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">jdbc</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s2">"""
    select u.id, u.display_for_managers, t.currency_id as "currencyId", t.last_date as "lastDate", t.max_amount as "maxAmount", t.count
    from (
        select user_id, currency_id, max(last_date) as last_date, max(max_amount) as max_amount, sum(count) as count
        from (
            select u.id as user_id, at.currency_id, max(t.date) as last_date, max(t.amount) as max_amount, count(*) as count
            from transfers t inner join accounts a on t.to_id = a.id
            inner join users u on a.user_id = u.id
            inner join account_types at on a.account_type_id = at.id
            where t.from_id in (:accountIds)
            group by u.id, at.currency_id
            union
            select u.id as user_id, at.currency_id, max(t.date) as last_date, max(t.amount) as max_amount, count(*) as count
            from transfers t inner join accounts a on t.from_id = a.id
            inner join users u on a.user_id = u.id
            inner join account_types at on a.account_type_id = at.id
            where t.to_id in (:accountIds)
            group by u.id, at.currency_id
        ) t1
        group by user_id, currency_id
    ) t inner join users u on t.user_id = u.id
    order by t.count desc, u.display_for_managers
    limit :limit
    offset :offset
"""</span><span class="o">,</span> <span class="o">[</span><span class="nl">accountIds:</span> <span class="n">accountIds</span><span class="o">,</span> <span class="nl">limit:</span> <span class="n">pageSize</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="nl">offset:</span> <span class="n">pageSize</span> <span class="o">*</span> <span class="n">currentPage</span><span class="o">],</span> <span class="k">new</span> <span class="n">ColumnMapRowMapper</span><span class="o">());</span>

<span class="c1">// Build the result</span>
<span class="k">return</span> <span class="o">[</span>
    <span class="nl">columns:</span> <span class="o">[</span>
        <span class="o">[</span><span class="nl">header:</span> <span class="s2">"User"</span><span class="o">,</span> <span class="nl">property:</span> <span class="s2">"display_for_managers"</span><span class="o">,</span> <span class="nl">width:</span> <span class="s2">"40%"</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">header:</span> <span class="s2">"Last date"</span><span class="o">,</span> <span class="nl">property:</span> <span class="s2">"lastDate"</span><span class="o">,</span> <span class="nl">align:</span> <span class="s2">"center"</span><span class="o">,</span> <span class="nl">type:</span> <span class="s2">"date"</span><span class="o">,</span> <span class="nl">width:</span> <span class="s2">"20%"</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">header:</span> <span class="s2">"Max amount"</span><span class="o">,</span> <span class="nl">property:</span> <span class="s2">"maxAmount"</span><span class="o">,</span> <span class="nl">currencyProperty:</span> <span class="s2">"currencyId"</span><span class="o">,</span> <span class="nl">align:</span> <span class="s2">"right"</span><span class="o">,</span> <span class="nl">width:</span> <span class="s2">"20%"</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">header:</span> <span class="s2">"Transactions"</span><span class="o">,</span> <span class="nl">property:</span> <span class="s2">"count"</span><span class="o">,</span> <span class="nl">align:</span> <span class="s2">"right"</span><span class="o">,</span> <span class="nl">type:</span> <span class="s2">"number"</span><span class="o">,</span> <span class="nl">width:</span> <span class="s2">"20%"</span><span class="o">],</span>
    <span class="o">],</span>
    <span class="nl">rows:</span> <span class="n">rows</span><span class="o">,</span>
    <span class="nl">totalCount:</span> <span class="n">totalCount</span>
<span class="o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-records-empty-value">Search records with an empty field value</h6>
<div class="paragraph">
<p>In this example, an administrator can search for user records which don&#8217;t have a specific custom field value. The record search page allows filtering by values, but not by records without value for a particular field.</p>
</div>
<div class="paragraph">
<p>The custom operation needs to have system scope and result type result page.
You can also set the "Action when clicking a row" to "Navigate to a Cyclos location", set "Location" to <code>record</code> and set "Parameters to be passed (comma-separated names)" to <code>id</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.QRecordCustomFieldValue</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.QUserRecord</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.RecordCustomField</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecord</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecordType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.persistence.DBQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.general.GeneralKeys</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.system.fields.CustomFieldType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.UsersKeys</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.Page</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.PageImpl</span>

<span class="kt">def</span> <span class="n">r</span> <span class="o">=</span> <span class="n">QUserRecord</span><span class="o">.</span><span class="na">userRecord</span>
<span class="kt">def</span> <span class="n">v</span> <span class="o">=</span> <span class="n">QRecordCustomFieldValue</span><span class="o">.</span><span class="na">recordCustomFieldValue</span>

<span class="c1">// Read the record type and custom field (adjust the internal names)</span>
<span class="kt">def</span> <span class="n">recordType</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">UserRecordType</span><span class="o">,</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">recordType</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">field</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">RecordCustomField</span><span class="o">,</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">field</span><span class="o">,</span> <span class="n">recordType</span><span class="o">)</span>

<span class="n">DBQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
        <span class="o">.</span><span class="na">leftJoin</span><span class="o">(</span><span class="n">v</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">owner</span><span class="o">().</span><span class="na">eq</span><span class="o">(</span><span class="n">r</span><span class="o">),</span> <span class="n">v</span><span class="o">.</span><span class="na">field</span><span class="o">().</span><span class="na">eq</span><span class="o">(</span><span class="n">field</span><span class="o">))</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">type</span><span class="o">().</span><span class="na">eq</span><span class="o">(</span><span class="n">recordType</span><span class="o">))</span>

<span class="c1">// According to the custom field type, the condition for empty changes</span>
<span class="k">switch</span> <span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">STRING</span><span class="o">:</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">URL</span><span class="o">:</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">DYNAMIC_SELECTION</span><span class="o">:</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">stringValue</span><span class="o">.</span><span class="na">isNull</span><span class="o">().</span><span class="na">or</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">stringValue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span>
        <span class="k">break</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">textValue</span><span class="o">.</span><span class="na">isNull</span><span class="o">().</span><span class="na">or</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">textValue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span>
        <span class="k">break</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">RICH_TEXT</span><span class="o">:</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">richTextValue</span><span class="o">.</span><span class="na">isNull</span><span class="o">().</span><span class="na">or</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">richTextValue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span>
        <span class="k">break</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">DATE</span><span class="o">:</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">dateValue</span><span class="o">.</span><span class="na">isNull</span><span class="o">())</span>
        <span class="k">break</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">INTEGER</span><span class="o">:</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">integerValue</span><span class="o">.</span><span class="na">isNull</span><span class="o">())</span>
        <span class="k">break</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">DECIMAL</span><span class="o">:</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">decimalValue</span><span class="o">.</span><span class="na">isNull</span><span class="o">())</span>
        <span class="k">break</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">LINKED_ENTITY</span><span class="o">:</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">linkedEntityId</span><span class="o">.</span><span class="na">isNull</span><span class="o">())</span>
        <span class="k">break</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">SINGLE_SELECTION</span><span class="o">:</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">enumeratedValue</span><span class="o">.</span><span class="na">isNull</span><span class="o">())</span>
        <span class="k">break</span>
    <span class="k">case</span> <span class="n">CustomFieldType</span><span class="o">.</span><span class="na">MULTI_SELECTION</span><span class="o">:</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">enumeratedValues</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span>
        <span class="k">break</span>

    <span class="nl">default:</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s2">"Unhandled custom field type: ${field.type}"</span><span class="o">)</span>
<span class="o">}</span>

<span class="n">query</span><span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">creationDate</span><span class="o">.</span><span class="na">desc</span><span class="o">())</span>

<span class="c1">// Execute the query</span>
<span class="kt">def</span> <span class="n">page</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">page</span><span class="o">(</span><span class="n">currentPage</span><span class="o">,</span> <span class="n">pageSize</span><span class="o">,</span> <span class="n">skipTotalCount</span><span class="o">,</span> <span class="n">r</span><span class="o">)</span> <span class="k">as</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">UserRecord</span><span class="o">&gt;</span>
<span class="kt">def</span> <span class="n">projection</span> <span class="o">=</span> <span class="o">{</span>
    <span class="o">[</span>
        <span class="nl">id:</span> <span class="n">it</span><span class="o">.</span><span class="na">id</span><span class="o">,</span>
        <span class="nl">date:</span> <span class="n">it</span><span class="o">.</span><span class="na">creationDate</span><span class="o">,</span>
        <span class="nl">user:</span> <span class="n">it</span><span class="o">.</span><span class="na">user</span><span class="o">.</span><span class="na">displayForManagers</span><span class="o">,</span>
        <span class="c1">// This will use the record type's 'Display records as',</span>
        <span class="c1">// which can be set to something like: "{fieldA} of {fieldB}"</span>
        <span class="c1">// and defaults to: "{type} ({id})"</span>
        <span class="nl">record:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">it</span><span class="o">)</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="c1">// Return the records without value</span>
<span class="k">return</span> <span class="o">[</span>
    <span class="nl">columns:</span> <span class="o">[</span>
        <span class="o">[</span><span class="nl">header:</span> <span class="n">translationHandler</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="n">UsersKeys</span><span class="o">.</span><span class="na">Records</span><span class="o">.</span><span class="na">CREATION_DATE</span><span class="o">),</span> <span class="nl">property:</span> <span class="s1">'date'</span><span class="o">,</span> <span class="nl">type:</span> <span class="s1">'date'</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">header:</span> <span class="n">translationHandler</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="n">UsersKeys</span><span class="o">.</span><span class="na">Records</span><span class="o">.</span><span class="na">USER</span><span class="o">),</span> <span class="nl">property:</span> <span class="s1">'user'</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">header:</span> <span class="n">translationHandler</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="n">GeneralKeys</span><span class="o">.</span><span class="na">InitialData</span><span class="o">.</span><span class="na">RECORD_TYPE</span><span class="o">),</span> <span class="nl">property:</span> <span class="s1">'record'</span><span class="o">]</span>
    <span class="o">],</span>
    <span class="nl">rows:</span> <span class="n">PageImpl</span><span class="o">.</span><span class="na">transformed</span><span class="o">(</span><span class="n">page</span><span class="o">,</span> <span class="n">projection</span><span class="o">),</span>
    <span class="nl">totalCount:</span> <span class="n">page</span><span class="o">.</span><span class="na">totalCount</span><span class="o">,</span>
    <span class="nl">hasNextPage:</span> <span class="n">page</span><span class="o">.</span><span class="na">hasNextPage</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the custom operation, besides setting the script, also set 2 parameters in the "Script parameters" field:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>recordType</code>: internal name of the record type to search;</p>
</li>
<li>
<p><code>field</code>: internal name of the custom field to search.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-easy-invoice-link">Get easy invoice link / QR-Code</h6>
<div class="paragraph">
<p>This example presents users a link and QR-code which can be shared for other users to pay him / her (easy invoice). The QR-code can be scanned by the Cyclos mobile application from the payer. To use it, you will need the following content in the script parameters box:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c">## The message shown above
</span><span class="py">message</span><span class="p">=</span><span class="s">You can copy and share the following easy invoice link or QR-code, </span><span class="se">\
</span><span class="s">which can be scanned by the Cyclos mobile application:</span>

<span class="c">## Currency to be appended to the URL.
## Not needed if users have a single currency.
# currency=unit
</span>
<span class="c">## Payment type to be appended to the URL.
## Not needed if users have a single payment type.
</span><span class="py">paymentType</span><span class="p">=</span><span class="s">user.tradeTransfer</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, use the following script code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.apache.commons.text.StringEscapeUtils</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="kt">def</span> <span class="n">rootUrl</span> <span class="o">=</span> <span class="n">sessionData</span><span class="o">.</span><span class="na">configuration</span><span class="o">.</span><span class="na">fullUrl</span>

<span class="c1">// Get the amount</span>
<span class="kt">def</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">amount</span><span class="o">.</span><span class="na">toPlainString</span><span class="o">()</span>

<span class="c1">// Get the description</span>
<span class="kt">def</span> <span class="n">description</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">description</span>

<span class="c1">// Get the to user his username</span>
<span class="kt">def</span> <span class="n">to</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">username</span>

<span class="kt">def</span> <span class="n">parameters</span> <span class="o">=</span> <span class="s2">"&amp;amount=${amount}"</span>
<span class="k">if</span> <span class="o">(</span><span class="n">StringHelper</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">description</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">encodeURIComponent</span><span class="o">(</span><span class="n">description</span><span class="o">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">description</span><span class="o">,</span> <span class="s2">"+"</span><span class="o">,</span> <span class="s2">"%20"</span><span class="o">)</span>
    <span class="n">parameters</span> <span class="o">+=</span> <span class="s2">"&amp;description=${description}"</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">StringHelper</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">currency</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">parameters</span> <span class="o">+=</span> <span class="s2">"&amp;currency=${scriptParameters.currency}"</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">StringHelper</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">paymentType</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">parameters</span> <span class="o">+=</span> <span class="s2">"&amp;type=${scriptParameters.paymentType}"</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">"${rootUrl}/pay/?to=${to}${parameters}"</span>
<span class="kt">def</span> <span class="n">qrCode</span> <span class="o">=</span> <span class="s2">"${rootUrl}/api/tickets/easy-invoice-qr-code/*:${to}?size=medium${parameters}"</span>

<span class="c1">// Return the result</span>
<span class="k">return</span> <span class="s2">"""
&lt;p&gt;${scriptParameters.message}&lt;/p&gt;
&lt;p&gt;
    &lt;br&gt;
    &lt;a href="${url}" target="_blank"&gt;${StringEscapeUtils.escapeHtml4(url)}&lt;/a&gt;
&lt;/p&gt;
&lt;p style="text-align:center"&gt;
    &lt;br&gt;
    &lt;img src="${qrCode}"&gt;
&lt;/p&gt;
"""</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create the custom operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Easy invoice;</p>
</li>
<li>
<p><strong>Script</strong>: Select the Get easy invoice link / QR-Code script;</p>
</li>
<li>
<p><strong>Scope</strong>: User;</p>
</li>
<li>
<p><strong>Result type</strong>: Rich text.</p>
<div class="literalblock">
<div class="content">
<pre>Finally, after saving, add the following form parameters:</pre>
</div>
</div>
</li>
<li>
<p><strong>Amount</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>amount</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Decimal;</p>
</li>
<li>
<p><strong>Decimal digits</strong>: 2 (adjust according to the currency);</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Description</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>description</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Multi-line text;</p>
</li>
<li>
<p><strong>Required</strong>: No.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-loan-request">Loan request (content page with action)</h6>
<div class="paragraph">
<p>This example shows some input fields for users to request a loan. Then shows the loan details and an action for the user to send the loan application. When clicked, an e-mail is sent with the request data, so the administration can actually handle that loan.</p>
</div>
<div class="paragraph">
<p>As both scripts calculate the loan, another script of type library is used. It contains a parameter for the interest rate. So, first is the code for the "Loan application" library script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.math.RoundingMode</span>

<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>

<span class="kn">import</span> <span class="nn">groovy.xml.MarkupBuilder</span>

<span class="cm">/**
 * Calculates the installment amount by composite monthly interests
 */</span>
<span class="kt">def</span> <span class="nf">installmentAmount</span><span class="o">(</span><span class="kt">double</span> <span class="n">rate</span><span class="o">,</span> <span class="kt">double</span> <span class="n">totalAmount</span><span class="o">,</span> <span class="kt">int</span> <span class="n">installments</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">rate</span> <span class="o">/=</span> <span class="mf">100.0</span>
    <span class="kt">double</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">rate</span> <span class="s">/ (1 - (1 /</span> <span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rate</span><span class="o">,</span> <span class="n">installments</span><span class="o">)))</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">BigDecimal</span><span class="o">(</span><span class="n">totalAmount</span> <span class="o">*</span> <span class="n">cf</span><span class="o">).</span><span class="na">setScale</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">RoundingMode</span><span class="o">.</span><span class="na">HALF_UP</span><span class="o">)</span>
<span class="o">}</span>

<span class="cm">/**
 * Returns an HTML with the loan request details
 */</span>
<span class="n">String</span> <span class="nf">loanRequestHTML</span><span class="o">(</span><span class="kt">double</span> <span class="n">rate</span><span class="o">,</span> <span class="kt">double</span> <span class="n">reqAmount</span><span class="o">,</span> <span class="kt">int</span> <span class="n">installments</span><span class="o">,</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">instAmount</span> <span class="o">=</span> <span class="n">installmentAmount</span><span class="o">(</span><span class="n">rate</span><span class="o">,</span> <span class="n">reqAmount</span><span class="o">,</span> <span class="n">installments</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">totalAmount</span> <span class="o">=</span> <span class="n">instAmount</span> <span class="o">*</span> <span class="n">installments</span>
    <span class="kt">def</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">()</span>
    <span class="n">MarkupBuilder</span> <span class="n">html</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MarkupBuilder</span><span class="o">(</span><span class="n">out</span><span class="o">)</span>
    <span class="n">html</span><span class="o">.</span><span class="na">div</span> <span class="o">{</span>
        <span class="n">table</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">tr</span> <span class="o">{</span>
                    <span class="n">td</span> <span class="nl">width:</span><span class="s2">"200px"</span><span class="o">,</span> <span class="o">{</span> <span class="n">b</span> <span class="s2">"Requested by user"</span> <span class="o">}</span>
                    <span class="n">td</span> <span class="s2">"${user.name} (${user.username})"</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">tr</span> <span class="o">{</span>
                <span class="n">td</span> <span class="nl">width:</span><span class="s2">"200px"</span><span class="o">,</span> <span class="o">{</span> <span class="n">b</span> <span class="s2">"Monthly interest rates"</span> <span class="o">}</span>
                <span class="n">td</span> <span class="s2">"${formatter.format(rate as BigDecimal)}% per month"</span>
            <span class="o">}</span>
            <span class="n">tr</span> <span class="o">{</span>
                <span class="n">td</span> <span class="o">{</span> <span class="n">b</span> <span class="s2">"Requested amount"</span> <span class="o">}</span>
                <span class="n">td</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">reqAmount</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="n">tr</span> <span class="o">{</span>
                <span class="n">td</span> <span class="o">{</span> <span class="n">b</span> <span class="s2">"Total amount to be repaid"</span> <span class="o">}</span>
                <span class="n">td</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">totalAmount</span> <span class="k">as</span> <span class="n">BigDecimal</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="n">tr</span> <span class="o">{</span>
                <span class="n">td</span> <span class="nl">colspan:</span> <span class="mi">2</span><span class="o">,</span> <span class="o">{</span> <span class="n">b</span> <span class="s2">"Installments"</span>
                <span class="o">}</span> <span class="o">}</span>
            <span class="n">tr</span> <span class="o">{</span>
                <span class="n">td</span> <span class="nl">style:</span><span class="s2">"text-align:center"</span><span class="o">,</span> <span class="o">{</span> <span class="n">b</span> <span class="s2">"Due date"</span> <span class="o">}</span>
                <span class="n">td</span> <span class="nl">style:</span><span class="s2">"text-align:right"</span><span class="o">,</span> <span class="o">{</span> <span class="n">b</span> <span class="s2">"Due amount"</span> <span class="o">}</span>
            <span class="o">}</span>
            <span class="kt">def</span> <span class="n">cal</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">()</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">installments</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">cal</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Calendar</span><span class="o">.</span><span class="na">MONTH</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
                <span class="n">tr</span> <span class="o">{</span>
                    <span class="n">td</span> <span class="nl">style:</span><span class="s2">"text-align:center"</span><span class="o">,</span> <span class="o">{</span> <span class="n">b</span> <span class="n">formatter</span><span class="o">.</span><span class="na">formatAsDate</span><span class="o">(</span><span class="n">cal</span><span class="o">.</span><span class="na">time</span><span class="o">)</span> <span class="o">}</span>
                    <span class="n">td</span> <span class="nl">style:</span><span class="s2">"text-align:right"</span><span class="o">,</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">instAmount</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This script needs a parameter which is the interest rate. So, paste this in the script parameters field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">monthlyInterests</span><span class="o">=</span><span class="mf">0.75</span>
<span class="n">email</span><span class="o">=</span><span class="n">admin</span><span class="nd">@admin</span><span class="o">-</span><span class="n">email</span><span class="o">.</span><span class="na">com</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the code for the custom operation that requests the loan.
Don&#8217;t forget to include the loan application library in the script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">monthlyInterests</span> <span class="k">as</span> <span class="kt">double</span>
<span class="kt">def</span> <span class="n">reqAmount</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">amount</span> <span class="k">as</span> <span class="n">BigDecimal</span>
<span class="kt">def</span> <span class="n">instCount</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">installments</span> <span class="k">as</span> <span class="kt">int</span>

<span class="k">return</span> <span class="o">[</span>
    <span class="nl">title:</span> <span class="s2">"Loan request details"</span><span class="o">,</span>
    <span class="nl">content:</span> <span class="n">loanRequestHTML</span><span class="o">(</span><span class="n">rate</span><span class="o">,</span> <span class="n">reqAmount</span><span class="o">,</span> <span class="n">instCount</span><span class="o">,</span> <span class="kc">null</span><span class="o">),</span>
    <span class="nl">actions:</span> <span class="o">[</span>
        <span class="nl">submitLoanApplication:</span> <span class="o">[</span>
            <span class="nl">parameters:</span> <span class="o">[</span>
                <span class="nl">user:</span> <span class="n">user</span><span class="o">.</span><span class="na">id</span>
            <span class="o">]</span>
        <span class="o">]</span>
    <span class="o">]</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is the code for the custom operation that submits the loan request.
The script should also include the loan application library.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">javax.mail.internet.InternetAddress</span>

<span class="kn">import</span> <span class="nn">org.springframework.mail.javamail.MimeMessageHelper</span>

<span class="kt">def</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">monthlyInterests</span> <span class="k">as</span> <span class="kt">double</span>
<span class="kt">def</span> <span class="n">reqAmount</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">amount</span> <span class="k">as</span> <span class="n">BigDecimal</span>
<span class="kt">def</span> <span class="n">instCount</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">installments</span>
<span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">user</span>
<span class="kt">def</span> <span class="n">body</span> <span class="o">=</span> <span class="n">loanRequestHTML</span><span class="o">(</span><span class="n">rate</span><span class="o">,</span> <span class="n">reqAmount</span><span class="o">,</span> <span class="n">instCount</span><span class="o">,</span> <span class="n">user</span><span class="o">)</span>

<span class="kt">def</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">mailHandler</span><span class="o">.</span><span class="na">mailSender</span>
<span class="kt">def</span> <span class="n">message</span> <span class="o">=</span> <span class="n">sender</span><span class="o">.</span><span class="na">createMimeMessage</span><span class="o">()</span>
<span class="kt">def</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessageHelper</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s2">"UTF-8"</span><span class="o">)</span>

<span class="n">helper</span><span class="o">.</span><span class="na">to</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">email</span><span class="o">)</span>
<span class="n">helper</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">email</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">)</span>
<span class="n">helper</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="s2">"Loan request"</span>
<span class="n">helper</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
<span class="n">sender</span><span class="o">.</span><span class="na">send</span> <span class="n">message</span>

<span class="k">return</span> <span class="s2">"The loan request was sent to the administration"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before creating the custom operation for the loan application itself, create the one for the action, with the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Send loan application;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>submitLoanApplication</code>;</p>
</li>
<li>
<p><strong>Label</strong>: Send;</p>
</li>
<li>
<p><strong>Script</strong>: Select the one with the code to send the application;</p>
</li>
<li>
<p><strong>Main menu</strong>: Banking;</p>
</li>
<li>
<p><strong>Scope</strong>: Internal;</p>
</li>
<li>
<p><strong>Result type</strong>: Notification.</p>
<div class="literalblock">
<div class="content">
<pre>Then, after saving, add the following form parameters:</pre>
</div>
</div>
</li>
<li>
<p><strong>Total amount</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>amount</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Decimal;</p>
</li>
<li>
<p><strong>Decimal digits</strong>: 2;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Number of installments</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>installments</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Integer;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>User</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>user</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Linked entity;</p>
</li>
<li>
<p><strong>Linked entity type</strong>: User;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then create the custom operation with the loan application form:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Loan application;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>loanApplication</code>;</p>
</li>
<li>
<p><strong>Script</strong>: Select the loan application request script;</p>
</li>
<li>
<p><strong>Scope</strong>: user;</p>
</li>
<li>
<p><strong>Result type</strong>: Rich text.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, after saving, add the following form parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Total amount</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>amount</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Decimal;</p>
</li>
<li>
<p><strong>Decimal digits</strong>: 2;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Number of installments</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>installments</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Integer;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>And add another action in the actions tab:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Total amount</strong>: Map to this operation&#8217;s Total amount;</p>
</li>
<li>
<p><strong>Number of installments</strong>: Map to this operation&#8217;s Number of installments;</p>
</li>
<li>
<p><strong>User</strong>: Set it for the script to define the value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After granting permission to the Loan application custom operation, it should appear in the menu.</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-external-records">Searching external records</h6>
<div class="paragraph">
<p>The following is an example script for a custom operation which lists fictional external records. It needs to have as URL action the custom operation presented ahead to show an external record details, and pass the URL parameter <code>recordId</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="k">return</span> <span class="o">[</span>
    <span class="nl">columns:</span> <span class="o">[</span>
        <span class="o">[</span><span class="nl">header:</span><span class="s2">"Name"</span><span class="o">,</span> <span class="nl">property:</span><span class="s2">"name"</span><span class="o">]</span>
    <span class="o">],</span>
    <span class="nl">rows:</span> <span class="o">[</span>
        <span class="o">[</span><span class="nl">name:</span> <span class="s2">"Record 1"</span><span class="o">,</span> <span class="nl">recordId:</span> <span class="mi">1</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">name:</span> <span class="s2">"Record 2"</span><span class="o">,</span> <span class="nl">recordId:</span> <span class="mi">2</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">name:</span> <span class="s2">"Record 3"</span><span class="o">,</span> <span class="nl">recordId:</span> <span class="mi">3</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">name:</span> <span class="s2">"Record 4"</span><span class="o">,</span> <span class="nl">recordId:</span> <span class="mi">4</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">name:</span> <span class="s2">"Record 5"</span><span class="o">,</span> <span class="nl">recordId:</span> <span class="mi">5</span><span class="o">],</span>
        <span class="o">[</span><span class="nl">name:</span> <span class="s2">"Invalid Record"</span><span class="o">,</span> <span class="nl">recordId:</span> <span class="mi">99999</span><span class="o">],</span>
    <span class="o">]</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then another custom operation, which should be defined as internal, and have a form field which internal name <code>recordId</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.EntityNotFoundException</span>

<span class="c1">// Validate the id</span>
<span class="kt">def</span> <span class="n">recordId</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">recordId</span>
<span class="kt">def</span> <span class="n">validIds</span> <span class="o">=</span> <span class="mi">1</span><span class="o">..</span><span class="mi">50</span>
<span class="k">if</span> <span class="o">(!(</span><span class="n">recordId</span> <span class="k">in</span> <span class="n">validIds</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">EntityNotFoundException</span><span class="o">([</span>
        <span class="nl">entityType:</span> <span class="s2">"External record"</span><span class="o">,</span>
        <span class="nl">key:</span> <span class="n">recordId</span> <span class="k">as</span> <span class="n">String</span><span class="o">])</span>
<span class="o">}</span>

<span class="k">return</span> <span class="o">[</span>
    <span class="nl">title:</span> <span class="s2">"Details for record ${recordId}"</span><span class="o">,</span>
    <span class="nl">content:</span> <span class="s2">"This is the description for record ${recordId}"</span>
<span class="o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-bulk-action-payment">Bulk action to perform a payment from system</h6>
<div class="paragraph">
<p>This is an example of a bulk action custom operation that performs a payment from a system account to each processed user. The script checks if the user has the account that receives the payment. If not, it is marked as skipped for that bulk action. If the user has the account, the payment is performed.</p>
</div>
<div class="paragraph">
<p>The script needs as parameters, the internal name of the system account and payment type, like this (make sure to check that the internal names are correct):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">systemAccount</span><span class="p">=</span><span class="s">debit</span>
<span class="py">paymentType</span><span class="p">=</span><span class="s">toUser</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the custom operation script block should be as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.TransferType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.EntityNotFoundException</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.SystemAccountOwner</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PerformPaymentDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transfertypes.TransferTypeVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.bulkactions.BulkActionUserStatus</span>

<span class="kt">def</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">TransferType</span><span class="o">,</span>
        <span class="s2">"${scriptParameters.systemAccount}.${scriptParameters.paymentType}"</span><span class="o">)</span>

<span class="c1">// Check if the user has the destination account type</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">accountService</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">tt</span><span class="o">.</span><span class="na">to</span><span class="o">)</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">EntityNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">BulkActionUserStatus</span><span class="o">.</span><span class="na">SKIPPED</span>
<span class="o">}</span>

<span class="c1">// Perform the payment</span>
<span class="kt">def</span> <span class="n">dto</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PerformPaymentDTO</span><span class="o">()</span>
<span class="n">dto</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">SystemAccountOwner</span><span class="o">.</span><span class="na">instance</span><span class="o">()</span>
<span class="n">dto</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="n">user</span>
<span class="n">dto</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransferTypeVO</span><span class="o">(</span><span class="n">tt</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
<span class="n">dto</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">amount</span>
<span class="n">paymentService</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">dto</span><span class="o">)</span>
<span class="k">return</span> <span class="n">BulkActionUserStatus</span><span class="o">.</span><span class="na">SUCCESS</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operations-example-bulk-action-remove-canceled-tokens">Bulk action to remove canceled tokens</h6>
<div class="paragraph">
<p>In this example a bulk action is used to remove canceled tokens, optionally filtering by type. If a type is selected, only the canceled tokens of that type will be removed, otherwise all canceled tokens will be removed.</p>
</div>
<div class="paragraph">
<p>First, create the script to load token principal types (of type <a href="#scripting-type-load-field-values">load custom field values</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.system.fields.DynamicFieldValueVO</span>

<span class="k">return</span> <span class="n">principalTypeService</span><span class="o">.</span><span class="na">listUserTokenPermissions</span><span class="o">(</span><span class="kc">null</span><span class="o">).</span><span class="na">collect</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nf">DynamicFieldValueVO</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">internalName</span><span class="o">,</span> <span class="n">it</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">name</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the script for the custom operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.access.principaltypes.TokenPrincipalTypeVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.access.tokens.TokenQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.access.tokens.TokenStatus</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.utils.ModelHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.CollectionHelper</span>

<span class="kt">def</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TokenQuery</span><span class="o">()</span>
<span class="n">query</span><span class="o">.</span><span class="na">setUnlimited</span><span class="o">()</span>
<span class="n">query</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="n">conversionHandler</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">UserVO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">user</span><span class="o">))</span>
<span class="n">query</span><span class="o">.</span><span class="na">setStatuses</span><span class="o">(</span><span class="n">CollectionHelper</span><span class="o">.</span><span class="na">asSet</span><span class="o">(</span><span class="n">TokenStatus</span><span class="o">.</span><span class="na">CANCELED</span><span class="o">))</span>
<span class="k">if</span> <span class="o">(</span><span class="n">formParameters</span><span class="o">.</span><span class="na">tokenType</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">query</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">ModelHelper</span><span class="o">.</span><span class="na">voFromString</span><span class="o">(</span><span class="n">TokenPrincipalTypeVO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">tokenType</span><span class="o">.</span><span class="na">value</span><span class="o">))</span>
<span class="o">}</span>

<span class="n">tokenService</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="na">getPageItems</span><span class="o">().</span><span class="na">each</span><span class="o">{</span> <span class="n">tokenService</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span> <span class="o">}</span>

<span class="k">return</span> <span class="s2">"Tokens removed successfully"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create the custom operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Remove canceled tokens (Can be changed);</p>
</li>
<li>
<p><strong>Scope</strong>: Bulk action;</p>
</li>
<li>
<p><strong>Script</strong>: Remove canceled tokens (the script created above);</p>
</li>
<li>
<p><strong>Show form</strong>: Always.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, after saving, add the following form parameter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Display name</strong>: Token type;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>tokenType</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Dynamic selection;</p>
</li>
<li>
<p><strong>Load values script</strong>: Load token types (The first script created);</p>
</li>
<li>
<p><strong>Field type</strong>: Dropdown;</p>
</li>
<li>
<p><strong>Required</strong>: No (Set it in "Yes" if you don&#8217;t want to let the user who runs the bulk action remove tokens of all types at once).</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-operation-rate-app">Mobile app rating</h6>
<div class="paragraph">
<p>This example allows rating the mobile app in Google Play and App Store</p>
</div>
<div class="paragraph">
<p>First create the script which handles the link redirection, this will open up in the store where the user can give an app rating</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">userAgent</span> <span class="o">=</span> <span class="n">userAgentHandler</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">sessionData</span><span class="o">.</span><span class="na">requestData</span><span class="o">.</span><span class="na">requestInfo</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">platform</span> <span class="o">=</span> <span class="n">userAgent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">userAgent</span><span class="o">.</span><span class="na">operatingSystem</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span>

<span class="k">if</span> <span class="o">(</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">'android'</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Replace &lt;package-name&gt; with your Android application package</span>
    <span class="k">return</span> <span class="s1">'market://details?id=&lt;package-name&gt;'</span>
<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">'ios'</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Replace &lt;app-id&gt; with your id from the App Store</span>
    <span class="k">return</span> <span class="s1">'itms-apps://itunes.apple.com/app/id&lt;app-id&gt;'</span>
<span class="o">}</span>

<span class="c1">// We should never reach here when connecting from a mobile device</span>
<span class="k">return</span> <span class="s2">""</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create the custom operation, in case you prefer to show the action in the Mobile app homepage use scope 'User' or in case you want to rate after a payment use scope 'Transfer':</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Rate app;</p>
</li>
<li>
<p><strong>Scope</strong>: User / Transfer;</p>
</li>
<li>
<p><strong>Enabled for channels</strong>: Mobile app;</p>
</li>
<li>
<p><strong>Script</strong>: Rate app (the script created above);</p>
</li>
<li>
<p><strong>Result type</strong>: URL.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_sending_mobile_app_notifications">Sending mobile app notifications</h6>
<div class="paragraph">
<p>The following example shows how to send a mobile app notification directly to a user.
Such notifications will be shown to the user even if the mobile application is not running or is running in background.
The underlying implementation uses Firebase Cloud Messaging (FCM) to send the notifications.
How to configure FCM is included in the documentation of the mobile application, if you do not have access to it please contact STRO at <a href="mailto:info@cyclos.org">info@cyclos.org</a>.</p>
</div>
<div class="paragraph">
<p>Before continue, please check the support Cyclos already has for mobile app mailings and also for sending all internal notifications as mobile app notifications.
See <a href="#scripting-type-notifications">this</a> to know how to customize the notifications.</p>
</div>
<div class="paragraph">
<p>You should consider this example only if the above options do not fulfil your particular requirements.</p>
</div>
<div class="paragraph">
<p>The script below assumes you created a custom operation with scope <code>User</code> associated with it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.appnotifications.AppNotificationHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.appnotifications.AppNotificationMessage</span>

<span class="n">ScriptHelper</span> <span class="n">scriptHelper</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptHelper</span>
<span class="c1">// Get a reference to the app notification handler</span>
<span class="n">AppNotificationHandler</span> <span class="n">appNotificationHandler</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">AppNotificationHandler</span><span class="o">)</span>

<span class="k">if</span> <span class="o">(</span><span class="n">appNotificationHandler</span><span class="o">.</span><span class="na">canReceiveNotifications</span><span class="o">(</span><span class="n">user</span><span class="o">))</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">AppNotificationMessage</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="s2">"Sample title"</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">body</span> <span class="o">=</span> <span class="s2">"Sample body"</span>
    <span class="c1">// (Optional) You can set the notification icon color (RGB format) to be shown in the notification drawer (only for Android). Default: null</span>
    <span class="c1">// builder.androidIconColor = '#f79734'</span>

    <span class="c1">// (Optional) You can set the public URL of a custom system/user image. Default: null</span>
    <span class="c1">//builder.imageUrl =</span>

    <span class="c1">// (Optional) Whether to show a badge for the iOS notification or not. Default: true</span>
    <span class="c1">//builer.iosBadge = true</span>

    <span class="c1">//(Optional) Instruct to go to the profile page when the user tap in the notification. Default: empty</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">variables</span> <span class="o">=</span> <span class="o">[</span>
        <span class="nl">customUrl:</span> <span class="s1">'cyclos://profile'</span><span class="o">,</span>
        <span class="nl">userId:</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">maskId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">toString</span><span class="o">()</span>
    <span class="o">]</span>
    <span class="c1">// Send the notification</span>
    <span class="k">return</span> <span class="n">appNotificationHandler</span><span class="o">.</span><span class="na">notify</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">())</span> <span class="o">?</span>
            <span class="s2">"Notification sent to ${user.username}"</span> <span class="o">:</span>
            <span class="s2">"The notification could not be sent to ${user.username}"</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s2">"User ${user.username} can not receive notifications!"</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-wizards">4.4.12. Custom wizards</h4>
<div class="paragraph">
<p>These scripts are invoked when a user runs a custom wizard. A custom wizard can be of the following types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Registration</strong>: Replaces the registration form. Gives the opportunity to present custom fields defined in the wizard itself, allowing more data to be collected and processed by script. Besides creating the script and the wizard, in the Configuration menu, the wizards should be set for registration on large screens (desktops), medium screens (tablets) and small screens (phones). When all 3 are set, the regular registration form / API is disabled;</p>
</li>
<li>
<p><strong>User</strong>: The wizard is executed by users via a menu item. Can also be set for administrators and brokers to run over other users via the profile;</p>
</li>
<li>
<p><strong>System</strong>: The wizard is executed by administrators via a menu item;</p>
</li>
<li>
<p><strong>Guest</strong>: The wizard is executed by guests. Can be shown in a menu via the menu entries in content management.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A wizard consists of several steps, which are manually ordered. When the wizard starts, by default the first step is shown. On each transition, by default the next step is executed, until the last step. After finishing the wizard, a result is shown.</p>
</div>
<div class="paragraph">
<p>Script can control which is the first step, and which are the possible transitions between steps. The transitions are determined before the step is shown, because each possible transition is displayed as a different button to users. When the script doesn&#8217;t return any transitions, the default is to use a single transition to the next step in the defined order.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-wizards-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>In all cases, the script will have the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>wizard</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWizard.html">org.cyclos.entities.system.CustomWizard</a> being executed;</p>
</li>
<li>
<p><code>execution</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWizardExecution.html">org.cyclos.entities.system.CustomWizardExecution</a> which contains all data for a given wizard execution, and is shared between steps;</p>
</li>
<li>
<p><code>step</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWizardStep.html">org.cyclos.entities.system.CustomWizardStep</a>. On transition, is the candidate next step;</p>
</li>
<li>
<p><code>previousStep</code>: The previous <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWizardStep.html">org.cyclos.entities.system.CustomWizardStep</a>. Only available in the transition function;</p>
</li>
<li>
<p><code>transition</code>: The transition id the user has selected. Only present on transitions;</p>
</li>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a>. The meaning depends on the wizard type. For registration wizards, it is only present in the finish function, and it is the newly registered user. For user wizards it is the user over which it is being executed;</p>
</li>
<li>
<p><code>steps</code>: The list of all steps, together with the possible transitions executed so far. Is a list of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/CustomWizardStepWithTransitions.html">org.cyclos.impl.system.CustomWizardStepWithTransitions</a>;</p>
</li>
<li>
<p><code>storage</code>: A <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/CustomWizardExecutionStorage.html">org.cyclos.impl.system.CustomWizardExecutionStorage</a> which is shared between all steps. Scripts can use it to pass data between steps, and to the final execution script function;</p>
</li>
<li>
<p><code>registration</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/users/users/PublicRegistrationDTO.html">org.cyclos.model.users.users.PublicRegistrationDTO</a> which is filled-in on each step. Only present for registration wizards. To persist any modification, assign it back to the storage, using <code>storage.registration = registration</code>;</p>
</li>
<li>
<p><code>customValues</code>: A Map&lt;String, Object&gt; keyed by custom field internal name, whose values are the values filled-in during the execution. Do not confuse it with custom profile fields, which are stored in the registration object. To persist any modification, assign it back to the storage, using <code>storage.customValues = customValues</code>;</p>
</li>
<li>
<p><code>returnUrl</code>: The URL to pass to the external system on external redirects. Is the URL to which the external system should redirect the user when returning to Cyclos;</p>
</li>
<li>
<p><code>request</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/RequestInfo.html">org.cyclos.model.utils.RequestInfo</a>. Only present on the script that runs the callback after an external redirect. Contains the information about the current request, so the script function which handles the callback can identify the context to complete the process.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-wizard-finish">Finish</h5>
<div class="paragraph">
<p>This is the only required code block. The script is executed after finishing the last step. For registration wizards, the script is executed after the user has been registered, so additional actions can be performed on that user, and the result is ignored. For other wizards, this is the action executed on finish.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-wizard-finish-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p><strong>String</strong>: The result content, which is handled either as plain text or HTML, depending on the wizard configuration;</p>
</li>
<li>
<p><strong>Object</strong> or <strong>Map</strong>: With the following properties</p>
<div class="ulist">
<ul>
<li>
<p><code>title</code>: The page title displayed on result;</p>
</li>
<li>
<p><code>result</code>: The result content.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-wizard-new">New execution</h5>
<div class="paragraph">
<p>This code is executed whenever a new execution starts. It is used to determine the initial step.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-wizard-new-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Null</strong>: The first step in order ise used as the initial step. It will have a single transition, to the subsequent step in order;</p>
</li>
<li>
<p><strong>String</strong>: The internal name of a step. It will have a single transition, to the next step in order;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWizardStep.html">org.cyclos.entities.system.CustomWizardStep</a>: A reference to the initial step. It will have a single transition, to the next step in order;</p>
</li>
<li>
<p><strong>Object</strong> or <strong>Map</strong>: With the following properties:</p>
<div class="ulist">
<ul>
<li>
<p><code>step</code>: Either a string with the internal name or the initial step itself;</p>
</li>
<li>
<p><code>transitions</code>: A single value or collection of the possible transitions. Each element should be an object or Map with the following properties:</p>
<div class="ulist">
<ul>
<li>
<p><code>id</code>: The transition id. This string is passed by clients when transitioning between steps, and is passed to the <a href="#scripting-type-wizard-transition">function that handles transitions</a>;</p>
</li>
<li>
<p><code>label</code>: The label displayed in the transition button.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-wizard-transition">Transition between steps</h5>
<div class="paragraph">
<p>This code is executed whenever an execution is transitioned between steps. The script determines which is the next step and its possible new transitions for subsequent steps. The result is the same as the <a href="#scripting-type-wizard-new-result">script block above</a>. The difference is that when nothing is returned, the candidate next step is actually used.</p>
</div>
<div class="paragraph">
<p><strong>WARNING</strong>: A change was introduced in Cyclos 4.16 for this script. On previous versions, the next step must have been included in the transition, whereas starting in 4.16, only a transition id and a label are used. This allows the script to determine the next step dynamically, for example, based on a custom field presented in the previous step. The expected result also changed. Before, the step was predefined, only the possible transitions were returned. Now, the script must return which is the next step and, optionally, its transitions.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-wizard-redirect">Redirect to external site</h5>
<div class="paragraph">
<p>This code is executed when the user confirms a step which is configured as external redirect. It is used to interact with an external system during the wizard. For example, a top-up could be required during the registration process. Please, note the <code>returnUrl</code> bound variable, which is the URL to pass to the external system, indicating where the external system should redirect the user back to Cyclos.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-wizard-redirect-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p><strong>String</strong>: The URL of the external service to which the user will be redirected.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-wizard-callback">External site callback</h5>
<div class="paragraph">
<p>This code is executed after the external redirect completes.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-wizard-callback-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Null</strong> or <strong>True</strong>: The execution will automatically transition to the next step in the defined order;</p>
</li>
<li>
<p><strong>False</strong>: Is interpreted as canceling the external redirect action. The execution will stay in the current step.</p>
</li>
<li>
<p><strong>String</strong>: Is handled as the identifier of the transition for the next step.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-wizard-tips">Tips</h5>
<div class="ulist">
<ul>
<li>
<p>Use the <code>storage</code> variable to store and retrieve custom data on any step of the current execution. The storage also provides access to specialized data within the execution. See the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/CustomWizardExecutionStorage.html">class JavaDoc</a> for more details.</p>
</li>
<li>
<p>The script can send notifications, which are displayed in the current step. For that, call either <code>storage.info(message)</code>, <code>storage.warn(message)</code> or <code>storage.error(message)</code>. Once a transition happens, any pending notifications are cleared.</p>
</li>
<li>
<p>If the wizard has a step that redirects to an external site, that step cannot be the last one. That is because after the redirect back to Cyclos, the wizard will transition automatically to the next step. The wizard execution page will have to query the current status. If the execution had ended, all the context would have been lost for that execution.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-wizard-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-wizard-example-registration-top-up">Registration with a required top-up</h6>
<div class="paragraph">
<p>This example requires a top-up via PayPal for the public user registration. It uses the same PayPal library from <a href="#scripting-solution-paypal">PayPal Integration</a>. Make sure you have the library code updated.</p>
</div>
<div class="paragraph">
<p>The example uses 3 script blocks for the wizard script, plus script parameters.</p>
</div>
<div class="paragraph">
<p>Script parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># Settings for the access token record type
</span><span class="py">auth.recordType</span> <span class="p">=</span> <span class="s">paypalAuth</span>
<span class="py">auth.clientId</span> <span class="p">=</span> <span class="s">clientId</span>
<span class="py">auth.clientSecret</span> <span class="p">=</span> <span class="s">clientSecret</span>
<span class="py">auth.token</span> <span class="p">=</span> <span class="s">token</span>
<span class="py">auth.tokenExpiration</span> <span class="p">=</span> <span class="s">tokenExpiration</span>

<span class="c"># Settings for PayPal
</span><span class="py">mode</span> <span class="p">=</span> <span class="s">sandbox</span>
<span class="py">currency</span> <span class="p">=</span> <span class="s">EUR</span>
<span class="py">paymentDescription</span> <span class="p">=</span> <span class="s">Initial top-up</span>

<span class="c"># Settings for the Cyclos payment
</span><span class="py">amountMultiplier</span> <span class="p">=</span> <span class="s">1</span>
<span class="py">accountType</span> <span class="p">=</span> <span class="s">debitUnits</span>
<span class="py">paymentType</span> <span class="p">=</span> <span class="s">paypalCredits</span>

<span class="c"># Messages
</span><span class="py">error.invalidRequest</span> <span class="p">=</span> <span class="s">Invalid request</span>
<span class="py">error.transactionNotFound</span> <span class="p">=</span> <span class="s">Transaction not found</span>
<span class="py">error.transactionAlreadyApproved</span> <span class="p">=</span> <span class="s">The transaction was already approved</span>
<span class="py">error.payment</span> <span class="p">=</span> <span class="s">There was an error while processing the top-up. Please, try again.</span>
<span class="py">error.notApproved</span> <span class="p">=</span> <span class="s">The top-up was not approved</span>
<span class="py">message.canceled</span> <span class="p">=</span> <span class="s">The top-up was canceled</span>
<span class="py">message.done</span> <span class="p">=</span> <span class="s">The top-up was approved</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Script code executed when the wizard finishes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.CustomWizardExecutionStorage</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">performPayments</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
    <span class="kt">def</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptParameters</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span>
    <span class="kt">def</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayPalService</span><span class="o">(</span><span class="n">variables</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">storage</span> <span class="k">as</span> <span class="n">CustomWizardExecutionStorage</span>
    <span class="kt">def</span> <span class="n">scriptHelper</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptHelper</span> <span class="k">as</span> <span class="n">ScriptHelper</span>
    <span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">user</span> <span class="k">as</span> <span class="n">User</span>
    <span class="kt">def</span> <span class="n">orderId</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s1">'payPalOrderId'</span><span class="o">)</span>

    <span class="c1">// If no order id, return an error</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">orderId</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="s1">'No PayPal payment data'</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="kt">def</span> <span class="n">order</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getOrderFromPayPal</span><span class="o">(</span><span class="n">orderId</span><span class="o">)</span>
    <span class="k">if</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">status</span> <span class="o">==</span> <span class="s2">"APPROVED"</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Add a commit listener to perform the payments,</span>
        <span class="c1">// it will be executed after a successful registration</span>
        <span class="n">scriptHelper</span><span class="o">.</span><span class="na">addOnCommitTransactional</span><span class="o">({</span>
            <span class="c1">// Execute the PayPal payment</span>
            <span class="kt">def</span> <span class="n">capturedOrder</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">captureOrder</span><span class="o">(</span><span class="n">orderId</span><span class="o">)</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// Try to perform the payment in Cyclos,</span>
                <span class="c1">// if fails, refund the payment in PayPal</span>
                <span class="n">service</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">,</span> <span class="n">user</span><span class="o">)</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">service</span><span class="o">.</span><span class="na">refundCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">user</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">})</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="s1">'error.notApproved'</span>
        <span class="o">?:</span> <span class="s2">"The payment was not approved"</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">performPayments</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Script code executed before the user is redirected to an external site:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.system.CustomWizardExecutionStorage</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">createOrder</span><span class="o">(){</span>
    <span class="kt">def</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span>
    <span class="kt">def</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayPalService</span><span class="o">(</span><span class="n">variables</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">storage</span> <span class="k">as</span> <span class="n">CustomWizardExecutionStorage</span>

    <span class="kt">def</span> <span class="n">customValues</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">customValues</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
    <span class="kt">def</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">customValues</span><span class="o">.</span><span class="na">amount</span> <span class="k">as</span> <span class="n">Number</span>
    <span class="kt">def</span> <span class="n">returnUrl</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">returnUrl</span> <span class="k">as</span> <span class="n">String</span>

    <span class="kt">def</span> <span class="n">order</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">createOrder</span><span class="o">(</span><span class="n">amount</span><span class="o">,</span> <span class="n">returnUrl</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">link</span> <span class="o">=</span> <span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">links</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;[])</span>
            <span class="o">.</span><span class="na">find</span> <span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">rel</span> <span class="o">==</span> <span class="s2">"approve"</span><span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">link</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Store the returned order id</span>
        <span class="n">storage</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s1">'payPalOrderId'</span><span class="o">,</span> <span class="n">order</span><span class="o">.</span><span class="na">id</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
        <span class="k">return</span> <span class="n">link</span><span class="o">.</span><span class="na">href</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s2">"No approval url returned from PayPal"</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">createOrder</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Script code executed when the external site redirects the user back to Cyclos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.system.CustomWizardExecutionStorage</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.utils.RequestInfo</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">payPalCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
    <span class="kt">def</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptParameters</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span>
    <span class="kt">def</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">storage</span> <span class="k">as</span> <span class="n">CustomWizardExecutionStorage</span>
    <span class="kt">def</span> <span class="n">request</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">request</span> <span class="k">as</span> <span class="n">RequestInfo</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s1">'cancel'</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// The operation has been canceled. Don't transition</span>
        <span class="n">storage</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="s1">'message.canceled'</span>
                <span class="o">?:</span> <span class="s1">'The top-up was canceled'</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="o">}</span>
    <span class="c1">// If no order id, return an error</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">storage</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s1">'payPalOrderId'</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="s1">'Invalid request'</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">payPalCallback</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, in your registration wizard, create a custom field with internal name <code>amount</code>, of type 'Decimal', and required.
Assign that field to the wizard step that performs an external redirect (and hence, cannot be the last one).</p>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-wizard-example-next-step">Deciding the next step dynamically</h6>
<div class="paragraph">
<p>This example is for the "Script code executed on transitions between steps" to dynamically choose the next step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// Note that this example works for Cyclos 4.16 onwards</span>
<span class="k">if</span> <span class="o">(</span><span class="n">previousStep</span><span class="o">.</span><span class="na">internalName</span> <span class="o">==</span> <span class="s1">'typeSelection'</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Example of transition based on the previous step</span>
    <span class="kt">def</span> <span class="n">type</span> <span class="o">=</span> <span class="n">customValues</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">internalName</span>
    <span class="c1">// A custom field shown in the previous step is used to decide the next step</span>
    <span class="k">return</span> <span class="o">[</span>
        <span class="nl">step:</span> <span class="n">type</span> <span class="o">==</span> <span class="s1">'business'</span> <span class="o">?</span> <span class="s1">'businessFields'</span> <span class="o">:</span> <span class="s1">'consumerFields'</span><span class="o">,</span>
        <span class="nl">transitions:</span> <span class="s1">'details'</span>
    <span class="o">]</span>
<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">step</span><span class="o">.</span><span class="na">internalName</span> <span class="o">==</span> <span class="s1">'details'</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Example of a transition based on the candidate next step</span>
    <span class="kt">def</span> <span class="n">formType</span> <span class="o">=</span> <span class="n">customValues</span><span class="o">.</span><span class="na">formType</span><span class="o">.</span><span class="na">internalName</span>
    <span class="c1">// Skip the details step if on simple form and continue to confirmation</span>
    <span class="k">return</span> <span class="n">formType</span> <span class="o">==</span> <span class="s1">'simple'</span> <span class="o">?</span> <span class="s1">'confirmation'</span> <span class="o">:</span> <span class="n">step</span><span class="o">.</span><span class="na">internalName</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-web-services">4.4.13. Custom web services</h4>
<div class="paragraph">
<p>These scripts are invoked when a request is received in some path under <code>&lt;cyclos-root-url&gt;[/network]/run/*</code>. To actually run them, it is needed to create a custom web service definition in the <strong>System - Tools - Custom web services</strong> menu.</p>
</div>
<div class="paragraph">
<p>The custom web services have the following important properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The accepted HTTP methods: <code>GET</code>, <code>POST</code> or both;</p>
</li>
<li>
<p>Whether the script will be executed as a guest (optionally using a fixed HTTP username / password, with basic authorization) or as an authenticated user, like with other web services, using the same headers described in <a href="#webservices-auth">authentication in web services</a>;</p>
</li>
<li>
<p>When marked to be executed as user, it is required to grant the user permission to run it, in the product;</p>
</li>
<li>
<p>An IP address whitelist, to control which hosts can call the custom web service;</p>
</li>
<li>
<p>The URL mappings, which is a list of paths (one per line) to be matched after the <code>&lt;cyclos-root-url&gt;[/network]/run</code> root path. It is possible to specify the following types of paths:</p>
<div class="ulist">
<ul>
<li>
<p>Simple paths. For example, <code>users</code>, matches <code>&lt;cyclos-root-url&gt;[/network]/run/users</code>;</p>
</li>
<li>
<p>Nested paths. For example, <code>users/list</code>, matches <code>&lt;cyclos-root-url&gt;[/network]/run/users/list</code>;</p>
</li>
<li>
<p>Wildcards. For example, <code>users/*</code>, matches <code>&lt;cyclos-root-url&gt;[/network]/run/users/a</code>, but not <code>&lt;cyclos-root-url&gt;[/network]/run/users/a/b</code>;</p>
</li>
<li>
<p>Nested wildcards. For example, <code>users/**</code>, matches <code>&lt;cyclos-root-url&gt;[/network]/run/users/a/b/c</code>;</p>
</li>
<li>
<p>Path variables. For example, <code>users/{groupId}/{userId}</code>, matches <code>&lt;cyclos-root-url&gt;[/network]/run/users/123/78</code>, and the <code>pathVariables</code> variable will be available to the script with the value <code>{groupId:123,userId:78}</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="scripting-type-web-services-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>customWebService</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWebService.html">org.cyclos.entities.system.CustomWebService</a> being executed;</p>
</li>
<li>
<p><code>request</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/RequestInfo.html">org.cyclos.model.utils.RequestInfo</a> which allows reading the original request parameters, headers and so on;</p>
</li>
<li>
<p><code>path</code>: A string containing the path part after the <code>&lt;cyclos-root-url&gt;[/network]/run/</code> prefix. Is neither initiated or terminated with <code>/</code>;</p>
</li>
<li>
<p><code>pathVariables</code>: A <code>Map&lt;String,String&gt;</code> containing the matched path variable values.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-web-services-result">Script result</h5>
<div class="ulist">
<ul>
<li>
<p>A <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/ResponseInfo.html">org.cyclos.model.utils.ResponseInfo</a>, containing full information to build the HTTP response;</p>
</li>
<li>
<p><strong>Null</strong>: The response will have status code 200 and no body;</p>
</li>
<li>
<p><strong>String</strong>: The response will have status code 200, <code>Content-type: text/plain`</code>, and the returned string as body;</p>
</li>
<li>
<p><strong>Object</strong> or <strong>Collection</strong>: The response will have status code 200, <code>Content-type: application/json</code>, and the body will contain a JSON representation of the returned object.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-web-services-exceptions">Handling exceptions</h5>
<div class="paragraph">
<p>If the script captures an exception and wants to customize the response, instead of silencing the exception in a catch clause and returning a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/ResponseInfo.html">org.cyclos.model.utils.ResponseInfo</a>, which will cause the current transaction to commit, possibly leaving the database in an inconsistent state, the script should throw a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/ResponseException.html">org.cyclos.model.utils.ResponseException</a>, which contains a <code>ResponseInfo</code> internally. This way the main transaction is rolled back.</p>
</div>
<div class="paragraph">
<p>Other exceptions than `ResponseException`s are returned as HTTP status codes other than 200, and the details are returned as JSON.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-web-services-permissions">Permissions</h5>
<div class="paragraph">
<p>Sometimes it is useful to extend the Cyclos API to clients, like doing specific payments, or running a series of operations in a single request.
However, it is important to use the same permissions as the user would normally have, to prevent security breaches. To do so, 3 steps are needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Make sure the script uses the security layer</strong>: Whenever using a service, use the security layer instead of the direct service implementation. For example, use the <code>userServiceSecurity</code> variable instead of <code>userService</code>, which would completely bypass security checks;</p>
</li>
<li>
<p><strong>Ensure the custom web service has user authentication</strong>: On the custom web service details page, ensure it runs as user, not as guest. Also grant permission for the custom web service in the products page;</p>
</li>
<li>
<p><strong>On the script, make sure it runs with the user permissions</strong>: On the details page of the script used by the custom web service, make sure the checkbox called <strong>Run with all permissions</strong> is unchecked. This guarantees the script will run with the exact permissions as the user.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-web-services-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-web-services-example-payment">Perform a payment</h6>
<div class="paragraph">
<p>This example allows a caller to quickly perform a payment between 2 users.
It is assumed that the URL mapping is something like <code>payment/{from}/{to}/{amount}</code> and there is a single possible payment type between the 2 users.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PerformPaymentDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserLocatorVO</span>

<span class="kt">def</span> <span class="n">pmt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PerformPaymentDTO</span><span class="o">()</span>
<span class="n">pmt</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserLocatorVO</span><span class="o">(</span><span class="nl">principal:</span> <span class="n">pathVariables</span><span class="o">.</span><span class="na">from</span><span class="o">)</span>
<span class="n">pmt</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserLocatorVO</span><span class="o">(</span><span class="nl">principal:</span> <span class="n">pathVariables</span><span class="o">.</span><span class="na">to</span><span class="o">)</span>
<span class="n">pmt</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">pathVariables</span><span class="o">.</span><span class="na">getDecimal</span><span class="o">(</span><span class="s1">'amount'</span><span class="o">)</span>

<span class="c1">// Perform the payment and return the complete PaymentVO</span>
<span class="k">return</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">pmt</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-web-services-example-sso">Single-sign-on (login users without their passwords)</h6>
<div class="paragraph">
<p>With this example, it is possible to login a user (create a session) without their password. This is useful when Cyclos works as a single-sign-on, with the user authenticated by some other system.</p>
</div>
<div class="paragraph">
<p>Just be extra careful with the external security which will be employed, such as creating an IP address whitelist, a guest user / password, etc. on the custom web service, otherwise, anyone could impersonate any user.</p>
</div>
<div class="paragraph">
<p>The script receives 2 query parameters: <code>user</code>, which is the login name (or some other identification, such as e-mail) of the user to be logged in, and <code>remoteAddress</code>, which is the remote IP address of the client accessing the third party software.</p>
</div>
<div class="paragraph">
<p>The script code is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.access.SessionDataFactory</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.access.SessionHandler.CreateSessionParameters</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.access.RequestData</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.access.channels.BuiltInChannel</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserLocatorVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="kt">def</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">parameters</span><span class="o">.</span><span class="na">user</span>
<span class="kt">def</span> <span class="n">remoteAddress</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">parameters</span><span class="o">.</span><span class="na">remoteAddress</span>
<span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userLocatorHandler</span><span class="o">.</span><span class="na">locate</span><span class="o">(</span><span class="k">new</span> <span class="n">UserLocatorVO</span><span class="o">(</span><span class="nl">principal:</span> <span class="n">principal</span><span class="o">))</span>
<span class="kt">def</span> <span class="n">requestData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestData</span><span class="o">(</span><span class="n">sessionData</span><span class="o">.</span><span class="na">requestData</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">StringHelper</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">remoteAddress</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">requestData</span><span class="o">.</span><span class="na">remoteAddress</span> <span class="o">=</span> <span class="n">remoteAddress</span>
<span class="o">}</span>
<span class="kt">def</span> <span class="n">runAs</span> <span class="o">=</span> <span class="n">SessionDataFactory</span><span class="o">.</span><span class="na">direct</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
        <span class="o">.</span><span class="na">requestData</span><span class="o">(</span><span class="n">requestData</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">BuiltInChannel</span><span class="o">.</span><span class="na">MAIN</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">()</span>
<span class="kt">def</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionHandler</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="n">CreateSessionParameters</span><span class="o">(</span><span class="n">runAs</span><span class="o">))</span>
<span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="na">sessionToken</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create a custom web service, select that script and set the URL mapping to <code>login</code>. When performing a request to <code>&lt;cyclos-root&gt;/run/login?user=consumer1&amp;remoteAddress=183.165.12.7</code>, a session will be created for that user, and the session token will be returned.</p>
</div>
<div class="paragraph">
<p>It is then possible to redirect the client to <code>&lt;cyclos-root&gt;/?Session-Token=&lt;returned-session-token&gt;</code> and the user will be logged-in to Cyclos.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-interceptors">4.4.14. Service interceptors</h4>
<div class="paragraph">
<p>These scripts are invoked before and / or after specific service operations. The services are those that extend <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/services/Service.html">org.cyclos.services.Service</a>, not the REST api. The REST services use the internal services, so, ultimately, they can be intercepted too.</p>
</div>
<div class="paragraph">
<p>In order to apply these kinds of scripts, a service interceptor needs to be created, and among its properties, the following can be highlighted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Which service(s) are intercepted;</p>
</li>
<li>
<p>Which operation(s) are intercepted;</p>
</li>
<li>
<p>Which script is executed;</p>
</li>
<li>
<p>Whether the interceptor is enabled or not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Multiple service interceptors may apply over the same operation. Hence, the order is important. For this reason, interceptors are manually ordered.</p>
</div>
<div class="paragraph">
<p>Interceptors run in the same database transaction as the regular service operation. Each service operation defines whether the transaction is read-write or read-only. Operations that just read data run in a read-only transaction. In that case, attempting to write data in the database will fail. Also, even if the transaction is read-write, in the script that runs after the operation, it might happen that an error was thrown, marking the transaction as rollback. As such, service interceptor scripts should be very careful when writing to the database.</p>
</div>
<div class="paragraph">
<p>If the interceptor really needs to write to the database, it is recommended to do it in another database transaction, running after the original transaction ends. The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/ScriptHelper.html">ScriptHelper</a> class (which is bound to the script context on the <code>scriptHelper</code> variable) provides the <code>addOnCommitTransactional</code> and <code>addOnRollbackTransactional</code> methods which allow running a closure after the main transaction ends either as commit or rollback. Those methods run the code block itself inside another transaction, in which it is safe to write to the database.</p>
</div>
<div class="paragraph">
<p>There is a shared context for all interceptors, of type <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/ServiceInterceptorContext.html">org.cyclos.impl.system.ServiceInterceptorContext</a>. This context can be used to replace parameters before the original operation invocation, or even to skip the invocation altogether and return a value determined by the script. Also, the context can be used to store attributes which will be shared among interceptors or between the code that runs before and after the service invocation itself. The <code>propertyMissing</code> mechanism from Groovy is supported by the context implementation. So, for example, <code>context.myVariable = 'x'</code> will set the attribute <code>myVariable</code>.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-interceptors-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>interceptor</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/ServiceInterceptor.html">org.cyclos.entities.system.ServiceInterceptor</a> being executed;</p>
</li>
<li>
<p><code>service</code>: The java class representing the service interface being intercepted;</p>
</li>
<li>
<p><code>operation</code>: The java method representing the service operation being intercepted as <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/reflect/Method.html">java.lang.reflect.Method</a>;</p>
</li>
<li>
<p><code>context</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/ServiceInterceptorContext.html">org.cyclos.impl.system.ServiceInterceptorContext</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-interceptor-result">Script result</h5>
<div class="paragraph">
<p>The return value from the script, in both functions that run before or after, is ignored.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-interceptor-recovery">Recovering from errors in crucial services</h5>
<div class="paragraph">
<p>If there is an error in the service interceptor script, and it is applied to crucial services, such as login or the application configuration, it may render the network unusable.</p>
</div>
<div class="paragraph">
<p>In order to recover from it, it is possible to go to the global mode (<code>&lt;cyclos_root_url&gt;/global</code>), go to the network details and click on "Disable service interceptors". It will disable all service interceptors for that network, allowing the regular usage again.</p>
</div>
<div class="paragraph">
<p>After fixing the scripts, any interceptors need to be manually enabled again.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-interceptor-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-interceptor-example-transfers-filters">Modifying the general transfers overview default filters</h6>
<div class="paragraph">
<p>This example will set the default filters on transfer overview to not include chargebacks, nor transfers that were charged back. A service interceptor needs to be applied on the <code>AccountService.getAccountHistoriesOverviewData</code> operation.</p>
</div>
<div class="paragraph">
<p>The script should have this on the code that runs after the service is executed (the code for before may be left empty):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.AccountHistoriesOverviewQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transfers.TransferNature</span>

<span class="nf">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">success</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">AccountHistoriesOverviewQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">result</span><span class="o">.</span><span class="na">query</span>
    <span class="c1">// Include all transfer natures except chargeback</span>
    <span class="n">query</span><span class="o">.</span><span class="na">natures</span> <span class="o">=</span> <span class="n">EnumSet</span><span class="o">.</span><span class="na">complementOf</span><span class="o">(</span><span class="n">EnumSet</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">TransferNature</span><span class="o">.</span><span class="na">CHARGEBACK</span><span class="o">))</span>
    <span class="c1">// Also don't include transfers that were themselves charged-back</span>
    <span class="n">query</span><span class="o">.</span><span class="na">chargedBack</span> <span class="o">=</span> <span class="kc">false</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-interceptor-example-default-sms">Marking mobile phones enabled for SMS by default on registrations by administrators or brokers</h6>
<div class="paragraph">
<p>This example sets mobile phones to be enabled for SMS by default when registering a user by administrator or broker. To achieve this, create a service interceptor that captures the <code>UserService.getDataForNew</code> operation.</p>
</div>
<div class="paragraph">
<p>The script should have this on the code that runs after the service is executed (the code for before may be left empty):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="k">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">success</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">phoneData</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">result</span><span class="o">?.</span><span class="na">mobilePhoneData</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">phoneData</span><span class="o">?.</span><span class="na">canManuallyVerify</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">phoneData</span><span class="o">.</span><span class="na">verified</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-recurring-tasks">4.4.15. Custom recurring tasks</h4>
<div class="paragraph">
<p>These scripts are called periodically by custom recurring tasks. See <a href="https://wiki.cyclos.org/index.php/System_-_Scheduled_tasks">System  Scheduled tasks</a> for more details.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-recurring-tasks-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>task</code> or <code>scheduledTask</code> (deprecated): The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomRecurringTask.html">org.cyclos.entities.system.CustomRecurringTask</a> being executed;</p>
</li>
<li>
<p><code>log</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomRecurringTaskLog.html">org.cyclos.entities.system.CustomRecurringTaskLog</a> which keeps track of the current execution.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-recurring-tasks-result">Script result</h5>
<div class="ulist">
<ul>
<li>
<p><strong>String</strong>: A message to be stored in the current execution log.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-recurring-tasks-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-recurring-tasks-example-import">Periodically importing a file</h6>
<div class="paragraph">
<p>This example imports a file with users, which is expected to be located at a given directory in the file system. For other import types, it is just a matter of using distinct <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/imports/ImportedFileDTO.html">org.cyclos.model.system.imports.ImportedFileDTO</a> subclasses (some require setting some parameter, like in the example, the group for users). The recurring task just triggers the import.
From that point, the import is processed in the background, and the status can be monitored on: System - Tools - Imports menu.</p>
</div>
<div class="paragraph">
<p>To use it, you will need the following content in the script parameters box (either in the script itself or in the custom recurring task&#8217;s script parameters):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">filename</span><span class="p">=</span><span class="s">/tmp/imports/users.csv</span>
<span class="py">group</span><span class="p">=</span><span class="s">consumers</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then use the following code in the script box:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.system.imports.UserImportedFileDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.groups.GroupVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.utils.FileSizeUnit</span>
<span class="kn">import</span> <span class="nn">org.cyclos.server.utils.SerializableInputStream</span>

<span class="c1">// Resolve the users filename and the group</span>
<span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">[</span><span class="s1">'filename'</span><span class="o">]</span>
<span class="n">String</span> <span class="n">groupInternalName</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">[</span><span class="s1">'group'</span><span class="o">]</span>

<span class="c1">// Download the file to a local temp file</span>
<span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filename</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s2">"The expected file, ${filename}, doesn't exist"</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s2">"The file ${filename} is empty"</span>
<span class="o">}</span>

<span class="c1">// Caution! the SerializableInputStream automatically deletes the file</span>
<span class="c1">// when closed, except when calling, except when calling .file()</span>
<span class="kt">def</span> <span class="n">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SerializableInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">)</span>
<span class="n">stream</span><span class="o">.</span><span class="na">file</span><span class="o">()</span>

<span class="c1">// Import</span>
<span class="n">UserImportedFileDTO</span> <span class="n">dto</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserImportedFileDTO</span><span class="o">()</span>
<span class="n">dto</span><span class="o">.</span><span class="na">fileName</span> <span class="o">=</span> <span class="n">filename</span>
<span class="c1">// It is important to mark the file as automatic import,</span>
<span class="c1">// otherwise manual interaction would be required for processing</span>
<span class="n">dto</span><span class="o">.</span><span class="na">processAutomatically</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">dto</span><span class="o">.</span><span class="na">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroupVO</span><span class="o">([</span><span class="nl">internalName:</span> <span class="n">groupInternalName</span><span class="o">])</span>
<span class="n">importService</span><span class="o">.</span><span class="na">upload</span><span class="o">(</span><span class="n">dto</span><span class="o">,</span> <span class="n">stream</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>

<span class="c1">// Build a result string</span>
<span class="kt">def</span> <span class="n">fileSize</span> <span class="o">=</span> <span class="n">FileSizeUnit</span><span class="o">.</span><span class="na">nearestFileSize</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">())</span>
<span class="k">return</span> <span class="s2">"Started import of ${filename}. File size is ${fileSize}"</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-recurring-tasks-html">Periodically update a static HTML page</h6>
<div class="paragraph">
<p>In this example, every time the recurring task runs, a static HTML file is updated. In the file, it is written the total number of users and the balances of each system account.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.QUser</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.AccountWithStatusVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.SystemAccountOwner</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.groups.BasicGroupNature</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserStatus</span>

<span class="kn">import</span> <span class="nn">groovy.xml.MarkupBuilder</span>

<span class="kt">def</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">()</span>

<span class="n">QUser</span> <span class="n">u</span> <span class="o">=</span> <span class="n">QUser</span><span class="o">.</span><span class="na">user</span>
<span class="kt">int</span> <span class="n">users</span> <span class="o">=</span> <span class="n">entityManagerHandler</span>
        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">u</span><span class="o">)</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">status</span><span class="o">.</span><span class="na">notIn</span><span class="o">(</span><span class="n">UserStatus</span><span class="o">.</span><span class="na">REMOVED</span><span class="o">,</span> <span class="n">UserStatus</span><span class="o">.</span><span class="na">PURGED</span><span class="o">),</span>
        <span class="n">u</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">nature</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">BasicGroupNature</span><span class="o">.</span><span class="na">MEMBER_GROUP</span><span class="o">,</span> <span class="n">BasicGroupNature</span><span class="o">.</span><span class="na">BROKER_GROUP</span><span class="o">))</span>
        <span class="o">.</span><span class="na">count</span><span class="o">()</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">AccountWithStatusVO</span><span class="o">&gt;</span> <span class="n">accounts</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span>
        <span class="n">getAccountsSummary</span><span class="o">(</span><span class="n">SystemAccountOwner</span><span class="o">.</span><span class="na">instance</span><span class="o">(),</span> <span class="kc">null</span><span class="o">)</span>

<span class="n">File</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">file</span><span class="o">)</span>

<span class="kt">def</span> <span class="n">sessionData</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionData</span>
<span class="kt">def</span> <span class="n">formatter</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">formatter</span>
<span class="n">MarkupBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MarkupBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">FileWriter</span><span class="o">(</span><span class="n">out</span><span class="o">))</span>
<span class="n">builder</span><span class="o">.</span><span class="na">html</span> <span class="o">{</span>
    <span class="n">head</span> <span class="o">{</span>
        <span class="n">title</span> <span class="s2">"${sessionData.configuration.applicationName} summary"</span>
        <span class="n">meta</span> <span class="nl">charset:</span> <span class="s2">"UTF-8"</span>
    <span class="o">}</span>
    <span class="n">body</span> <span class="o">{</span>
        <span class="n">p</span> <span class="o">{</span>
            <span class="n">b</span> <span class="s2">"Total users"</span>
            <span class="n">span</span> <span class="s2">": ${users}"</span>
        <span class="o">}</span>
        <span class="n">accounts</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="n">p</span> <span class="o">{</span>
                <span class="n">b</span> <span class="n">a</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">name</span>
                <span class="n">span</span> <span class="s2">" balance: ${formatter.format(a.status.balance)}"</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">br</span><span class="o">()</span>
        <span class="n">br</span><span class="o">()</span>
        <span class="n">br</span><span class="o">()</span>
        <span class="n">p</span> <span class="nl">style:</span> <span class="s2">"font-size: small"</span><span class="o">,</span> <span class="s2">"Last updated: ${formatter.format(now)}"</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="k">return</span> <span class="s2">"File ${out.absolutePath} updated"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It also needs the script properties to set the file name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">file</span> <span class="p">=</span> <span class="s">/var/www/html/summary.html</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-background-tasks">4.4.16. Custom background tasks</h4>
<div class="paragraph">
<p>These scripts are called in a single shot task, which is scheduled to run either immediately or after a given time point.</p>
</div>
<div class="paragraph">
<p>Whenever a task is scheduled, a string context is stored, and will be later on passed to the script. The script uses this context to determine what to do.</p>
</div>
<div class="paragraph">
<p>Background tasks are mainly used in 2 use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Bulk processing</strong>: When many database entities need to be checked / updated in a batch, using a <a href="#scripting-type-recurring-tasks">custom recurring task</a> would end up processing all those entities in a single database transaction and in a single CPU. It would probably be much better for that script to just schedule all the background task executions, one per entity to be processed;</p>
</li>
<li>
<p><strong>Long-running task</strong>: In cases where a script needs to perform a long-running task, if that task would be triggered by a custom operation or custom web service, for example, it would take too long to return a result. Instead, such an operation can just schedule the execution of the long-running task as a background task, and return immediately.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The custom background task execution is logged following the same semantics as the built-in background tasks. The global configuration has a setting for background tasks logging, which can be all, default or verbose. When configuring the background task in the <em>System &gt; Tools &gt; Scheduled tasks &gt; Background tasks tab</em>, there&#8217;s a checkbox indicating whether successful executions of the task should be handled as verbose. If so, successful executions will only be logged to the global-tasks log if the global configuration setting is to log verbose tasks.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-background-tasks-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>task</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomBackgroundTask.html">org.cyclos.entities.system.CustomBackgroundTask</a> being executed;</p>
</li>
<li>
<p><code>context</code>: The string with the context passed in when the background task was <a href="#scripting-type-background-tasks-schedule">scheduled</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-background-tasks-result">Script result</h5>
<div class="paragraph">
<p>The script result is ignored.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-background-tasks-schedule">Scheduling background tasks</h5>
<div class="paragraph">
<p>Custom background tasks are always scheduled to run from other scripts. For this, use the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/tasks/BackgroundTaskHandler.html">org.cyclos.impl.utils.tasks.BackgroundTaskHandler</a>'s <code>custom()</code> method.</p>
</div>
<div class="paragraph">
<p>Its arguments are the custom background tasks' internal name and the context. Don&#8217;t forget to call the <code>schedule()</code> method in the result. See the <a href="#scripting-type-background-tasks-example">examples</a> section.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-background-tasks-fork-join">Using the fork-join model</h5>
<div class="paragraph">
<p>The <a href="https://en.wikipedia.org/wiki/Fork%E2%80%93join_model">fork-join model</a> consists of submitting a number of parallel tasks for execution, and then resuming execution when they have all finished.</p>
</div>
<div class="paragraph">
<p>Starting with Cyclos 4.16, it is possible to apply this model to background tasks. An example built-in feature that uses this model is the account fee charges. When dispatching an account fee charge, Cyclos schedules a background task execution for each 200 users that should be charged. And after all those are finished, the execution is marked as finished (and notified).</p>
</div>
<div class="paragraph">
<p>For custom background tasks to use a fork-join, at the moment of the scheduling the number of tasks must be known beforehand. A call to <code>def forkJoin = backgroundTaskHandler.newForkJoin(n, 'code'[, &#8230;&#8203;libraryInternalNames])</code> is needed, being <code>n</code> the number of tasks and <code>code</code> the groovy code that will be submitted for execution after all tasks finish. The <code>newForkJoin</code> method also receives a variable number of internal names for library scripts, which will be available when running the specified code. Also note that if you have each background task to process a batch, not a single record, you need to calculate the number of tasks as: <code>n = Math.ceil(count * 1.0 / batchSize) as int</code>.</p>
</div>
<div class="paragraph">
<p>The script code is executed at a later time, when all tasks have finished. Please, note that there&#8217;s no guarantee that the join code will be executed immediately after the execution of all background tasks, but it can take up to a minute for this to happen. Anyway, this feature is really useful when processing a lot of data, so this extra time will be barely noticeable.</p>
</div>
<div class="paragraph">
<p>Try to keep the join code as small as possible, because it will be harder to debug the code which is passed in dynamically in a string. Instead, create a library and just call a function in that library passing some form of dynamically generated id. See the <a href="#scripting-type-background-tasks-example-schedule-fork-join">example below</a> for more details.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-background-tasks-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-background-tasks-example-schedule">Scheduling a bulk of custom background tasks</h6>
<div class="paragraph">
<p>This script is used to schedule custom background tasks. Its type is <a href="#scripting-type-recurring-tasks">Custom recurring task</a>, but any kind of script could schedule background tasks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.QueryHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.records.UserRecordQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.recordtypes.RecordTypeVO</span>

<span class="c1">// Retrieve the ids to process</span>
<span class="kt">def</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">recordSearchHandler</span><span class="o">.</span><span class="na">iterateIds</span><span class="o">(</span><span class="k">new</span> <span class="n">UserRecordQuery</span><span class="o">(</span>
        <span class="nl">type:</span> <span class="k">new</span> <span class="n">RecordTypeVO</span><span class="o">(</span><span class="nl">internalName:</span> <span class="s1">'recordInternalName'</span><span class="o">)))</span>

<span class="c1">// For each one, schedule a background task which will process it</span>
<span class="n">QueryHelper</span><span class="o">.</span><span class="na">processBatch</span><span class="o">(</span><span class="n">entityManagerHandler</span><span class="o">,</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span> <span class="n">Long</span> <span class="n">id</span> <span class="o">-&gt;</span>
    <span class="kt">def</span> <span class="n">context</span> <span class="o">=</span> <span class="n">id</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
    <span class="n">backgroundTaskHandler</span><span class="o">.</span><span class="na">custom</span><span class="o">(</span><span class="s2">"taskInternalName"</span><span class="o">,</span> <span class="n">context</span><span class="o">).</span><span class="na">schedule</span><span class="o">()</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-background-tasks-example-schedule-fork-join">Scheduling a bulk of custom background tasks with fork-join</h6>
<div class="paragraph">
<p>This is basically the same script as in the previous example. However, it uses a fork-join, assuming a library script exist with internal name 'libraryInternalName', and defines a function to notify that all records have been processed the execution has finished.</p>
</div>
<div class="paragraph">
<p>Library that defines the functions to start and finish the executions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="nf">newExecution</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">id</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">()</span>
    <span class="n">println</span> <span class="s2">"Starting execution of $id"</span>
    <span class="k">return</span> <span class="n">id</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">finishExecution</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">println</span> <span class="s2">"Finishing execution of $id"</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Recurring task that actually schedules the background tasks using a fork-join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.users.records.UserRecordQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.recordtypes.RecordTypeVO</span>

<span class="c1">// Library function that creates a new execution and returns the id</span>
<span class="kt">def</span> <span class="n">execution</span> <span class="o">=</span> <span class="n">newExecution</span><span class="o">()</span>

<span class="c1">// Get the record ids to process</span>
<span class="kt">def</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">recordSearchHandler</span><span class="o">.</span><span class="na">iterateIds</span><span class="o">(</span><span class="k">new</span> <span class="n">UserRecordQuery</span><span class="o">(</span>
        <span class="nl">type:</span> <span class="k">new</span> <span class="n">RecordTypeVO</span><span class="o">(</span><span class="nl">internalName:</span> <span class="s1">'recordInternalName'</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">toList</span><span class="o">()</span>

<span class="k">if</span> <span class="o">(</span><span class="n">ids</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Nothing to process!</span>
    <span class="k">return</span> <span class="s1">'Nothing to process'</span>
<span class="o">}</span>

<span class="c1">// Create a new fork-join instance, calling the code that</span>
<span class="c1">// finishes the execution, and including the library.</span>
<span class="c1">// Take care to property wrap strings between quotes.</span>
<span class="kt">def</span> <span class="n">forkJoin</span> <span class="o">=</span> <span class="n">backgroundTaskHandler</span><span class="o">.</span><span class="na">newForkJoin</span><span class="o">(</span><span class="n">ids</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="s2">"""
    finishExecution('${execution}')
"""</span><span class="o">,</span> <span class="s1">'libraryInternalName'</span><span class="o">)</span>

<span class="c1">// For each one, schedule a background task which will process it</span>
<span class="n">ids</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span> <span class="n">Long</span> <span class="n">id</span> <span class="o">-&gt;</span>
    <span class="kt">def</span> <span class="n">context</span> <span class="o">=</span> <span class="n">id</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
    <span class="c1">// Pass the fork-join id to the 'custom' method</span>
    <span class="n">backgroundTaskHandler</span><span class="o">.</span><span class="na">custom</span><span class="o">(</span><span class="s1">'taskInternalName'</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">forkJoin</span><span class="o">)</span>
            <span class="o">.</span><span class="na">schedule</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">return</span> <span class="s2">"Scheduled ${ids.size()} tasks"</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-background-tasks-example-process">Process each record</h6>
<div class="paragraph">
<p>In both the previous examples, many background tasks are scheduled, one per record id. This example processes each one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// Use the context as record id</span>
<span class="kt">def</span> <span class="n">record</span> <span class="o">=</span> <span class="n">recordService</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">context</span><span class="o">))</span>
<span class="kt">def</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">record</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">status</span><span class="o">?.</span><span class="na">internalName</span> <span class="o">==</span> <span class="s1">'toProcess'</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Do some processing with this record, then mark it as done</span>
    <span class="n">fields</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="s1">'done'</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-sms-operation">4.4.17. Custom SMS operations</h4>
<div class="paragraph">
<p>These scripts are invoked when a user executes a custom sms operation, as set in the sms channel in the configuration. The function should implement the logic for that operation.</p>
</div>
<div class="paragraph">
<p>In terms of permissions, the same concerns applied to <a href="#scripting-type-web-services-permissions">custom web services</a> should also be applied to custom SMS operations as well, because there is no built-in security layer.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-sms-operation-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>configuration</code>:: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomSmsOperationConfiguration.html">org.cyclos.entities.system.CustomSmsOperationConfiguration</a>. With its <code>channelConfiguration</code> field, it is possible to access the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/SmsChannelConfiguration.html">org.cyclos.entities.system.SmsChannelConfiguration</a>;</p>
</li>
<li>
<p><code>phone</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/MobilePhone.html">org.cyclos.entities.users.MobilePhone</a> which sent the SMS message;</p>
</li>
<li>
<p><code>sms</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/sms/InboundSmsData.html">org.cyclos.impl.utils.sms.InboundSmsData</a>, containing the operation alias and parameters;</p>
</li>
<li>
<p><code>parameterProcessor</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/sms/SmsParameterProcessor.html">org.cyclos.impl.utils.sms.SmsParameterProcessor</a>, which is a helper class to obtain operation parameters as specific data types.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-sms-operation-result">Script result</h5>
<div class="paragraph">
<p>The script result is ignored.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-sms-operation-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-sms-operation-example-taxi">Pay taxi with an SMS message</h6>
<div class="paragraph">
<p>In this example SMS operation, users can pay taxi drivers via SMS. Make sure all the following are configured:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the script details, the checkbox "Run with all permissions" is disabled;</p>
</li>
<li>
<p>There should be a single transfer type enabled for the SMS operations channel, and the user performing the operation needs to have permission to perform that payment;</p>
</li>
<li>
<p>A custom profile field with internal name <code>taxiId</code> of type single line text, and marked as unique needs to be enabled for the product of taxi owners;</p>
</li>
<li>
<p>A user identification method of type custom field, called "Taxi id" with the <code>taxiId</code> field needs to be created. Make sure its internal name is also <code>taxiId</code>;</p>
</li>
<li>
<p>In the configuration details, in the channels tab, enable SMS operations. Then, in that channel, make sure "Taxi id" is allowed as user identification method to perform payments;</p>
</li>
<li>
<p>Still in the same channel configuration page, create a new SMS operation of type Custom, selecting the alias <code>taxi</code> and the selected script.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, customers can perform the payment by sending a sms in the format: <code>taxi &lt;taxi id&gt; &lt;amount&gt;</code>. Below is the script that should be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.banking.TransferException</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PerformPaymentDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transfertypes.TransferTypeVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.messaging.sms.OutboundSmsType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserLocatorVO</span>

<span class="c1">// Read the parameters</span>
<span class="n">String</span> <span class="n">taxiId</span> <span class="o">=</span> <span class="n">parameterProcessor</span><span class="o">.</span><span class="na">nextString</span><span class="o">(</span><span class="s2">"taxiId"</span><span class="o">)</span>
<span class="n">BigDecimal</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">parameterProcessor</span><span class="o">.</span><span class="na">nextDecimal</span><span class="o">(</span><span class="s2">"amount"</span><span class="o">)</span>

<span class="c1">// Find the user by taxi id</span>
<span class="kt">def</span> <span class="n">locator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserLocatorVO</span><span class="o">(</span>
        <span class="nl">principalType:</span> <span class="s2">"taxiId"</span><span class="o">,</span>
        <span class="nl">principal:</span> <span class="n">taxiId</span><span class="o">)</span>

<span class="c1">// Perform the payment</span>
<span class="kt">def</span> <span class="n">pmt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PerformPaymentDTO</span><span class="o">()</span>
<span class="n">pmt</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">amount</span>
<span class="n">pmt</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="na">user</span>
<span class="n">pmt</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="n">locator</span>
<span class="n">pmt</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransferTypeVO</span><span class="o">(</span><span class="nl">internalName:</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">paymentType</span><span class="o">)</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">vo</span> <span class="o">=</span> <span class="n">paymentServiceSecurity</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">pmt</span><span class="o">)</span>
    <span class="n">outboundSmsHandler</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">phone</span><span class="o">,</span>
            <span class="s2">"The payment was successful"</span><span class="o">,</span>
            <span class="n">OutboundSmsType</span><span class="o">.</span><span class="na">SMS_OPERATION_RESPONSE</span><span class="o">)</span>
    <span class="c1">// Also notify the taxi, for example, by connecting to the</span>
    <span class="c1">// taxi company system, which notifies the taxi driver...</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TransferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">outboundSmsHandler</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">phone</span><span class="o">,</span>
            <span class="s2">"The payment couldn't be performed"</span><span class="o">,</span>
            <span class="n">OutboundSmsType</span><span class="o">.</span><span class="na">SMS_OPERATION_RESPONSE</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, set in the script parameters the payment type to be used, with the format <code>accountTypeInternalName.transferTypeInternalName</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">paymentType</span> <span class="p">=</span> <span class="s">userUnits.taxiPayment</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-inbound-sms">4.4.18. Inbound SMS handling</h4>
<div class="paragraph">
<p>These scripts are invoked when a gateway sends SMS messages to Cyclos. There are two functions in this script: one to generate the gateway response and another one to resolve basic SMS data from an inbound HTTP request. Both functions are optional, defaulting to the normal behavior (when not using a script).</p>
</div>
<div class="sect4">
<h5 id="scripting-type-inbound-sms-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>configuration</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/ConfigurationAccessor.html">org.cyclos.impl.system.ConfigurationAccessor</a> for the inbound SMS;</p>
</li>
<li>
<p><code>channelConfiguration</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/SmsChannelConfiguration.html">org.cyclos.entities.system.SmsChannelConfiguration</a> with the SMS settings;</p>
</li>
<li>
<p><code>request</code>: The input <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/RequestInfo.html">org.cyclos.model.utils.RequestInfo</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-inbound-sms-resolve">Resolve basic SMS data</h5>
<div class="paragraph">
<p>This function is used to read an inbound sms request and return an object containing the phone number, the SMS message and the split SMS message into parts. Only the phone number and SMS message are required. If the message parts are empty, it will be assumed the message will be split by spaces.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-inbound-sms-resolve-result">Result</h6>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/sms/InboundSmsBasicData.html">org.cyclos.impl.utils.sms.InboundSmsBasicData</a>: The resolved SMS characteristics</p>
</li>
<li>
<p><strong>Object</strong> or <strong>Map</strong>: Any object compatible with <code>InboundSmsBasicData</code>;</p>
</li>
<li>
<p><strong>Null</strong>: The default inbound SMS handling is performed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-inbound-sms-response">Return response to gateway</h5>
<div class="paragraph">
<p>This function is used to determine the HTTP status code, headers and body to be returned to the SMS gateway. It can be called either when the bare minimum parameters  mobile phone number and sms message  were not sent by the gateway or when the gateway has sent a valid SMS. Keep in mind that if an operation has resulted in error, from a gateway perspective, the SMS was still delivered correctly, and the response should be a successful one. Maybe when the bare minimum parameters weren&#8217;t sent, the script could choose to return a different message. When no code is given, the default processing will be done, returning the HTTP status code 200 with "OK" in the body.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-inbound-sms-response-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>inboundSmsData</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/sms/InboundSmsData.html">org.cyclos.impl.utils.sms.InboundSmsData</a> which contains the operation alias and parameters. If the received request is invalid, may be null;</p>
</li>
<li>
<p><code>inboundSms</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/messaging/InboundSms.html">org.cyclos.entities.messaging.InboundSms</a>, which is a log of the incoming message;</p>
</li>
<li>
<p><code>inboundSmsResponseType</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/sms/InboundSmsResponseType.html">org.cyclos.impl.utils.sms.InboundSmsResponseType</a>, which is the type of response according to the operation execution;</p>
<div class="ulist">
<ul>
<li>
<p><code>inboundSmsException</code>: The exception that caused the operation to fail, if any.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-inbound-sms-response-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/ResponseInfo.html">org.cyclos.model.utils.ResponseInfo</a>: The HTTP response</p>
</li>
<li>
<p><strong>Object</strong> or <strong>Map</strong>: Any object compatible with <code>ResponseInfo</code>;</p>
</li>
<li>
<p><strong>Null</strong>: The default gateway response is generated.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-inbound-sms-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-inbound-sms-example-json">Receiving an SMS in JSON format</h6>
<div class="paragraph">
<p>This example assumes the request body is a JSON object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span>

<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.sms.InboundSmsBasicData</span>

<span class="kt">def</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">body</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">json</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readTree</span><span class="o">(</span><span class="n">body</span><span class="o">)</span>

<span class="kt">def</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InboundSmsBasicData</span><span class="o">()</span>
<span class="n">result</span><span class="o">.</span><span class="na">phoneNumber</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s2">"phoneNumber"</span><span class="o">)?.</span><span class="na">asText</span><span class="o">()</span>
<span class="n">result</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s2">"message"</span><span class="o">)?.</span><span class="na">asText</span><span class="o">()</span>
<span class="k">return</span> <span class="n">result</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-inbound-sms-example-custom">Receiving an SMS with a custom format</h6>
<div class="paragraph">
<p>This example reads the phone number from a request header, and the message from the request body:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.sms.InboundSmsBasicData</span>

<span class="c1">// Read the phone from a header, and the message from the body</span>
<span class="kt">def</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InboundSmsBasicData</span><span class="o">()</span>
<span class="n">result</span><span class="o">.</span><span class="na">phoneNumber</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">headers</span><span class="o">.</span><span class="s2">"phone-number"</span>
<span class="n">println</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">headers</span><span class="o">)</span>
<span class="n">result</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">body</span><span class="o">,</span> <span class="s2">"UTF-8"</span><span class="o">)</span>
<span class="n">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">message</span><span class="o">)</span>
<span class="k">return</span> <span class="n">result</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-outbound-sms">4.4.19. Outbound SMS handling</h4>
<div class="paragraph">
<p>These scripts are invoked to send SMS messages. By default, Cyclos connects to gateways via HTTP POST / GET, which can be set in the configuration. However, the sending can be customized (or totally replaced) via a script.</p>
</div>
<div class="paragraph">
<p>As in most cases the custom sending just wants to customize some aspects of the sending, not all, it is possible that the script just creates a subclass of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/sms/GatewaySmsSender.html">org.cyclos.impl.utils.sms.GatewaySmsSender</a>, customizing some aspects of it (for example, by overriding the buildRequest method and adding some headers, or the resolveVariables method to have some additional variables which can be sent in the POST body).</p>
</div>
<div class="sect4">
<h5 id="scripting-type-outbound-sms-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>configuration</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/ConfigurationAccessor.html">org.cyclos.impl.system.ConfigurationAccessor</a> for the sent SMS;</p>
</li>
<li>
<p><code>phone</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/MobilePhone.html">org.cyclos.entities.users.MobilePhone</a> to which the SMS is being sent. May be null when sending SMS messages to unregistered phones;</p>
</li>
<li>
<p><code>phoneNumber</code>: The international phone number, in the <a href="http://en.wikipedia.org/wiki/E.164">E.164</a> format. Never null;</p>
</li>
<li>
<p><code>message</code>: The SMS message to send.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-outbound-sms-result">Script result</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/sms/OutboundSmsStatus.html">org.cyclos.model.messaging.sms.OutboundSmsStatus</a>: The status that will be stored in the log;</p>
</li>
<li>
<p><strong>String</strong>: Must be the name of one of the <code>OutboundSmsStatus</code> enumeration values;</p>
</li>
<li>
<p><strong>Null</strong>: It is assumed the SMS was correctly delivered.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-outbound-sms-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-outbound-sms-example-json">Sending SMS requests as JSON</h6>
<div class="paragraph">
<p>This example posts the SMS message as JSON to the gateway, and awaits the response before returning the status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span>

<span class="kn">import</span> <span class="nn">org.cyclos.model.messaging.sms.OutboundSmsStatus</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpEntity</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.MediaType</span>

<span class="c1">// Read some gateway data from the configuration</span>
<span class="kt">def</span> <span class="n">smsConfig</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">outboundSmsConfiguration</span>
<span class="kt">def</span> <span class="n">url</span> <span class="o">=</span> <span class="n">smsConfig</span><span class="o">.</span><span class="na">gatewayUrl</span>
<span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">smsConfig</span><span class="o">.</span><span class="na">username</span>
<span class="kt">def</span> <span class="n">pwd</span> <span class="o">=</span> <span class="n">smsConfig</span><span class="o">.</span><span class="na">password</span>

<span class="c1">// Prepare the request headers</span>
<span class="kt">def</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">()</span>
<span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">pwd</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)</span>
<span class="o">}</span>
<span class="c1">// Build the JSON body</span>
<span class="kt">def</span> <span class="n">body</span> <span class="o">=</span> <span class="o">[</span>
    <span class="nl">to:</span> <span class="n">phoneNumber</span><span class="o">,</span>
    <span class="nl">text:</span> <span class="n">message</span>
<span class="o">]</span>
<span class="c1">// Send the request</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">rest</span><span class="o">.</span><span class="na">postForObject</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="n">headers</span><span class="o">),</span> <span class="n">HttpEntity</span><span class="o">)</span>
    <span class="k">return</span> <span class="n">OutboundSmsStatus</span><span class="o">.</span><span class="na">SUCCESS</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">OutboundSmsStatus</span><span class="o">.</span><span class="na">UNKNOWN_ERROR</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-outbound-sms-example-xml">Sending SMS requests as XML</h6>
<div class="paragraph">
<p>This example posts the SMS message as XML to the gateway, and awaits the response before returning the status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span>

<span class="kn">import</span> <span class="nn">org.cyclos.model.messaging.sms.OutboundSmsStatus</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpEntity</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.MediaType</span>

<span class="kn">import</span> <span class="nn">groovy.xml.MarkupBuilder</span>

<span class="c1">// Read some gateway data from the configuration</span>
<span class="kt">def</span> <span class="n">smsConfig</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">outboundSmsConfiguration</span>
<span class="kt">def</span> <span class="n">url</span> <span class="o">=</span> <span class="n">smsConfig</span><span class="o">.</span><span class="na">gatewayUrl</span>
<span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">smsConfig</span><span class="o">.</span><span class="na">username</span>
<span class="kt">def</span> <span class="n">pwd</span> <span class="o">=</span> <span class="n">smsConfig</span><span class="o">.</span><span class="na">password</span>

<span class="c1">// Prepare the request headers</span>
<span class="kt">def</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">()</span>
<span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_XML</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">pwd</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)</span>
<span class="o">}</span>
<span class="c1">// Build the XML body</span>
<span class="kt">def</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">()</span>
<span class="k">new</span> <span class="nf">MarkupBuilder</span><span class="o">(</span><span class="n">body</span><span class="o">).</span><span class="s2">"sms-message"</span> <span class="o">{</span>
    <span class="s2">"destination-phone"</span> <span class="n">phoneNumber</span>
    <span class="n">text</span> <span class="n">message</span>
<span class="o">}</span>
<span class="c1">// Send the request</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">rest</span><span class="o">.</span><span class="na">postForObject</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">(</span><span class="n">body</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">headers</span><span class="o">),</span> <span class="n">HttpEntity</span><span class="o">)</span>
    <span class="k">return</span> <span class="n">OutboundSmsStatus</span><span class="o">.</span><span class="na">SUCCESS</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">OutboundSmsStatus</span><span class="o">.</span><span class="na">UNKNOWN_ERROR</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-link">4.4.20. Link generation</h4>
<div class="paragraph">
<p>These scripts are used to generate links (URLs) which are used to point users to specific functionality. Some systems have a custom front-end for users, which means that when they receive e-mails with links, instead of pointing the links to the default Cyclos page, it should point to the custom front-end page.</p>
</div>
<div class="paragraph">
<p>Whenever the script returns null, the default link to Cyclos is generated, so the script may handle specific users / groups, and fallback to the default for other users by returning null.</p>
</div>
<div class="paragraph">
<p>To actually use a custom link generation script, it has to be set in the Cyclos configuration in System &gt; System configuration &gt; Configurations.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-link-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/LinkType.html">org.cyclos.impl.utils.LinkType</a> to be generated;</p>
</li>
<li>
<p><code>user</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/BasicUser.html">org.cyclos.entities.users.BasicUser</a> for which the link is being created. Can be null in some cases;</p>
</li>
<li>
<p><code>urlFilePart</code>: The URL part which is used by the default link in Cyclos. Kept mostly for backwards compatibility, because if the default is desired, the script should return null.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-result">Script result</h5>
<div class="ulist">
<ul>
<li>
<p><strong>String</strong>: The URL used for the link;</p>
</li>
<li>
<p><strong>Null</strong>: Returning null indicates the default link is used.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-login">Login</h5>
<div class="paragraph">
<p>Generate a link to the login page. The <code>type</code> variable is <code>LOGIN</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-login-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>No additional variables for this type.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-root">Root</h5>
<div class="paragraph">
<p>Generate a link to the root page. The <code>type</code> variable is <code>ROOT</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-root-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>No additional variables for this type.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-home">Home</h5>
<div class="paragraph">
<p>Generate a link to the home page. The <code>type</code> variable is <code>HOME</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-home-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>No additional variables for this type.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-notification">Notification</h5>
<div class="paragraph">
<p>Generate a link to a specific built-in location, optionally passing a parameter. The <code>type</code> variable is <code>NOTIFICATION</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-notification-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>location</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/Location.html">org.cyclos.model.utils.Location</a>;</p>
</li>
<li>
<p><code>entityId</code>: The identifier of the entity related to the notification;</p>
</li>
<li>
<p><code>entityIdParam</code>: The parameter name to pass the entity identifier.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-registration-validation">Registration validation</h5>
<div class="paragraph">
<p>Generate a link which validates a user registration. The <code>type</code> variable is <code>REGISTRATION_VALIDATION</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-registration-validation-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>validationKey</code>: The key which is sent by e-mail to validate the action.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-operation-external-redirect">Custom operation redirect</h5>
<div class="paragraph">
<p>Generate a link to a custom operation callback URL. The <code>type</code> variable is <code>EXTERNAL_REDIRECT</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-operation-external-redirect-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>execution</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/ExternalRedirectExecution.html">org.cyclos.entities.system.ExternalRedirectExecution</a> which provides both the <code>id</code> and the <code>verificationToken</code> which are used to find the custom operation after the callback is executed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-wizard-external-redirect">Wizard redirect</h5>
<div class="paragraph">
<p>Generate a link to a custom operation callback URL. The <code>type</code> variable is <code>WIZARD_EXTERNAL_REDIRECT</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-wizard-external-redirect-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>execution</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWizardExecution.html">org.cyclos.entities.system.CustomWizardExecution</a> which provides the <code>key</code> to resume the wizard execution after the external redirect is performed, and hence, should be appended to the generated URL;</p>
</li>
<li>
<p><code>storage</code>: The storage for wizard execution, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/CustomWizardExecutionStorage.html">org.cyclos.impl.system.CustomWizardExecutionStorage</a>. It can be used to look up the custom fields which were filled so far, as well as the registration parameters, if the wizard is of type registration.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-wizard-execution">Wizard execution</h5>
<div class="paragraph">
<p>Generate a link to resume a wizard execution.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-wizard-execution-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>execution</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomWizardExecution.html">org.cyclos.entities.system.CustomWizardExecution</a> which provides the <code>key</code> to resume the wizard execution;</p>
</li>
<li>
<p><code>storage</code>: The storage for wizard execution, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/CustomWizardExecutionStorage.html">org.cyclos.impl.system.CustomWizardExecutionStorage</a>. It can be used to look up the custom fields which were filled so far, as well as the registration parameters, if the wizard is of type registration.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-ticket">Pay ticket</h5>
<div class="paragraph">
<p>Generate a link to pay a ticket, which is another, simplified application provided by Cyclos. The <code>type</code> variable is <code>TICKET</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-ticket-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>ticket</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Ticket.html">org.cyclos.entities.banking.Ticket</a> to be paid. This class contains the 'ticketNumber' which is used to pay the ticket, and hence, should be appended to the generated URL.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-easy-invoice">Easy invoice</h5>
<div class="paragraph">
<p>Generate a link to pay an easy invoice, which is another, simplified page provided by Cyclos. The <code>type</code> variable is <code>EASY_INVOICE</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-easy-invoice-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>paymentTo</code>: The easy invoice payee, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/users/LocateUserResult.html">org.cyclos.impl.users.LocateUserResult</a>. Generally, its <code>principal</code> property should be used to generate the parameter value;</p>
</li>
<li>
<p><code>paymentAmount</code>: The (optional) easy invoice amount, as <code>BigDecimal</code>;</p>
</li>
<li>
<p><code>paymentType</code>: The (optional) easy invoice payment type, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/PaymentTransferType.html">org.cyclos.entities.banking.PaymentTransferType</a>;</p>
</li>
<li>
<p><code>paymentDescription</code>: The (optional) easy invoice description, as string;
<strong>*paymentCustomValues</strong>: Values for custom fields on the easy invoice. Is a map of strings, keyed by <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/TransactionCustomField.html">org.cyclos.entities.banking.TransactionCustomField</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-mobile-redirect">Mobile / mobile redirect</h5>
<div class="paragraph">
<p>Generate a link to redirect to a mobile application page (<code>type</code> is <code>MOBILE_REDIRECT</code>), or a URL with a custom schema (such as <code>cyclos://</code>) for the mobile application to open directly (<code>type</code> is <code>MOBILE</code>).</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-mobile-redirect-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>mobileUrlFilePart</code>: The URL part of the mobile page to open.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-reply-message">Reply a message</h5>
<div class="paragraph">
<p>Generate a link to directly reply to an internal message. The <code>type</code> variable is <code>REPLY_MESSAGE</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-reply-message-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>replyTo</code>: The message being replied, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/messaging/IncomingMessage.html">org.cyclos.entities.messaging.IncomingMessage</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-email-unsubscribe">Email unsubscription</h5>
<div class="paragraph">
<p>Generate a link to a simplified page which allows users to unsubscribe from emails of a given type (direct message, notifications, email mailings, etc.). The <code>type</code> variable is <code>EMAIL_UNSUBSCRIBE</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-email-unsubscribe-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>unsubscribeEmailKey</code>: The key which should be sent by e-mail, identifying this unsubscription intent;</p>
</li>
<li>
<p><code>unsubscribeEmailType</code>: The type of email unsubscription, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/notificationsettings/EmailUnsubscribeType.html">org.cyclos.model.messaging.notificationsettings.EmailUnsubscribeType</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-email-change">Email change</h5>
<div class="paragraph">
<p>Generate a link which validates a user email change. The <code>type</code> variable is <code>EMAIL_CHANGE</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-email-change-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>validationKey</code>: The key which is sent by e-mail to validate the action.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-voucher-info">Voucher information</h5>
<div class="paragraph">
<p>Generate a link to the simplified page that shows details of a voucher. The <code>type</code> variable is <code>VOUCHER_INFO</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-voucher-info-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>voucher</code>: The voucher to which the link will be generated, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Voucher.html">org.cyclos.entities.banking.Voucher</a>. Maybe null, in which case should point to a page where the user can type-in the voucher token.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-idp-redirect">Identity provider redirect</h5>
<div class="paragraph">
<p>Generate a link to the URL that will redirect to the identity provider, when using the 'Login with' Google, Facebook, Microsoft, etc. The <code>type</code> variable is <code>IDENTITY_PROVIDER_REDIRECT</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-idp-redirect-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>identityProvider</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/IdentityProvider.html">org.cyclos.entities.access.IdentityProvider</a>;</p>
</li>
<li>
<p><code>requestId</code>: The request identifier.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-idp-callback">Identity provider callback</h5>
<div class="paragraph">
<p>Generate a link to the URL which handles callback URLs passed to identity providers. The <code>type</code> variable is <code>IDENTITY_PROVIDER_CALLBACK</code>.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-idp-callback-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>identityProvider</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/IdentityProvider.html">org.cyclos.entities.access.IdentityProvider</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-invite">Invite</h5>
<div class="paragraph">
<p>Generate a link for a user invitation.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-link-invite-bindings">Additional bound variables</h6>
<div class="ulist">
<ul>
<li>
<p><code>inviteToken</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/InviteToken.html">org.cyclos.entities.users.InviteToken</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-link-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-link-example-location">Link generation for the frontend</h6>
<div class="paragraph">
<p>This example generates the links to the <a href="#setup-adjustments-frontend-self-hosted">frontend when hosted separately from Cyclos</a>.
To use it, you will need the following content in the script parameters box:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">rootUrl</span> <span class="p">=</span> <span class="s">https://account.example.com</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, use the following script code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.BasicUser</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.LinkType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="n">BasicUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">user</span>
<span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">?.</span><span class="na">admin</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="na">user</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">adminType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Don't generate custom links for system administrators</span>
    <span class="k">return</span> <span class="kc">null</span>
<span class="o">}</span>

<span class="c1">// Read the parameters</span>
<span class="n">Map</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptParameters</span>
<span class="n">LinkType</span> <span class="n">linkType</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">type</span>
<span class="n">String</span> <span class="n">root</span> <span class="o">=</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">removeEnd</span><span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="na">rootUrl</span><span class="o">,</span> <span class="s1">'/'</span><span class="o">)</span>

<span class="c1">// For root, return the configured root URL</span>
<span class="k">if</span> <span class="o">(</span><span class="n">linkType</span> <span class="o">==</span> <span class="n">linkType</span><span class="o">.</span><span class="na">ROOT</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">root</span>
<span class="o">}</span>

<span class="c1">// Cyclos already generates links to the built-in frontend,</span>
<span class="c1">// using the /ui/ prefix. This script assumes that the users</span>
<span class="c1">// configuration sets the new frontend for all regular users.</span>
<span class="n">String</span> <span class="n">urlFilePart</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">urlFilePart</span>
<span class="k">if</span> <span class="o">(</span><span class="n">urlFilePart</span><span class="o">?.</span><span class="na">startsWith</span><span class="o">(</span><span class="s2">"/ui/"</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">root</span> <span class="o">+</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">removeStart</span><span class="o">(</span><span class="n">urlFilePart</span><span class="o">,</span> <span class="s2">"/ui"</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-phone-number">4.4.21. Phone number handling</h4>
<div class="paragraph">
<p>Cyclos uses Google&#8217;s excellent <a href="https://github.com/google/libphonenumber">libphonenumber</a> library to handle phone numbers. It is able to perform many tasks related to phone numbers, given a default country (numbers may include the country code itself). Some examples include validating a phone number, determining the number type (mobile, fixed line or both), formatting a phone number (national, international and <a href="https://en.wikipedia.org/wiki/E.164">E.164</a> formats), generating example numbers, and much more.</p>
</div>
<div class="paragraph">
<p>Phone number rules across countries change over time. In this case, it usually takes a few weeks for a new release of libphonenumber to cover the new rules. It takes more time for a new Cyclos version, with the new library version, to be released. If your project is affected by a number rule change, it is always advisable to report a bug in libphonenumber, and manually update the library in your Cyclos installation as soon as it is released (by replacing the <code>WEB-INF/lib/libphonenumber-&lt;version&gt;.jar</code> with the new one, making sure only one version exists).</p>
</div>
<div class="paragraph">
<p>However, for projects that cannot wait a new release of libphonenumber, starting with Cyclos 4.16, a new kind of script was introduced: phone number handling.</p>
</div>
<div class="paragraph">
<p>To actually use a phone number handling script, it has to be set in the Cyclos configuration in System &gt; System configuration &gt; Configurations.</p>
</div>
<div class="paragraph">
<p>The script has 2 blocks:</p>
</div>
<div class="sect4">
<h5 id="scripting-type-phone-number-parse">Parse</h5>
<div class="paragraph">
<p>This script function is called when parsing a phone number entered by some user. The script is responsible for parsing, validating, determining the number type and formatting the phone number. If <code>null</code> is returned, the regular parsing by libphonenumber will be performed.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-phone-number-parse-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>The parse function has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>number</code>: The raw phone number, as typed-in by the user;</p>
</li>
<li>
<p><code>country</code>: The default <a href="https://en.wikipedia.org/wiki/ISO_3166-2">ISO-3166 2-letter country code</a>. The number may include a country itself by starting with <code>+country_code</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-phone-number-parse-result">Script result</h6>
<div class="paragraph">
<p>The script may return one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Null</strong>: When returning <code>null</code>, the default parsing will be performed, with libphonenumber;</p>
</li>
<li>
<p><strong>False</strong>: Returning <code>false</code> indicates that the number is invalid, and the regular parsing won&#8217;t be attempted;</p>
</li>
<li>
<p><strong>Object / Map</strong>: Must be an object compatible with <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/utils/PhoneNumberData.html">org.cyclos.impl.utils.PhoneNumberData</a>. Basically, need the following properties:</p>
<div class="ulist">
<ul>
<li>
<p><code>e164</code>: String, required. The <a href="https://en.wikipedia.org/wiki/E.164">E.164</a> formatted number from the given input <code>number</code>;</p>
</li>
<li>
<p><code>mobile</code>: Boolean, required. Indicates whether the given input number can be used as mobile number;</p>
</li>
<li>
<p><code>landLine</code>: Boolean, required. Indicates whether the given input number can be used as land-line (fixed) number. Some countries / rules might allow a phone to be used as both types;</p>
</li>
<li>
<p><code>international</code>: String, optional. The international representation of the input number. When not set, the E.164 format is used.</p>
</li>
<li>
<p><code>national</code>: String, optional. The national representation of the input number. When not set, the international or E.164 format is used.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-phone-number-sample">Generate an example number</h5>
<div class="paragraph">
<p>This script function is called when an example number should be displayed for users.</p>
</div>
<div class="sect5">
<h6 id="scripting-type-phone-number-sample-bindings">Additional bound variables</h6>
<div class="paragraph">
<p>The example number generation function has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mobile</code>: Flag indicating whether to return a mobile phone number example;</p>
</li>
<li>
<p><code>landLine</code>: Flag indicating whether to return a (fixed) land-line phone number example;</p>
</li>
<li>
<p><code>country</code>: The <a href="https://en.wikipedia.org/wiki/ISO_3166-2">ISO-3166 2-letter country code</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-phone-number-sample-result">Script result</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Null</strong>: When returning <code>null</code>, the default example from libphonenumber will be used;</p>
</li>
<li>
<p><strong>String</strong>: The example number.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-phone-number-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-phone-number-brazil">Custom Brazilian phone number handling</h6>
<div class="paragraph">
<p>This example does custom handling of Brazilian phone numbers (country dialing code is 55). Brazilian numbers are fully supported by libphonenumber, but this is just a didactic example.</p>
</div>
<div class="paragraph">
<p>Function to parse numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="kt">def</span> <span class="n">numbers</span> <span class="o">=</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">numbersOnly</span><span class="o">(</span><span class="n">number</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">hasCountryCode</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s2">"55"</span><span class="o">);</span>

<span class="k">if</span> <span class="o">(!</span><span class="n">hasCountryCode</span> <span class="o">&amp;&amp;</span> <span class="n">country</span> <span class="o">!=</span> <span class="s1">'BR'</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">(</span><span class="n">hasCountryCode</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="o">}</span>
<span class="kt">def</span> <span class="n">landline</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">10</span>
<span class="kt">def</span> <span class="n">mobile</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">11</span>

<span class="k">if</span> <span class="o">(!</span><span class="n">landline</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mobile</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="n">areaCode</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">firstPart</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">mobile</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">6</span><span class="o">)</span>

<span class="kt">def</span> <span class="n">mobilePrefix</span> <span class="o">=</span> <span class="n">firstPart</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s2">"9"</span><span class="o">)</span> <span class="o">||</span> <span class="n">firstPart</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s2">"8"</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">mobile</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mobilePrefix</span> <span class="o">||</span> <span class="n">landline</span> <span class="o">&amp;&amp;</span> <span class="n">mobilePrefix</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="n">secondPart</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">mobile</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">6</span><span class="o">,</span> <span class="n">numbers</span><span class="o">.</span><span class="na">length</span><span class="o">())</span>
<span class="kt">def</span> <span class="n">local</span> <span class="o">=</span> <span class="s2">"${firstPart}-${secondPart}"</span>

<span class="k">return</span> <span class="o">[</span>
    <span class="nl">landLine:</span> <span class="n">landline</span><span class="o">,</span>
    <span class="nl">mobile:</span> <span class="n">mobile</span><span class="o">,</span>
    <span class="nl">e164:</span> <span class="s2">"+55${numbers}"</span><span class="o">,</span>
    <span class="nl">national:</span> <span class="s2">"(${areaCode}) ${local}"</span><span class="o">,</span>
    <span class="nl">international:</span> <span class="s2">"55 ${areaCode} ${local}"</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Function to generate example numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="k">if</span> <span class="o">(</span><span class="n">country</span> <span class="o">!=</span> <span class="s1">'BR'</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span>
<span class="o">}</span>
<span class="k">return</span> <span class="n">mobile</span> <span class="o">?</span> <span class="s2">"01 90123-4567"</span> <span class="o">:</span> <span class="s2">"01 3012-3456"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-ip-geolocation">4.4.22. IP geolocation</h4>
<div class="paragraph">
<p>These scripts are used to map an IP address to a geolocation. This is useful in different contexts. For example, users may be notified when accessing their accounts from a new device, showing the approximate location. Or the IP address list can also show the approximate location.</p>
</div>
<div class="paragraph">
<p>To actually use an IP geolocation script, it has to be set in the Cyclos configuration in System &gt; System configuration &gt; Configurations.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-ip-geolocation-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>address</code>: The IP address, as string.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-ip-geolocation-result">Script result</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/IpGeolocation.html">org.cyclos.entities.system.IpGeolocation</a> (or a compatible Map): the geolocation result. Neither <code>address</code> nor <code>expirationDate</code> fields need to be returned - they will always be overridden;</p>
</li>
<li>
<p><strong>Null</strong>: When not returning anything, it will be considered that the address cannot be located.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-ip-geolocation-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-ip-geolocation-example-ipinfo">IP geolocation with IPinfo.io</h6>
<div class="paragraph">
<p>This example uses <a href="https://ipinfo.com/" class="bare">https://ipinfo.com/</a>. IPinfo.io allows free usage for up to 50k requests per month, allowing paid plans with higher limits. You need to sign in to get an API key (which they call <code>token</code>). That API key should be set in the script parameters with <code>apiKey = &lt;your-api-key&gt;</code>. Then, paste the following code in the script block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.system.IpGeolocation</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.utils.LatLong</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpEntity</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpMethod</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptParameters</span>
<span class="n">String</span> <span class="n">address</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">address</span>
<span class="n">RestTemplate</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">rest</span>
<span class="kt">def</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://ipinfo.io/${address}"</span>

<span class="kt">def</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">()</span>
<span class="n">headers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s1">'Authorization'</span><span class="o">,</span> <span class="s2">"Bearer ${scriptParameters.apiKey}"</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">result</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span>
        <span class="k">new</span> <span class="nf">HttpEntity</span><span class="o">(</span><span class="n">headers</span><span class="o">),</span> <span class="n">Map</span><span class="o">)</span>

<span class="kt">def</span> <span class="n">map</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">body</span>
<span class="kt">def</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">loc</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s1">','</span><span class="o">)</span>
<span class="k">return</span> <span class="k">new</span> <span class="nf">IpGeolocation</span><span class="o">(</span>
        <span class="nl">country:</span> <span class="n">map</span><span class="o">.</span><span class="na">country</span><span class="o">,</span>
        <span class="nl">region:</span> <span class="n">map</span><span class="o">.</span><span class="na">region</span><span class="o">,</span>
        <span class="nl">city:</span> <span class="n">map</span><span class="o">.</span><span class="na">city</span><span class="o">,</span>
        <span class="nl">location:</span> <span class="k">new</span> <span class="n">LatLong</span><span class="o">(</span><span class="n">loc</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="k">as</span> <span class="n">BigDecimal</span><span class="o">,</span> <span class="n">loc</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="k">as</span> <span class="n">BigDecimal</span><span class="o">))</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-ip-geolocation-example-ipbase">IP geolocation with ipbase</h6>
<div class="paragraph">
<p>This other example uses <a href="https://ipbase.com/" class="bare">https://ipbase.com/</a>. Its free usage allows only up to 150 requests per month, but paid plans are reasonably cheap. You need to sign in to get an API key. That API key should be set in the script parameters with <code>apiKey = &lt;your-api-key&gt;</code>. Then, paste the following code in the script block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.system.IpGeolocation</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.utils.LatLong</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpEntity</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpMethod</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.HttpServerErrorException</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptParameters</span>
<span class="n">String</span> <span class="n">address</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">address</span>
<span class="n">RestTemplate</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">rest</span>
<span class="kt">def</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://api.ipbase.com/v2/info/?ip=${address}"</span>

<span class="kt">def</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">()</span>
<span class="n">headers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s1">'apiKey'</span><span class="o">,</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">apiKey</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">result</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">HttpEntity</span><span class="o">(</span><span class="n">headers</span><span class="o">),</span> <span class="n">Map</span><span class="o">)</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">HttpServerErrorException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">statusCode</span> <span class="o">==</span> <span class="n">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// The IP was not found in IpBase</span>
        <span class="k">return</span> <span class="kc">null</span>
    <span class="o">}</span>
    <span class="k">throw</span> <span class="n">e</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="n">location</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">body</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">location</span>
<span class="k">return</span> <span class="k">new</span> <span class="nf">IpGeolocation</span><span class="o">(</span>
        <span class="nl">country:</span> <span class="n">location</span><span class="o">.</span><span class="na">country</span><span class="o">.</span><span class="na">alpha2</span><span class="o">,</span>
        <span class="nl">region:</span> <span class="n">location</span><span class="o">.</span><span class="na">region</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
        <span class="nl">city:</span> <span class="n">location</span><span class="o">.</span><span class="na">city</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
        <span class="nl">location:</span> <span class="k">new</span> <span class="n">LatLong</span><span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">latitude</span><span class="o">,</span> <span class="n">location</span><span class="o">.</span><span class="na">longitude</span><span class="o">))</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-export-format">4.4.23. Export formats</h4>
<div class="paragraph">
<p>These scripts are invoked when exporting data to a file in a custom format.</p>
</div>
<div id="scripting-type-export-format-contexts" class="paragraph">
<p>There are several contexts which can be exported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Account history;</p>
</li>
<li>
<p>Transfers overview;</p>
</li>
<li>
<p>Transactions search (such as scheduled payments search);</p>
</li>
<li>
<p>Transactions overview (such as payment requests overview);</p>
</li>
<li>
<p>Payment details (such as payment, scheduled payment, payment request, external payment or transfer);</p>
</li>
<li>
<p>Users search;</p>
</li>
<li>
<p>User balances overview;</p>
</li>
<li>
<p>Account limits overview;</p>
</li>
<li>
<p>Records search (for system or specific user, of a given type);</p>
</li>
<li>
<p>Records overview (as administrator or broker, of a given type);</p>
</li>
<li>
<p>Shared fields records search;</p>
</li>
<li>
<p>Tokens search (such as cards);</p>
</li>
<li>
<p>Vouchers search;</p>
</li>
<li>
<p>Voucher details;</p>
</li>
<li>
<p>Custom operation results (when returning a result page).</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="scripting-type-export-format-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>format</code>: The <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/ExportFormat.html">org.cyclos.entities.system.ExportFormat</a>;</p>
</li>
<li>
<p><code>context</code>: The <a href="#scripting-type-export-format-contexts">context</a>, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/exportformats/ExportFormatContext.html">org.cyclos.model.system.exportformats.ExportFormatContext</a>;</p>
</li>
<li>
<p><code>query</code>: When exporting a search results, is the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/QueryParameters.html">org.cyclos.model.QueryParameters</a> with the search filters;</p>
</li>
<li>
<p><code>data</code>: Depending on the context, is either an iterator or the object being exported:</p>
<div class="ulist">
<ul>
<li>
<p><code>ACCOUNT_HISTORY</code>: An iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/AccountHistoryEntry.html">org.cyclos.impl.banking.AccountHistoryEntry</a>;</p>
</li>
<li>
<p><code>TRANSFERS_OVERVIEW</code>: An iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a>;</p>
</li>
<li>
<p><code>TRANS_DETAILS</code>: A single <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transfer.html">org.cyclos.entities.banking.Transfer</a> or <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transaction.html">org.cyclos.entities.banking.Transaction</a>;</p>
</li>
<li>
<p><code>TRANSACTIONS_SEARCH</code> and <code>TRANSACTIONS_OVERVIEW</code>: An iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transaction.html">org.cyclos.entities.banking.Transaction</a>;</p>
</li>
<li>
<p><code>TRANSACTION_DETAILS</code>: A single <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Transaction.html">org.cyclos.entities.banking.Transaction</a>;</p>
</li>
<li>
<p><code>USERS_SEARCH</code>: An iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a>;</p>
</li>
<li>
<p><code>USERS_WITH_BALANCES</code>: An iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/accounts/UserWithBalanceVO.html">org.cyclos.model.banking.accounts.UserWithBalanceVO</a>;</p>
</li>
<li>
<p><code>BALANCE_LIMITS_OVERVIEW</code>: An iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/UserAccount.html">org.cyclos.entities.banking.UserAccount</a>;</p>
</li>
<li>
<p><code>RECORDS_SEARCH</code>, <code>RECORDS_OVERVIEW</code> and <code>SHARED_FIELDS_RECORDS_SEARCH</code>: An iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Record.html">org.cyclos.entities.users.Record</a>;</p>
</li>
<li>
<p><code>TOKENS_SEARCH</code>: An iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/access/Token.html">org.cyclos.entities.access.Token</a>;</p>
</li>
<li>
<p><code>VOUCHERS_SEARCH</code>: An iterator of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Voucher.html">org.cyclos.entities.banking.Voucher</a>;</p>
</li>
<li>
<p><code>VOUCHER_DETAILS</code>: A single <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Voucher.html">org.cyclos.entities.banking.Voucher</a>;</p>
</li>
<li>
<p><code>CUSTOM_OPERATION</code>: An iterator of arrays of strings;</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>additionalData</code>*: A map whose values depend on the context.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-export-format-result">Script result</h5>
<div class="ulist">
<ul>
<li>
<p><code>java.io.InputStream</code>: The binary file content;</p>
</li>
<li>
<p><code>byte[]</code>: The binary file content;</p>
</li>
<li>
<p><code>java.io.Reader</code>: The textual file content;</p>
</li>
<li>
<p><code>java.io.File</code>: The file to read the content. <strong>The file will be deleted after the content is read</strong>;</p>
</li>
<li>
<p>Otherwise, it will call the <code>toString()</code> method on the result and assume a textual file content.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-export-format-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-export-format-example-mt490">Exporting the account history as Swift MT940 format</h6>
<div class="paragraph">
<p>This script allows exporting the account history entries in the <a href="https://en.wikipedia.org/wiki/MT940">MT940</a>, which is used by some accounting software for importing / exporting transactions:</p>
</div>
<div class="paragraph">
<p>First create a script of type Export format with the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span>

<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.Account</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.AccountHistoryEntry</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.AccountHistoryQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="kt">def</span> <span class="n">timeZone</span> <span class="o">=</span> <span class="n">sessionData</span><span class="o">.</span><span class="na">configuration</span><span class="o">.</span><span class="na">timeZone</span>
<span class="kt">def</span> <span class="n">dateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s2">"yyMMdd"</span><span class="o">)</span>
<span class="n">dateFormat</span><span class="o">.</span><span class="na">timeZone</span> <span class="o">=</span> <span class="n">timeZone</span>
<span class="kt">def</span> <span class="n">entryDateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s2">"yyMMdd"</span><span class="o">)</span>
<span class="n">entryDateFormat</span><span class="o">.</span><span class="na">timeZone</span> <span class="o">=</span> <span class="n">timeZone</span>

<span class="kt">def</span> <span class="nf">formatAmount</span><span class="o">(</span><span class="n">BigDecimal</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">amount</span><span class="o">.</span><span class="na">abs</span><span class="o">().</span><span class="na">toPlainString</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s1">'.'</span><span class="o">,</span> <span class="s1">','</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">formatSignal</span><span class="o">(</span><span class="n">BigDecimal</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">amount</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">BigDecimal</span><span class="o">.</span><span class="na">ZERO</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">'C'</span> <span class="o">:</span> <span class="s1">'D'</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">formatOwner</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">text</span>
    <span class="nf">if</span> <span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">owner</span> <span class="k">instanceof</span> <span class="n">User</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="na">owner</span><span class="o">.</span><span class="na">username</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">internalName</span> <span class="o">?:</span> <span class="n">account</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">name</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">formatText</span><span class="o">(</span><span class="n">text</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">formatDescription</span><span class="o">(</span><span class="n">AccountHistoryEntry</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">description</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">transaction</span><span class="o">?.</span><span class="na">description</span> <span class="o">?:</span> <span class="n">entry</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">valueForEmptyDescription</span>
    <span class="k">return</span> <span class="nf">formatText</span><span class="o">(</span><span class="n">description</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">formatText</span><span class="o">(</span><span class="n">text</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// First replace line breaks or multiple spaces by a single space, trimming to 60 chars</span>
    <span class="n">text</span> <span class="o">=</span> <span class="o">(</span><span class="n">text</span> <span class="o">?:</span> <span class="s1">''</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">"[\n|\r]+"</span><span class="o">,</span> <span class="s2">" "</span><span class="o">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">"\\s+"</span><span class="o">,</span> <span class="s2">" "</span><span class="o">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">trim</span><span class="o">(</span><span class="n">StringHelper</span><span class="o">.</span><span class="na">truncate</span><span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="mi">60</span><span class="o">))</span>
    <span class="c1">// Second make sure that no special characters are used</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">asciiOnly</span><span class="o">(</span><span class="n">StringHelper</span><span class="o">.</span><span class="na">unaccent</span><span class="o">(</span><span class="n">text</span><span class="o">))</span>
    <span class="c1">// Finally make sure that no colon character is used, this might mess up the mt940 file</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s1">'\\:'</span><span class="o">,</span> <span class="s1">' '</span><span class="o">)</span>
<span class="o">}</span>

<span class="c1">// Get the account</span>
<span class="n">AccountHistoryQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">query</span>
<span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">conversionHandler</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">Account</span><span class="o">,</span> <span class="n">query</span><span class="o">.</span><span class="na">account</span><span class="o">)</span>

<span class="c1">// Get the begin date</span>
<span class="n">Date</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">conversionHandler</span><span class="o">.</span><span class="na">toDate</span><span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">period</span><span class="o">?.</span><span class="na">begin</span><span class="o">)</span> <span class="o">?:</span> <span class="n">account</span><span class="o">.</span><span class="na">creationDate</span>

<span class="c1">// Get the end date</span>
<span class="n">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">()</span>
<span class="n">Date</span> <span class="n">end</span> <span class="o">=</span> <span class="n">conversionHandler</span><span class="o">.</span><span class="na">toDate</span><span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">period</span><span class="o">?.</span><span class="na">end</span><span class="o">)</span> <span class="o">?:</span> <span class="n">now</span>
<span class="k">if</span> <span class="o">(</span><span class="n">end</span><span class="o">.</span><span class="na">after</span><span class="o">(</span><span class="n">now</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">now</span>
<span class="o">}</span>

<span class="c1">// Get the balance at begin / end</span>
<span class="kt">def</span> <span class="n">balanceBegin</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">getBalance</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="n">begin</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">balanceEnd</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">getBalance</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="n">end</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">currency</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">currencyCode</span>

<span class="c1">// Write the header</span>
<span class="n">StringBuilder</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s2">""":20:CN${dateFormat.format(end)}
:25:${scriptParameters.iban}
:28:000
:60F:${formatSignal(balanceBegin)}${dateFormat.format(begin)}${currency}${formatAmount(balanceBegin)}
"""</span><span class="o">)</span>

<span class="c1">// Process each entry</span>
<span class="n">scriptHelper</span><span class="o">.</span><span class="na">processBatch</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="o">{</span> <span class="n">AccountHistoryEntry</span> <span class="n">entry</span> <span class="o">-&gt;</span>
    <span class="kt">def</span> <span class="n">date</span> <span class="o">=</span> <span class="n">entryDateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">date</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">formatAmount</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">amount</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">signal</span> <span class="o">=</span> <span class="n">formatSignal</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">amount</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">fromTo</span> <span class="o">=</span> <span class="n">formatOwner</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">relatedAccount</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">description</span> <span class="o">=</span> <span class="n">formatDescription</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">":61:${date}${signal}${amount}NOV NONREF\n"</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">":86:${fromTo} &gt; ${description}\n"</span>
<span class="o">}</span>

<span class="c1">// Write the footer</span>
<span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">":62F:${formatSignal(balanceEnd)}${dateFormat.format(end)}${currency}${formatAmount(balanceEnd)}"</span>

<span class="c1">// Return the output content</span>
<span class="k">return</span> <span class="n">out</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also set the following in the script parameters box:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># The currency code that will be exported on the file
</span><span class="py">currencyCode</span> <span class="p">=</span> <span class="s">EUR</span>
<span class="c"># The IBAN account number that will be exported in the file
</span><span class="py">iban</span> <span class="p">=</span> <span class="s">NL70TRIO0123456789</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, create a new export format in System &gt; System configuration &gt; Export formats, with the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: MT940 (change as desired);</p>
</li>
<li>
<p><strong>Internal name</strong>: mt940;</p>
</li>
<li>
<p><strong>Content type</strong>: application/octet-stream;</p>
</li>
<li>
<p><strong>Binary</strong>: No;</p>
</li>
<li>
<p><strong>Character encoding</strong>: UTF-8;</p>
</li>
<li>
<p><strong>File extension</strong>: mt940;</p>
</li>
<li>
<p><strong>Contexts</strong>: Account history;</p>
</li>
<li>
<p><strong>Script</strong>: Select the previously created script.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-notifications">4.4.24. Notifications</h4>
<div class="paragraph">
<p>These scripts are invoked before generating the notification to be stored in the database. Later, the notifications will be sent through a background task.</p>
</div>
<div class="paragraph">
<p>For the script to be actually used, it needs to be set in the Cyclos configuration.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-notifications-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code>: The notification type to generate (never null). One of the following classes:</p>
<div class="ulist">
<ul>
<li>
<p>For administrators: <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/notifications/AdminNotificationType.html">org.cyclos.model.messaging.notifications.AdminNotificationType</a></p>
</li>
<li>
<p>For users: one of:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/notifications/PersonalNotificationType.html">org.cyclos.model.messaging.notifications.PersonalNotificationType</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/notifications/AccountNotificationType.html">org.cyclos.model.messaging.notifications.AccountNotificationType</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/notifications/BrokeringNotificationType.html">org.cyclos.model.messaging.notifications.BrokeringNotificationType</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/notifications/FeedbackAndReferenceNotificationType.html">org.cyclos.model.messaging.notifications.FeedbackAndReferenceNotificationType</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/notifications/MarketplaceBuyerNotificationType.html">org.cyclos.model.messaging.notifications.MarketplaceBuyerNotificationType</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/notifications/MarketplaceSellerNotificationType.html">org.cyclos.model.messaging.notifications.MarketplaceSellerNotificationType</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>entity</code>: The entity associated with the notification (never null);
This entity should be used to retrieve all values used to create the notification content (body, title, etc.). For the type of entity associated with each notification type, please check the links to the notification types above;</p>
</li>
<li>
<p><code>user</code>: The user to be notified (never null). For users or administrators, there will be an instance of <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/User.html">org.cyclos.entities.users.User</a>. For operators, there will be a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/users/Operator.html">org.cyclos.entities.users.Operator</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-notifications-result">Script result</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Null</strong>: No customizations are made for this notification;</p>
</li>
<li>
<p>A Map with the following properties, each could be null to fall back to the default notification:</p>
<div class="ulist">
<ul>
<li>
<p><code>title</code>: The email notification title, as string;</p>
</li>
<li>
<p><code>body</code>: The email notification body, as string;</p>
</li>
<li>
<p><code>sms</code>: The SMS message, as string;</p>
</li>
<li>
<p><code>fcm</code>: Allows customizing push notifications sent via <a href="https://firebase.google.com/docs/cloud-messaging">Firebase Cloud Messaging</a>. Is another map with:</p>
<div class="ulist">
<ul>
<li>
<p><code>title</code>: The push notification title. If not given, then the title above will be used (if any);</p>
</li>
<li>
<p><code>body</code>: The push notification body. If not given, then the body above will be used (if any);</p>
</li>
<li>
<p><code>imageUrl</code>: The url of the image associated with the push notification. If not given, the user&#8217;s profile image is used (only for users, not operators);</p>
</li>
<li>
<p><code>iosBadge</code>: A boolean flag indicating if a badge must be shown for iOS notifications. Default is true;</p>
</li>
<li>
<p><code>androidIconColor</code>: The color in #rrggbb format (e.g: #23AB34) used to colorize the small notification icon shown in Android devices. By default, no color is sent. Device support depends on the Android version;</p>
</li>
<li>
<p><code>data</code>: A <code>Map&lt;String, String&gt;</code> used to send additional data to the mobile application.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-notifications-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-notifications-example-payment-received">Include the balance for a "Payment received" notification</h6>
<div class="paragraph">
<p>This script will add the user balance to the body of the notification generated for the type: <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/messaging/notifications/AccountNotificationType.html#PAYMENT_RECEIVED">PAYMENT_RECEIVED</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.messaging.notifications.AccountNotificationType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="kt">def</span> <span class="n">received</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">AccountNotificationType</span><span class="o">.</span><span class="na">PAYMENT_RECEIVED</span>
<span class="kt">def</span> <span class="n">performed</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">AccountNotificationType</span><span class="o">.</span><span class="na">ALL_NON_SMS_PERFORMED_PAYMENTS</span>
<span class="k">if</span> <span class="o">(</span><span class="n">received</span> <span class="o">||</span> <span class="n">performed</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">account</span> <span class="o">=</span> <span class="n">received</span> <span class="o">?</span> <span class="n">entity</span><span class="o">.</span><span class="na">to</span><span class="o">:</span> <span class="n">entity</span><span class="o">.</span><span class="na">from</span>
    <span class="kt">def</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">currency</span><span class="o">,</span>
            <span class="n">accountService</span><span class="o">.</span><span class="na">getBalance</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span>
    <span class="kt">def</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">currencyAmount</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">received</span> <span class="o">?</span> <span class="n">entity</span><span class="o">.</span><span class="na">fromOwner</span><span class="o">:</span> <span class="n">entity</span><span class="o">.</span><span class="na">toOwner</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">ownerShort</span> <span class="o">=</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">truncate</span><span class="o">(</span><span class="n">owner</span><span class="o">,</span> <span class="mi">30</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">received</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">[</span>
            <span class="nl">body:</span> <span class="s2">"You have received a payment of $amount from $owner."</span>
            <span class="o">+</span> <span class="s2">" Your new balance is: $balance."</span><span class="o">,</span>
            <span class="nl">sms:</span> <span class="s2">"Payment of $amount received from $ownerShort."</span>
            <span class="o">+</span> <span class="s2">" New balance: $balance."</span>
        <span class="o">]</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">[</span>
            <span class="nl">body:</span> <span class="s2">"You have performed a payment of $amount to $owner."</span>
            <span class="o">+</span> <span class="s2">" Your new balance is: $balance."</span><span class="o">,</span>
            <span class="nl">sms:</span> <span class="s2">"Payment of $amount performed to $ownerShort."</span>
            <span class="o">+</span> <span class="s2">" New balance: $balance."</span>
        <span class="o">]</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// default values for the rest of the notification types</span>
<span class="k">return</span> <span class="kc">null</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-content-helper">4.4.25. Content helper</h4>
<div class="paragraph">
<p>These scripts are used to generate data which is passed in to the Thymeleaf context when processing <a href="#content-thymeleaf">dynamic content</a>.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-content-helper-bindings">Additional bound variables</h5>
<div class="paragraph">
<p>The script code has the following bound variables (besides the <a href="#scripting-bindings">default bindings</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>source</code>: The source entity that contains the content, and content script. Some (non-exhaustive) examples:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/contentmanagement/BaseStaticContent.html">org.cyclos.entities.contentmanagement.BaseStaticContent</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/contentmanagement/MenuItem.html">org.cyclos.entities.contentmanagement.MenuItem</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/VoucherTemplate.html">org.cyclos.entities.banking.VoucherTemplate</a>;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/system/CustomOperation.html">org.cyclos.entities.system.CustomOperation</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>target</code>: The bean which is receiving the processed content. Are the detailed VOs of each corresponding entity. Always null for voucher templates;</p>
</li>
<li>
<p><code>property</code>: The name of the bean property which is receiving the processed content. Always null for voucher templates.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-content-helper-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-content-helper-example-userRecords">Show user records in a content</h6>
<div class="paragraph">
<p>This script adds the current user&#8217;s records of a hard-coded type to be later on processed by Thymeleaf. Assuming there&#8217;s a record type with internal name <code>remark</code> which has a field with internal name <code>description</code>, this example fetches and wraps each record, so the template can easily use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecordType</span>

<span class="kt">def</span> <span class="n">type</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">UserRecordType</span><span class="o">,</span> <span class="s1">'recordType'</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">records</span> <span class="o">=</span> <span class="n">recordService</span><span class="o">.</span><span class="na">listUser</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">sessionData</span><span class="o">.</span><span class="na">loggedUser</span><span class="o">)</span>

<span class="k">return</span> <span class="o">[</span>
    <span class="nl">records:</span> <span class="n">records</span><span class="o">.</span><span class="na">collect</span> <span class="o">{</span>
        <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">it</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is an example content that shows the description of each record, together with its creation date:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;div</span> <span class="na">th:each=</span><span class="s">"remark: ${records}"</span> <span class="na">style=</span><span class="s">"display: flex"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">th:text=</span><span class="s">"${#format.object(remark.creationDate)}"</span><span class="nt">&gt;</span>Date<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div&gt;</span><span class="ni">&amp;nbsp;</span><span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">th:text=</span><span class="s">"${remark.description}"</span><span class="nt">&gt;</span>Description<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-type-run-directly">4.4.26. Running scripts directly</h4>
<div class="paragraph">
<p>In many cases, it is handy for administrators to run scripts directly.
So, instead of having to create a custom operation script, then a custom operation, then granting permissions, refreshing the browser and running, there is a menu called Run script, which presents a text box where the script may be typed in or pasted, which can be executed directly.
Of course, only the <a href="#scripting-bindings">default bindings</a> are available.</p>
</div>
<div class="sect4">
<h5 id="scripting-type-run-directly-result">Result</h5>
<div class="ulist">
<ul>
<li>
<p><strong>String</strong>: The text is displayed as plain text;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/system/scripts/ScriptResult.html">org.cyclos.model.system.scripts.ScriptResult</a>: This is the way to return either a notification by setting the notification property as string or an HTML-formatted text, by setting the richText property;</p>
</li>
<li>
<p><strong>Map</strong>: A Map compatible with ScriptResult will be handled in the same way as it;</p>
</li>
<li>
<p><strong>File</strong>, <strong>InputStream</strong> or <strong>Reader</strong>: used to return a file;</p>
</li>
<li>
<p><a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/utils/FileInfo.html">org.cyclos.model.utils.FileInfo</a>: return a file, with more control over it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, for example, to return an HTML text with a title, the script can return <code>[title:"The result title", richText:"&lt;b&gt;Formatted&lt;/b&gt; text"]</code>. To show a notification, the script can return <code>[notification:"Notification text"]</code>. The same prefixes available on notifications for <a href="#scripting-type-operation-notification">custom operations</a> are available on notifications: <code>[INFO]</code>, <code>[WARN]</code> and <code>[ERROR]</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-type-run-directly-example">Examples</h5>
<div class="sect5">
<h6 id="scripting-type-run-directly-example-remove-data">Remove all users, transactions and related data</h6>
<div class="paragraph">
<p>Here is an example of a script to remove all regular users (not administrators) and related data, as well as all system to system transactions. This script must be executed in a network. Be advised that there will be no confirmation, and all users and all related data will be removed.</p>
</div>
<div class="paragraph">
<p>The script works by first recreating all database constraints with the option ON DELETE CASCADE. Then, all users are removed, which will cascade the removal to accounts, transfers, advertisements, records, messages, notifications, references and so on. For this reason, all tables are locked, and the script will likely fail if there is any activity in the system, such as active users or background tasks. If this script doesn&#8217;t work because some tables are locked, run the <a href="#setup-maintenance-remove-data">command-line application</a> instead.</p>
</div>
<div class="paragraph">
<p>Be careful when running in systems where specific users are used in the configuration, such as fees that are paid by a specific user, or payment types which are restricted to specific users. In such configurations, all such related data will be removed as well. Also, note that it may take a while to run, so, please, wait before the script completes.</p>
</div>
<div class="paragraph">
<p><strong>AGAIN:</strong> be very careful when using this script! Only run it on test instances and always have a database backup before running it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.db.DeleteNetworkData</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.cache.CacheType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>

<span class="nf">if</span> <span class="o">(</span><span class="n">sessionData</span><span class="o">.</span><span class="na">network</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="s2">"This script can only be executed in a network"</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="n">deleteNetworkData</span> <span class="o">=</span> <span class="n">beanHandler</span><span class="o">.</span><span class="na">autowire</span><span class="o">(</span><span class="n">DeleteNetworkData</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">users</span> <span class="o">=</span> <span class="n">deleteNetworkData</span><span class="o">.</span><span class="na">deleteUsersAndBanking</span><span class="o">(</span><span class="n">sessionData</span><span class="o">.</span><span class="na">network</span><span class="o">)</span>
<span class="n">CacheType</span><span class="o">.</span><span class="na">all</span><span class="o">().</span><span class="na">each</span> <span class="o">{</span> <span class="n">cacheHandler</span><span class="o">.</span><span class="na">scheduleClear</span><span class="o">(</span><span class="n">it</span><span class="o">)</span> <span class="o">}</span>
<span class="n">searchHandler</span><span class="o">.</span><span class="na">reindex</span><span class="o">()</span>
<span class="k">return</span> <span class="s2">"Removed ${users} users"</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-run-directly-export-ads-images">Export advertisements with images</h6>
<div class="paragraph">
<p>Here is an example of a script to export the published advertisements with its images in the same format used in the Cyclos import,  so the result can be used to add the returned advertisements in other Cyclos networks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span>
<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span>
<span class="kn">import</span> <span class="nn">java.util.zip.ZipEntry</span>
<span class="kn">import</span> <span class="nn">java.util.zip.ZipOutputStream</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.lang3.StringUtils</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.marketplace.AdImage</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.marketplace.QAdImage</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.access.SessionData</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.marketplace.AdImageServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.storage.StoredFileHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.formatting.FormatterImpl</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.persistence.EntityManagerHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.marketplace.advertisements.BasicAdVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.utils.FileInfo</span>
<span class="kn">import</span> <span class="nn">org.cyclos.server.utils.SerializableInputStream</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.ContentType</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.ColumnMapRowMapper</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.RowCallbackHandler</span>

<span class="kn">import</span> <span class="nn">com.opencsv.CSVParserBuilder</span>
<span class="kn">import</span> <span class="nn">com.opencsv.CSVWriterBuilder</span>

<span class="n">JdbcTemplate</span> <span class="n">jdbc</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">jdbc</span>
<span class="n">SessionData</span> <span class="n">sessionData</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionData</span>
<span class="n">EntityManagerHandler</span> <span class="n">entityManagerHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">entityManagerHandler</span>
<span class="n">StoredFileHandler</span> <span class="n">storedFileHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">storedFileHandler</span>
<span class="n">FormatterImpl</span> <span class="n">formatter</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">formatter</span>
<span class="n">AdImageServiceLocal</span> <span class="n">adImageService</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">adImageService</span>

<span class="kt">def</span> <span class="n">sql</span> <span class="o">=</span> <span class="s2">"""
select
    ad.id,
    u.username as user,
    ad.creation_date as creationdate,
    ad.name as title,
    ad.description,
    ad.status,
    array_to_string(array_agg(
        cy_name_hierarchy(ac.category_id, 'ad_categories', 'internal_name')
    ), ',') as categories,
    ad.begin_publication_period as publicationbegin,
    ad.end_publication_period as publicationend,
    ad.price_amount as price,
    ad.promotional_price as promotionalprice,
    ad.begin_promotional_price_period as promotionalperiodbegin,
    ad.end_promotional_price_period as promotionalperiodend
from ads ad
    inner join users u on ad.owner_id = u.id
    inner join ads_categories ac on ad.id = ac.ad_id
    inner join ad_categories c on ac.category_id = c.id
where u.network_id = ${sessionData.network.id}
and ad.end_publication_period &gt; now()
group by 1, 2, 3, 4, 5, 6, 8, 9, 10, 11, 12
"""</span>

<span class="kt">def</span> <span class="n">file</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s2">"export"</span><span class="o">,</span> <span class="s2">".zip"</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">zip</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZipOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">file</span><span class="o">),</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)</span>

<span class="c1">// Write the index</span>
<span class="n">zip</span><span class="o">.</span><span class="na">putNextEntry</span><span class="o">(</span><span class="k">new</span> <span class="n">ZipEntry</span><span class="o">(</span><span class="s2">"index.csv"</span><span class="o">))</span>
<span class="kt">def</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CSVParserBuilder</span><span class="o">().</span><span class="na">withSeparator</span><span class="o">(</span><span class="n">sessionData</span><span class="o">.</span><span class="na">configuration</span><span class="o">.</span><span class="na">listSeparator</span><span class="o">.</span><span class="na">value</span> <span class="k">as</span> <span class="kt">char</span><span class="o">).</span><span class="na">build</span><span class="o">()</span>
<span class="kt">def</span> <span class="n">csv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CSVWriterBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">OutputStreamWriter</span><span class="o">(</span><span class="n">zip</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)).</span><span class="na">withParser</span><span class="o">(</span><span class="n">parser</span><span class="o">).</span><span class="na">build</span><span class="o">()</span>
<span class="n">csv</span><span class="o">.</span><span class="na">writeNext</span><span class="o">([</span>
    <span class="s1">'user'</span><span class="o">,</span>
    <span class="s1">'creationdate'</span><span class="o">,</span>
    <span class="s1">'title'</span><span class="o">,</span>
    <span class="s1">'description'</span><span class="o">,</span>
    <span class="s1">'status'</span><span class="o">,</span>
    <span class="s1">'categories'</span><span class="o">,</span>
    <span class="s1">'publicationbegin'</span><span class="o">,</span>
    <span class="s1">'publicationend'</span><span class="o">,</span>
    <span class="s1">'price'</span><span class="o">,</span>
    <span class="s1">'promotionalprice'</span><span class="o">,</span>
    <span class="s1">'promotionalperiodbegin'</span><span class="o">,</span>
    <span class="s1">'promotionalperiodend'</span><span class="o">,</span>
    <span class="s1">'images'</span>
<span class="o">]</span> <span class="k">as</span> <span class="n">String</span><span class="o">[])</span>
<span class="kt">def</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ColumnMapRowMapper</span><span class="o">()</span>
<span class="kt">def</span> <span class="n">rch</span> <span class="o">=</span> <span class="o">{</span> <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">-&gt;</span>
    <span class="kt">def</span> <span class="n">map</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">mapRow</span><span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">images</span> <span class="o">=</span> <span class="n">adImageService</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="k">new</span> <span class="n">BasicAdVO</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">id</span> <span class="k">as</span> <span class="kt">long</span><span class="o">))</span>
    <span class="kt">def</span> <span class="n">imageNames</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="na">collect</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">contentType</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="na">getByMimeType</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">contentType</span><span class="o">)</span>
        <span class="k">return</span> <span class="s2">"${it.id}.${contentType.extension}"</span>
    <span class="o">}</span>
    <span class="n">csv</span><span class="o">.</span><span class="na">writeNext</span><span class="o">([</span>
        <span class="n">map</span><span class="o">.</span><span class="na">user</span><span class="o">,</span>
        <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">creationdate</span><span class="o">),</span>
        <span class="n">map</span><span class="o">.</span><span class="na">title</span><span class="o">,</span>
        <span class="n">map</span><span class="o">.</span><span class="na">description</span><span class="o">,</span>
        <span class="n">map</span><span class="o">.</span><span class="na">status</span><span class="o">,</span>
        <span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">categories</span> <span class="k">as</span> <span class="n">String</span><span class="o">).</span><span class="na">tokenize</span><span class="o">(</span><span class="s1">','</span><span class="o">).</span><span class="na">collect</span> <span class="o">{</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">strip</span><span class="o">(</span><span class="n">it</span><span class="o">,</span> <span class="s1">'_'</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s1">'_a_'</span><span class="o">,</span> <span class="s1">'&gt;'</span><span class="o">)}.</span><span class="na">unique</span><span class="o">().</span><span class="na">join</span><span class="o">(</span><span class="s1">', '</span><span class="o">),</span>
        <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">publicationbegin</span><span class="o">),</span>
        <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">publicationend</span><span class="o">),</span>
        <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">price</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span> <span class="o">?:</span> <span class="s1">''</span><span class="o">,</span>
        <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">promotionalprice</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span> <span class="o">?:</span> <span class="s1">''</span><span class="o">,</span>
        <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">promotionalperiodbegin</span><span class="o">)</span> <span class="o">?:</span> <span class="s1">''</span><span class="o">,</span>
        <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">promotionalperiodend</span><span class="o">)</span> <span class="o">?:</span> <span class="s1">''</span><span class="o">,</span>
        <span class="n">imageNames</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s1">','</span><span class="o">)</span>
    <span class="o">]</span> <span class="k">as</span> <span class="n">String</span><span class="o">[])</span>
    <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">clear</span><span class="o">()</span>
<span class="o">}</span> <span class="k">as</span> <span class="n">RowCallbackHandler</span>
<span class="n">jdbc</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">rch</span><span class="o">)</span>
<span class="n">csv</span><span class="o">.</span><span class="na">flush</span><span class="o">()</span>
<span class="n">zip</span><span class="o">.</span><span class="na">closeEntry</span><span class="o">()</span>

<span class="c1">// Write each image</span>
<span class="kt">def</span> <span class="n">ai</span> <span class="o">=</span> <span class="n">QAdImage</span><span class="o">.</span><span class="na">adImage</span>
<span class="n">entityManagerHandler</span>
        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">ai</span><span class="o">)</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">ad</span><span class="o">().</span><span class="na">publicationPeriod</span><span class="o">().</span><span class="na">end</span><span class="o">.</span><span class="na">future</span><span class="o">())</span>
        <span class="o">.</span><span class="na">iterate</span><span class="o">(</span><span class="n">ai</span><span class="o">)</span>
        <span class="o">.</span><span class="na">forEachRemaining</span> <span class="o">{</span> <span class="n">AdImage</span> <span class="n">image</span> <span class="o">-&gt;</span>
            <span class="kt">def</span> <span class="n">contentType</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="na">getByMimeType</span><span class="o">(</span><span class="n">image</span><span class="o">.</span><span class="na">contentType</span><span class="o">)</span>
            <span class="n">zip</span><span class="o">.</span><span class="na">putNextEntry</span><span class="o">(</span><span class="k">new</span> <span class="n">ZipEntry</span><span class="o">(</span><span class="s2">"${image.id}.${contentType.extension}"</span><span class="o">))</span>
            <span class="n">storedFileHandler</span><span class="o">.</span><span class="na">getContent</span><span class="o">(</span><span class="n">image</span><span class="o">).</span><span class="na">withCloseable</span> <span class="o">{</span> <span class="n">content</span> <span class="o">-&gt;</span> <span class="n">IOUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">zip</span><span class="o">)</span> <span class="o">}</span>
            <span class="n">zip</span><span class="o">.</span><span class="na">closeEntry</span><span class="o">()</span>
            <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">clear</span><span class="o">()</span>
        <span class="o">}</span>

<span class="n">zip</span><span class="o">.</span><span class="na">finish</span><span class="o">()</span>
<span class="n">zip</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>

<span class="k">return</span> <span class="k">new</span> <span class="nf">FileInfo</span><span class="o">(</span>
        <span class="nl">content:</span> <span class="k">new</span> <span class="n">SerializableInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">),</span>
        <span class="nl">contentType:</span> <span class="n">ContentType</span><span class="o">.</span><span class="na">ZIP</span><span class="o">.</span><span class="na">mimeType</span><span class="o">,</span>
        <span class="nl">name:</span> <span class="s1">'ads.zip'</span><span class="o">,</span>
        <span class="nl">length:</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">())</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-run-directly-example-generate-account-numbers">Generating an account number for all accounts which doesn&#8217;t have a number yet</h6>
<div class="paragraph">
<p>If the account number is enabled after existing users / transactions, existing accounts will not have numbers automatically assigned.
To assign a number to all accounts (even system accounts) which don&#8217;t have a number yet, run the following script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.QSystemAccount</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.QBulkActionUser</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.AccountServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.bulkactions.AdjustAccountsBulkActionDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserQuery</span>

<span class="kt">int</span> <span class="n">system</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kt">def</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">QSystemAccount</span><span class="o">.</span><span class="na">systemAccount</span>
<span class="n">entityManagerHandler</span>
        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">sa</span><span class="o">)</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">sa</span><span class="o">.</span><span class="na">number</span><span class="o">.</span><span class="na">isNull</span><span class="o">())</span>
        <span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">sa</span><span class="o">)</span>
        <span class="o">.</span><span class="na">forEach</span> <span class="o">{</span> <span class="n">account</span> <span class="o">-&gt;</span>
            <span class="n">account</span><span class="o">.</span><span class="na">number</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">generateNumber</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">type</span><span class="o">,</span> <span class="n">account</span><span class="o">.</span><span class="na">owner</span><span class="o">)</span>
            <span class="n">system</span><span class="o">++</span>
        <span class="o">}</span>

<span class="kt">def</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserQuery</span><span class="o">();</span>
<span class="n">query</span><span class="o">.</span><span class="na">setUserStatus</span><span class="o">(</span><span class="n">AccountServiceLocal</span><span class="o">.</span><span class="na">POSSIBLE_STATUSES_TO_OWN_ACCOUNTS</span><span class="o">);</span>
<span class="kt">def</span> <span class="n">id</span> <span class="o">=</span> <span class="n">bulkActionService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">AdjustAccountsBulkActionDTO</span><span class="o">(</span><span class="nl">query:</span> <span class="n">query</span><span class="o">));</span>

<span class="kt">def</span> <span class="n">bau</span> <span class="o">=</span> <span class="n">QBulkActionUser</span><span class="o">.</span><span class="na">bulkActionUser</span>
<span class="kt">def</span> <span class="n">users</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">bau</span><span class="o">).</span><span class="na">where</span><span class="o">(</span><span class="n">bau</span><span class="o">.</span><span class="na">bulkAction</span><span class="o">().</span><span class="na">id</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">id</span><span class="o">)).</span><span class="na">fetchCount</span><span class="o">()</span>

<span class="k">return</span> <span class="s2">"Generated account numbers for ${system} system accounts"</span> <span class="o">+</span>
        <span class="s2">" and scheduled generation for ${users} users"</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-run-directly-example-custom-pdf">Generating a custom PDF file</h6>
<div class="paragraph">
<p>In this example, a custom PDF file is downloaded directly.
A similar example could be used as a custom operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.CyclosVersion</span>

<span class="kn">import</span> <span class="nn">groovy.xml.MarkupBuilder</span>

<span class="kt">def</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">()</span>

<span class="c1">// We'll be using Groovy's MarkupBuilder. Could also be a hand-crafted string</span>
<span class="kt">def</span> <span class="n">html</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MarkupBuilder</span><span class="o">(</span><span class="n">out</span><span class="o">)</span>
<span class="n">html</span><span class="o">.</span><span class="na">div</span> <span class="o">{</span>
    <span class="n">p</span> <span class="s2">"Currently logged-in as ${sessionData.loggedUser?.name}."</span>
    <span class="n">p</span> <span class="s2">"This is an example PDF."</span>
    <span class="n">div</span> <span class="kd">class</span><span class="err">:'</span><span class="nc">note</span><span class="err">'</span><span class="o">,</span> <span class="o">{</span>
        <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="s2">"Built with "</span>
        <span class="n">a</span> <span class="nl">href:</span> <span class="s2">"https://www.cyclos.org"</span><span class="o">,</span> <span class="s2">"Cyclos"</span>
        <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="s2">" version ${CyclosVersion.get()}"</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="n">css</span> <span class="o">=</span> <span class="s2">"""
    .note {
        font-size: 90%;
        color: #333;
        margin-top: 2cm;
        text-align: center;
    }
"""</span>

<span class="k">return</span> <span class="n">pdfHandler</span>
        <span class="o">.</span><span class="na">newTemplate</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">css</span><span class="o">)</span>
        <span class="o">.</span><span class="na">title</span><span class="o">(</span><span class="s2">"Example PDF"</span><span class="o">)</span>
        <span class="c1">// Or, instead of title, hide the header with .noHeader()</span>
        <span class="c1">// Similarly, could hide the footer with .noFooter()</span>
        <span class="o">.</span><span class="na">renderToFile</span><span class="o">(</span><span class="s2">"custom.pdf"</span><span class="o">)</span>
<span class="c1">// Alternatively, could use .render() instead of .renderToFile() to get the InputStream</span>
<span class="c1">// If the script needs a Base64 version of the content, do:</span>
<span class="c1">// Base64.encoder.encodeToString(inputStream.bytes)</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-run-directly-example-fix-balances">Manual account balance verification</h6>
<div class="paragraph">
<p>Some very large systems may choose to disable the online account balance verification recurring task, by setting <code>cyclos.accountsVerification.balanceCheckDays = never</code>. In such systems it has no effect to manually run the recurring task in the Reports &gt; System information &gt; Recurring tasks tab, because the task is a no-op. Instead, it can be executed by script, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">accountVerificationHandler</span><span class="o">.</span><span class="na">fixInconsistentBalances</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="scripting-type-run-directly-example-rebuild-balances">Manually rebuilding closed account balances</h6>
<div class="paragraph">
<p>Account balances are closed daily for accounts that had any transfers in that day. It should never be needed to manually do this operation, but in case of problems, it is possible to completely rebuild the closed balances of accounts since the beginning of history. This operation can take a long time depending on the amount of transfers in the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// Rebuild all account balances</span>
<span class="n">accountVerificationHandler</span><span class="o">.</span><span class="na">rebuildClosedBalances</span><span class="o">()</span>

<span class="c1">// Rebuild account balances of specific accounts with ids 1 and 2</span>
<span class="c1">// accountVerificationHandler.rebuildClosedBalances(1, 2)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scripting-solution">4.5. Solutions using scripts</h3>
<div class="paragraph">
<p>Examples of script types that require a single script can be found directly in the specific script description page (links directly above). Solutions that need several scripts and configurations can be found in this section.</p>
</div>
<div class="sect3">
<h4 id="scripting-solution-paypal">4.5.1. PayPal Integration</h4>
<div class="paragraph">
<p>It is possible to integrate Cyclos with <a href="http://www.paypal.com/">PayPal</a>, allowing users to top up their account by performing a payment from their PayPal account.</p>
</div>
<div class="paragraph">
<p>This is done with a custom operation which allows users to confirm the payment in PayPal and then, once the payment is confirmed, a payment from a system account is performed to the corresponding user account, automating the process of buying units. However, keep in mind the rates charged by PayPal, which vary according to some conditions.</p>
</div>
<div class="paragraph">
<p>To do so, first you&#8217;ll need a PayPal premium or business account (for testing  using PayPal sandbox  any account is enough). You&#8217;ll need to go to the <a href="https://developer.paypal.com/developer/applications/">PayPal Developer page</a> to create an application on "REST API apps", and get the client id and secret.</p>
</div>
<div class="paragraph">
<p>Then several configurations are required in Cyclos. Scripts can only be created as global administrators logged into a network, so it is advised to use a global admin to perform the configuration. Carefully follow each of the following steps:</p>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-root-url">Check the root URL</h5>
<div class="paragraph">
<p>Make sure that the configuration for users use a correct root URL. In System &gt; System configuration &gt; Configurations, select the configuration set for users and make sure the Main URL field points to the correct external URL. It will be used to generate the links which will be sent to PayPal, to redirect users back to Cyclos after confirming / canceling the operation.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-tx-number">Enable transaction number in currency</h5>
<div class="paragraph">
<p>This can be checked under System &gt; Currencies select the currency used for this operation, mark the Enable transfer number option and fill in the required parameters.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-system-record-type">Create a system record type to store the client id and secret</h5>
<div class="paragraph">
<p>Under System &gt; System configuration &gt; Record types, create a new system record type, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: PayPal Authentication;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>paypalAuth</code>;</p>
</li>
<li>
<p><strong>Display style</strong>: Single form;</p>
</li>
<li>
<p><strong>Main menu</strong>: System.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this record type, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Client ID</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>clientId</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Client Secret</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>clientSecret</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Token</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>token</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text;</p>
</li>
<li>
<p><strong>Required</strong>: No.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Token expiration</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>tokenExpiration</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Date</p>
</li>
<li>
<p><strong>Required</strong>: No.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-user-record-type">Create a user record type to store each payment information</h5>
<div class="paragraph">
<p>Under System &gt; System configuration &gt; Record types, create a new user record type, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: PayPal payment;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>paypalPayment</code>;</p>
</li>
<li>
<p><strong>Display style</strong>: List;</p>
</li>
<li>
<p><strong>Main menu</strong>: Banking;</p>
</li>
<li>
<p><strong>User management section</strong>: Banking.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this record type, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Payment ID</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>paymentId</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text;</p>
</li>
<li>
<p><strong>Required</strong>: No.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Amount</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>amount</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Decimal;</p>
</li>
<li>
<p><strong>Required</strong>: No.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Transaction</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>transaction</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Linked entity;</p>
</li>
<li>
<p><strong>Linked entity type</strong>: Transaction;</p>
</li>
<li>
<p><strong>Required</strong>: No.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-library-script">Create the library script</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create a new library script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: PayPal;</p>
</li>
<li>
<p><strong>Type</strong>: Library;</p>
</li>
<li>
<p><strong>Included libraries</strong>: none;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># Settings for the access token record type
</span><span class="py">auth.recordType</span> <span class="p">=</span> <span class="s">paypalAuth</span>
<span class="py">auth.clientId</span> <span class="p">=</span> <span class="s">clientId</span>
<span class="py">auth.clientSecret</span> <span class="p">=</span> <span class="s">clientSecret</span>
<span class="py">auth.token</span> <span class="p">=</span> <span class="s">token</span>
<span class="py">auth.tokenExpiration</span> <span class="p">=</span> <span class="s">tokenExpiration</span>

<span class="c"># Settings for the payment record type
</span><span class="py">payment.recordType</span> <span class="p">=</span> <span class="s">paypalPayment</span>
<span class="py">payment.paymentId</span> <span class="p">=</span> <span class="s">paymentId</span>
<span class="py">payment.amount</span> <span class="p">=</span> <span class="s">amount</span>
<span class="py">payment.transaction</span> <span class="p">=</span> <span class="s">transaction</span>

<span class="c"># Settings for PayPal
</span><span class="py">mode</span> <span class="p">=</span> <span class="s">sandbox</span>
<span class="py">currency</span> <span class="p">=</span> <span class="s">EUR</span>
<span class="py">paymentDescription</span> <span class="p">=</span> <span class="s">Buy Cyclos units</span>

<span class="c"># Settings for the Cyclos payment
</span><span class="py">multiplier</span> <span class="p">=</span> <span class="s">1</span>
<span class="py">accountType</span> <span class="p">=</span> <span class="s">debitUnits</span>
<span class="py">paymentType</span> <span class="p">=</span> <span class="s">paypalCredits</span>

<span class="c"># Messages
</span><span class="py">error.invalidRequest</span> <span class="p">=</span> <span class="s">Invalid request</span>
<span class="py">error.transactionNotFound</span> <span class="p">=</span> <span class="s">Transaction not found</span>
<span class="py">error.transactionAlreadyApproved</span> <span class="p">=</span> <span class="s">The transaction was already approved</span>
<span class="py">error.payment</span> <span class="p">=</span> <span class="s">There was an error while processing the payment. Please, try again.</span>
<span class="py">error.notApproved</span> <span class="p">=</span> <span class="s">The payment was not approved</span>
<span class="py">message.canceled</span> <span class="p">=</span> <span class="s">You have cancelled the operation.</span><span class="se">\n</span><span class="s">Feel free to start again if needed.</span>
<span class="py">message.done</span> <span class="p">=</span> <span class="s">You have successfully completed the payment. Thank you.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Script code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span>

<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.PaymentTransferType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.SystemAccountType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.RecordCustomField</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.SystemRecord</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.SystemRecordType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecord</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecordType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.PaymentServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.messaging.AlertServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.users.RecordServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.persistence.EntityManagerHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.EntityNotFoundException</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.SystemAccountOwner</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PaymentVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PerformPaymentDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transfertypes.TransferTypeVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.messaging.alerts.SystemAlertType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.records.RecordDataParams</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.records.UserRecordDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.recordtypes.RecordTypeVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserLocatorVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.ParameterStorage</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.ParameterizedTypeReference</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpEntity</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpMethod</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.MediaType</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.LinkedMultiValueMap</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>
<span class="kn">import</span> <span class="nn">groovy.transform.TypeCheckingMode</span>

<span class="cm">/**
 * Class used to store / retrieve the authentication information for PayPal
 * A system record type is used, with the following fields: client id (string),
 * client secret (string), access token (string) and token expiration (date)
 */</span>
<span class="nd">@TypeChecked</span>
<span class="kd">class</span> <span class="nc">PayPalAuth</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">recordTypeName</span>
    <span class="n">String</span> <span class="n">clientIdName</span>
    <span class="n">String</span> <span class="n">clientSecretName</span>
    <span class="n">String</span> <span class="n">tokenName</span>
    <span class="n">String</span> <span class="n">tokenExpirationName</span>

    <span class="n">SystemRecordType</span> <span class="n">recordType</span>
    <span class="n">SystemRecord</span> <span class="n">record</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">wrapped</span>

    <span class="kd">public</span> <span class="nf">PayPalAuth</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">variables</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">params</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptParameters</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
        <span class="n">recordTypeName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="s1">'auth.recordType'</span> <span class="o">?:</span> <span class="s1">'paypalAuth'</span>
        <span class="n">clientIdName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="s1">'auth.clientId'</span> <span class="o">?:</span> <span class="s1">'clientId'</span>
        <span class="n">clientSecretName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="s1">'auth.clientSecret'</span> <span class="o">?:</span> <span class="s1">'clientSecret'</span>
        <span class="n">tokenName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="s1">'auth.token'</span> <span class="o">?:</span> <span class="s1">'token'</span>
        <span class="n">tokenExpirationName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="s1">'auth.tokenExpiration'</span> <span class="o">?:</span> <span class="s1">'tokenExpiration'</span>

        <span class="c1">// Read the record type and the parameters for field internal names</span>
        <span class="n">recordType</span> <span class="o">=</span> <span class="o">(</span><span class="n">variables</span><span class="o">.</span><span class="na">entityManagerHandler</span> <span class="k">as</span> <span class="n">EntityManagerHandler</span><span class="o">)</span>
                <span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">SystemRecordType</span><span class="o">,</span> <span class="n">recordTypeName</span><span class="o">)</span>

        <span class="c1">// Should return the existing instance, of a single form type.</span>
        <span class="c1">// Otherwise it would be an error</span>
        <span class="kt">def</span> <span class="n">dataParams</span> <span class="o">=</span>
                <span class="k">new</span> <span class="nf">RecordDataParams</span><span class="o">(</span><span class="nl">recordType:</span> <span class="k">new</span> <span class="n">RecordTypeVO</span><span class="o">(</span><span class="nl">id:</span> <span class="n">recordType</span><span class="o">.</span><span class="na">id</span><span class="o">))</span>
        <span class="n">record</span> <span class="o">=</span> <span class="o">(</span><span class="n">variables</span><span class="o">.</span><span class="na">recordService</span> <span class="k">as</span> <span class="n">RecordServiceLocal</span><span class="o">)</span>
                <span class="o">.</span><span class="na">newEntity</span><span class="o">(</span><span class="n">dataParams</span><span class="o">)</span> <span class="k">as</span> <span class="n">SystemRecord</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">record</span><span class="o">.</span><span class="na">persistent</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span>
            <span class="s2">"No instance of system record ${recordType.name} was found"</span><span class="o">)</span>

        <span class="n">wrapped</span> <span class="o">=</span> <span class="o">(</span><span class="n">variables</span><span class="o">.</span><span class="na">scriptHelper</span> <span class="k">as</span> <span class="n">ScriptHelper</span><span class="o">).</span><span class="na">wrap</span><span class="o">(</span><span class="n">record</span><span class="o">,</span> <span class="n">recordType</span><span class="o">.</span><span class="na">fields</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getClientId</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">clientIdName</span><span class="o">]</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getClientSecret</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">clientSecretName</span><span class="o">]</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getToken</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">tokenName</span><span class="o">]</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getTokenExpiration</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">tokenExpirationName</span><span class="o">]</span> <span class="k">as</span> <span class="n">Date</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setClientId</span><span class="o">(</span><span class="n">String</span> <span class="n">clientId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">clientIdName</span><span class="o">]</span> <span class="o">=</span> <span class="n">clientId</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setClientSecret</span><span class="o">(</span><span class="n">String</span> <span class="n">clientSecret</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">clientSecretName</span><span class="o">]</span> <span class="o">=</span> <span class="n">clientSecret</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">tokenName</span><span class="o">]</span> <span class="o">=</span> <span class="n">token</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTokenExpiration</span><span class="o">(</span><span class="n">Date</span> <span class="n">tokenExpiration</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">tokenExpirationName</span><span class="o">]</span> <span class="o">=</span> <span class="n">tokenExpiration</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Class used to store / retrieve PayPal payments as user records in Cyclos
 */</span>
<span class="nd">@TypeChecked</span>
<span class="kd">class</span> <span class="nc">PayPalRecord</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">recordTypeName</span>
    <span class="n">String</span> <span class="n">paymentIdName</span>
    <span class="n">String</span> <span class="n">amountName</span>
    <span class="n">String</span> <span class="n">transactionName</span>

    <span class="n">UserRecordType</span> <span class="n">recordType</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">RecordCustomField</span><span class="o">&gt;</span> <span class="n">fields</span>

    <span class="kd">private</span> <span class="n">EntityManagerHandler</span> <span class="n">entityManagerHandler</span>
    <span class="kd">private</span> <span class="n">RecordServiceLocal</span> <span class="n">recordService</span>
    <span class="kd">private</span> <span class="n">ScriptHelper</span> <span class="n">scriptHelper</span>

    <span class="kd">public</span> <span class="nf">PayPalRecord</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">variables</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">params</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptParameters</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
        <span class="n">recordTypeName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="s1">'payment.recordType'</span> <span class="o">?:</span> <span class="s1">'paypalPayment'</span>
        <span class="n">paymentIdName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="s1">'payment.paymentId'</span> <span class="o">?:</span> <span class="s1">'paymentId'</span>
        <span class="n">amountName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="s1">'payment.amount'</span> <span class="o">?:</span> <span class="s1">'amount'</span>
        <span class="n">transactionName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="s1">'payment.transaction'</span> <span class="o">?:</span> <span class="s1">'transaction'</span>

        <span class="n">entityManagerHandler</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">entityManagerHandler</span> <span class="k">as</span> <span class="n">EntityManagerHandler</span>
        <span class="n">recordService</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">recordService</span> <span class="k">as</span> <span class="n">RecordServiceLocal</span>
        <span class="n">scriptHelper</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptHelper</span> <span class="k">as</span> <span class="n">ScriptHelper</span>
        <span class="n">recordType</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">UserRecordType</span><span class="o">,</span> <span class="n">recordTypeName</span><span class="o">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="o">[:]</span>
        <span class="n">recordType</span><span class="o">.</span><span class="na">fields</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">fields</span><span class="o">[</span><span class="n">f</span><span class="o">.</span><span class="na">internalName</span><span class="o">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Creates a payment record, for the given user and JSON,
     * as returned from PayPal's create payment REST method
     */</span>
    <span class="kd">public</span> <span class="n">UserRecord</span> <span class="nf">create</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">Number</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">RecordDataParams</span> <span class="n">newParams</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordDataParams</span><span class="o">([</span>
            <span class="nl">user:</span> <span class="k">new</span> <span class="n">UserLocatorVO</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">id</span><span class="o">),</span>
            <span class="nl">recordType:</span> <span class="k">new</span> <span class="n">RecordTypeVO</span><span class="o">(</span><span class="n">recordType</span><span class="o">.</span><span class="na">id</span><span class="o">)])</span>
        <span class="kt">def</span> <span class="n">dto</span> <span class="o">=</span> <span class="n">recordService</span><span class="o">.</span><span class="na">getDataForNew</span><span class="o">(</span><span class="n">newParams</span><span class="o">).</span><span class="na">dto</span> <span class="k">as</span> <span class="n">UserRecordDTO</span>
        <span class="kt">def</span> <span class="n">wrapped</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">dto</span><span class="o">,</span> <span class="n">recordType</span><span class="o">.</span><span class="na">fields</span><span class="o">)</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">amountName</span><span class="o">]</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="n">UserRecord</span> <span class="n">record</span> <span class="o">=</span> <span class="n">recordService</span><span class="o">.</span><span class="na">saveEntity</span><span class="o">(</span><span class="n">dto</span><span class="o">)</span>
        <span class="k">return</span> <span class="n">record</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Finds the record by id
     */</span>
    <span class="kd">public</span> <span class="n">UserRecord</span> <span class="nf">find</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">UserRecord</span> <span class="n">userRecord</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">UserRecord</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">userRecord</span><span class="o">.</span><span class="na">type</span> <span class="o">!=</span> <span class="n">recordType</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">userRecord</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">EntityNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Removes the given record, but only if it is of the
     * expected type and hasn't been confirmed
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">UserRecord</span> <span class="n">userRecord</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userRecord</span><span class="o">.</span><span class="na">type</span> <span class="o">!=</span> <span class="n">recordType</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span>
        <span class="o">}</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">wrapped</span> <span class="o">=</span> <span class="n">scriptHelper</span>
                <span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">userRecord</span><span class="o">,</span> <span class="n">recordType</span><span class="o">.</span><span class="na">fields</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">wrapped</span><span class="o">[</span><span class="n">transactionName</span><span class="o">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span>
            <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">userRecord</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Class used to interact with PayPal services
 */</span>
<span class="nd">@TypeChecked</span>
<span class="kd">class</span> <span class="nc">PayPalService</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">mode</span>
    <span class="n">String</span> <span class="n">baseUrl</span>
    <span class="n">String</span> <span class="n">currency</span>
    <span class="n">String</span> <span class="n">paymentDescription</span>

    <span class="n">String</span> <span class="n">accountTypeName</span>
    <span class="n">String</span> <span class="n">paymentTypeName</span>
    <span class="kt">double</span> <span class="n">multiplier</span>

    <span class="n">SystemAccountType</span> <span class="n">accountType</span>
    <span class="n">PaymentTransferType</span> <span class="n">paymentType</span>
    <span class="n">PayPalAuth</span> <span class="n">auth</span>
    <span class="n">PayPalRecord</span> <span class="n">record</span>

    <span class="kd">private</span> <span class="n">ScriptHelper</span> <span class="n">scriptHelper</span>
    <span class="kd">private</span> <span class="n">PaymentServiceLocal</span> <span class="n">paymentService</span>
    <span class="kd">private</span> <span class="n">AlertServiceLocal</span> <span class="n">alertService</span>
    <span class="kd">private</span> <span class="n">ParameterStorage</span> <span class="n">storage</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">params</span>
    <span class="kd">private</span> <span class="n">RestTemplate</span> <span class="n">rest</span>

    <span class="nf">PayPalService</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">variables</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">auth</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayPalAuth</span><span class="o">(</span><span class="n">variables</span><span class="o">)</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">record</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayPalRecord</span><span class="o">(</span><span class="n">variables</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">EntityNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// There are usages without user record</span>
        <span class="o">}</span>
        <span class="n">scriptHelper</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptHelper</span> <span class="k">as</span> <span class="n">ScriptHelper</span>
        <span class="n">paymentService</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">paymentService</span> <span class="k">as</span> <span class="n">PaymentServiceLocal</span>
        <span class="n">alertService</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">alertService</span> <span class="k">as</span> <span class="n">AlertServiceLocal</span>
        <span class="n">storage</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">parameterStorage</span> <span class="k">as</span> <span class="n">ParameterStorage</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptParameters</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">rest</span> <span class="k">as</span> <span class="n">RestTemplate</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">mode</span> <span class="o">?:</span> <span class="s1">'sandbox'</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">'sandbox'</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">'live'</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s2">"Invalid PayPal parameter "</span> <span class="o">+</span>
            <span class="s2">"'mode': ${mode}. Should be either sandbox or live"</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">baseUrl</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">'sandbox'</span>
                <span class="o">?</span> <span class="s1">'https://api.sandbox.paypal.com'</span> <span class="o">:</span> <span class="s1">'https://api.paypal.com'</span>

        <span class="n">currency</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">currency</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currency</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">currency</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s2">"Missing PayPal parameter 'currency'"</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="kt">def</span> <span class="n">emh</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">entityManagerHandler</span> <span class="k">as</span> <span class="n">EntityManagerHandler</span>
        <span class="n">accountTypeName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">accountType</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">accountTypeName</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">accountTypeName</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s2">"Missing PayPal parameter 'accountType'"</span><span class="o">)</span>
        <span class="n">paymentTypeName</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">paymentType</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">paymentTypeName</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">paymentTypeName</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s2">"Missing PayPal parameter 'paymentType'"</span><span class="o">)</span>
        <span class="n">accountType</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">SystemAccountType</span><span class="o">,</span> <span class="n">accountTypeName</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">accountType</span><span class="o">.</span><span class="na">currency</span><span class="o">.</span><span class="na">transactionNumber</span><span class="o">?.</span><span class="na">used</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s2">"Currency "</span> <span class="o">+</span> <span class="n">accountType</span><span class="o">.</span><span class="na">currency</span>
            <span class="o">+</span> <span class="s2">" doesn't have transaction number enabled"</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">paymentType</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">PaymentTransferType</span><span class="o">,</span> <span class="n">paymentTypeName</span><span class="o">,</span> <span class="n">accountType</span><span class="o">)</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">((</span><span class="n">params</span><span class="o">.</span><span class="na">multiplier</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span> <span class="o">?:</span> <span class="s2">"1"</span><span class="o">)</span>
        <span class="n">paymentDescription</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">paymentDescription</span> <span class="o">?:</span> <span class="s2">""</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Creates an order in PayPal and the corresponding user record
     */</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">createOrder</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">Number</span> <span class="n">amount</span><span class="o">,</span> <span class="n">String</span> <span class="n">callbackUrl</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Create the UserRecord for this payment</span>
        <span class="n">UserRecord</span> <span class="n">userRecord</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">amount</span><span class="o">)</span>
        <span class="c1">//store the record's id to retrieve it after the payment was confirmed in PayPal</span>
        <span class="n">storage</span><span class="o">[</span><span class="s1">'recordId'</span><span class="o">]</span> <span class="o">=</span> <span class="n">userRecord</span><span class="o">.</span><span class="na">id</span>

        <span class="c1">// Create the payment in PayPal</span>
        <span class="kt">def</span> <span class="n">json</span> <span class="o">=</span> <span class="n">createOrder</span><span class="o">(</span><span class="n">amount</span><span class="o">,</span> <span class="n">callbackUrl</span><span class="o">)</span>
        <span class="c1">//store the PayPal order id to retrieve it after the payment was confirmed in PayPal</span>
        <span class="n">storage</span><span class="o">[</span><span class="s1">'orderId'</span><span class="o">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="na">id</span>

        <span class="k">return</span> <span class="n">json</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Creates an order in PayPal with a given amount, without updating any record
     */</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">createOrder</span><span class="o">(</span><span class="n">Number</span> <span class="n">amount</span><span class="o">,</span> <span class="n">String</span> <span class="n">callbackUrl</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">callbackUrl</span> <span class="o">+=</span> <span class="n">callbackUrl</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s2">"?"</span><span class="o">)</span> <span class="o">?</span> <span class="s2">"&amp;"</span> <span class="o">:</span> <span class="s2">"?"</span>
        <span class="n">String</span> <span class="n">returnUrl</span> <span class="o">=</span> <span class="s2">"${callbackUrl}success=true"</span>
        <span class="n">String</span> <span class="n">cancelUrl</span> <span class="o">=</span> <span class="s2">"${callbackUrl}cancel=true"</span>

        <span class="kt">def</span> <span class="n">jsonBody</span> <span class="o">=</span> <span class="o">[</span>
            <span class="nl">intent:</span> <span class="s2">"CAPTURE"</span><span class="o">,</span>
            <span class="nl">application_context:</span> <span class="o">[</span>
                <span class="nl">return_url:</span> <span class="n">returnUrl</span><span class="o">,</span>
                <span class="nl">cancel_url:</span> <span class="n">cancelUrl</span><span class="o">,</span>
                <span class="nl">user_action:</span> <span class="s2">"PAY_NOW"</span>
            <span class="o">],</span>
            <span class="nl">purchase_units:</span> <span class="o">[</span>
                <span class="o">[</span>
                    <span class="nl">description:</span> <span class="n">paymentDescription</span><span class="o">,</span>
                    <span class="nl">amount:</span> <span class="o">[</span>
                        <span class="nl">value:</span> <span class="n">amount</span><span class="o">,</span>
                        <span class="nl">currency_code:</span> <span class="n">currency</span>
                    <span class="o">]</span>
                <span class="o">]</span>
            <span class="o">]</span>
        <span class="o">]</span>
        <span class="c1">// Create the payment in PayPal</span>
        <span class="k">return</span> <span class="nf">performRequest</span><span class="o">(</span><span class="s2">"${baseUrl}/v2/checkout/orders"</span><span class="o">,</span> <span class="n">jsonBody</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Capture the order (execute the payment in PayPal)
     */</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">captureOrder</span><span class="o">(</span><span class="n">String</span> <span class="n">orderId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">performRequest</span><span class="o">(</span><span class="s2">"${baseUrl}/v2/checkout/orders/${orderId}/capture"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Get the order information from PayPal
     */</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">getOrderFromPayPal</span><span class="o">(</span><span class="n">String</span> <span class="n">orderId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">performRequest</span><span class="o">(</span><span class="s2">"${baseUrl}/v2/checkout/orders/${orderId}"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Executes a PayPal payment, and creates the payment in Cyclos
     */</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">execute</span><span class="o">(</span><span class="n">UserRecord</span> <span class="n">userRecord</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">wrapped</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">userRecord</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">orderId</span> <span class="o">=</span> <span class="n">storage</span><span class="o">[</span><span class="s1">'orderId'</span><span class="o">]</span> <span class="k">as</span> <span class="n">String</span>
        <span class="c1">// Execute the payment in PayPal</span>
        <span class="kt">def</span> <span class="n">capturedOrder</span> <span class="o">=</span> <span class="n">captureOrder</span><span class="o">(</span><span class="n">orderId</span><span class="o">)</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
        <span class="c1">// Update the payment id</span>
        <span class="n">wrapped</span><span class="o">[</span><span class="n">record</span><span class="o">.</span><span class="na">paymentIdName</span><span class="o">]</span> <span class="o">=</span> <span class="n">getPaymentIdFromCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">vo</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Try to perform the payment in Cyclos, if it fails, refund the payment in PayPal</span>
            <span class="n">vo</span> <span class="o">=</span> <span class="n">perform</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">,</span> <span class="n">userRecord</span><span class="o">.</span><span class="na">user</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">refundCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">,</span> <span class="n">userRecord</span><span class="o">,</span> <span class="n">userRecord</span><span class="o">.</span><span class="na">user</span><span class="o">)</span>
            <span class="k">throw</span> <span class="n">ex</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">vo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Update the record, setting the linked transaction</span>
            <span class="n">wrapped</span><span class="o">[</span><span class="n">record</span><span class="o">.</span><span class="na">transactionName</span><span class="o">]</span> <span class="o">=</span> <span class="n">vo</span>
            <span class="n">userRecord</span><span class="o">.</span><span class="na">lastModifiedDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">()</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">capturedOrder</span>
    <span class="o">}</span>
    <span class="cm">/**
     * Refund the completed order using the refund link returned when the
     * order was captured and remove the user record if given
     */</span>
    <span class="kt">void</span> <span class="nf">refundCapturedOrder</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">capturedOrder</span><span class="o">,</span> <span class="n">UserRecord</span> <span class="n">userRecord</span><span class="o">,</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">refundLink</span> <span class="o">=</span> <span class="n">getRefundLinkFromCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">refundLink</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">def</span> <span class="n">refundedOrder</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// Make the refund</span>
                <span class="n">refundedOrder</span> <span class="o">=</span> <span class="n">performRequest</span><span class="o">(</span><span class="n">refundLink</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//Do nothing because an alert is going to be created</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(!</span><span class="n">refundedOrder</span> <span class="o">||</span> <span class="n">refundedOrder</span><span class="o">.</span><span class="na">status</span> <span class="o">!=</span> <span class="s2">"COMPLETED"</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">createRefundFailAlert</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">,</span> <span class="n">user</span><span class="o">)</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">userRecord</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">record</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">userRecord</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="cm">/**
     * Create the system alert for a failed refund
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createRefundFailAlert</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">capturedOrder</span><span class="o">,</span> <span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">errorMessage</span> <span class="o">=</span> <span class="s2">"""User: ${user.username}. The PayPal payment
            (${getPaymentIdFromCapturedOrder(capturedOrder)}) was completed,
            but there was an error in Cyclos and the attempt to refund in PayPal failed."""</span>
        <span class="n">alertService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">SystemAlertType</span><span class="o">.</span><span class="na">CUSTOM</span><span class="o">,</span> <span class="n">errorMessage</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs the payment in Cyclos
     */</span>
    <span class="n">PaymentVO</span> <span class="nf">perform</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">capturedOrder</span><span class="o">,</span> <span class="n">User</span> <span class="n">subject</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getPaymentStatusFromCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">)</span> <span class="o">==</span> <span class="s1">'COMPLETED'</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">def</span> <span class="n">amount</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">getAmountFromCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">)</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
            <span class="n">BigDecimal</span> <span class="n">finalAmount</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">multiplier</span>
            <span class="c1">// Perform the payment in Cyclos</span>
            <span class="n">PerformPaymentDTO</span> <span class="n">dto</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PerformPaymentDTO</span><span class="o">()</span>
            <span class="n">dto</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">SystemAccountOwner</span><span class="o">.</span><span class="na">instance</span><span class="o">()</span>
            <span class="n">dto</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="n">subject</span>
            <span class="n">dto</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">finalAmount</span>
            <span class="n">dto</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransferTypeVO</span><span class="o">(</span><span class="n">paymentType</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
            <span class="k">return</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">dto</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Get the payment id of a captured order result
     */</span>
    <span class="nd">@TypeChecked</span><span class="o">(</span><span class="n">TypeCheckingMode</span><span class="o">.</span><span class="na">SKIP</span><span class="o">)</span>
    <span class="n">String</span> <span class="nf">getPaymentIdFromCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">capturedOrder</span><span class="o">.</span><span class="na">purchase_units</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">payments</span><span class="o">.</span><span class="na">captures</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">id</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Get the payment status of a captured order result.
     * We must get the status from the captured payment
     * because it will be NOT completed even when the order status is completed
     */</span>
    <span class="nd">@TypeChecked</span><span class="o">(</span><span class="n">TypeCheckingMode</span><span class="o">.</span><span class="na">SKIP</span><span class="o">)</span>
    <span class="n">String</span> <span class="nf">getPaymentStatusFromCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">capturedOrder</span><span class="o">.</span><span class="na">purchase_units</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">payments</span><span class="o">.</span><span class="na">captures</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">status</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Get the amount of a captured order result
     */</span>
    <span class="nd">@TypeChecked</span><span class="o">(</span><span class="n">TypeCheckingMode</span><span class="o">.</span><span class="na">SKIP</span><span class="o">)</span>
    <span class="n">String</span> <span class="nf">getAmountFromCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">capturedOrder</span><span class="o">.</span><span class="na">purchase_units</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">payments</span><span class="o">.</span><span class="na">captures</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">amount</span><span class="o">.</span><span class="na">value</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Get the refund link of a captured order result
     */</span>
    <span class="nd">@TypeChecked</span><span class="o">(</span><span class="n">TypeCheckingMode</span><span class="o">.</span><span class="na">SKIP</span><span class="o">)</span>
    <span class="n">String</span> <span class="nf">getRefundLinkFromCapturedOrder</span><span class="o">(</span><span class="n">capturedOrder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">capturedOrder</span><span class="o">.</span><span class="na">purchase_units</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">payments</span><span class="o">.</span><span class="na">captures</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">links</span><span class="o">.</span><span class="na">find</span> <span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">rel</span> <span class="o">==</span> <span class="s2">"refund"</span><span class="o">}?.</span><span class="na">href</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs a synchronous request, posting and accepting JSON
     */</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">performRequest</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="kt">def</span> <span class="n">jsonBody</span><span class="o">,</span> <span class="n">HttpMethod</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Check if we need a new token</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">auth</span><span class="o">.</span><span class="na">token</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">auth</span><span class="o">.</span><span class="na">tokenExpiration</span> <span class="o">&lt;</span> <span class="k">new</span> <span class="n">Date</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">refreshToken</span><span class="o">()</span>
        <span class="o">}</span>

        <span class="c1">// Send the request</span>
        <span class="kt">def</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">()</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setBearerAuth</span><span class="o">(</span><span class="n">auth</span><span class="o">.</span><span class="na">token</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">responseType</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ParameterizedTypeReference</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;()</span> <span class="o">{}</span>
        <span class="k">return</span> <span class="n">rest</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">(</span><span class="n">jsonBody</span><span class="o">,</span> <span class="n">headers</span><span class="o">),</span> <span class="n">responseType</span><span class="o">).</span><span class="na">body</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Refreshes the access token
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">refreshToken</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">"${baseUrl}/v1/oauth2/token"</span>
        <span class="kt">def</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">()</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">)</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="n">auth</span><span class="o">.</span><span class="na">clientId</span><span class="o">,</span> <span class="n">auth</span><span class="o">.</span><span class="na">clientSecret</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span>
        <span class="n">body</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s2">"grant_type"</span><span class="o">,</span> <span class="o">[</span><span class="s2">"client_credentials"</span><span class="o">])</span>
        <span class="kt">def</span> <span class="n">response</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="na">postForObject</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="n">headers</span><span class="o">),</span> <span class="n">Map</span><span class="o">)</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>

        <span class="c1">// Update the authentication data</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">access_token</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">tokenExpiration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span>
                <span class="o">(((</span><span class="n">response</span><span class="o">.</span><span class="na">expires_in</span> <span class="k">as</span> <span class="n">Integer</span><span class="o">)</span> <span class="o">-</span> <span class="mi">30</span><span class="o">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">))</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-operation-script">Create the custom operation script</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create a new custom operation script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Buy units with PayPal;</p>
</li>
<li>
<p><strong>Type</strong>: Custom operation;</p>
</li>
<li>
<p><strong>Run with all permissions</strong>: Yes;</p>
</li>
<li>
<p><strong>Included libraries</strong>: PayPal;</p>
</li>
<li>
<p><strong>Parameters</strong>: leave empty.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the custom operation is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">createPayment</span><span class="o">(){</span>
    <span class="kt">def</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span>
    <span class="kt">def</span> <span class="n">formParameters</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">formParameters</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
    <span class="kt">def</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayPalService</span><span class="o">(</span><span class="n">variables</span><span class="o">)</span>

    <span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">user</span> <span class="k">as</span> <span class="n">User</span>
    <span class="kt">def</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">amount</span> <span class="k">as</span> <span class="n">Number</span>
    <span class="kt">def</span> <span class="n">returnUrl</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">returnUrl</span> <span class="k">as</span> <span class="n">String</span>
    <span class="kt">def</span> <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">createOrder</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">amount</span><span class="o">,</span> <span class="n">returnUrl</span><span class="o">)</span>

    <span class="kt">def</span> <span class="n">links</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">links</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;[]</span>
    <span class="kt">def</span> <span class="n">link</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="na">find</span> <span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">rel</span> <span class="o">==</span> <span class="s2">"approve"</span><span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">link</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">link</span><span class="o">.</span><span class="na">href</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s2">"No approval url returned from PayPal"</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">createPayment</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Script code executed when the external site redirects the user back to Cyclos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecord</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.utils.RequestInfo</span>
<span class="kn">import</span> <span class="nn">org.cyclos.server.utils.ObjectParameterStorage</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">payPalCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
    <span class="kt">def</span> <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptParameters</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
    <span class="kt">def</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayPalService</span><span class="o">(</span><span class="n">variables</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">storage</span> <span class="k">as</span> <span class="n">ObjectParameterStorage</span>
    <span class="kt">def</span> <span class="n">recordId</span> <span class="o">=</span> <span class="n">storage</span><span class="o">[</span><span class="s1">'recordId'</span><span class="o">]</span> <span class="k">as</span> <span class="n">Long</span>
    <span class="kt">def</span> <span class="n">request</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">request</span> <span class="k">as</span> <span class="n">RequestInfo</span>
    <span class="kt">def</span> <span class="n">record</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">record</span>

    <span class="c1">// No record?</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">recordId</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s2">"[ERROR] "</span> <span class="o">+</span>
                <span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="s1">'error.invalidRequest'</span> <span class="o">?:</span> <span class="s2">"Invalid request"</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="c1">// Find the corresponding record</span>
    <span class="n">UserRecord</span> <span class="n">userRecord</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">recordId</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">userRecord</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s2">"[ERROR] "</span> <span class="o">+</span>
                <span class="o">(</span><span class="n">scriptParameters</span><span class="o">.</span><span class="s1">'error.transactionNotFound'</span>
                <span class="o">?:</span> <span class="s2">"Transaction not found"</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="kt">def</span> <span class="n">wrapped</span> <span class="o">=</span> <span class="o">(</span><span class="n">variables</span><span class="o">.</span><span class="na">scriptHelper</span> <span class="k">as</span> <span class="n">ScriptHelper</span><span class="o">).</span><span class="na">wrap</span><span class="o">(</span><span class="n">userRecord</span><span class="o">)</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s2">"cancel"</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// The operation has been canceled.</span>
        <span class="c1">// Remove the record and send a message.</span>
        <span class="n">record</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">userRecord</span><span class="o">)</span>
        <span class="k">return</span> <span class="s2">"[WARN]"</span> <span class="o">+</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="s1">'message.canceled'</span>
                <span class="o">?:</span> <span class="s2">"You have cancelled the operation.\nFeel free to start again if needed."</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// Execute the payment</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">def</span> <span class="n">order</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">userRecord</span><span class="o">)</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="na">getPaymentStatusFromCapturedOrder</span><span class="o">(</span><span class="n">order</span><span class="o">)</span> <span class="o">==</span> <span class="s1">'COMPLETED'</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="s1">'message.done'</span>
                        <span class="o">?:</span> <span class="s2">"You have successfully completed the payment. Thank you."</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s2">"[ERROR] "</span> <span class="o">+</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="s1">'error.notApproved'</span>
                        <span class="o">?:</span> <span class="s2">"The payment was not approved"</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s2">"[ERROR] "</span> <span class="o">+</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="s1">'error.payment'</span>
                    <span class="o">?:</span> <span class="s2">"There was an error while processing the payment. Please, try again."</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">payPalCallback</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-operation">Create the custom operation</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Custom operations, create a new one with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Buy units with PayPal (can be changed  will be the label displayed on the menu);</p>
</li>
<li>
<p><strong>Enabled</strong>: Yes;</p>
</li>
<li>
<p><strong>Scope</strong>: User;</p>
</li>
<li>
<p><strong>Script</strong>: Buy units with PayPal;</p>
</li>
<li>
<p><strong>Script parameters</strong>: leave empty;</p>
</li>
<li>
<p><strong>Result type</strong>: External redirect;</p>
</li>
<li>
<p><strong>Has file upload</strong>: no;</p>
</li>
<li>
<p><strong>Main menu</strong>: Banking;</p>
</li>
<li>
<p><strong>User management section</strong>: Banking;</p>
</li>
<li>
<p><strong>Information text</strong>: You can add here some text explaining the process  it will be displayed in the operation page;</p>
</li>
<li>
<p><strong>Confirmation text</strong>: Leave empty (can be used to show a dialog asking the user to confirm before submitting, but in this case is not needed).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this custom operation, create the following form field:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Amount;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>amount</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Decimal;</p>
</li>
<li>
<p><strong>Decimal digits</strong>: 2;</p>
</li>
<li>
<p><strong>Required</strong>: yes.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-system-account">Configure the system account from which payments will be performed to users</h5>
<div class="paragraph">
<p>Under System &gt; Accounts configuration &gt; Account types, choose the (normally unlimited) account from which payments will be performed to users. Then set its internal name to some meaningful name. The example configuration uses <code>debitUnits</code> as internal name, but it can be changed. Save the form.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-payment-type">Configure the payment type which will be used on payments</h5>
<div class="paragraph">
<p>Still in the details page for the account type, on the Transfer types tab, create a new Payment transfer type with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Units bought with PayPal (can be changed as desired);</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>paypalCredits</code>;</p>
</li>
<li>
<p><strong>To</strong>: Select the user account which will receive the payment;</p>
</li>
<li>
<p><strong>Enabled</strong>: Yes.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-admin-permissions">Grant the administrator permissions</h5>
<div class="paragraph">
<p>Under System &gt; User configuration &gt; Groups, select the Network administrators group. Then, in the Permissions tab:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In System &gt; System records, set the permissions to view, create and edit for the PayPal authentication record;</p>
</li>
<li>
<p>In User data &gt; User records, make the PayPal payment visible only (make sure to create, edit and remove are unchecked, as this record is not meant to be manually edited);</p>
</li>
<li>
<p>Save the permissions.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-credentials">Setup the PayPal credentials</h5>
<div class="paragraph">
<p>Click System &gt; System records &gt; PayPal authentication. If this menu entry is not showing up, refresh the browser page (by pressing F5) and try again. Update the Client ID and Client Secret fields exactly with the ones you got in the application you registered in the <a href="https://developer.paypal.com/developer/applications">PayPal Developer page</a>.</p>
</div>
<div class="paragraph">
<p>Remember that PayPal has a sandbox, which can be used to test the application, and a live environment. For now, use the sandbox credentials. The other 2 fields can be left blank. Save the record.</p>
</div>
<div class="paragraph">
<p>Once the record is properly set, if you want to remove it from the menu, you can just remove the permission to view this system record in the administrator group page.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-user-permissions">Grant the user permissions / enable the operation</h5>
<div class="paragraph">
<p>In System &gt; User configuration &gt; Products (permissions), select the member product for users which will run the operation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the Custom operations field, make the Buy units with PayPal both enabled and allowed to run;</p>
</li>
<li>
<p>In Records, enable the PayPal payment record. It can be made visible to the users themselves. If not, only admins will be able to see the records;</p>
</li>
<li>
<p>Save the product. From this moment, the operation will show up for users in the banking menu.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-script-params">Configuring the script parameters</h5>
<div class="paragraph">
<p>In the PayPal library script, in parameters, there are several configurations which can be done. All those settings can be overridden in the custom operation&#8217;s script parameters, allowing using distinct configurations for distinct operations.</p>
</div>
<div class="paragraph">
<p>For example, it is possible to have distinct operations to perform payments in distinct currencies. In that case, the script parameters for each operation would define the currency again.</p>
</div>
<div class="paragraph">
<p>Here are some elements which can be configured:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Internal names for the records used to store the credentials and payments.</p>
</li>
<li>
<p>PayPal mode: the <code>mode</code> parameter can be either <code>sandbox</code> or <code>live</code>, indicating that operations are performed either in a test or in the real environment. To go live, you&#8217;ll need a premier or business account in PayPal, and you need to use the live credentials (client ID and client secret) in Cyclos.</p>
</li>
<li>
<p>Payment currency: the <code>currency</code> parameter defines the 3-letter <a href="http://en.wikipedia.org/wiki/ISO_4217">ISO 4217</a> code for the currency in PayPal. Sometimes, according to country-specific laws, the currency used for payments may be limited. For example, Brazilians can only pay other Brazilians in Reais. Make sure the PayPal destination account can receive payments for the specified currency, otherwise payments or refunds will fail;</p>
</li>
<li>
<p>Description for payments in PayPal: using the <code>paymentDescription</code> setting.</p>
</li>
<li>
<p>Amount multiplier: Sometimes it may be desired that the payment performed in Cyclos isn&#8217;t of the exact amount of the payment in PayPal. This can normally be resolved using transfer fees, but it could also be handy to use this parameter called <code>multiplier</code>. If left in 1, the payment in Cyclos will have the same amount as the one in PayPal. If greater / less than 1, the payment in Cyclos will be greater / less than the one in PayPal. For example, if the <code>multiplier</code> is 1.05, and the PayPal payment was 100 USD, the payment in Cyclos will have the amount 105. Or, if the multiplier is 0.95 and the PayPal payment was 200 EUR, the payment in Cyclos will be of 190.</p>
</li>
<li>
<p>System account from which the payment will be performed to users: the <code>accountType</code> setting is the internal name of the system account type from which payments will be performed, as explained previously. Make sure it is exactly the same as set in the account type.</p>
</li>
<li>
<p>Payment type: the <code>paymentType</code> setting is the internal name of the payment transfer type used. Make sure it is exactly the same internal name set in the payment type that was created in previous steps.</p>
</li>
<li>
<p>Messages: several messages (displayed to the user) can be set / translated here.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-paypal-other">Other considerations</h5>
<div class="paragraph">
<p>Make sure the payment type is from an unlimited account, so payments in Cyclos won&#8217;t fail because of funds. The way the example script is done, first the payment is executed in PayPal and, if authorized, a payment is made in Cyclos. If this payment fails, to avoid inconsistency between the Cyclos account and the PayPal payment, a refund payment is performed in PayPal. If that refund fails, it creates a Custom system alert, so it is advisable to have admins receive that type of alert.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-solution-loan">4.5.2. Loan module</h4>
<div class="paragraph">
<p>Loan features in Cyclos 4 can be implemented using scripting. As loans tend to be very specific for each project, having it implemented with scripts brings the possibility to tailor the behavior to each project.</p>
</div>
<div class="paragraph">
<p>The example provided works as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An administrator has a custom operation to grant the loan, setting the amount, number of installments and first installment date.</p>
</li>
<li>
<p>The loan is a payment from a system account to a user. It has a status, which can be either open or closed.</p>
</li>
<li>
<p>The same custom operation also performs a scheduled payment from the user to the system, with each installment amount and due date corresponding to the loan installments. This scheduled payment has (with a custom field) a link to the original loan. Also, the loan payment has a link to the scheduled payment, making it easy to navigate between them. However, if the loan is pending authorization, the scheduled payment won&#8217;t be created.</p>
</li>
<li>
<p>Each installment will be processed at the respective due date, allowing users to repay the loan with internal units. The administrator can, however, mark individual installments as settled, which means the installment won&#8217;t be repaid internally, but with some other way (for example, with money or using other Cyclos payments).</p>
</li>
<li>
<p>Once the scheduled payment is closed, an extension point updates the status of the original payment to closed.</p>
</li>
<li>
<p>If the original loan was submitted for authorization, an extension point is triggered when it is authorized, and then creates the scheduled payment. <strong>IMPORTANT:</strong> If the administrator performing a payment also has the permission to authorize it, the payment will be immediately processed. So, be careful when testing with a single administrator group when authorization is desired, as in that case the loan would never get to authorization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to configure the loan script, follow carefully each of the following steps:</p>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-tx-number">Enable transaction number in currency</h5>
<div class="paragraph">
<p>This can be checked under System &gt; Currencies select the currency used for this operation, mark the Enable transfer number option and fill in the required parameters.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-status-flow">Create the transfer status flow</h5>
<div class="paragraph">
<p>Under System &gt; Accounts configuration &gt; Transfer status flows, create a new one, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Name: Loan status (can be changed as desired);</p>
</li>
<li>
<p>Internal name: loan (this name is used in the example configuration).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After saving, create the following statuses:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Closed</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>closed</code>;</p>
</li>
<li>
<p><strong>Possible next statuses</strong>: &lt;None&gt;.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Open</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>open</code>;</p>
</li>
<li>
<p><strong>Possible next statuses</strong>: Closed.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-tx-fields">Create the payment custom fields</h5>
<div class="paragraph">
<p>Under System &gt; Accounts configuration &gt; Payment fields, create a new one, with the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Installments count</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>numberOfInstallments</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Integer;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>First due date</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>firstDueDate</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Date;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Loan</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>loan</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Linked entity;</p>
</li>
<li>
<p><strong>Linked entity type</strong>: Transaction;</p>
</li>
<li>
<p><strong>Required</strong>: No.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Repayment</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>repayment</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Linked entity;</p>
</li>
<li>
<p><strong>Linked entity type</strong>: Transaction;</p>
</li>
<li>
<p><strong>Required</strong>: No.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-system-account">Configure the system account from which payments will be performed to users</h5>
<div class="paragraph">
<p>Under System &gt; Accounts configuration &gt; Account types, choose the (normally unlimited) account from which payments will be performed to users.
Then set its internal name to some meaningful name.
The example configuration uses debitUnits as internal name, but it can be changed later.
Save the form.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-type-grant">Create the payment type which will be used to grant the loan</h5>
<div class="paragraph">
<p>Still in the system account type details page for the account type, on the Transfer types tab, create a new Payment transfer type with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Loan (can be changed as desired);</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>loanGrant</code>;</p>
</li>
<li>
<p><strong>Default description</strong>: Loan grant (can be changed as desired, is the description for payments, visible in the account history);</p>
</li>
<li>
<p><strong>To</strong>: select the user account which will receive the payment;</p>
</li>
<li>
<p><strong>Transfer status flows</strong>: Loan status;</p>
</li>
<li>
<p><strong>Initial status for Loan status</strong>: Open;</p>
</li>
<li>
<p><strong>Enabled</strong>: Yes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After saving, on the "Payment fields" tab, add the following custom fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Installments count;</p>
</li>
<li>
<p>First due date;</p>
</li>
<li>
<p>Repayment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the loan can go through authorization, then create an authorization role in System &gt; Account configuration &gt; Authorization roles. Then, in the payment type details, check the "Requires authorization" field. After saving, in the "Authorization levels" tab, add a new authorization level with that role. Afterwards, grant some administrator group the permission to manage that authorization role.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-user-account">Configure the user account which will receive loans</h5>
<div class="paragraph">
<p>Under System &gt; Accounts configuration &gt; Account types, choose the user account which will receive payments. Then set its internal name to some meaningful name. The example configuration uses <code>userUnits</code> as internal name. Save the form.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-type-repay">Create the payment type which will be used to repay the loan</h5>
<div class="paragraph">
<p>Still in the user account type details page, on the Transfer types tab, create a new Payment transfer type with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Loan repayment (can be changed as desired);</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>loanRepayment</code>;</p>
</li>
<li>
<p><strong>Default description</strong>: Loan repayment (can be changed as desired, is the description for payments, visible in the account history);</p>
</li>
<li>
<p><strong>To</strong>: select the system account which granted the loan;</p>
</li>
<li>
<p><strong>Enabled</strong>: Yes;</p>
</li>
<li>
<p><strong>Allows scheduled payment</strong>: Yes;</p>
</li>
<li>
<p><strong>Max installments on scheduled payments</strong>: 36 (any value greater than zero is fine);</p>
</li>
<li>
<p><strong>Show scheduled payments to receiver</strong>: Yes;</p>
</li>
<li>
<p><strong>Reserve total amount on scheduled payments</strong>: No.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After saving, on the Payment fields tab, add the custom field named "Loan".</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-library">Create the library script</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create a new library script, with the following script parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># Loan configuration
</span><span class="py">loan.account</span> <span class="p">=</span> <span class="s">debitUnits</span>
<span class="py">loan.type</span> <span class="p">=</span> <span class="s">loanGrant</span>
<span class="c">#loan.description =
</span>
<span class="c"># Repayment configuration
</span><span class="py">repayment.account</span> <span class="p">=</span> <span class="s">userUnits</span>
<span class="py">repayment.type</span> <span class="p">=</span> <span class="s">loanRepayment</span>
<span class="c">#repayment.description =
</span>
<span class="c"># Payment custom fields
</span><span class="py">field.loan</span> <span class="p">=</span> <span class="s">loan</span>
<span class="py">field.repayment</span> <span class="p">=</span> <span class="s">repayment</span>

<span class="c"># Monthly compound interest rate (zero for none)
</span><span class="py">monthlyInterestRate</span> <span class="p">=</span> <span class="s">0</span>

<span class="c"># Transfer status configuration
</span><span class="py">status.flow</span> <span class="p">=</span> <span class="s">loan</span>
<span class="py">status.open</span> <span class="p">=</span> <span class="s">open</span>
<span class="py">status.closed</span> <span class="p">=</span> <span class="s">closed</span>

<span class="c"># Custom operation configuration
</span><span class="py">operation.amount</span> <span class="p">=</span> <span class="s">amount</span>
<span class="py">operation.installments</span> <span class="p">=</span> <span class="s">numberOfInstallments</span>
<span class="py">operation.firstDueDate</span> <span class="p">=</span> <span class="s">firstDueDate</span>

<span class="c"># Messages
</span><span class="py">message.invalidInstallments</span> <span class="p">=</span> <span class="s">The number of installments is invalid</span>
<span class="py">message.invalidLoanAmount</span> <span class="p">=</span> <span class="s">Invalid loan amount</span>
<span class="py">message.invalidFirstDueDate</span> <span class="p">=</span> <span class="s">The first due date cannot be lower than tomorrow</span>
<span class="py">message.loanGranted</span> <span class="p">=</span> <span class="s">The loan was successfully granted</span>
<span class="py">message.loanGranted.pending</span> <span class="p">=</span> <span class="s">The loan was granted and is now pending authorization</span>
<span class="py">message.authorization.expired</span> <span class="p">=</span> <span class="s">The loan cannot be authorized as the first due date is over</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The script code is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.Payment</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.PaymentTransferType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.ScheduledPayment</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.SystemAccountType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.TransactionCustomField</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.Transfer</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.TransferStatus</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.TransferStatusFlow</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.UserAccountType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.access.SessionData</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.PaymentServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.ScheduledPaymentServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.TransferStatusServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ConfigurationAccessor</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.persistence.EntityManagerHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounts.SystemAccountOwner</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.InstallmentDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PaymentVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PerformPaymentDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.PerformScheduledPaymentDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.ScheduledPaymentVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transfers.TransferVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transferstatus.ChangeTransferStatusDTO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transferstatus.TransferStatusVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transfertypes.TransferTypeVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.utils.TimeField</span>
<span class="kn">import</span> <span class="nn">org.cyclos.server.utils.DateHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.BigDecimalHelper</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>



<span class="nd">@TypeChecked</span>
<span class="kd">class</span> <span class="nc">Loan</span> <span class="o">{</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">config</span>
    <span class="n">EntityManagerHandler</span> <span class="n">emh</span>
    <span class="n">PaymentServiceLocal</span> <span class="n">paymentService</span>
    <span class="n">ScheduledPaymentServiceLocal</span> <span class="n">scheduledPaymentService</span>
    <span class="n">TransferStatusServiceLocal</span> <span class="n">transferStatusService</span>
    <span class="n">ScriptHelper</span> <span class="n">scriptHelper</span>
    <span class="n">ConfigurationAccessor</span> <span class="n">configuration</span>

    <span class="kt">double</span> <span class="n">monthlyInterestRate</span>
    <span class="n">SystemAccountType</span> <span class="n">systemAccount</span>
    <span class="n">UserAccountType</span> <span class="n">userAccount</span>
    <span class="n">PaymentTransferType</span> <span class="n">loanType</span>
    <span class="n">PaymentTransferType</span> <span class="n">repaymentType</span>
    <span class="n">TransactionCustomField</span> <span class="n">loanField</span>
    <span class="n">TransactionCustomField</span> <span class="n">repaymentField</span>
    <span class="n">TransferStatusFlow</span> <span class="n">flow</span>
    <span class="n">TransferStatus</span> <span class="n">open</span>
    <span class="n">TransferStatus</span> <span class="n">closed</span>

    <span class="nf">Loan</span><span class="o">(</span><span class="n">Binding</span> <span class="n">binding</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span>
        <span class="n">config</span> <span class="o">=</span> <span class="o">[:]</span>
        <span class="kt">def</span> <span class="n">params</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptParameters</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
        <span class="o">[</span>
            <span class="s1">'loan.account'</span><span class="o">:</span> <span class="s1">'systemAccount'</span><span class="o">,</span>
            <span class="s1">'loan.type'</span><span class="o">:</span> <span class="s1">'loanGrant'</span><span class="o">,</span>
            <span class="s1">'loan.description'</span><span class="o">:</span> <span class="kc">null</span><span class="o">,</span>
            <span class="s1">'repayment.account'</span><span class="o">:</span> <span class="s1">'userUnits'</span><span class="o">,</span>
            <span class="s1">'repayment.type'</span><span class="o">:</span> <span class="s1">'loanRepayment'</span><span class="o">,</span>
            <span class="s1">'repayment.description'</span><span class="o">:</span> <span class="kc">null</span><span class="o">,</span>
            <span class="s1">'field.loan'</span><span class="o">:</span> <span class="s1">'loan'</span><span class="o">,</span>
            <span class="s1">'field.repayment'</span><span class="o">:</span> <span class="s1">'repayment'</span><span class="o">,</span>
            <span class="s1">'monthlyInterestRate'</span> <span class="o">:</span> <span class="kc">null</span><span class="o">,</span>
            <span class="s1">'status.flow'</span><span class="o">:</span> <span class="s1">'loan'</span><span class="o">,</span>
            <span class="s1">'status.open'</span><span class="o">:</span> <span class="s1">'open'</span><span class="o">,</span>
            <span class="s1">'status.closed'</span><span class="o">:</span> <span class="s1">'closed'</span><span class="o">,</span>
            <span class="s1">'operation.amount'</span><span class="o">:</span> <span class="s1">'amount'</span><span class="o">,</span>
            <span class="s1">'operation.installments'</span><span class="o">:</span> <span class="s1">'installments'</span><span class="o">,</span>
            <span class="s1">'operation.firstDueDate'</span><span class="o">:</span> <span class="s1">'firstDueDate'</span><span class="o">,</span>
            <span class="s1">'message.invalidInstallments'</span><span class="o">:</span>
            <span class="s1">'The number of installments is invalid'</span><span class="o">,</span>
            <span class="s1">'message.invalidLoanAmount'</span><span class="o">:</span> <span class="s1">'Invalid loan amount'</span><span class="o">,</span>
            <span class="s1">'message.invalidFirstDueDate'</span><span class="o">:</span>
            <span class="s1">'The first due date cannot be lower than tomorrow'</span><span class="o">,</span>
            <span class="s1">'message.loanGranted'</span><span class="o">:</span>
            <span class="s1">'The loan was successfully granted to the user'</span><span class="o">,</span>
            <span class="s1">'message.loanGranted.pending'</span><span class="o">:</span>
            <span class="s1">'The loan was granted and is now pending authorization'</span><span class="o">,</span>
            <span class="s1">'message.authorization.expired'</span><span class="o">:</span>
            <span class="s1">'The loan cannot be authorized as the first due date is over'</span>
        <span class="o">].</span><span class="na">each</span> <span class="o">{</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span> <span class="o">-&gt;</span>
            <span class="n">config</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">?:</span> <span class="n">v</span>
        <span class="o">}</span>
        <span class="n">emh</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">entityManagerHandler</span> <span class="k">as</span> <span class="n">EntityManagerHandler</span>
        <span class="n">paymentService</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">paymentService</span> <span class="k">as</span> <span class="n">PaymentServiceLocal</span>
        <span class="n">scriptHelper</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">scriptHelper</span> <span class="k">as</span> <span class="n">ScriptHelper</span>
        <span class="n">scheduledPaymentService</span> <span class="o">=</span>
                <span class="n">variables</span><span class="o">.</span><span class="na">scheduledPaymentService</span> <span class="k">as</span> <span class="n">ScheduledPaymentServiceLocal</span>
        <span class="n">transferStatusService</span> <span class="o">=</span>
                <span class="n">variables</span><span class="o">.</span><span class="na">transferStatusService</span> <span class="k">as</span> <span class="n">TransferStatusServiceLocal</span>
        <span class="n">configuration</span> <span class="o">=</span>
                <span class="o">(</span><span class="n">variables</span><span class="o">.</span><span class="na">sessionData</span> <span class="k">as</span> <span class="n">SessionData</span><span class="o">).</span><span class="na">configuration</span> <span class="k">as</span> <span class="n">ConfigurationAccessor</span>

        <span class="n">systemAccount</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">SystemAccountType</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="s1">'loan.account'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">systemAccount</span><span class="o">.</span><span class="na">currency</span><span class="o">.</span><span class="na">transactionNumber</span> <span class="o">==</span> <span class="kc">null</span>
                <span class="o">||</span> <span class="o">!</span><span class="n">systemAccount</span><span class="o">.</span><span class="na">currency</span><span class="o">.</span><span class="na">transactionNumber</span><span class="o">.</span><span class="na">used</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s2">"The currency ${systemAccount.currency.name}"</span>
            <span class="o">+</span> <span class="s2">" doesn't have transaction number enabled"</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">userAccount</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">UserAccountType</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="s1">'repayment.account'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
        <span class="n">loanType</span> <span class="o">=</span>
                <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">PaymentTransferType</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="s1">'loan.type'</span> <span class="k">as</span> <span class="n">String</span><span class="o">,</span> <span class="n">systemAccount</span><span class="o">)</span>
        <span class="n">repaymentType</span> <span class="o">=</span>
                <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">PaymentTransferType</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="s1">'repayment.type'</span> <span class="k">as</span> <span class="n">String</span><span class="o">,</span> <span class="n">userAccount</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">repaymentType</span><span class="o">.</span><span class="na">allowsScheduledPayments</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
            <span class="s2">"The repayment type ${repaymentType.name} doesn't allows scheduled payment"</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="n">loanField</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">TransactionCustomField</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="s1">'field.loan'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
        <span class="n">repaymentField</span> <span class="o">=</span>
                <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">TransactionCustomField</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="s1">'field.repayment'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">loanType</span><span class="o">.</span><span class="na">customFields</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">repaymentField</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s2">"The loan type ${loanType.name}"</span>
            <span class="o">+</span> <span class="s2">" doesn't contain the custom field ${repaymentField.name}"</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">repaymentType</span><span class="o">.</span><span class="na">customFields</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">loanField</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s2">"The repayment type ${repaymentType.name}"</span>
            <span class="o">+</span> <span class="s2">" doesn't contain the custom field ${loanField.name}"</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">TransferStatusFlow</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="s1">'status.flow'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
        <span class="n">open</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">TransferStatus</span><span class="o">,</span><span class="n">config</span><span class="o">.</span><span class="s1">'status.open'</span> <span class="k">as</span> <span class="n">String</span><span class="o">,</span> <span class="n">flow</span><span class="o">)</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">TransferStatus</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="s1">'status.closed'</span> <span class="k">as</span> <span class="n">String</span><span class="o">,</span> <span class="n">flow</span><span class="o">)</span>
        <span class="n">monthlyInterestRate</span> <span class="o">=</span> <span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="s1">'monthlyInterestRate'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)?.</span><span class="na">toDouble</span><span class="o">()</span> <span class="o">?:</span> <span class="mi">0</span>
    <span class="o">}</span>

    <span class="n">BigDecimal</span> <span class="nf">calculateInstallmentAmount</span><span class="o">(</span><span class="n">BigDecimal</span> <span class="n">amount</span><span class="o">,</span> <span class="kt">int</span> <span class="n">installments</span><span class="o">,</span>
            <span class="n">Date</span> <span class="n">grantDate</span><span class="o">,</span> <span class="n">Date</span> <span class="n">firstInstallmentDate</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// Calculate the delay</span>
        <span class="n">Date</span> <span class="n">shouldBeFirstExpiration</span> <span class="o">=</span> <span class="n">DateHelper</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">grantDate</span><span class="o">,</span> <span class="n">TimeField</span><span class="o">.</span><span class="na">DAYS</span><span class="o">,</span> <span class="mi">30</span><span class="o">)</span>
        <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">DateHelper</span><span class="o">.</span><span class="na">daysBetween</span><span class="o">(</span><span class="n">firstInstallmentDate</span><span class="o">,</span> <span class="n">shouldBeFirstExpiration</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="o">}</span>
        <span class="kt">double</span> <span class="n">interest</span> <span class="o">=</span> <span class="n">monthlyInterestRate</span> <span class="o">/</span> <span class="mf">100.0</span>
        <span class="kt">double</span> <span class="n">numerator</span> <span class="o">=</span> <span class="o">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">interest</span><span class="o">)</span> <span class="o">**</span> <span class="o">(</span><span class="n">installments</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">/</span> <span class="mf">30.0</span><span class="o">))</span> <span class="o">*</span> <span class="n">interest</span>
        <span class="kt">double</span> <span class="n">denominator</span> <span class="o">=</span> <span class="o">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">interest</span><span class="o">)</span> <span class="o">**</span> <span class="n">installments</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">BigDecimal</span> <span class="n">result</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
        <span class="k">return</span> <span class="n">BigDecimalHelper</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">systemAccount</span><span class="o">.</span><span class="na">currency</span><span class="o">.</span><span class="na">precision</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="n">ScheduledPayment</span> <span class="n">scheduledPayment</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">map</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">scheduledPayment</span><span class="o">)</span>
        <span class="n">Payment</span> <span class="n">loan</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">loanField</span><span class="o">.</span><span class="na">internalName</span><span class="o">)</span> <span class="k">as</span> <span class="n">Payment</span>
        <span class="n">Transfer</span> <span class="n">loanTransfer</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="na">transfer</span>
        <span class="n">TransferStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">loanTransfer</span><span class="o">.</span><span class="na">getStatus</span><span class="o">(</span><span class="n">flow</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">closed</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// The loan was not closed: close it</span>
            <span class="n">transferStatusService</span><span class="o">.</span><span class="na">changeStatus</span><span class="o">(</span><span class="k">new</span> <span class="n">ChangeTransferStatusDTO</span><span class="o">([</span>
                <span class="nl">transfer:</span> <span class="k">new</span> <span class="n">TransferVO</span><span class="o">(</span><span class="n">loanTransfer</span><span class="o">.</span><span class="na">id</span><span class="o">),</span>
                <span class="nl">newStatus:</span> <span class="k">new</span> <span class="n">TransferStatusVO</span><span class="o">(</span><span class="n">closed</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
            <span class="o">]))</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">Payment</span> <span class="nf">grant</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">formParameters</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">BigDecimal</span> <span class="n">loanAmount</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">[</span><span class="n">config</span><span class="o">.</span><span class="s1">'operation.amount'</span><span class="o">]</span> <span class="k">as</span> <span class="n">BigDecimal</span>
        <span class="kt">int</span> <span class="n">installments</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">[</span><span class="n">config</span><span class="o">.</span><span class="s1">'operation.installments'</span><span class="o">]</span> <span class="k">as</span> <span class="kt">int</span>
        <span class="n">Date</span> <span class="n">firstDueDate</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">[</span><span class="n">config</span><span class="o">.</span><span class="s1">'operation.firstDueDate'</span><span class="o">]</span> <span class="k">as</span> <span class="n">Date</span>
        <span class="n">Date</span> <span class="n">minDate</span> <span class="o">=</span> <span class="n">DateHelper</span><span class="o">.</span><span class="na">shiftToNextDay</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">(),</span> <span class="n">configuration</span><span class="o">.</span><span class="na">timeZone</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">installments</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">installments</span> <span class="o">&gt;</span> <span class="n">repaymentType</span><span class="o">.</span><span class="na">maxInstallments</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="s1">'message.invalidInstallments'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">loanAmount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="s1">'message.invalidLoanAmount'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">firstDueDate</span> <span class="o">&lt;</span> <span class="n">minDate</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="s1">'message.invalidFirstDueDate'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>

        <span class="c1">// Grant the loan, copying the installments count and first due date</span>
        <span class="n">PerformPaymentDTO</span> <span class="n">perform</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PerformPaymentDTO</span><span class="o">([</span>
            <span class="nl">owner:</span> <span class="n">SystemAccountOwner</span><span class="o">.</span><span class="na">instance</span><span class="o">(),</span>
            <span class="nl">subject:</span> <span class="n">user</span><span class="o">,</span>
            <span class="nl">type:</span> <span class="k">new</span> <span class="n">TransferTypeVO</span><span class="o">(</span><span class="n">loanType</span><span class="o">.</span><span class="na">id</span><span class="o">),</span>
            <span class="nl">amount:</span> <span class="n">loanAmount</span><span class="o">,</span>
            <span class="nl">description:</span> <span class="n">config</span><span class="o">.</span><span class="s1">'loan.description'</span> <span class="k">as</span> <span class="n">String</span>
        <span class="o">])</span>
        <span class="kt">def</span> <span class="n">performBean</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">perform</span><span class="o">)</span>
        <span class="n">performBean</span><span class="o">[</span><span class="n">config</span><span class="o">.</span><span class="s1">'operation.installments'</span> <span class="k">as</span> <span class="n">String</span><span class="o">]</span> <span class="o">=</span> <span class="n">installments</span>
        <span class="n">performBean</span><span class="o">[</span><span class="n">config</span><span class="o">.</span><span class="s1">'operation.firstDueDate'</span> <span class="k">as</span> <span class="n">String</span><span class="o">]</span> <span class="o">=</span> <span class="n">firstDueDate</span>
        <span class="n">PaymentVO</span> <span class="n">loanVO</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">perform</span><span class="o">)</span>
        <span class="n">Payment</span> <span class="n">loan</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Payment</span><span class="o">,</span> <span class="n">loanVO</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">loan</span><span class="o">.</span><span class="na">transfer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// The loan is processed. Create the repayment</span>
            <span class="n">createRepayment</span><span class="o">(</span><span class="n">loan</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">loan</span>
    <span class="o">}</span>

    <span class="n">ScheduledPayment</span> <span class="nf">createRepayment</span><span class="o">(</span><span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Transfer</span> <span class="n">loanTransfer</span> <span class="o">=</span> <span class="n">payment</span><span class="o">.</span><span class="na">transfer</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">loanTransfer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span>
        <span class="o">}</span>
        <span class="n">TransferStatus</span> <span class="n">currentStatus</span> <span class="o">=</span> <span class="n">loanTransfer</span><span class="o">.</span><span class="na">getStatus</span><span class="o">(</span><span class="n">flow</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentStatus</span> <span class="o">!=</span> <span class="n">open</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span>
            <span class="s2">"The initial status for flow ${flow.name} in ${loanType.name} "</span>
            <span class="o">+</span> <span class="s2">"is not the expected one: ${open.name}, but ${currentStatus?.name} instead"</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="c1">// Read the scheduling information from the loan</span>
        <span class="kt">def</span> <span class="n">loanBean</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">payment</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">existingRepayment</span> <span class="o">=</span> <span class="n">loanBean</span><span class="o">[</span><span class="n">repaymentField</span><span class="o">.</span><span class="na">internalName</span><span class="o">]</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">existingRepayment</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">existingRepayment</span> <span class="k">as</span> <span class="n">ScheduledPayment</span>
        <span class="o">}</span>
        <span class="n">BigDecimal</span> <span class="n">loanAmount</span> <span class="o">=</span> <span class="n">payment</span><span class="o">.</span><span class="na">amount</span>
        <span class="n">Integer</span> <span class="n">installments</span> <span class="o">=</span> <span class="n">loanBean</span><span class="o">[</span><span class="n">config</span><span class="o">.</span><span class="s1">'operation.installments'</span><span class="o">]</span> <span class="k">as</span> <span class="n">Integer</span>
        <span class="n">Date</span> <span class="n">firstDueDate</span> <span class="o">=</span> <span class="n">loanBean</span><span class="o">[</span><span class="n">config</span><span class="o">.</span><span class="s1">'operation.firstDueDate'</span><span class="o">]</span> <span class="k">as</span> <span class="n">Date</span>

        <span class="c1">// Make sure the first due date is not expired</span>
        <span class="n">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">()</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">firstDueDate</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="n">now</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="s1">'message.authorization.expired'</span> <span class="k">as</span> <span class="n">String</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="c1">// Perform the repayment scheduled payment</span>
        <span class="n">PerformScheduledPaymentDTO</span> <span class="n">dto</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PerformScheduledPaymentDTO</span><span class="o">([</span>
            <span class="nl">from:</span> <span class="n">payment</span><span class="o">.</span><span class="na">toOwner</span><span class="o">,</span>
            <span class="nl">to:</span> <span class="n">payment</span><span class="o">.</span><span class="na">fromOwner</span><span class="o">,</span>
            <span class="nl">type:</span> <span class="k">new</span> <span class="n">TransferTypeVO</span><span class="o">(</span><span class="n">repaymentType</span><span class="o">.</span><span class="na">id</span><span class="o">),</span>
            <span class="nl">amount:</span> <span class="n">payment</span><span class="o">.</span><span class="na">amount</span><span class="o">,</span>
            <span class="nl">description:</span> <span class="n">config</span><span class="o">.</span><span class="s1">'repayment.description'</span> <span class="k">as</span> <span class="n">String</span>
        <span class="o">])</span>
        <span class="kt">def</span> <span class="n">dtoBean</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">dto</span><span class="o">)</span>
        <span class="n">dtoBean</span><span class="o">.</span><span class="na">installmentsCount</span> <span class="o">=</span> <span class="n">installments</span>
        <span class="n">dtoBean</span><span class="o">.</span><span class="na">firstInstallmentDate</span> <span class="o">=</span> <span class="n">firstDueDate</span>
        <span class="n">dtoBean</span><span class="o">[</span><span class="n">loanField</span><span class="o">.</span><span class="na">internalName</span><span class="o">]</span> <span class="o">=</span> <span class="n">payment</span>

        <span class="c1">// Interest</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">monthlyInterestRate</span> <span class="o">&gt;</span> <span class="mf">0.00001</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">BigDecimal</span> <span class="n">installmentAmount</span> <span class="o">=</span> <span class="n">calculateInstallmentAmount</span><span class="o">(</span>
                    <span class="n">loanAmount</span><span class="o">,</span> <span class="n">installments</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(),</span> <span class="n">firstDueDate</span><span class="o">)</span>

            <span class="n">dto</span><span class="o">.</span><span class="na">installments</span> <span class="o">=</span> <span class="o">[]</span>
            <span class="n">Date</span> <span class="n">dueDate</span> <span class="o">=</span> <span class="n">firstDueDate</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">installments</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="kt">def</span> <span class="n">installment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstallmentDTO</span><span class="o">()</span>
                <span class="kt">def</span> <span class="n">instBean</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">installment</span><span class="o">)</span>
                <span class="n">instBean</span><span class="o">.</span><span class="na">dueDate</span> <span class="o">=</span> <span class="n">dueDate</span>
                <span class="n">instBean</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">installmentAmount</span>
                <span class="n">dto</span><span class="o">.</span><span class="na">installments</span> <span class="o">&lt;&lt;</span> <span class="n">installment</span>
                <span class="n">dueDate</span> <span class="o">=</span> <span class="n">DateHelper</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dueDate</span><span class="o">,</span> <span class="n">TimeField</span><span class="o">.</span><span class="na">DAYS</span><span class="o">,</span> <span class="mi">30</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="n">dtoBean</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">installmentAmount</span> <span class="o">*</span> <span class="n">installments</span>
        <span class="o">}</span>

        <span class="n">ScheduledPaymentVO</span> <span class="n">repaymentVO</span> <span class="o">=</span> <span class="n">scheduledPaymentService</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">dto</span><span class="o">)</span>
        <span class="n">ScheduledPayment</span> <span class="n">repayment</span> <span class="o">=</span> <span class="n">emh</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">ScheduledPayment</span><span class="o">,</span> <span class="n">repaymentVO</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>

        <span class="c1">// Update the loan with the repayment link</span>
        <span class="n">loanBean</span><span class="o">[</span><span class="n">repaymentField</span><span class="o">.</span><span class="na">internalName</span><span class="o">]</span> <span class="o">=</span> <span class="n">repayment</span>
        <span class="k">return</span> <span class="n">repayment</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">loan</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Loan</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-operation-script">Create the custom operation script</h5>
<div class="paragraph">
<p>Create a new script for the custom operation, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Name: Grant loan;</p>
</li>
<li>
<p>Type: Custom operation;</p>
</li>
<li>
<p>Included libraries: Loan;</p>
</li>
<li>
<p>Run with all permissions: No;</p>
</li>
<li>
<p>Parameters: leave empty.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the custom operation is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.Payment</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">grantLoan</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span>
    <span class="n">Loan</span> <span class="n">loan</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">loan</span> <span class="k">as</span> <span class="n">Loan</span>
    <span class="n">Payment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">loan</span><span class="o">.</span><span class="na">grant</span><span class="o">(</span><span class="n">variables</span><span class="o">.</span><span class="na">user</span> <span class="k">as</span> <span class="n">User</span><span class="o">,</span>
        <span class="n">variables</span><span class="o">.</span><span class="na">formParameters</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">payment</span><span class="o">.</span><span class="na">transfer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">loan</span><span class="o">.</span><span class="na">config</span><span class="o">[</span><span class="s1">'message.loanGranted.pending'</span><span class="o">]</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">loan</span><span class="o">.</span><span class="na">config</span><span class="o">[</span><span class="s1">'message.loanGranted'</span><span class="o">]</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">grantLoan</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-extension-points">Create two extension point scripts</h5>
<div class="paragraph">
<p>Create a new script for the transaction extension point, which will close the loan when all installments are processed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Loan closing;</p>
</li>
<li>
<p><strong>Type</strong>: Extension point;</p>
</li>
<li>
<p><strong>Included libraries</strong>: Loan;</p>
</li>
<li>
<p><strong>Parameters</strong>: leave empty.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the data is saved:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.ScheduledPayment</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.transactions.ScheduledPaymentStatus</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">closeLoan</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">ScheduledPayment</span> <span class="n">transaction</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">transaction</span> <span class="k">as</span> <span class="n">ScheduledPayment</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">status</span> <span class="o">==</span> <span class="n">ScheduledPaymentStatus</span><span class="o">.</span><span class="na">CANCELED</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Should never cancel a loan scheduled payment</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span><span class="s2">"Cannot cancel a loan"</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">status</span> <span class="o">==</span> <span class="n">ScheduledPaymentStatus</span><span class="o">.</span><span class="na">CLOSED</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Close the loan</span>
        <span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">loan</span> <span class="k">as</span> <span class="n">Loan</span><span class="o">).</span><span class="na">close</span><span class="o">(</span><span class="n">transaction</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">closeLoan</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, create another script for the authorization extension point, which will create the repayment scheduled payment once the loan is authorized:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Loan authorization;</p>
</li>
<li>
<p><strong>Type</strong>: Extension point;</p>
</li>
<li>
<p><strong>Included libraries</strong>: Loan;</p>
</li>
<li>
<p><strong>Parameters</strong>: leave empty.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the data is saved:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.Payment</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">createRepayment</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Payment</span> <span class="n">transaction</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">transaction</span> <span class="k">as</span> <span class="n">Payment</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getTransfer</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// The transaction was authorized, create the repayment</span>
        <span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">loan</span> <span class="k">as</span> <span class="n">Loan</span><span class="o">).</span><span class="na">createRepayment</span><span class="o">(</span><span class="n">transaction</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">createRepayment</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-operation">Create the custom operation</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Custom operations, create a new one, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Grant loan (can be changed, is the label displayed to users);</p>
</li>
<li>
<p><strong>Enabled</strong>: Yes;</p>
</li>
<li>
<p><strong>Scope</strong>: User;</p>
</li>
<li>
<p><strong>Script</strong>: Grant loan;</p>
</li>
<li>
<p><strong>Script parameters</strong>: leave empty;</p>
</li>
<li>
<p><strong>Result type</strong>: Notification;</p>
</li>
<li>
<p><strong>Has file upload</strong>: No;</p>
</li>
<li>
<p><strong>Main menu</strong>: Banking;</p>
</li>
<li>
<p><strong>User management section</strong>: Banking;</p>
</li>
<li>
<p><strong>Information text</strong>: you can add here some text explaining the process  it will be displayed in the operation page;</p>
</li>
<li>
<p><strong>Confirmation text</strong>: add here some text which will be displayed in a confirmation dialog before granting the loan.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After saving, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Amount</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>amount</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Decimal;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Installment count</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>numberOfInstallments</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Integer;</p>
</li>
<li>
<p><strong>Required</strong>: Yes;</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>First due date</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>firstDueDate</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Date;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-extensions">Create the extension points</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Extension points, create a two new extension points, each with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A transaction extension point (will close the loan when all installments are processed):</p>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Close loan;</p>
</li>
<li>
<p><strong>Type</strong>: Transaction;</p>
</li>
<li>
<p><strong>Enabled</strong>: Yes;</p>
</li>
<li>
<p><strong>Transfer types</strong>: Units account  Loan repayment (choose the loan repayment type);</p>
</li>
<li>
<p><strong>Events</strong>: Change status;</p>
</li>
<li>
<p><strong>Script</strong>: Loan closing;</p>
</li>
<li>
<p><strong>Script parameters</strong>: Leave empty.</p>
</li>
</ul>
</div>
</li>
<li>
<p>An authorization extension point (will create the repayment once the loan is authorized):</p>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Loan authorization;</p>
</li>
<li>
<p><strong>Type</strong>: Authorization;</p>
</li>
<li>
<p><strong>Enabled</strong>: Yes;</p>
</li>
<li>
<p><strong>Transfer types</strong>: Debit account  Loan grant (choose the loan grant type);</p>
</li>
<li>
<p><strong>Events</strong>: Authorize;</p>
</li>
<li>
<p><strong>Script</strong>: Loan authorization;</p>
</li>
<li>
<p><strong>Script parameters</strong>: Leave empty.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-admin-permissions">Grant the administrator permissions</h5>
<div class="paragraph">
<p>Under System &gt; User configuration &gt; Groups, select the Network administrators group (or the ones that will grant loans). Then, in the Permissions tab:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Under User management &gt; Run custom operations over users, check the Grant loan operation;</p>
</li>
<li>
<p>Under Accounts &gt; Transfer status flows, make Loan visible, but not editable;</p>
</li>
<li>
<p>Under Accounts &gt; Visible transaction fields, select all related custom fields;</p>
</li>
<li>
<p>Under User accounts &gt; Scheduled payments, select View (and maybe process installment and settle too).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-loan-user-permissions">Enable the custom operation for users which will be able to receive loans</h5>
<div class="paragraph">
<p>In System &gt; User configuration &gt; Products (permissions), select the member product for users which will be able to receive loans.
In the Custom operations field, make the Grant loan operation enabled.
Leave the run checkbox unchecked (or users would be able to grant loans to themselves!).</p>
</div>
<div class="paragraph">
<p>You can permit users to repay loan installments anticipated in Units.
For this you have to check in the member product 'process installment' and the user needs to have permissions to make a payment of the transaction type used for the loan repayments.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-solution-record">4.5.3. Record management</h4>
<div class="paragraph">
<p>This solution lets you search, view, create, edit and remove (CRUD) records using custom operations. It uses records for being already available as a customizable data storage in Cyclos. But the example can be expanded to other use cases as well, such as custom database tables, or data in an external system. Also, with this functionality it is possible to allow users to view other user&#8217;s records, which is not available in Cyclos for records, but users can run operations over other users.</p>
</div>
<div class="paragraph">
<p>The example record type has just 2 fields: title and description.</p>
</div>
<div class="paragraph">
<p>To configure this solution, follow carefully each of the following steps:</p>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-type">Create the user record type to work with and give permissions</h5>
<div class="paragraph">
<p>Under System &gt; System configuration &gt; Record types, create a new 'User record type', with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Daily note;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>dailyNote</code>;</p>
</li>
<li>
<p><strong>Display style</strong>: List;</p>
</li>
<li>
<p><strong>Main menu</strong>: Personal;</p>
</li>
<li>
<p><strong>User management section</strong>: User management.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this record type, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Title</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>title</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text;</p>
</li>
<li>
<p><strong>Required</strong>: Yes;</p>
</li>
<li>
<p><strong>Show in results</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Description</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>description</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Multiple line text;</p>
</li>
<li>
<p><strong>Required</strong>: No;</p>
</li>
<li>
<p><strong>Show in results</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now give permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To user group (System &gt; User configuration &gt; Products &gt; Product): in Records, check 'Enable' over 'Daily note'.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-library-script">Create the library script</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Records library;</p>
</li>
<li>
<p><strong>Type</strong>: Library.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.Record</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecord</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.access.SessionData</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.users.RecordServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.formatting.FormatterImpl</span>

<span class="kd">class</span> <span class="nc">RecordProjection</span> <span class="o">{</span>
    <span class="n">Long</span> <span class="n">recordId</span>
    <span class="n">String</span> <span class="n">title</span>
    <span class="n">String</span> <span class="n">description</span>
    <span class="n">String</span> <span class="n">user</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">RecordView</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">type</span>
    <span class="n">String</span> <span class="n">user</span>
    <span class="n">String</span> <span class="n">creationDate</span>
    <span class="n">String</span> <span class="n">lastModifiedDate</span>
    <span class="n">String</span> <span class="n">modifiedBy</span>
    <span class="n">String</span> <span class="n">createdBy</span>
    <span class="n">String</span> <span class="n">title</span>
    <span class="n">String</span> <span class="n">description</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">RecordHelper</span> <span class="o">{</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">formParameters</span>
    <span class="n">User</span> <span class="n">user</span>
    <span class="n">ScriptHelper</span> <span class="n">scriptHelper</span>
    <span class="n">SessionData</span> <span class="n">sessionData</span>
    <span class="n">FormatterImpl</span> <span class="n">formatter</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">scriptParameters</span>
    <span class="n">String</span> <span class="n">typeInternalName</span>
    <span class="n">String</span> <span class="n">titleInternalName</span>
    <span class="n">String</span> <span class="n">descriptionInternalName</span>
    <span class="n">RecordServiceLocal</span> <span class="n">recordService</span>

    <span class="nf">RecordHelper</span><span class="o">(</span><span class="n">Binding</span> <span class="n">binding</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">formParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">formParameters</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">user</span>
        <span class="n">scriptHelper</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptHelper</span>
        <span class="n">sessionData</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionData</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">formatter</span>
        <span class="n">scriptParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptParameters</span>
        <span class="n">typeInternalName</span> <span class="o">=</span> <span class="n">scriptParameters</span><span class="o">.</span><span class="na">recordType</span>
        <span class="n">recordService</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">recordService</span>
    <span class="o">}</span>

    <span class="n">RecordProjection</span> <span class="nf">toProjection</span><span class="o">(</span><span class="n">Record</span> <span class="n">record</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
        <span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">record</span> <span class="k">instanceof</span> <span class="n">UserRecord</span> <span class="o">?</span> <span class="n">record</span><span class="o">.</span><span class="na">user</span> <span class="o">:</span> <span class="kc">null</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RecordProjection</span><span class="o">(</span>
                <span class="nl">recordId:</span> <span class="n">record</span><span class="o">.</span><span class="na">id</span><span class="o">,</span>
                <span class="nl">user:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">user</span><span class="o">),</span>
                <span class="nl">title:</span> <span class="n">fields</span><span class="o">.</span><span class="na">title</span><span class="o">,</span>
                <span class="nl">description:</span> <span class="n">fields</span><span class="o">.</span><span class="na">description</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">RecordView</span> <span class="nf">toView</span><span class="o">(</span><span class="n">Record</span> <span class="n">record</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
        <span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">record</span> <span class="k">instanceof</span> <span class="n">UserRecord</span> <span class="o">?</span> <span class="n">record</span><span class="o">.</span><span class="na">user</span> <span class="o">:</span> <span class="kc">null</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RecordView</span><span class="o">(</span>
                <span class="nl">type:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">type</span><span class="o">),</span>
                <span class="nl">user:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">user</span><span class="o">),</span>
                <span class="nl">creationDate:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">creationDate</span><span class="o">),</span>
                <span class="nl">lastModifiedDate:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">lastModifiedDate</span><span class="o">),</span>
                <span class="nl">modifiedBy:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">modifiedBy</span><span class="o">),</span>
                <span class="nl">createdBy:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">createdBy</span><span class="o">),</span>
                <span class="nl">title:</span> <span class="n">fields</span><span class="o">.</span><span class="na">title</span><span class="o">,</span>
                <span class="nl">description:</span> <span class="n">fields</span><span class="o">.</span><span class="na">description</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It will also needs a single parameter. Copy the following to the 'Script parameters' field, adjusting the internal name in case you set another one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">recordType</span><span class="p">=</span><span class="s">dailyNote</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-email-script">Create a custom operation script to send the record by email</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Send record by email;</p>
</li>
<li>
<p><strong>Type</strong>: Custom operation.</p>
</li>
<li>
<p><strong>Run with all permissions</strong>: Yes;</p>
</li>
<li>
<p><strong>Included libraries</strong>: Records library.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the custom operation is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecord</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.notifications.MailHandler</span>
<span class="kn">import</span> <span class="nn">org.springframework.mail.javamail.MimeMessageHelper</span>

<span class="kn">import</span> <span class="nn">groovy.transform.Field</span>
<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@Field</span> <span class="n">RecordHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordHelper</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span>
<span class="nd">@Field</span> <span class="n">MailHandler</span> <span class="n">mailHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">mailHandler</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">sendByEmail</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">id</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">scriptHelper</span><span class="o">.</span><span class="na">unmaskId</span><span class="o">(</span><span class="n">helper</span><span class="o">.</span><span class="na">formParameters</span><span class="o">.</span><span class="na">recordId</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">record</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">recordService</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">as</span> <span class="n">UserRecord</span>
    <span class="kt">def</span> <span class="n">view</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">toView</span><span class="o">(</span><span class="n">record</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">mailHandler</span><span class="o">.</span><span class="na">mailSender</span>
    <span class="kt">def</span> <span class="n">message</span> <span class="o">=</span> <span class="n">sender</span><span class="o">.</span><span class="na">createMimeMessage</span><span class="o">()</span>
    <span class="kt">def</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessageHelper</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>

    <span class="kt">def</span> <span class="n">body</span> <span class="o">=</span> <span class="s2">"""
        This is your record details:&lt;br&gt;
        &lt;b&gt;Title:&lt;/b&gt; ${view.title}&lt;br&gt;
    """</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">description</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="s2">"&lt;b&gt;Description:&lt;/b&gt; &lt;pre&gt;${view.description}&lt;/pre&gt;"</span>
    <span class="o">}</span>

    <span class="n">mailHandler</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">user</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">record</span><span class="o">.</span><span class="na">user</span><span class="o">.</span><span class="na">email</span><span class="o">,</span> <span class="s2">"Your record"</span><span class="o">,</span> <span class="n">body</span><span class="o">)</span>

    <span class="k">return</span> <span class="s2">"The email was sent"</span>
<span class="o">}</span>
<span class="k">return</span> <span class="nf">sendByEmail</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-search-script">Create the custom operation script to search records</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Search records;</p>
</li>
<li>
<p><strong>Type</strong>: Custom operation;</p>
</li>
<li>
<p><strong>Run with all permissions</strong>: Yes;</p>
</li>
<li>
<p><strong>Included libraries</strong>: Records library.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the custom operation is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.search.RecordSearchHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.records.UserRecordQuery</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.recordtypes.RecordTypeVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.users.UserVO</span>

<span class="kn">import</span> <span class="nn">groovy.transform.Field</span>
<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@Field</span> <span class="n">RecordHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordHelper</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span>
<span class="nd">@Field</span> <span class="n">Integer</span> <span class="n">currentPage</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">currentPage</span>
<span class="nd">@Field</span> <span class="n">Integer</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">pageSize</span>
<span class="nd">@Field</span> <span class="n">Boolean</span> <span class="n">skipTotalCount</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">skipTotalCount</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">searchRecords</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">recordSearchHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">recordSearchHandler</span> <span class="k">as</span> <span class="n">RecordSearchHandler</span>

    <span class="kt">def</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserRecordQuery</span><span class="o">()</span>
    <span class="kt">def</span> <span class="n">formParameters</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">formParameters</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">formParameters</span><span class="o">.</span><span class="na">searchOnlyInMyRecords</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">query</span><span class="o">.</span><span class="na">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserVO</span><span class="o">(</span><span class="n">helper</span><span class="o">.</span><span class="na">user</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">query</span><span class="o">.</span><span class="na">currentPage</span> <span class="o">=</span> <span class="n">currentPage</span>
    <span class="n">query</span><span class="o">.</span><span class="na">pageSize</span> <span class="o">=</span> <span class="n">pageSize</span>
    <span class="n">query</span><span class="o">.</span><span class="na">skipTotalCount</span> <span class="o">=</span> <span class="n">skipTotalCount</span>
    <span class="n">query</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordTypeVO</span><span class="o">(</span><span class="nl">internalName:</span> <span class="n">helper</span><span class="o">.</span><span class="na">typeInternalName</span><span class="o">)</span>
    <span class="n">query</span><span class="o">.</span><span class="na">keywords</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">keywords</span> <span class="k">as</span> <span class="n">String</span>

    <span class="kt">def</span> <span class="n">page</span> <span class="o">=</span> <span class="n">recordSearchHandler</span><span class="o">.</span><span class="na">searchEntities</span><span class="o">(</span><span class="n">query</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">pageItems</span><span class="o">.</span><span class="na">collect</span> <span class="o">{</span> <span class="n">helper</span><span class="o">.</span><span class="na">toProjection</span><span class="o">(</span><span class="n">it</span><span class="o">)</span> <span class="o">}</span>

    <span class="k">return</span> <span class="o">[</span>
        <span class="nl">columns:</span> <span class="o">[</span>
            <span class="o">[</span><span class="nl">header:</span> <span class="s2">"Owner"</span><span class="o">,</span> <span class="nl">property:</span> <span class="s2">"user"</span><span class="o">,</span><span class="nl">width:</span><span class="s2">"15%"</span><span class="o">],</span>
            <span class="o">[</span><span class="nl">header:</span> <span class="s2">"Title"</span><span class="o">,</span> <span class="nl">property:</span> <span class="s2">"title"</span><span class="o">,</span> <span class="nl">width:</span><span class="s2">"35%"</span><span class="o">],</span>
            <span class="o">[</span><span class="nl">header:</span> <span class="s2">"Description"</span><span class="o">,</span> <span class="nl">property:</span> <span class="s2">"description"</span><span class="o">,</span><span class="nl">width:</span><span class="s2">"50%"</span><span class="o">]</span>
        <span class="o">],</span>
        <span class="nl">rows:</span> <span class="n">rows</span><span class="o">,</span>
        <span class="nl">totalCount:</span> <span class="n">page</span><span class="o">.</span><span class="na">totalCount</span><span class="o">,</span>
        <span class="nl">hasNextPage:</span> <span class="n">page</span><span class="o">.</span><span class="na">hasNextPage</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="k">return</span> <span class="nf">searchRecords</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-create-script">Create the custom operation script to create records</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Create record;</p>
</li>
<li>
<p><strong>Type</strong>: Custom operation;</p>
</li>
<li>
<p><strong>Run with all permissions</strong>: Yes;</p>
</li>
<li>
<p><strong>Included libraries</strong>: Records library.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the custom operation is executed</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.users.records.RecordDataParams</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.recordtypes.RecordTypeVO</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.utils.NotificationLevel</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.TransactionStatus</span>

<span class="kn">import</span> <span class="nn">groovy.transform.Field</span>
<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@Field</span> <span class="n">RecordHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordHelper</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">createRecord</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">"The record was created successfully."</span>
    <span class="kt">def</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">false</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">data</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">recordService</span><span class="o">.</span><span class="na">getDataForNew</span><span class="o">(</span><span class="k">new</span> <span class="n">RecordDataParams</span><span class="o">(</span>
                <span class="nl">recordType:</span> <span class="k">new</span> <span class="n">RecordTypeVO</span><span class="o">(</span><span class="nl">internalName:</span> <span class="n">helper</span><span class="o">.</span><span class="na">typeInternalName</span><span class="o">)))</span>
        <span class="kt">def</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">dto</span><span class="o">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">formParameters</span><span class="o">.</span><span class="na">title</span>
        <span class="n">fields</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">formParameters</span><span class="o">.</span><span class="na">description</span>
        <span class="n">helper</span><span class="o">.</span><span class="na">recordService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">dto</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Mark the transaction to be rolled-back</span>
        <span class="kt">def</span> <span class="n">transactionStatus</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">scriptParameters</span><span class="o">.</span><span class="na">transactionStatus</span> <span class="k">as</span> <span class="n">TransactionStatus</span>
        <span class="n">transactionStatus</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">()</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">"""There was an error trying to create the record.
            Please, contact the administration."""</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="o">[</span>
        <span class="nl">notification:</span> <span class="n">msg</span><span class="o">,</span>
        <span class="nl">notificationLevel:</span> <span class="n">error</span> <span class="o">?</span>  <span class="n">NotificationLevel</span><span class="o">.</span><span class="na">ERROR</span> <span class="o">:</span> <span class="n">NotificationLevel</span><span class="o">.</span><span class="na">INFORMATION</span><span class="o">,</span>
        <span class="nl">backTo:</span> <span class="n">error</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="s2">"searchRecords"</span><span class="o">,</span>
        <span class="nl">reRun:</span> <span class="o">!</span><span class="n">error</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="k">return</span> <span class="nf">createRecord</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-view-script">Create the custom operation script to view records</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: View record;</p>
</li>
<li>
<p><strong>Type</strong>: Custom operation;</p>
</li>
<li>
<p><strong>Run with all permissions</strong>: Yes;</p>
</li>
<li>
<p><strong>Included libraries</strong>: Records library.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the custom operation is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecord</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecordType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="kn">import</span> <span class="nn">groovy.transform.Field</span>
<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>
<span class="kn">import</span> <span class="nn">groovy.xml.MarkupBuilder</span>

<span class="kd">class</span> <span class="nc">Styles</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="n">String</span> <span class="n">infoBox</span> <span class="o">=</span> <span class="s2">"white-space: normal; text-overflow: ellipsis;"</span>
    <span class="kd">static</span> <span class="n">String</span> <span class="n">fieldContainerLabel</span> <span class="o">=</span> <span class="s2">"white-space: normal; text-overflow: ellipsis; font-weight: 400; font-size: 15px; color: #1865a3;"</span>
    <span class="kd">static</span> <span class="n">String</span> <span class="n">fieldContainerValue</span> <span class="o">=</span> <span class="s2">"white-space: normal; text-overflow: ellipsis;  margin: 2px 0 9px 0; font-size: 16px; line-height: 18px;"</span>
<span class="o">}</span>

<span class="nd">@Field</span> <span class="n">RecordHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordHelper</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span>

<span class="kt">def</span> <span class="nf">createContent</span><span class="o">(</span><span class="n">StringWriter</span> <span class="n">out</span><span class="o">,</span> <span class="n">UserRecord</span> <span class="n">record</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">view</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">toView</span><span class="o">(</span><span class="n">record</span><span class="o">)</span>
    <span class="n">UserRecordType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">type</span>
    <span class="kt">def</span> <span class="n">html</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MarkupBuilder</span><span class="o">(</span><span class="n">out</span><span class="o">)</span>
    <span class="n">html</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.infoBox}"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">div</span> <span class="o">{</span>
            <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerLabel}"</span><span class="o">)</span> <span class="o">{</span> <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="s2">"Owner:"</span> <span class="o">}</span>
            <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerValue}"</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="n">view</span><span class="o">.</span><span class="na">user</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">showUpdateToUsers</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">div</span> <span class="o">{</span>
                <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerLabel}"</span><span class="o">)</span> <span class="o">{</span> <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="s2">"Created by:"</span> <span class="o">}</span>
                <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerValue}"</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="n">view</span><span class="o">.</span><span class="na">createdBy</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">div</span> <span class="o">{</span>
                <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerLabel}"</span><span class="o">)</span> <span class="o">{</span> <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="s2">"Creation date:"</span> <span class="o">}</span>
                <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerValue}"</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="n">view</span><span class="o">.</span><span class="na">creationDate</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">StringHelper</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">lastModifiedDate</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">div</span> <span class="o">{</span>
                    <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerLabel}"</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="s2">"Last modification date:"</span>
                    <span class="o">}</span>
                    <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerValue}"</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="n">view</span><span class="o">.</span><span class="na">lastModifiedDate</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">div</span> <span class="o">{</span>
                    <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerLabel}"</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="s2">"Last modification by:"</span>
                    <span class="o">}</span>
                    <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerValue}"</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="n">view</span><span class="o">.</span><span class="na">modifiedBy</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">StringHelper</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">title</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">div</span> <span class="o">{</span>
                <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerLabel}"</span><span class="o">)</span> <span class="o">{</span> <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="s2">"Title:"</span> <span class="o">}</span>
                <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerValue}"</span><span class="o">)</span> <span class="o">{</span> <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="n">view</span><span class="o">.</span><span class="na">title</span> <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">StringHelper</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">description</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">div</span> <span class="o">{</span>
                <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerLabel}"</span><span class="o">)</span> <span class="o">{</span> <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="s2">"Description:"</span> <span class="o">}</span>
                <span class="n">div</span><span class="o">(</span><span class="nl">style:</span><span class="s2">"${Styles.fieldContainerValue}"</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">pre</span> <span class="o">{</span>
                        <span class="n">mkp</span><span class="o">.</span><span class="na">yield</span> <span class="n">view</span><span class="o">.</span><span class="na">description</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">viewRecord</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">sessionData</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">sessionData</span>
    <span class="kt">def</span> <span class="n">id</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">scriptHelper</span><span class="o">.</span><span class="na">unmaskId</span><span class="o">(</span><span class="n">helper</span><span class="o">.</span><span class="na">formParameters</span><span class="o">.</span><span class="na">recordId</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">record</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">recordService</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">as</span> <span class="n">UserRecord</span>
    <span class="kt">def</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">()</span>
    <span class="n">createContent</span><span class="o">(</span><span class="n">out</span><span class="o">,</span> <span class="n">record</span><span class="o">)</span>

    <span class="kt">def</span> <span class="n">loggedInAsOwner</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">user</span> <span class="o">==</span> <span class="n">sessionData</span><span class="o">.</span><span class="na">loggedUser</span>
    <span class="k">return</span> <span class="o">[</span>
        <span class="nl">content:</span> <span class="n">out</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span>
        <span class="nl">actions:</span> <span class="o">[</span>
            <span class="nl">removeRecord:</span> <span class="o">[</span>
                <span class="nl">enabled:</span> <span class="n">loggedInAsOwner</span>
            <span class="o">],</span>
            <span class="nl">updateRecord:</span> <span class="o">[</span>
                <span class="nl">enabled:</span> <span class="n">loggedInAsOwner</span>
            <span class="o">]</span>
        <span class="o">]</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="k">return</span> <span class="nf">viewRecord</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-update-script">Create the custom operation script to update records</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Update record;</p>
</li>
<li>
<p><strong>Type</strong>: Custom operation;</p>
</li>
<li>
<p><strong>Run with all permissions</strong>: Yes;</p>
</li>
<li>
<p><strong>Included libraries</strong>: Records library.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the custom operation is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.users.records.RecordData</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.utils.NotificationLevel</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.TransactionStatus</span>

<span class="kn">import</span> <span class="nn">groovy.transform.Field</span>
<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@Field</span> <span class="n">RecordHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordHelper</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span>
<span class="nd">@Field</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">formParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">formParameters</span>
<span class="nd">@Field</span> <span class="n">TransactionStatus</span> <span class="n">transactionStatus</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">transactionStatus</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">updateRecord</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">"The record was updated successfully."</span>
    <span class="kt">def</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">false</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">id</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">scriptHelper</span><span class="o">.</span><span class="na">unmaskId</span><span class="o">(</span><span class="n">formParameters</span><span class="o">.</span><span class="na">recordId</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">data</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">recordService</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">as</span> <span class="n">RecordData</span>
        <span class="kt">def</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">dto</span><span class="o">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">title</span>
        <span class="n">fields</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">description</span>
        <span class="n">helper</span><span class="o">.</span><span class="na">recordService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">dto</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="n">transactionStatus</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">"""There was an error trying to update the record.
            Please, contact the administration."""</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="o">[</span>
        <span class="nl">notification:</span> <span class="n">msg</span><span class="o">,</span>
        <span class="nl">notificationLevel:</span> <span class="n">error</span> <span class="o">?</span>  <span class="n">NotificationLevel</span><span class="o">.</span><span class="na">ERROR</span> <span class="o">:</span> <span class="n">NotificationLevel</span><span class="o">.</span><span class="na">INFORMATION</span><span class="o">,</span>
        <span class="nl">backTo:</span> <span class="n">error</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="s2">"recordDetails"</span><span class="o">,</span>
        <span class="nl">reRun:</span> <span class="o">!</span><span class="n">error</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="k">return</span> <span class="nf">updateRecord</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Script code executed before the form is show, to fill the initial field values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserRecord</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.persistence.EntityManagerHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.utils.StringHelper</span>

<span class="kn">import</span> <span class="nn">groovy.transform.Field</span>
<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@Field</span> <span class="n">RecordHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordHelper</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span>
<span class="nd">@Field</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">formParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">formParameters</span>
<span class="nd">@Field</span> <span class="n">EntityManagerHandler</span> <span class="n">entityManagerHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">entityManagerHandler</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">loadRecordFields</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">id</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">scriptHelper</span><span class="o">.</span><span class="na">unmaskId</span><span class="o">(</span><span class="n">formParameters</span><span class="o">.</span><span class="na">recordId</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">record</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">UserRecord</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">newRecord</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">recordService</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">dto</span>
    <span class="kt">def</span> <span class="n">view</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">toView</span><span class="o">(</span><span class="n">record</span><span class="o">)</span>

    <span class="k">return</span> <span class="o">[</span>
        <span class="nl">title:</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">emptyIfNull</span><span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">title</span><span class="o">),</span>
        <span class="nl">description:</span> <span class="n">StringHelper</span><span class="o">.</span><span class="na">emptyIfNull</span><span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">description</span><span class="o">)</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="k">return</span> <span class="nf">loadRecordFields</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-remove-script">Create the custom operation script to remove records</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Remove record;</p>
</li>
<li>
<p><strong>Type</strong>: Custom operation;</p>
</li>
<li>
<p><strong>Run with all permissions</strong>: Yes;</p>
</li>
<li>
<p><strong>Included libraries</strong>: Records library.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the custom operation is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.model.utils.NotificationLevel</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.TransactionStatus</span>

<span class="kn">import</span> <span class="nn">groovy.transform.Field</span>
<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@Field</span> <span class="n">RecordHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordHelper</span><span class="o">(</span><span class="n">binding</span><span class="o">)</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">removeRecord</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">"The record was removed successfully."</span>
    <span class="kt">def</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">false</span>

    <span class="kt">def</span> <span class="n">recordId</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">scriptHelper</span><span class="o">.</span><span class="na">unmaskId</span><span class="o">(</span><span class="n">helper</span><span class="o">.</span><span class="na">formParameters</span><span class="o">.</span><span class="na">recordId</span><span class="o">)</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">helper</span><span class="o">.</span><span class="na">recordService</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">recordId</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">transactionStatus</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">scriptParameters</span><span class="o">.</span><span class="na">transactionStatus</span> <span class="k">as</span> <span class="n">TransactionStatus</span>
        <span class="n">transactionStatus</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">()</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">"""There was an error trying to remove the record.
            Please, contact the administration."""</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="o">[</span>
        <span class="nl">notification:</span> <span class="n">msg</span><span class="o">,</span>
        <span class="nl">notificationLevel:</span> <span class="n">error</span> <span class="o">?</span> <span class="n">NotificationLevel</span><span class="o">.</span><span class="na">ERROR</span> <span class="o">:</span> <span class="n">NotificationLevel</span><span class="o">.</span><span class="na">INFORMATION</span><span class="o">,</span>
        <span class="nl">backTo:</span> <span class="n">error</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="s2">"searchRecords"</span><span class="o">,</span>
        <span class="nl">reRun:</span> <span class="o">!</span><span class="n">error</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="k">return</span> <span class="nf">removeRecord</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-remove-operation">Create the custom operation to remove records</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Custom operations, create a new one with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Remove record;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>removeRecord</code>;</p>
</li>
<li>
<p><strong>Enable for channels</strong>: Main, Web services, Mobile app;</p>
</li>
<li>
<p><strong>Custom submit label</strong>: Remove (can be changed - will be the label displayed in the action button);</p>
</li>
<li>
<p><strong>Scope</strong>: Internal;</p>
</li>
<li>
<p><strong>Script</strong>: Remove record;</p>
</li>
<li>
<p><strong>Result type</strong>: Notification;</p>
</li>
<li>
<p><strong>Custom script execute message</strong>: This record will be removed. Do you want to continue? (can be edited - it is necessary to alert the user that the record is going to be removed).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once saved, on the Form fields tab, create a new field, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Display name</strong>: Record id;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>recordId</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-update-operation">Create the custom operation to update records</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Custom operations, create a new one with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Update record;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>updateRecord</code>;</p>
</li>
<li>
<p><strong>Enable for channels</strong>: Main, Web services, Mobile app;</p>
</li>
<li>
<p><strong>Custom submit label</strong>: Update (can be changed - will be the label displayed in the action button);</p>
</li>
<li>
<p><strong>Scope</strong>: Internal;</p>
</li>
<li>
<p><strong>Script</strong>: Update record;</p>
</li>
<li>
<p><strong>Result type</strong>: Notification;</p>
</li>
<li>
<p><strong>Show form</strong>: Always.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once saved, on the Form fields tab, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Record id</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Display name</strong>: Record id;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>recordId</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Title</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Display name</strong>: Title;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>title</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text;</p>
</li>
<li>
<p><strong>Required</strong>: Yes.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Description</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Display name</strong>: Description;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>description</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Multiple line text.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-email-operation">Create the custom operation to send the record email</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Custom operations, create a new one with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Send record email;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>sendRecordEmail</code>;</p>
</li>
<li>
<p><strong>Enable for channels</strong>: Main, Web services, Mobile app;</p>
</li>
<li>
<p><strong>Custom submit label</strong>: Send email (can be changed - will be the label displayed in the action button);</p>
</li>
<li>
<p><strong>Scope</strong>: Internal;</p>
</li>
<li>
<p><strong>Script</strong>: Send record email;</p>
</li>
<li>
<p><strong>Result type</strong>: Notification.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once saved, on the Form fields tab, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Record id</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Display name</strong>: Record id;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>recordId</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-view-operation">Create the custom operation to view records details</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Custom operations, create a new one with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Record details;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>recordDetails</code>;</p>
</li>
<li>
<p><strong>Enable for channels</strong>: Main, Web services, Mobile app;</p>
</li>
<li>
<p><strong>Scope</strong>: Internal;</p>
</li>
<li>
<p><strong>Script</strong>: View record;</p>
</li>
<li>
<p><strong>Result type</strong>: Rich text.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once saved, on the Form fields tab, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Record id</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Display name</strong>: Record id;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>recordId</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once saved, on the Actions tab, add the following actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Remove record</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Parameters</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Record id</strong>: Record id.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Update record</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Parameters</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Record id</strong>: Record id;</p>
</li>
<li>
<p><strong>Title</strong>: Not used;</p>
</li>
<li>
<p><strong>Description</strong>: Not used.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Send record email</strong>.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Record id</strong>: Record id.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-create-operation">Create the custom operation to create records</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Custom operations, create a new one with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Create record;</p>
</li>
<li>
<p><strong>Internal name</strong>: createRecord;</p>
</li>
<li>
<p><strong>Enable for channels</strong>: Main, Web services, Mobile app;</p>
</li>
<li>
<p><strong>Label</strong>: New (can be changed - will be the label displayed in the action button);</p>
</li>
<li>
<p><strong>Scope</strong>: Internal;</p>
</li>
<li>
<p><strong>Script</strong>: Create record;</p>
</li>
<li>
<p><strong>Result type</strong>: Notification;</p>
</li>
<li>
<p><strong>Show form</strong>: Always.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once saved, on the Form fields tab, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Title</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Display name</strong>: Title;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>title</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Description</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Display name</strong>: Description;</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>description</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Multiple line text.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-search-operation">Create the custom operation to search records</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Custom operations, create a new one with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: Daily notes (can be changed - will be the label displayed on the menu);</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>searchRecords</code>;</p>
</li>
<li>
<p><strong>Enable for channels</strong>: Main, Web services, Mobile app;</p>
</li>
<li>
<p><strong>Scope</strong>: User;</p>
</li>
<li>
<p><strong>Script</strong>: Search records;</p>
</li>
<li>
<p><strong>Result type</strong>: Result page;</p>
</li>
<li>
<p><strong>Allow printing results</strong>: Yes;</p>
</li>
<li>
<p><strong>Allow exporting results to CSV</strong>: Yes;</p>
</li>
<li>
<p><strong>Action when clicking a row</strong>: Run an internal custom operation;</p>
</li>
<li>
<p><strong>Custom operation</strong>: Record details;</p>
</li>
<li>
<p><strong>Parameters to be passed (comma-separated names)</strong>: <code>recordId</code>;</p>
</li>
<li>
<p><strong>Main menu</strong>: Personal (can be changed - will be the menu where the label is going to be displayed);</p>
</li>
<li>
<p><strong>User management section</strong>: User management (can be changed -  will be the section where the  label is going to be displayed);</p>
</li>
<li>
<p><strong>Enable for active users</strong>: Yes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once saved, on the Form fields tab, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Keywords</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>keywords</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Single line text.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Search only in my records</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>searchOnlyInMyRecords</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Boolean.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once saved, on the Actions tab, add the following actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Create record</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Visibility</strong>: Before and after run the custom operation;</p>
</li>
<li>
<p><strong>Parameters</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Title</strong>: Not used;</p>
</li>
<li>
<p><strong>Description</strong>: Not used.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-record-permissions">Enable the custom operation for users</h5>
<div class="paragraph">
<p>In System &gt; User configuration &gt; Products (permissions), select the member product for users which will be able to work with this operation. In the Custom operations field, make sure the Daily notes is both 'Enabled' and allowed to 'Run over self'.</p>
</div>
<div class="paragraph">
<p>You can also grant the operation for admins over users.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scripting-solution-user-balances">4.5.4. User balances</h4>
<div class="paragraph">
<p>This solution provides a custom operation for administrators to search the users' balances, with 2 advantages over the regular user balances overview in Cyclos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is possible to select a date, so all presented balances will be for that date;</p>
</li>
<li>
<p>The available balances are also shown, but only if no date is set (as credit limit could have changed over time).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These options are not available in the regular balances search because they need to be calculated per user, whereas the current balance is stored in the database. This makes the script unviable when there are too many users. Still, some systems require this functionality.</p>
</div>
<div class="paragraph">
<p>However, as a drawback, the filters for users are also more limited in this script: it is only possible to filter by a specific group. So, if only the current balance is desired, it is advised to use the built-in functionality instead.</p>
</div>
<div class="paragraph">
<p>To configure this functionality, follow carefully each of the following steps:</p>
</div>
<div class="sect4">
<h5 id="scripting-solution-user-balances-load-accounts-script">Create the script to load user account types</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: User account types loader;</p>
</li>
<li>
<p><strong>Type</strong>: Load custom field values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code that returns the possible values when either creating or editing an entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span>

<span class="kn">import</span> <span class="nn">org.cyclos.impl.access.SessionData</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.AccountTypeServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.accounttypes.AccountTypeNature</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.system.fields.DynamicFieldValueVO</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">loadUserAccountTypes</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span>
    <span class="kt">def</span> <span class="n">accountTypeService</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">accountTypeService</span> <span class="k">as</span> <span class="n">AccountTypeServiceLocal</span>
    <span class="kt">def</span> <span class="n">sessionData</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">sessionData</span> <span class="k">as</span> <span class="n">SessionData</span>
    <span class="k">return</span> <span class="n">sessionData</span><span class="o">.</span><span class="na">getProducts</span><span class="o">().</span><span class="na">grantedAccountTypes</span><span class="o">()</span>
            <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">filter</span> <span class="o">{</span> <span class="n">it</span><span class="o">.</span><span class="na">getNature</span><span class="o">()</span> <span class="o">==</span> <span class="n">AccountTypeNature</span><span class="o">.</span><span class="na">USER</span> <span class="o">}</span>
            <span class="o">.</span><span class="na">map</span> <span class="o">{</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">id</span><span class="o">),</span> <span class="n">it</span><span class="o">.</span><span class="na">name</span><span class="o">)</span> <span class="o">}</span>
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())</span>
<span class="o">}</span>

<span class="n">loadUserAccountTypes</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-user-balances-load-groups-script">Create the script to load user groups</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: User groups loader;</p>
</li>
<li>
<p><strong>Type</strong>: Load custom field values;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code that returns the possible values when either creating or editing an entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span>

<span class="kn">import</span> <span class="nn">org.cyclos.impl.access.SessionData</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.users.GroupsHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.system.fields.DynamicFieldValueVO</span>

<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">loadUserGroups</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">variables</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">variables</span>
    <span class="kt">def</span> <span class="n">groupsHandler</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">groupsHandler</span> <span class="k">as</span> <span class="n">GroupsHandler</span>
    <span class="kt">def</span> <span class="n">sessionData</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="na">sessionData</span> <span class="k">as</span> <span class="n">SessionData</span>

    <span class="k">return</span> <span class="n">groupsHandler</span>
            <span class="o">.</span><span class="na">getAccessibleUserGroups</span><span class="o">(</span><span class="n">sessionData</span><span class="o">.</span><span class="na">getLoggedUser</span><span class="o">())</span>
            <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">map</span> <span class="o">{</span> <span class="k">new</span> <span class="n">DynamicFieldValueVO</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">id</span><span class="o">),</span> <span class="n">it</span><span class="o">.</span><span class="na">name</span><span class="o">)</span> <span class="o">}</span>
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())</span>
<span class="o">}</span>

<span class="n">loadUserGroups</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-user-balances-search-script">Create the custom operation script to search users balances</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Scripts, create the next script, with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: User balances;</p>
</li>
<li>
<p><strong>Type</strong>: Custom operation;</p>
</li>
<li>
<p><strong>Run with all permissions</strong>: Yes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Script code executed when the custom operation is executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span>

<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.QAccount</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.QAccountType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.banking.UserAccountType</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.system.DynamicFieldValue</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.system.ExportFormat</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.QGroup</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.QUser</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.User</span>
<span class="kn">import</span> <span class="nn">org.cyclos.entities.users.UserCustomField</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.ApplicationHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.InvocationContext</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.access.SessionData</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.banking.AccountServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.contentmanagement.TranslationHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.system.ScriptHelper</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.users.UserCustomFieldServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.formatting.FormatterImpl</span>
<span class="kn">import</span> <span class="nn">org.cyclos.impl.utils.persistence.EntityManagerHandler</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.ValidationException</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.banking.BankingKeys</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.users.UsersKeys</span>
<span class="kn">import</span> <span class="nn">org.cyclos.server.utils.DateHelper</span>

<span class="kn">import</span> <span class="nn">com.querydsl.core.types.Expression</span>
<span class="kn">import</span> <span class="nn">com.querydsl.core.types.dsl.Expressions</span>

<span class="kn">import</span> <span class="nn">groovy.transform.Field</span>
<span class="kn">import</span> <span class="nn">groovy.transform.TypeChecked</span>

<span class="nd">@Field</span> <span class="n">EntityManagerHandler</span> <span class="n">entityManagerHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">entityManagerHandler</span>
<span class="nd">@Field</span> <span class="n">TranslationHandler</span> <span class="n">translationHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">translationHandler</span>
<span class="nd">@Field</span> <span class="n">AccountServiceLocal</span> <span class="n">accountService</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">accountService</span>
<span class="nd">@Field</span> <span class="n">FormatterImpl</span> <span class="n">formatter</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">formatter</span>
<span class="nd">@Field</span> <span class="n">ExportFormat</span> <span class="n">exportFormat</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">exportFormat</span>
<span class="nd">@Field</span> <span class="n">UserCustomFieldServiceLocal</span> <span class="n">userCustomFieldService</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">userCustomFieldService</span>
<span class="nd">@Field</span> <span class="n">ApplicationHandler</span> <span class="n">applicationHandler</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">applicationHandler</span>
<span class="nd">@Field</span> <span class="n">ScriptHelper</span> <span class="n">scriptHelper</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">scriptHelper</span>
<span class="nd">@Field</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">formParameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">formParameters</span>
<span class="nd">@Field</span> <span class="n">SessionData</span> <span class="n">sessionData</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sessionData</span>
<span class="nd">@Field</span> <span class="n">Integer</span> <span class="n">currentPage</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">currentPage</span>
<span class="nd">@Field</span> <span class="n">Integer</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">pageSize</span>
<span class="nd">@Field</span> <span class="n">Boolean</span> <span class="n">skipTotalCount</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">skipTotalCount</span>

<span class="nd">@TypeChecked</span>
<span class="kt">def</span> <span class="nf">searchBalances</span><span class="o">(){</span>
    <span class="kt">def</span> <span class="n">a</span> <span class="o">=</span> <span class="n">QAccount</span><span class="o">.</span><span class="na">account</span>
    <span class="kt">def</span> <span class="n">at</span> <span class="o">=</span> <span class="n">QAccountType</span><span class="o">.</span><span class="na">accountType</span>
    <span class="kt">def</span> <span class="n">u</span> <span class="o">=</span> <span class="n">QUser</span><span class="o">.</span><span class="na">user</span>
    <span class="kt">def</span> <span class="n">g</span> <span class="o">=</span> <span class="n">QGroup</span><span class="o">.</span><span class="na">group</span>

    <span class="kt">def</span> <span class="n">accountTypeId</span> <span class="o">=</span> <span class="o">(</span><span class="n">formParameters</span><span class="o">.</span><span class="na">accountType</span> <span class="k">as</span> <span class="n">DynamicFieldValue</span><span class="o">)?.</span><span class="na">value</span> <span class="k">as</span> <span class="n">Long</span>
    <span class="kt">def</span> <span class="n">accountType</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">UserAccountType</span><span class="o">,</span> <span class="n">accountTypeId</span><span class="o">)</span>

    <span class="kt">def</span> <span class="n">query</span> <span class="o">=</span> <span class="n">entityManagerHandler</span>
            <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">u</span><span class="o">)</span>
            <span class="o">.</span><span class="na">innerJoin</span><span class="o">(</span><span class="n">g</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">group</span><span class="o">().</span><span class="na">eq</span><span class="o">(</span><span class="n">g</span><span class="o">))</span>
            <span class="o">.</span><span class="na">leftJoin</span><span class="o">(</span><span class="n">a</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">user</span><span class="o">().</span><span class="na">eq</span><span class="o">(</span><span class="n">u</span><span class="o">))</span>
            <span class="o">.</span><span class="na">leftJoin</span><span class="o">(</span><span class="n">at</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">type</span><span class="o">().</span><span class="na">eq</span><span class="o">(</span><span class="n">at</span><span class="o">))</span>

    <span class="kt">def</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">(</span><span class="n">formParameters</span><span class="o">.</span><span class="na">groups</span> <span class="k">as</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">DynamicFieldValue</span><span class="o">&gt;)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">groups</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">groups</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">groupIds</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="na">collect</span> <span class="o">{</span>
            <span class="n">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">value</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">g</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">groupIds</span><span class="o">))</span>
    <span class="o">}</span>

    <span class="n">query</span>
            <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">at</span><span class="o">.</span><span class="na">isNull</span><span class="o">().</span><span class="na">or</span><span class="o">(</span><span class="n">at</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">accountType</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">pageSize</span><span class="o">)</span>
            <span class="o">.</span><span class="na">offset</span><span class="o">(</span><span class="n">pageSize</span> <span class="o">*</span> <span class="n">currentPage</span><span class="o">)</span>
            <span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">asc</span><span class="o">(),</span> <span class="n">at</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">asc</span><span class="o">())</span>

    <span class="kt">def</span> <span class="n">totalCount</span> <span class="o">=</span> <span class="n">skipTotalCount</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">query</span><span class="o">.</span><span class="na">fetchCount</span><span class="o">()</span>

    <span class="kt">def</span> <span class="n">balanceExpression</span>
    <span class="kt">def</span> <span class="n">expressions</span> <span class="o">=</span> <span class="o">[</span>
        <span class="n">u</span><span class="o">.</span><span class="na">id</span><span class="o">,</span>
        <span class="n">u</span><span class="o">.</span><span class="na">displayForManagers</span><span class="o">,</span>
        <span class="n">at</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
        <span class="n">at</span><span class="o">.</span><span class="na">currencyId</span>
    <span class="o">]</span> <span class="k">as</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Expression</span><span class="o">&gt;</span>
    <span class="kt">def</span> <span class="n">date</span> <span class="o">=</span> <span class="n">formParameters</span><span class="o">.</span><span class="na">date</span> <span class="k">as</span> <span class="n">Date</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">date</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Validate the archiving date, if any</span>
        <span class="kt">def</span> <span class="n">archivingDate</span> <span class="o">=</span> <span class="n">applicationHandler</span><span class="o">.</span><span class="na">application</span><span class="o">.</span><span class="na">archivingDate</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">archivingDate</span> <span class="o">&amp;&amp;</span> <span class="n">date</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="n">archivingDate</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValidationException</span><span class="o">(</span>
            <span class="s2">"Account data before ${formatter.format(archivingDate)} is archived"</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="n">query</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">creationDate</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="n">date</span><span class="o">))</span>
        <span class="kt">def</span> <span class="n">timeZone</span> <span class="o">=</span> <span class="n">sessionData</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getTimeZone</span><span class="o">()</span>

        <span class="c1">// When there's a date, get the balance at that particular date</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">DateHelper</span><span class="o">.</span><span class="na">shiftToEnd</span><span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="n">timeZone</span><span class="o">)</span>
        <span class="n">balanceExpression</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">balance</span><span class="o">(</span><span class="n">Expressions</span><span class="o">.</span><span class="na">constant</span><span class="o">(</span><span class="n">date</span><span class="o">))</span>
        <span class="n">expressions</span> <span class="o">&lt;&lt;</span> <span class="n">balanceExpression</span>
    <span class="o">}</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">UserCustomField</span><span class="o">&gt;</span> <span class="n">customFields</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">exportFormat</span> <span class="o">&amp;&amp;</span> <span class="n">exportFormat</span><span class="o">.</span><span class="na">internalName</span> <span class="o">!=</span> <span class="s1">'pdf'</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// When exporting tabular data, include the profile fields</span>
        <span class="n">customFields</span> <span class="o">=</span> <span class="n">userCustomFieldService</span><span class="o">.</span><span class="na">listAll</span><span class="o">().</span><span class="na">findAll</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">it</span><span class="o">.</span><span class="na">includeInExport</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kt">def</span> <span class="n">cacheFlusher</span> <span class="o">=</span> <span class="n">InvocationContext</span><span class="o">.</span><span class="na">newCacheFlusher</span><span class="o">()</span>
    <span class="kt">def</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">expressions</span> <span class="k">as</span> <span class="n">Expression</span><span class="o">[]).</span><span class="na">map</span> <span class="o">{</span>
        <span class="n">Long</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">result</span> <span class="o">=</span> <span class="o">[</span>
            <span class="nl">id:</span> <span class="n">userId</span><span class="o">,</span>
            <span class="nl">display:</span> <span class="n">it</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">displayForManagers</span><span class="o">),</span>
            <span class="nl">accountType:</span> <span class="n">accountType</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
            <span class="nl">currency:</span> <span class="n">accountType</span><span class="o">.</span><span class="na">currency</span><span class="o">.</span><span class="na">id</span>
        <span class="o">]</span> <span class="k">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span>
        <span class="c1">// We need to fetch the user for current date or custom fields</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">customFields</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">entityManagerHandler</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">User</span><span class="o">,</span> <span class="n">userId</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// When no date, we get the current account status, to fetch the available balance</span>
            <span class="kt">def</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">accountType</span><span class="o">)</span>
            <span class="kt">def</span> <span class="n">status</span> <span class="o">=</span> <span class="n">accountService</span><span class="o">.</span><span class="na">getAccountStatus</span><span class="o">(</span><span class="n">account</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">result</span><span class="o">.</span><span class="na">balance</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="na">balance</span>
            <span class="n">result</span><span class="o">.</span><span class="na">availableBalance</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="na">availableBalance</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// The balance is an expression for a specific date</span>
            <span class="n">result</span><span class="o">.</span><span class="na">balance</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">balanceExpression</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">customFields</span><span class="o">.</span><span class="na">empty</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">def</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">scriptHelper</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">customFields</span><span class="o">)</span>
            <span class="n">customFields</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span>
                <span class="kt">def</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span><span class="o">[</span><span class="n">it</span><span class="o">.</span><span class="na">internalName</span><span class="o">]</span>
                <span class="n">result</span><span class="o">[</span><span class="n">it</span><span class="o">.</span><span class="na">internalName</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span> <span class="k">instanceof</span> <span class="n">Date</span> <span class="o">?</span>
                        <span class="n">formatter</span><span class="o">.</span><span class="na">formatAsDate</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">:</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">cacheFlusher</span><span class="o">.</span><span class="na">flush</span><span class="o">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="o">}.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())</span>

    <span class="kt">def</span> <span class="n">columns</span> <span class="o">=</span> <span class="o">[</span>
        <span class="o">[</span>
            <span class="nl">header:</span> <span class="n">translationHandler</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="n">UsersKeys</span><span class="o">.</span><span class="na">Users</span><span class="o">.</span><span class="na">USER</span><span class="o">),</span>
            <span class="nl">property:</span> <span class="s2">"display"</span>
        <span class="o">],</span>
        <span class="o">[</span>
            <span class="nl">header:</span> <span class="n">translationHandler</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="n">BankingKeys</span><span class="o">.</span><span class="na">Accounts</span><span class="o">.</span><span class="na">TYPE</span><span class="o">),</span>
            <span class="nl">property:</span> <span class="s2">"accountType"</span>
        <span class="o">],</span>
        <span class="o">[</span>
            <span class="nl">header:</span> <span class="n">translationHandler</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="n">BankingKeys</span><span class="o">.</span><span class="na">Accounts</span><span class="o">.</span><span class="na">BALANCE</span><span class="o">),</span>
            <span class="nl">property:</span> <span class="s2">"balance"</span><span class="o">,</span>
            <span class="nl">currencyProperty:</span> <span class="s2">"currency"</span><span class="o">,</span>
            <span class="nl">align:</span> <span class="s2">"right"</span>
        <span class="o">]</span>
    <span class="o">]</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">columns</span> <span class="o">&lt;&lt;</span> <span class="o">[</span>
            <span class="nl">header:</span> <span class="n">translationHandler</span><span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="n">BankingKeys</span><span class="o">.</span><span class="na">Accounts</span><span class="o">.</span><span class="na">AVAILABLE_BALANCE</span><span class="o">),</span>
            <span class="nl">property:</span> <span class="s2">"availableBalance"</span><span class="o">,</span>
            <span class="nl">currencyProperty:</span> <span class="s2">"currency"</span><span class="o">,</span>
            <span class="nl">align:</span> <span class="s2">"right"</span>
        <span class="o">]</span>
    <span class="o">}</span>
    <span class="n">customFields</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span>
        <span class="n">columns</span> <span class="o">&lt;&lt;</span> <span class="o">[</span> <span class="nl">header:</span> <span class="n">it</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="nl">property:</span> <span class="n">it</span><span class="o">.</span><span class="na">internalName</span> <span class="o">]</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">[</span>
        <span class="nl">columns:</span> <span class="n">columns</span><span class="o">,</span>
        <span class="nl">rows:</span> <span class="n">rows</span><span class="o">,</span>
        <span class="nl">totalCount:</span> <span class="n">totalCount</span><span class="o">,</span>
        <span class="nl">currentPage:</span> <span class="n">currentPage</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="n">searchBalances</span><span class="o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-user-balances-search-operation">Create the custom operation to search users balances</h5>
<div class="paragraph">
<p>Under System &gt; Tools &gt; Custom operations, create a new one with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong>: User balances (can be changed - will be the label displayed on the menu);</p>
</li>
<li>
<p><strong>Internal name</strong>: <code>userBalances</code>;</p>
</li>
<li>
<p><strong>Enable for channels</strong>: Main, Web services, Mobile app;</p>
</li>
<li>
<p><strong>Scope</strong>: System;</p>
</li>
<li>
<p><strong>Script</strong>: User balances;</p>
</li>
<li>
<p><strong>Result type</strong>: Result page;</p>
</li>
<li>
<p><strong>Search automatically on page load</strong>: No;</p>
</li>
<li>
<p><strong>Allow printing results</strong>: Yes;</p>
</li>
<li>
<p><strong>Allow exporting results to CSV</strong>: Yes;</p>
</li>
<li>
<p><strong>Action when clicking a row</strong>: Navigate to a Cyclos location;</p>
</li>
<li>
<p><strong>Location</strong>: user_profile;</p>
</li>
<li>
<p><strong>Parameters to be passed (comma-separated names)</strong>: <code>id</code>;</p>
</li>
<li>
<p><strong>Main menu</strong>: Banking (can be changed - will be the menu where the label is going to be displayed).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once saved, on the Form fields tab, create the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Account type</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>accountType</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Dynamic selection;</p>
</li>
<li>
<p><strong>Required</strong>: true;</p>
</li>
<li>
<p><strong>All selected label</strong>: All;</p>
</li>
<li>
<p><strong>Load values script</strong>: User account types loader.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Groups</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>groups</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Dynamic multi selection;</p>
</li>
<li>
<p><strong>All selected label</strong>: All (can be changed as desired);</p>
</li>
<li>
<p><strong>Load values script</strong>: User groups loader.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Date</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Internal name</strong>: <code>date</code>;</p>
</li>
<li>
<p><strong>Data type</strong>: Date.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="scripting-solution-user-balances-permissions">Enable the custom operation</h5>
<div class="paragraph">
<p>Enable this operation in the administrators group, in the Permissions tab, under 'Run system custom operations'.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scripting-storage">4.6. Script storage</h3>
<div class="paragraph">
<p>A general-purpose storage is available for scripts. It is a key / value storage, implementing the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/server/utils/ObjectParameterStorage.html">ObjectParameterStorage</a> interface.</p>
</div>
<div class="paragraph">
<p>It stores the values as JSON in the database. Besides the methods for get / set String, Boolean, Decimal, Integer, Long and Enum, it also supports storing objects.</p>
</div>
<div class="paragraph">
<p>Also, a mechanism is provided for Groovy scripts to access objects directly via the property name, such as <code>storage.name = value</code> or <code>value = storage.name</code>.</p>
</div>
<div class="paragraph">
<p>A script storage is obtained using a key (string), and a timeout can (optionally) be set before the storage expires. The storage is accessed via the <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/system/ScriptStorageHandler.html">ScriptStorageHandler</a>. It provides the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>get(key)</code> or <code>get(key, timeoutInSeconds)</code>: Returns a storage by key (string). If a valid storage exists (in the same network), it is returned. Otherwise, a new one is created and returned. Optionally, a timeout in seconds can be passed, which sets an expiration for the stored data;</p>
</li>
<li>
<p><code>exists(key)</code>: Returns whether a valid storage with a given key exists;</p>
</li>
<li>
<p><code>remove(key)</code>: Removes a storage by key;</p>
</li>
<li>
<p><code>detach(key)</code>: Detaches the given storage from the current transaction. Subsequent calls to <code>get</code> will re-read the data from the database.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some restrictions apply on which kind of objects can be stored or retrieved.
Entities can only be stored if they are already persisted (only the id is stored, and the entity is loaded by id from the database when retrieved). Other objects need to have a public empty constructor, plus getters and setters for fields.</p>
</div>
<div class="paragraph">
<p>Here is an example. It will also cover the case where in the first request of a user, a complex computation is performed. And we want to make sure this is done exactly once per user. So the example is a bit complex, but it prevents any race conditions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// Storage retrieval</span>
<span class="kt">def</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">3</span> <span class="c1">// Expires in 3 hours</span>
<span class="kt">def</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">"requests_for_${sessionData.loggedUser.id}"</span>
<span class="kt">def</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">scriptStorageHandler</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">timeout</span><span class="o">)</span>

<span class="kt">def</span> <span class="n">currentRequests</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="na">requests</span> <span class="o">?:</span> <span class="mi">0</span>

<span class="c1">// If the user has never done any request, we'll do some unique and costly operation...</span>
<span class="k">if</span> <span class="o">(</span><span class="n">currentRequests</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// But we need to make sure that no other thread can make this code run twice</span>
    <span class="n">lockHandler</span><span class="o">.</span><span class="na">lock</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
    <span class="c1">// After locking, detach the storage to force it to be re-read</span>
    <span class="n">scriptStorageHandler</span><span class="o">.</span><span class="na">detach</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>

    <span class="c1">// Re-read the storage in the critical section (after lock)</span>
    <span class="n">storage</span> <span class="o">=</span> <span class="n">scriptStorageHandler</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
    <span class="n">currentRequests</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="na">requests</span> <span class="o">?:</span> <span class="mi">0</span>

    <span class="c1">// We need to check again if this is still the first request</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">currentRequests</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Only now we're 100% sure that this is the first request for the user</span>
        <span class="c1">// Do the complex computation here...</span>
        <span class="c1">// We know this is the user's first request, so store 1</span>
        <span class="n">storage</span><span class="o">.</span><span class="na">requests</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// Increment normally, as the initial computation was already done by another transaction</span>
        <span class="n">storage</span><span class="o">.</span><span class="na">requests</span><span class="o">++</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">// Increment the number of requests for the logged user</span>
    <span class="n">storage</span><span class="o">.</span><span class="na">requests</span><span class="o">++</span>
<span class="o">}</span>

<span class="c1">// Then, later on, maybe on another script...</span>
<span class="k">return</span> <span class="s2">"There are ${storage.requests} requests for user ${sessionData.loggedUser.name}"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scripting-custom-alerts">4.7. Custom alerts</h3>
<div class="paragraph">
<p>From Cyclos 4.12 onwards, custom alerts can be defined for both system and user.
These alerts will be created using <a href="#scripting">scripting</a>. It can be done in any kind of script just adding a few lines as the next examples show:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>System alert</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.messaging.AlertServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.messaging.alerts.SystemAlertType</span>

<span class="n">AlertServiceLocal</span> <span class="n">alertService</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">alertService</span>
<span class="n">alertService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">SystemAlertType</span><span class="o">.</span><span class="na">CUSTOM</span><span class="o">,</span> <span class="cm">/*Alert text*/</span> <span class="s2">"This is a system alert example"</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>User alert</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.cyclos.impl.messaging.AlertServiceLocal</span>
<span class="kn">import</span> <span class="nn">org.cyclos.model.messaging.alerts.UserAlertType</span>

<span class="n">AlertServiceLocal</span> <span class="n">alertService</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">alertService</span><span class="o">;</span>
<span class="c1">// Create the alert for the corresponding user, in this case we use the one logged.</span>
<span class="n">alertService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">sessionData</span><span class="o">.</span><span class="na">getLoggedUser</span><span class="o">(),</span> <span class="n">UserAlertType</span><span class="o">.</span><span class="na">CUSTOM</span><span class="o">,</span> <span class="cm">/*Alert text*/</span> <span class="s2">"This is a user alert example"</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This type will appear as an option in the administrator&#8217;s notification settings page under <code>User alerts</code> and <code>System alerts</code> preferences.</p>
</div>
</div>
<div class="sect2">
<h3 id="scripting-debug">4.8. Debugging scripts</h3>
<div class="paragraph">
<p>The script editor in Cyclos uses <a href="https://codemirror.net/">CodeMirror</a>, which provides syntax highlighting. However, as the script complexity grows, better tooling support is desired. We use and support using <a href="https://www.eclipse.org">Eclipse</a>, together with the <a href="https://github.com/groovy/groovy-eclipse/wiki">Groovy plugin</a>.</p>
</div>
<div class="paragraph">
<p>For this purpose, Cyclos provides, in the details page of scripts, a button named <code>Get code for debug</code>. It will download a ZIP file with the full code of each script box, with all library code already included (there are comments separating each include). Also, the script parameters are returned, including script parameters of included libraries as well. This is the code that is actually executed by Cyclos.</p>
</div>
<div class="paragraph">
<p>In order to run the scripts in the IDE, a local copy of the Cyclos database is needed, as well as a copy of the JARs bundled with Cyclos. Also, a small Groovy script needs to be written to provide the actual script the context (bound variables). The ZIP file also includes a <code>README.html file</code>, which will explain how to set up the environment and run the script.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="content-management">5. Content management</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cyclos allows customizing content in several ways, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Static content: Headers, footers, home page, etc.;</p>
</li>
<li>
<p>Menu pages: Content pages which is shown as a menu item;</p>
</li>
<li>
<p>Mobile pages: Content pages shown in the mobile application;</p>
</li>
<li>
<p>Themes: Theme used in one of the front-ends (classic web frontend, new web frontend, mobile app);</p>
</li>
<li>
<p>Application translation: Translation of static text displayed in one of the front-ends;</p>
</li>
<li>
<p>Data translation: Translation of different data types, such as profile fields, groups, account types, etc.;</p>
</li>
<li>
<p>Voucher templates: PDF templates for printing vouchers;</p>
</li>
<li>
<p>Banners: Small sections which display custom content in either classic or new frontend;</p>
</li>
<li>
<p>Documents: Either static files or dynamic documents which are applied to users;</p>
</li>
<li>
<p>Images: Logos, custom images to display in static content / pages;</p>
</li>
<li>
<p>SVG icons: Icons used in frontends for custom operations, records, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This chapter covers details on some aspects of content management, which are done by administrators with permission using the classic frontend. It is under the menu 'Content'. Many of the content management concepts are applied to specific configurations. Hence, when accessing the menu for translations, pages and banners, first you need to choose to which configuration will the content be applied to.</p>
</div>
<div class="sect2">
<h3 id="content-security">5.1. Security considerations</h3>
<div class="paragraph">
<p>Cyclos allows administrators with either 'System configuration', 'Manage specific configurations' or 'Manage content for configurations' permissions to create and edit HTML pages. Please be aware that JavaScript (and any other HTML tag) can be executed by these pages! Please only grant these permissions to trusted personnel!</p>
</div>
<div class="paragraph">
<p>Cyclos does not sanitize these pages because it gives administrators more freedom in creating desired content. Script code in <code>&lt;script&gt;</code> tags will not be executed, but scripts on events such as <code>onload</code> will be executed.</p>
</div>
</div>
<div class="sect2">
<h3 id="content-user-variables">5.2. User variables</h3>
<div class="paragraph">
<p>It is possible to use variables with data of the current user in places like sent notifications, emails and in-app push notifications, as well as static content, content pages, mobile pages and banners.</p>
</div>
<div class="paragraph">
<p>Variables are always used between curly braces (like <code>{variable}</code>).
The list of available variables is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>{display}</code>: The configured user&#8217;s display name (is the user&#8217;s full name by default, but can be changed in the configuration);</p>
</li>
<li>
<p><code>{name}</code> or <code>{fullName}</code>: The user&#8217;s full name;</p>
</li>
<li>
<p><code>{username}</code>, <code>{loginName}</code> or <code>{login}</code>: The user&#8217;s login name;</p>
</li>
<li>
<p><code>{userEmail}</code> or <code>{email}</code>: The user&#8217;s email address. Note: for email templates, use <code>{userEmail}</code> because <code>{email}</code> is the email destination and they could differ;</p>
</li>
<li>
<p><code>{&lt;internalName&gt;}</code>: A user custom field by internal name;</p>
</li>
<li>
<p><code>{phone}</code>: A single mobile or land-line phone;</p>
</li>
<li>
<p><code>{phones}</code>: A comma-separated list with all mobile and land-line phone;</p>
</li>
<li>
<p><code>{mobilePhone}</code>: A single mobile phone;</p>
</li>
<li>
<p><code>{mobilePhones}</code>: A comma-separated list with all mobile phones;</p>
</li>
<li>
<p><code>{landLinePhone}</code>: A single land-line phone;</p>
</li>
<li>
<p><code>{landLinePhones}</code>: A comma-separated list with all land-line phones;</p>
</li>
<li>
<p><code>{address}</code>: The formatted user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.name}</code>: The name of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.addressLine1}</code>: The line1 of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.addressLine2}</code>: The line2 of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.street}</code>: The street of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.buildingNumber}</code>: The building number of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.complement}</code>: The complement of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.neighborhood}</code>: The neighborhood of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.poBox}</code>: The PO-box of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.zip}</code>: The ZIP code of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.city}</code>: The city of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.region}</code>: The region of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{address.country}</code>: The country name of the user&#8217;s default address;</p>
</li>
<li>
<p><code>{groupSet}</code>: The name of the user&#8217;s group set;</p>
</li>
<li>
<p><code>{group}</code>: The name of the user&#8217;s group;</p>
</li>
<li>
<p><code>{groupDisplay}</code>: The display name at registration for the user&#8217;s group;</p>
</li>
<li>
<p><code>{applicationName}</code>: The application name set in the user&#8217;s configuration;</p>
</li>
<li>
<p><code>{applicationURL}</code>: The application root URL set in the user&#8217;s configuration;</p>
</li>
<li>
<p><code>{date}</code>: The current date, formatted as configured in Cyclos;</p>
</li>
<li>
<p><code>{dateTime}</code>: The current date and time, formatted as configured in Cyclos;</p>
</li>
<li>
<p><code>{time}</code>: The current time, formatted as configured in Cyclos;</p>
</li>
<li>
<p><code>{&lt;typeInternalName&gt;.number}</code>: The user&#8217;s account number;</p>
</li>
<li>
<p><code>{&lt;typeInternalName&gt;.balance}</code>: The formatted user&#8217;s account balance;</p>
</li>
<li>
<p><code>{&lt;typeInternalName&gt;.availableBalance}</code>: The formatted user&#8217;s account available balance;</p>
</li>
<li>
<p><code>{&lt;typeInternalName&gt;.creditLimit}</code>: The formatted user&#8217;s account lower credit limit;</p>
</li>
<li>
<p><code>{&lt;typeInternalName&gt;.upperCreditLimit}</code>: The formatted user&#8217;s account upper credit limit;</p>
</li>
<li>
<p><code>{&lt;typeInternalName&gt;.typeName}</code>: The user&#8217;s account type display name;</p>
</li>
<li>
<p><code>{&lt;typeInternalName&gt;.typeId}</code>: The user&#8217;s account type internal id;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that for all account-related variables, if the provided account type internal name is <code>account</code>, it will use the first visible account type. For systems with a single user account, it will be easier to use the <code>account</code> prefix.</p>
</div>
</div>
<div class="sect2">
<h3 id="content-thymeleaf">5.3. Using Thymeleaf for dynamic content</h3>
<div class="paragraph">
<p>Starting with Cyclos 4.16, in some content elements, the HTML markup can be enhanced with (Thymeleaf)[<a href="https://www.thymeleaf.org/" class="bare">https://www.thymeleaf.org/</a>] to add dynamic content. These elements are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Static content</p>
</li>
<li>
<p>Menu pages</p>
</li>
<li>
<p>Mobile pages</p>
</li>
<li>
<p>Banners</p>
</li>
<li>
<p>Voucher templates</p>
</li>
<li>
<p>Dynamic documents</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, it is possible to generate dynamic content in both custom operation and custom wizard step information texts.</p>
</div>
<div class="paragraph">
<p>Note that when using Thymeleaf it is not recommended to edit the content with the visual editor in the content editor. Always prefer the source editor, which allows editing the raw HTML source code, and won&#8217;t mess up with the content.</p>
</div>
<div class="sect3">
<h4 id="content-thymeleaf-markup">5.3.1. Thymeleaf markup</h4>
<div class="paragraph">
<p>Thymeleaf uses a minimally-invasive markup over HTML, adding attributes to HTML tags which are processed dynamically. Expressions are evaluated in tag attributes with the <code>${expressions}</code> syntax. The attributes processed by thymeleaf start with <code>th:</code>, and some of the most used ones are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>th:if</code>: Conditionally render the enclosing HTML element. Example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;div</span> <span class="na">th:if=</span><span class="s">"${user.admin}"</span><span class="nt">&gt;</span>This content is only rendered for administrators<span class="nt">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>th:text</code>: Replaces the element content with the result of an expression. The content is automatically escaped to render safe HTML. If the expression value is itself an HTML text, use <code>th:utext</code> instead, which will render the content unescaped. Example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;div</span> <span class="na">th:text=</span><span class="s">"${user.name}"</span><span class="nt">&gt;</span>This content is replaced by the current user's name<span class="nt">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>th:each</code>: Renders the enclosing element many times, one per element in a collection. Example (uses both <code>#account</code> and <code>#format</code> expression objects, which are <a href="#content-thymeleaf-expression-objects">explained below</a>):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;div</span> <span class="na">th:each=</span><span class="s">"account : ${#accounts.all()}"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">th:text=</span><span class="s">"${account.type.name}"</span><span class="nt">&gt;&lt;/span&gt;</span>:
    <span class="nt">&lt;span</span> <span class="na">th:text=</span><span class="s">"${#format.amount(account.currency, account.balance)}"</span><span class="nt">&gt;&lt;/span&gt;</span>
<span class="nt">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>th:with</code>: Defines a new variable to be used in an expression. Note that you can have a single <code>th:with</code> per element. Example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;div</span> <span class="na">th:each=</span><span class="s">"account : ${#accounts.all()}"</span> <span class="na">th:with=</span><span class="s">"type=${account.type}"</span>
    <span class="na">th:text=</span><span class="s">"${type.name}"</span><span class="nt">&gt;&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>th:block</code>: This is the only element handled by Thymeleaf, and it actually renders no element at all in the resulting HTML, but is useful for conditionals and loops. In the following example, both text blocks will be rendered without any enclosing HTML element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;th:block</span> <span class="na">th:if=</span><span class="s">"${user.member}"</span><span class="nt">&gt;</span>
    You are a regular user.
    <span class="nt">&lt;th:block</span> <span class="na">th:if=</span><span class="s">"${user.group.internalName == 'members'}"</span><span class="nt">&gt;</span>
        And you are in the members group!
    <span class="nt">&lt;/th:block&gt;</span>
<span class="nt">&lt;/th:block&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>${{expression}}</code>: Formats a variable for output. It will delegate to the Cyclos built-in formatter, which, is able to format a wide range of data types. It is semantically equivalent to using the <a href="#content-thymeleaf-expression-objects-format">${#format.object(expression)}</a>. Here&#8217;s an example which outputs the current date and time with the format taken from Cyclos' configuration:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;th:block</span> <span class="na">th:text=</span><span class="s">"${{now}}"</span><span class="nt">&gt;&lt;/th:block&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The expressions have access to variables. The variables that Cyclos provides in all contexts are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sessionData</code>: Contains information about the currently authenticated user (if any), as a <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/access/SessionData.html">org.cyclos.impl.access.SessionData</a>;</p>
</li>
<li>
<p><code>user</code>: The currently authorized user, as a <a href="#scripting-general-wrap">wrapped user</a>, so custom fields are accessible directly. For guests, is null;</p>
</li>
<li>
<p><code>now</code>: The current date / time as <code>java.util.Date</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, when processing dynamic documents, there are the following extra attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>owner</code>: The user over which the document is being processed. Will be different from the currently authorized user when an administrator or broker is printing a user document. It is a <a href="#scripting-general-wrap">wrapped user</a>, so custom fields are accessible directly;</p>
</li>
<li>
<p><code>customValues</code>: A map with the values of custom fields selected in the form.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="content-thymeleaf-expression-objects">5.3.2. Thymeleaf expression utility objects</h4>
<div class="paragraph">
<p>Thymeleaf offers the concept of <a href="https://www.thymeleaf.org/doc/tutorials/3.1/usingthymeleaf.html#expression-utility-objects">expression utility objects</a>, which act as helpers in expressions. There are several built-in objects, please, refer to the documentation for a reference of them.</p>
</div>
<div class="paragraph">
<p>Besides the built-in expression utility objects, Cyclos provides a set of utility objects:</p>
</div>
<div class="sect4">
<h5 id="content-thymeleaf-expression-objects-format">#format</h5>
<div class="paragraph">
<p>Handles data formatting. Provides the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>object(object)</code>: Attempts to format the given input for display. Dates are formatted as date and time;</p>
</li>
<li>
<p><code>objectOrDate(object)</code>: Attempts to format the given input for display. Dates are formatted as date-only;</p>
</li>
<li>
<p><code>amount(currency, amount)</code>: Formats an amount as currency amount. The first parameter is a reference to a currency, or one of: internal name, an entity that has a currency or a currency VO. The second parameter is a number, a currency amount or a string;</p>
</li>
<li>
<p><code>number(number, scale)</code>: Formats a number using a given number of decimals;</p>
</li>
<li>
<p><code>percentage(number, scale)</code>: Formats a number as percentage, using a given number of decimals (scale). 0.1 = 10%, 1 = 100%;</p>
</li>
<li>
<p><code>objectOrDate(object)</code>: Attempts to format the given input for display. Dates are formatted as date-only;</p>
</li>
<li>
<p><code>url(image)</code>: Returns the public API URL for the given image;</p>
</li>
<li>
<p><code>var(name)</code>: Returns a variable for the current user. The available variables are the same as <a href="#content-user-variables">User variables</a>. Just make sure to pass the variable name as string (between quotes), like <code>${#format.var('mobilePhone')}</code>;</p>
</li>
<li>
<p><code>country(code)</code>: Returns a country name from the 2-letter ISO 3166-2 code;</p>
</li>
<li>
<p><code>truncate(text, length)</code>: Truncates a text for a maximum length;</p>
</li>
<li>
<p><code>maskId(id)</code>: Applies the id mask, that means, returns the external representation of a database id.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="content-thymeleaf-expression-objects-decimals">#decimals</h5>
<div class="paragraph">
<p>Manipulation and comparison of decimal values. Provides the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>decimal(number)</code>: Converts the given object into a <code>BigDecimal</code>;</p>
</li>
<li>
<p><code>areEquals(number1, number2)</code>: Returns whether 2 numbers (each one processed by <code>decimal(number)</code>) represent the same decimal amount;</p>
</li>
<li>
<p><code>isPositive(number)</code>: Returns whether the given number (processed by <code>decimal(number)</code>) is positive (and not zero);</p>
</li>
<li>
<p><code>isPositiveOrZero(number)</code>: Returns whether the given number (processed by <code>decimal(number)</code>) is positive or zero;</p>
</li>
<li>
<p><code>isNegative(number)</code>: Returns whether the given number (processed by <code>decimal(number)</code>) is negative;</p>
</li>
<li>
<p><code>isNegativeOrZero(number)</code>: Returns whether the given number (processed by <code>decimal(number)</code>) is negative or zero;</p>
</li>
<li>
<p><code>isZero(number)</code>: Returns whether the given number (processed by <code>decimal(number)</code>) is zero;</p>
</li>
<li>
<p><code>isNotZero(number)</code>: Returns whether the given number (processed by <code>decimal(number)</code>) is not zero.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="content-thymeleaf-expression-objects-accounts">#accounts</h5>
<div class="paragraph">
<p>Provides access to the current user accounts. If the current user is an administrator, provides access to visible system accounts. Provides the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>all()</code>: Returns all visible accounts;</p>
</li>
<li>
<p><code>get(type)</code>: Returns an account with a given type, using the type internal name or account type reference;</p>
</li>
<li>
<p><code>first()</code>: Returns the first account. Useful for systems with a single account.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The returned objects are of type <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/AccountWrapper.html">org.cyclos.impl.banking.AccountWrapper</a>, which has the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>number</code>: The formatted account number, if configured;</p>
</li>
<li>
<p><code>balance</code>: The current account balance, as a <code>BigDecimal</code>;</p>
</li>
<li>
<p><code>negativeSince</code>: The date the account crossed the zero balance border as <code>Date</code>;</p>
</li>
<li>
<p><code>availableBalance</code>: The current account&#8217;s available balance, as a <code>BigDecimal</code>;</p>
</li>
<li>
<p><code>reservedAmount</code>: The current account&#8217;s reserved balance, as a <code>BigDecimal</code>;</p>
</li>
<li>
<p><code>creditLimit</code>: The current account&#8217;s lower credit limit, as a <code>BigDecimal</code>;</p>
</li>
<li>
<p><code>upperCreditLimit</code>: The current account&#8217;s upper credit limit, as a <code>BigDecimal</code>;</p>
</li>
<li>
<p><code>account</code>: The underlying <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Account.html">org.cyclos.entities.banking.Account</a>;</p>
</li>
<li>
<p><code>type</code>: The underlying <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/AccountType.html">org.cyclos.entities.banking.AccountType</a>;</p>
</li>
<li>
<p><code>currency</code>: The underlying <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/entities/banking/Currency.html">org.cyclos.entities.banking.Currency</a>;</p>
</li>
<li>
<p><code>status</code>: The current <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/banking/accounts/AccountStatusVO.html">org.cyclos.model.banking.accounts.AccountStatusVO</a>;</p>
</li>
<li>
<p><code>lastTransfers(n)</code>: Returns the last <em>n</em> transfers, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/AccountHistoryEntry.html">org.cyclos.impl.banking.AccountHistoryEntry</a>;</p>
</li>
<li>
<p><code>lastCredits(n)</code>: Returns the last <em>n</em> incoming transfers, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/AccountHistoryEntry.html">org.cyclos.impl.banking.AccountHistoryEntry</a>;</p>
</li>
<li>
<p><code>lastDebits(n)</code>: Returns the last <em>n</em> outgoing transfers, as <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/impl/banking/AccountHistoryEntry.html">org.cyclos.impl.banking.AccountHistoryEntry</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="content-thymeleaf-expression-objects-permissions">#permissions</h5>
<div class="paragraph">
<p>Allows querying for permissions providing the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>has(string)</code>: Returns true if the logged user has the given permission. See <a href="https://documentation.cyclos.org/4.16.3/scripting-api-docs/org/cyclos/model/access/Permission.html">org.cyclos.model.access.Permission</a> for the list with the valid names. E.g.: 'MY_PAYMENTS_RECEIVE' and 'myPaymentReceive' are two valid names for the same permission.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;div</span> <span class="na">th:if=</span><span class="s">"${#permissions.has('MY_PAYMENTS_RECEIVE')}"</span><span class="nt">&gt;</span>
  The user has the receive payment permission
<span class="nt">&lt;/div&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 4.16.3<br>
Last updated 2023-08-09 14:32:06 UTC
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>